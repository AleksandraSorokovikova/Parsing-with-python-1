<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Сбербанк или туда и обратно / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/451188\/"},"headline":"Сбербанк или туда и обратно","datePublished":"2019-05-10T10:47:51+03:00","dateModified":"2019-05-11T14:08:18+03:00","author":{"@type":"Person","name":"staticmain"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"ГЛАВА 1. Нежданные гости Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращ...","url":"https:\/\/habr.com\/ru\/post\/451188\/#post-content-body","about":["h_system_programming","h_debug","f_develop"],"image":["https:\/\/habrastorage.org\/webt\/si\/bq\/2u\/sibq2unjy0i1yoy_7sa0qljphae.jpeg","https:\/\/habrastorage.org\/webt\/ak\/k4\/do\/akk4do9scie61w_tobeuwpk6liu.png","https:\/\/habrastorage.org\/webt\/oh\/ul\/ts\/ohultstzocyw8za06mbxqwmnrma.jpeg","https:\/\/habrastorage.org\/webt\/rk\/vm\/sc\/rkvmscw9ret9atfnts-nezxtaqg.png","https:\/\/habrastorage.org\/webt\/zr\/-d\/ez\/zr-dez83p56hekuceyiiqka2rdi.jpeg","https:\/\/habrastorage.org\/webt\/yp\/44\/t_\/yp44t_qwokissyt75mayl71mcdm.jpeg","https:\/\/habrastorage.org\/webt\/c8\/7f\/m2\/c87fm26nwcdjtfol6m0vamuvk8e.jpeg","https:\/\/habrastorage.org\/webt\/r6\/qe\/de\/r6qedenl5w3dez4ysscvod8rmjw.png","https:\/\/habrastorage.org\/webt\/mt\/gl\/q-\/mtglq-c68eyegv74wjnzjvpmddi.png","https:\/\/habrastorage.org\/webt\/pb\/dz\/85\/pbdz85atzxiscdkdkq0z97ahhsm.png","https:\/\/habrastorage.org\/webt\/ve\/tr\/d4\/vetrd4m4rsdhmkyxkgrvxbkepko.png","https:\/\/habrastorage.org\/webt\/wo\/eu\/2g\/woeu2gk8m1mvtibiepfxwiijrbo.png","https:\/\/habrastorage.org\/webt\/ko\/im\/3y\/koim3ykfftmlltegcqh_rkdkgxc.jpeg"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Сбербанк или туда и обратно" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Сбербанк или туда и обратно" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Сбербанк или туда и обратно" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="ГЛАВА 1. Нежданные гости
Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="ГЛАВА 1. Нежданные гости
Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="ГЛАВА 1. Нежданные гости
Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="ГЛАВА 1. Нежданные гости
Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="ГЛАВА 1. Нежданные гости
Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/451188/445d1f9df3085f8d05efb1abd8fcaad0/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/451188/445d1f9df3085f8d05efb1abd8fcaad0/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/451188/445d1f9df3085f8d05efb1abd8fcaad0/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/451188/445d1f9df3085f8d05efb1abd8fcaad0/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/451188/445d1f9df3085f8d05efb1abd8fcaad0/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="451188" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-10T07:47:51.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/451188/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/451188/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/451188/445d1f9df3085f8d05efb1abd8fcaad0/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/staticmain/" title="staticmain" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/d97/784/45d/d9778445d6ba07ab20d3aceb2613bd1f.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/staticmain/" class="tm-user-info__username">
      staticmain
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-10T07:47:51.000Z" title="2019-05-10, 10:47">10  мая  2019 в 10:47</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Сбербанк или туда и обратно</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/system_programming/" class="tm-article-snippet__hubs-item-link"><span>Системное программирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/debug/" class="tm-article-snippet__hubs-item-link"><span>Отладка</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Из песочницы
      </span></div></div> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><img src="https://habrastorage.org/r/w780q1/webt/si/bq/2u/sibq2unjy0i1yoy_7sa0qljphae.jpeg" data-src="https://habrastorage.org/webt/si/bq/2u/sibq2unjy0i1yoy_7sa0qljphae.jpeg" data-blurred="true"/><br/>
<br/>
<h2>ГЛАВА 1. Нежданные гости</h2><br/>
Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект должен быть готов через 4 дня. Нет, наш PO не зверь, и ничуть не похож на <a href="https://twitter.com/toonsxander/status/1069105064529268737">сову</a> (разве что чуть-чуть на ворона), просто так сложилось. Ну раз надо, так надо, тем более что команде (а я являюсь ведущим разработчиком команды «С») было обещано что-то вкусное. На часах и календаре был четверг, 11:00, к понедельнику проект должен быть готов.<br/>
<br/>
Для начала, чем мы вообще занимаемся. Мы занимаемся автоматизацией кинотеатров — автоматическим и дистанционным управлением оборудования, автоматизацией кинопоказа, мониторингом, видеопанелями, а теперь еще и терминалами продажи билетов и бара. Конкретно последнему пункту и посвящена данная статья.<br/>
<a name="habracut"></a><br/>
Сам проект, который нужно было завершить до понедельника представляет из себя некую прослойку между основным сервером на Scala и железным терминалом оплаты VeriFone VX 820 (на самом деле терминалов больше, но для примера возьмем только его). Понятно, что просто так проводить через него транзакции нам никто не даст, поэтому используются утилиты и библиотеки Сбербанка/Arcus и UCS. Таким образом схема работы в итоге должна быть следующей:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/ak/k4/do/akk4do9scie61w_tobeuwpk6liu.png"/><br/>
<br/>
Внешне он выглядит вот так:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/oh/ul/ts/ohultstzocyw8za06mbxqwmnrma.jpeg" data-src="https://habrastorage.org/webt/oh/ul/ts/ohultstzocyw8za06mbxqwmnrma.jpeg" data-blurred="true"/><br/>
<br/>
Также данная подсистема должна использоваться на стандартных кассовых машинах которые все видели в любом кинотеатре у кассиров.<br/>
<br/>
Согласно внутренней традиции каждый проект нашей команды мы называем именем из древнескандинавской мифологии, для данной подсистемы было выбрано имя Gefjon — Имя богини плодородия и изобилия (неплохое название для сервера оплаты, разве нет? Ну и легенда о быках отрезающих остров идеально ложится на текущую архитектуру, отрезая работу с оборудованием от высокоуровневого языка).<br/>
<br/>
Формат входящих и выходящих сообщений — HTTP сервер с JSON нагрузкой. Это оптимальный компромисс между Scala, которой сложно опуститься до вычленения бинарных данных из socket-потоков и C, которому трудно подняться до передачи объектов через сеть. Возможных операций, которыми необходимо оперировать не так много: оплата, отмена, возврат, разные типы отчетов, открытие сервисного меню и ping. С виду ничего сложного. Так как банковских систем целых три (а в последствии ожидается пополнение семейства), то было решено разделить проект на компоненты:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/rk/vm/sc/rkvmscw9ret9atfnts-nezxtaqg.png"/><br/>
<br/>
Зеленым покрашены блоки, которые нам нужно было сделать, синим — те, которые нельзя поменять и которые предоставляет банк.<br/>
<br/>
Так как основные проблемы возникли только с ПО от Сбербанка, то статья в целом будет посвящена подводным камням, которые мы пересчитали своей ладьей.<br/>
<br/>
<h2>ГЛАВА 2. Баранье жаркое</h2><br/>
<img src="https://habrastorage.org/r/w780q1/webt/zr/-d/ez/zr-dez83p56hekuceyiiqka2rdi.jpeg" data-src="https://habrastorage.org/webt/zr/-d/ez/zr-dez83p56hekuceyiiqka2rdi.jpeg" data-blurred="true"/><br/>
(фото: heaclub.ru)<br/>
<br/>
… выглядит примерно так. Примерно так же выглядел код того прототипа, который был написан несколько месяцев назад для того, чтобы дать понять всем вышестоящим людям, что мы можем работать с банковскими приложениями.<br/>
<br/>
<pre><code class="cpp">        char buf[BUF_KB * 2];
        char * null;
        char * grep;
 
#ifdef _WIN32_WINNT
        char * ptr;
        null = "nul";
        grep = "findstr";
#else
        null = "/dev/null";
        grep = "grep";
#endif
        sprintf(buf, "%s %"PRIi32"= %sops.ini >%s 2>%s || "
                     "echo %"PRIi32"=9,6,PINPAD_TEST >> %sops.ini",
               grep,
               TERM_ARCUS_TEST_PINPAD,
               TERM_PATH,
               null,
               null,
               TERM_ARCUS_TEST_PINPAD,
               TERM_PATH);
 
#ifdef _WIN32_WINNT
        ptr = buf;
        while (*ptr)
        {
            if (*ptr == '/')
                *ptr = '\\';
            ptr++;
        }
#endif</code></pre><br/>
Понятное дело, что для Production варианта это не годилось, поэтому нужно было по сути написать все заново.<br/>
<br/>
Каждый банк, который предоставляет библиотеки для работы с терминалом обычно предоставляет два варианта подключения: через функции библиотеки (.so/.dll) или посредством готовой утилиты, которой всего-то нужно передать два значения — тип операции и сумму (когда нужно). В теории ничего сложного, всего-то<br/>
<br/>
<pre><code class="cpp">char buffer[100];
sprintf(buffer, "%d %d", atoi(argv[1]), atoi(argv[2]));
system(buffer);</code></pre><br/>
Результат операции при этом будет помещен в файл «e», а слип-чек — в файл «p». Просто отправим эти файлы на stdout с преобразованием в JSON, чтобы HTTP-сервер просто отправил их наверх как payload без размышлений о том, что там.<br/>
<br/>
Но эта статья не вышла бы, если бы все было так просто.<br/>
<br/>
<h2>ГЛАВА 4. Через гору и под горой</h2><br/>
Первоначальный вариант реализации представлял из себя простой вызов приложения — HTTP-сервер вызывал нужную обертку с унифицированными параметрами (например X-отчет это 4), а утилита например gfj_pilot запускала sb_pilot с параметром, который требовался для это операции (например X-отчет это 9). Затем утилита-обертка читала из е-файла результат операции (например 2000 — «отказ оплаты, повторите операцию») и преобразовывала в универсальную ошибку (например 3 — «Ошибка чтения или процессинга карты/счета, повторите операцию»). После этого файл «p» преобразовывался в base64 для избежания ломания форматирования и отсылался вместе с результатом в stdout в виде JSON.<br/>
<br/>
Все это прекрасно работало, пока в один прекрасный момент нам не сообщили, что…<br/>
<br/>
… это не работает под Windows.<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/yp/44/t_/yp44t_qwokissyt75mayl71mcdm.jpeg" data-src="https://habrastorage.org/webt/yp/44/t_/yp44t_qwokissyt75mayl71mcdm.jpeg" data-blurred="true"/><br/>
<br/>
Ну точнее у самого Windows проблем нет (кроме того, что слип генерируется в кодировке Cp-1251, а консоль работает в CP866). Просто не генерировался «е» файл. Запустили банковскую утилиту напрямую:<br/>
<br/>
<pre><code class="plaintext">C:\banks\sber\sb_pilot>dir
 Том в устройстве C не имеет метки.
 Серийный номер тома: B401-6B9D
 
 Содержимое папки C:\banks\sber\sb_pilot
 
04.02.2019  12:28    &lt;DIR>          .
04.02.2019  12:28    &lt;DIR>          ..
31.01.2019  17:12            10 832 F12X24.BIN
31.01.2019  17:12           128 000 gate.dll
31.01.2019  17:12            72 192 loadparm.exe
31.01.2019  17:12            36 204 OPT0.R
31.01.2019  17:12            20 716 OPT1.R
31.01.2019  17:12             1 806 OPT3.R
31.01.2019  17:12           388 608 pilot_nt.dll
31.01.2019  23:06               463 pinpad.ini
31.01.2019  17:12            91 136 posScheduler.exe
31.01.2019  17:12               418 printers.ini
01.02.2019  16:51            91 646 sbkernel1902.log
31.01.2019  17:12           653 312 sbrf.dll
31.01.2019  17:12           840 192 SBRFCOM.dll
31.01.2019  17:12         3 142 656 sb_kernel.dll
01.02.2019  16:51                 9 SESS.D
01.02.2019  16:51               715 SPLC.D
31.01.2019  17:12            72 192 upwin.exe
              20 файлов      5 659 718 байт
               2 папок  37 567 004 672 байт свободно
 
# Отправляем команду оплаты (1) на 10 рублей (1000 копеек)
C:\banks\sber\sb_pilot>loadparm.exe 1 1000
 
C:\banks\sber\sb_pilot>dir
 Том в устройстве C не имеет метки.
 Серийный номер тома: B401-6B9D
 
 Содержимое папки C:\banks\sber\sb_pilot
 
04.02.2019  12:28    &lt;DIR>          .
04.02.2019  12:28    &lt;DIR>          ..
04.02.2019  12:28               216 commerr.log
31.01.2019  17:12            10 832 F12X24.BIN
31.01.2019  17:12           128 000 gate.dll
31.01.2019  17:12            72 192 loadparm.exe
31.01.2019  17:12            36 204 OPT0.R
31.01.2019  17:12            20 716 OPT1.R
31.01.2019  17:12             1 806 OPT3.R
01.02.2019  18:51             1 349 p
31.01.2019  17:12           388 608 pilot_nt.dll
31.01.2019  23:06               463 pinpad.ini
31.01.2019  17:12            91 136 posScheduler.exe
31.01.2019  17:12               418 printers.ini
04.02.2019  12:28            92 218 sbkernel1902.log
31.01.2019  17:12           653 312 sbrf.dll
31.01.2019  17:12           840 192 SBRFCOM.dll
31.01.2019  17:12         3 142 656 sb_kernel.dll
01.02.2019  16:51                 9 SESS.D
01.02.2019  16:51               715 SPLC.D
31.01.2019  17:12            72 192 upwin.exe
              19 файлов      5 659 029 байт
               2 папок  37 567 008 768 байт свободно
 
C:\banks\sber\sb_pilot></code></pre><br/>
Действительно, «e»-файла нет. Камень в сторону Сбербанка #1. Пишем письмо в сбербанк (впоследствии получили ответ, что так и должно быть), а так как времени на переписку нет и надо запускаться вот прям уже, ищем обходные пути получения результата.<br/>
<br/>
<pre><code class="plaintext">04.02 12:28:55 SBKRNL: Failed to open device \\.\COM1, err 2
04.02 12:28:56 SBKRNL: Failed to open device \\.\COM1, err 2
04.02 12:28:56 SBKRNL: Result  = 0
04.02 12:28:56 GATE: unlock:'00000054'
04.02 12:28:56 GATE: lock:'00000054' 'UPOSWINMUTEX2'
04.02 12:28:56 GATE: unlock:'00000054'
04.02 12:28:56 LOADPARM: Unloading GATE.DLL...
04.02 12:28:56 GATE: SB_KERNEL.DLL is unloaded
04.02 12:28:56 LOADPARM: GATE.DLL unloaded</code></pre><br/>
Ага, результат можно получить из лога sbkernelГГММ.log. Неудобно, плюс нет хеша карты чтобы впоследствии прикрутить «Спасибо» от сбербанка. Не годится.<br/>
<br/>
Придется подключаться к библиотеке pilot_nt.dll и импортировать из нее функции. Все бы ничего, но… Камень в сторону Сбербанка #2: под Linux такой библиотеки нет, придется создавать два разных приложения под разные платформы — для linux вызывать утилиту sb_pilot (аналог loadparm.exe, кстати камень #3 за разное название утилиты под разными платформами), под windows подключаться к библиотеке pilot_nt.dll.<br/>
<br/>
<h2>ГЛАВА 5. Загадки в темноте</h2><br/>
На часах 19:00.<br/>
<br/>
Сбербанк — компания крупная, большинство программных решений производятся по ГОСТам и формальным документам. Залезаем в каталог, который поставляет Сбербанк вместе с библиотеками:<br/>
<br/>
<pre><code class="plaintext">Sberbank$ ls -l Docs
итого 30160
drwx------ 2 alex alex    4096 янв 17 19:31 FAQ
-rw-rw-r-- 1 alex alex 3398465 май  9  2018 Базовая настройка UPOS для автономного решения (АР).docx
-rw-rw-r-- 1 alex alex 1182078 май  9  2018 Базовая настройка UPOS для ИКР.docx
-rw-rw-r-- 1 alex alex  853504 май  9  2018 Версии и изменения.doc
drwx------ 3 alex alex    4096 янв 31 17:11 Для разработчиков ПО ККМ
-rw-rw-r-- 1 alex alex 5280787 май  9  2018 Загрузка ПО в POS-терминалы.docx
-rw-rw-r-- 1 alex alex 1149640 май  9  2018 Коды ошибок.docx
drwx------ 2 alex alex    4096 май 28  2018 Настройка UPOS
drwx------ 2 alex alex    4096 май 28  2018 Настройка кассовых программ
-rw-rw-r-- 1 alex alex 3451601 май  9  2018 Определение схемы автономного решения (АР).docx
-rw-rw-r-- 1 alex alex 1956196 май  9  2018 Определение схемы ИКР.docx
-rw-rw-r-- 1 alex alex 1043161 май  9  2018 Памятка по настройке функции ОПЛАТА авиабилетов (Аэрофлот)_(ИКР).docx
-rw-rw-r-- 1 alex alex 4348157 май  9  2018 Параметры POS-терминалов.docx
-rw-rw-r-- 1 alex alex 3970267 май  9  2018 Подключение отдельных функций.docx
drwx------ 3 alex alex    4096 май 28  2018 Руководства пользователя
-rw-rw-r-- 1 alex alex 2644702 май  9  2018 Руководство по настройке POS-терминалов.docx
drwx------ 2 alex alex    4096 май 28  2018 Сопроводительная документация
-rw-rw-r-- 1 alex alex 1558211 май  9  2018 Схема содержания документов.png</code></pre><br/>
Куча добра, однако нас интересует только каталог для разработчиков:<br/>
<br/>
<pre><code class="plaintext">Sberbank$ ls -l Docs/Для\ разработчиков\ ПО\ ККМ/
итого 8704
-rw-rw-r-- 1 alex alex   47105 май  9  2018 1C.docx
-rw-rw-r-- 1 alex alex    1824 май  9  2018 cardtype.h
-rw-rw-r-- 1 alex alex 2590378 май  9  2018 cr_ttk_protocol_ru.rtf
-rw-rw-r-- 1 alex alex     208 май  9  2018 deprtmnt.h
-rw-rw-r-- 1 alex alex   16681 май  9  2018 errors.h
drwx------ 6 alex alex    4096 май 28  2018 examples
-rw-rw-r-- 1 alex alex   58575 май  9  2018 gate.h
-rw-rw-r-- 1 alex alex    4218 май  9  2018 paramsln.h
-rw-rw-r-- 1 alex alex   61693 май  9  2018 pilot_nt.h
-rw-rw-r-- 1 alex alex   28160 май  9  2018 ReadTrack2.doc
-rw-rw-r-- 1 alex alex    7417 май  9  2018 sbkernel.h
-rw-rw-r-- 1 alex alex  144896 май  9  2018 sb_pilot.doc
-rw-rw-r-- 1 alex alex 3525323 май  9  2018 Интеграция с ККМ через ole-объект sbrf.dll.rtf
-rw-rw-r-- 1 alex alex   46683 май  9  2018 Интеграция с ККМ через библиотеку gate.dll.chi
-rw-rw-r-- 1 alex alex  255414 май  9  2018 Интеграция с ККМ через библиотеку gate.dll.chm
-rw-rw-r-- 1 alex alex  814653 май  9  2018 Интеграция с ККМ через библиотеку gate.dll.pdf
-rw-rw-r-- 1 alex alex   41618 май  9  2018 Интеграция с ККМ через библиотеку pilot_nt.chi
-rw-rw-r-- 1 alex alex  241716 май  9  2018 Интеграция с ККМ через библиотеку pilot_nt.chm
-rw-rw-r-- 1 alex alex  968753 май  9  2018 Интеграция с ККМ через библиотеку pilot_nt.pdf
-rw-rw-r-- 1 alex alex      81 май  9  2018 Подтипы пинпадов.txt</code></pre><br/>
Много макулатуры, на всякий случай еще раз перечитаем pilot_nt, из которой узнаем следующее:<br/>
<blockquote>Таблица 1. Поддерживаемые sb_pilot ОС.<br/>
<div class="scrollable-table"><table>
<tr>
<th>ОС</th>
<th>Разрядность</th>
<th>Имя модуля</th>
</tr>
<tr>
<td>Windows</td>
<td>32</td>
<td>sb_pilot.exe</td>
</tr>
<tr>
<td>Linux</td>
<td>32</td>
<td>sb_pilot</td>
</tr>
<tr>
<td>DOS</td>
<td>16</td>
<td>sb_pilot.exe</td>
</tr>
</table></div></blockquote><br/>
Оказывается утилита под windows должна все-таки называться sb_pilot. Что ж, камень в сторону Сбербанка #4 за несоответствие собственной документации.<br/>
<blockquote>Передача результатов работы программы.<br/>
<br/>
По окончании работы программы формируются два текстовых файла — файл обмена и файл чека.<br/>
<br/>
Первый имеет имя e и предназначен для передачи вызывающей программе параметров совершенной операции. Первая строка в этом файле содержит код результата операции, и через запятую – поясняющее текстовой сообщение. Код 0 означает успешное проведение платежа, любое другое значение – отказ или невозможность проведения платежа.</blockquote><br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/c8/7f/m2/c87fm26nwcdjtfol6m0vamuvk8e.jpeg" data-src="https://habrastorage.org/webt/c8/7f/m2/c87fm26nwcdjtfol6m0vamuvk8e.jpeg" data-blurred="true"/><br/>
<br/>
Лениво кидаем еще один камень и начинаем изучать документацию на подключение библиотеки напрямую.<br/>
<blockquote><b>Порядок вызова функций библиотеки</b><br/>
<br/>
При оплате (возврате) покупки по банковской карте кассовая программа должна вызвать из библиотеки Сбербанка функцию card_authorize(), заполнив поля TType и Amount и указав нулевые значения в остальных полях. По окончании работы функции необходимо проанализировать поле RCode. Если в нем содержится значение «0» или «00», авторизация считается успешно выполненной, в противном случае отклоненной. Кроме этого, необходимо проверить значение поля Check.<br/>
<br/>
Если оно не равно NULL, его необходимо отправить на печать (в нефискальном режиме) и затем<br/>
удалить вызовом функции GlobalFree(). При закрытии смены кассовая программа должна вызвать из библиотеки Сбербанка функцию close_day(), заполнив поле TType = 7 и указав нулевые значения в остальных полях. По окончании работы функции необходимо проверить значение поля Check.<br/>
<br/>
Если поле Check не равно NULL, его необходимо отправить на печать (в нефискальном режиме) и после этого удалить вызовом функции GlobaFree().</blockquote> Звучит несложно, даже хэдер файл предоставлен. Что ж, подключаем его, компилируем и…<br/>
<br/>
<pre><code class="cpp">$ cat main.c &amp;&amp; i686-w64-mingw32-gcc main.c -o main.a
#include "pilot_nt.h"
 
int main(void) {
    return 0;
}
 
 
In file included from main.c:1:0:
pilot_nt.h:525:3: error: unknown type name ‘auth_answer’
   auth_answer   ans;                     /**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer */
   ^
pilot_nt.h:544:3: error: unknown type name ‘auth_answer’
   auth_answer   ans;               /**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer */
   ^
pilot_nt.h:567:3: error: unknown type name ‘auth_answer’
   auth_answer   ans;               /**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer */
   ^
pilot_nt.h:590:3: error: unknown type name ‘auth_answer’
   auth_answer   ans;              /**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer */
   ^
pilot_nt.h:627:3: error: unknown type name ‘auth_answer’
   auth_answer   ans;              /**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer */
   ^
pilot_nt.h:668:3: error: unknown type name ‘auth_answer’
   auth_answer   ans;               /**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer */</code></pre><br/>
Эммм… Что? Открываем pilot_nt.h:<br/>
<br/>
<pre><code class="cpp">#ifdef __cplusplus
extern "C"{
#endif
&lt;...>
/**
 * Основные параметры операции
 * Структура, используемая для описания операции и получения результатов выполнения операции.
 */
struct auth_answer{
   int TType;             /**&lt; [in] тип транзакции. см ::OpetationTypes */
   unsigned long Amount;  /**&lt; [in] сумма в копейках                    */
   char RCode[3];         /**&lt; [out] код результата авторизации         */
   char AMessage[16];     /**&lt; [out] текст результата авторизации       */
   int  CType;            /**&lt; [in,out] тип карты                       */
   char* Check;           /**&lt; [out] образ чека, должен освобождаться GlobalFree в вызывающей программе */
};
&lt;...>
struct auth_answer7{
  auth_answer auth_answ;           /**&lt; [in, out]  Основные параметры операции. См. ::auth_answer */ &lt;---- THIS
  char   AuthCode[MAX_AUTHCODE];  /**&lt; [out] Код авторизации. 7 байт.                            */
  char   CardID [CARD_ID_LEN];     /**&lt; [out] Идентификатор карты. 25 байт.                       */
  int    SberOwnCard;              /**&lt; [out] Флаг принадлежности карты Сбербанку                 */
};</code></pre><br/>
Сразу, не глядя камень за комментарии на русском в кодировке CP1251.<br/>
<br/>
Ну и самый серьезный камень: дорогие разработчики на С++. Если вы пишете extern «C» — это означает, что код внутри блока должен компилироваться С-компилятором. Если вы НЕ сделали `typedef` структуры, то при каждом ее упоминании в качестве указания типа необходимо писать ключевое слово `struct`.<br/>
<br/>
Патчим файл для разработчиков, подставляя везде, где нужно слово `struct`. Линкуемся с библиотекой `pilot_nt.dll`. Победа, не? Запускаем наше приложение.<br/>
<br/>
<h2>ГЛАВА 6. Из огня да в полымя</h2><br/>
Ну вы поняли, да? Приложение просто падает. Сразу, до main. Медитируем, добавляем NIH-аналог функции errno для windows: GetLastError (камень #3 в сторону Microsoft, первые два за кодировки).<br/>
<br/>
<pre><code class="plaintext">C:\banks\sber\WIN>sb_pilot.exe 1 1000
E: !g_sblibrary (0xc0000096)</code></pre><br/>
0xc0000096? А разве GetLastError не должна возвращать адекватный код ошибки?<br/>
<blockquote>For a complete list of error codes provided by the operating system, see System Error Codes.</blockquote> Ага, открываем статью по <a href="https://docs.microsoft.com/ru-ru/windows/desktop/Debug/system-error-codes">ссылке</a>: <br/>
<blockquote>The following topics provide lists of system error codes. These values are defined in the WinError.h header file.<br/>
<br/>
<ul>
<li>System Error Codes (0-499) (0x0-0x1f3)</li>
<li>System Error Codes (500-999) (0x1f4-0x3e7)</li>
<li>System Error Codes (1000-1299) (0x3e8-0x513)</li>
<li>System Error Codes (1300-1699) (0x514-0x6a3)</li>
<li>System Error Codes (1700-3999) (0x6a4-0xf9f)</li>
<li>System Error Codes (4000-5999) (0xfa0-0x176f)</li>
<li>System Error Codes (6000-8199) (0x1770-0x2007)</li>
<li>System Error Codes (8200-8999) (0x2008-0x2327)</li>
<li>System Error Codes (9000-11999) (0x2328-0x2edf)</li>
<li>System Error Codes (12000-15999) (0x2ee0-0x3e7f)</li>
</ul></blockquote> Отлично, мы получили незадокументированную ошибку, кидаем камень и открываем всезнающий google:<br/>
<br/>
<ul>
<li><a href="http://forum.vingrad.ru/forum/topic-346194/kw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html">forum.vingrad.ru/forum/topic-346194/kw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html</a></li>
<li><a href="https://bbs.csdn.net/topics/80078275">bbs.csdn.net/topics/80078275</a></li>
<li><a href="http://forums.codeguru.com/showthread.php?179566-0xC0000096-Privileged-Instruction">forums.codeguru.com/showthread.php?179566-0xC0000096-Privileged-Instruction</a></li>
<li><a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/97763-privileged-instruction-error.html">www.unknowncheats.me/forum/general-programming-and-reversing/97763-privileged-instruction-error.html</a></li>
<li><a href="https://cboard.cprogramming.com/windows-programming/146130-prallel-port-programming.html">cboard.cprogramming.com/windows-programming/146130-prallel-port-programming.html</a></li>
<li><a href="http://computer-programming-forum.com/82-mfc/dc2481c0ecead2f2.htm">computer-programming-forum.com/82-mfc/dc2481c0ecead2f2.htm</a></li>
</ul><br/>
Суть ошибки сводится к тому, что какая-то подпрограмма использует одну из инструкций <br/>
<br/>
<ul>
<li>_inp()</li>
<li>_inpw()</li>
<li>_inpd()</li>
<li>_outp()</li>
<li>_outpw()</li>
<li>_outpd()</li>
</ul><br/>
Использование которых запрещено под NT-ядрами, так как они пытаются работать с параллельным портом напрямую. Судя по всему этот код вызывается в инициализаторе библиотеки, т.е. библиотека при старте хочет опросить порты на наличие устройств, но NT-ядро требует работы через драйвер.<br/>
<br/>
Безвыходная ситуация?<br/>
<br/>
<h2>ГЛАВА 8. Пауки и мухи</h2><br/>
22:00. На всякий случай возникает идея проверить, что это не из-за того, что мы используем кросскомпиляцию с Linux с помощью mingw. Параллельно понимаем, что Сбербанк поставляет только 32хбитное приложение, поэтому слинковаться с 64хбитным приложением не выйдет, ну ладно, но все равно запустим камень в сторону Сбербанка за 32-only версию в 2019м году.<br/>
<br/>
<b>Дано</b>: установленная в virtualbox windows 7;<br/>
<b>Необходимо</b>: установить Visual Studio и скопилировать MVP.<br/>
<br/>
Заходим на сайт Microsoft, качаем Visual Studio 2017. Берем лицензию сообщества, так как мы берем ее для проверки, для бизнеса лицензия будет куплена, если взлетит.<br/>
Скачиваем несколько сотен мегабайт и…<br/>
<br/>
Видим, что наша версия ОС (Windows 7) не поддерживается.<br/>
<br/>
Ок, идем на всякие непотребные сайты, ищем Visual Studio 2008, скачиваем несколько сотен мегабайт заново и…<br/>
<br/>
Получаем iso файл.<br/>
<br/>
Ладно, попытаемся установить Daemon Tools 10 (так как это та версия, которую предлагает сайт), чтобы вставить этот виртуальный диск.<br/>
<br/>
Запускаем скачанный бинарь. Осечка, требуется .NET Framework 4.5, скачиваем, ставим.<br/>
Запускаем скачанный бинарь, установка началась, загрузчик говорит что ему нужна 4.5.2, скачиваем, ставим.<br/>
Запускаем скачанный бинарь, установка началась, загрузчик говорит что никуда не поедет, пока мы не поставим обновление безопасности KB3033929, скачиваем, ставим.<br/>
<br/>
И получаем оплеуху от Microsoft в виде сообщения:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/r6/qe/de/r6qedenl5w3dez4ysscvod8rmjw.png"/><br/>
<br/>
Яростно кидаем очень острый камень в сторону Microsoft, качаем с торрентов старый Daemon Tools, успешно распаковываем Visual Studio, устанавливаем, наконец-таки (00:00) компилируем MVP, получаем такую же ошибку. Что ж, хорошая была версия, но не срослось.<br/>
<br/>
<h2>ГЛАВА 11. На пороге</h2><br/>
Пишем второму программисту, который в этот момент в срочном порядке допиливает сервер и процедуру регистрации. Он вспоминает, есть гит-<a href="https://github.com/vyacheslafka/sb_pilot_nt">репозиторий</a>, который на NT-подключает эту библиотеку и работает с ней.<br/>
<br/>
Подозрительно глядя на репозиторий скачиваем его, компилируем и запускаем. Работает.<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/mt/gl/q-/mtglq-c68eyegv74wjnzjvpmddi.png"/><br/>
<br/>
Еще более подозрительно смотрим на код. Код идентичен, разве что написан на C++ а не С.<br/>
Понимаем, что язык тут не причем. Смотрим библиотеки сбербанка, которые тянет за собой код.<br/>
Видим последний коммит.<br/>
<br/>
И вот тут нас поджидает очередной сюрприз.<br/>
<br/>
Оказывается, что версии библиотеки Сбербанка могут быть разными. Последний коммит увеличивает версию с 23 до 27й. Копируем себе на тестовый компьютер версию из гита — РАБОТАЕТ!<br/>
<br/>
Проверяем все архивы, которые присылал Сбербанк, сравниваем версии и строим табличку:<br/>
<div class="scrollable-table"><table>
<tr>
<th>Версия</th>
<th>Работает</th>
</tr>
<tr>
<td>26.0.15 — Основная</td>
<td>нет</td>
</tr>
<tr>
<td>27.4.12 — Из репозитория</td>
<td>да</td>
</tr>
<tr>
<td>23.0.13 — Из репозитория</td>
<td>да</td>
</tr>
<tr>
<td>29.0.9 — Самая свежая от СБ</td>
<td>да</td>
</tr>
<tr>
<td>23.0.13 — С патчем для системы «Криптера»</td>
<td>да</td>
</tr>
</table></div><br/>
Отлично, вот теперь заживем. На тех системах где стоит 26 обновим до 29 или 27 и все взлетит.<br/>
Кидаем камень #9 в сторону Сбербанка за то, что сломали поведение на NT системах.<br/>
<br/>
<h2>ГЛАВА 12. Что ждало их внутри</h2><br/>
Не хватает «е» файла? Не беда, берем патченные заголовочники, динамически линкуемся с библиотекой чтобы корректно вернуть ошибку, пишем код, который просто запишет код возврата из функции в файл «е», назовем бинарь sb_pilot.exe и…<br/>
<br/>
Работать-то оно работает.<br/>
<br/>
Вот только на версии для системы «Криптера» не создается «р» файл.<br/>
<br/>
<i>Грустно смотрим на капающую по костяшкам кровь и на вмятину в стене.</i><br/>
<br/>
Для начала, что такое система «Криптера». <br/>
<br/>
Cryptera — это датская компания, выпускающая шифрующее оборудование/оборудование безопасности/ключи и пр. Думаю, что вы все видели один из экземпляров их продукции:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/pb/dz/85/pbdz85atzxiscdkdkq0z97ahhsm.png"/><br/>
<br/>
Так вот Сбербанк использует их криптомодуль для пинпадов и выпускает специальную «патченную» библиотеку, в которой, как мы уже поняли, не создается файл «р». Пишем по этому поводу в Сбербанк и через несколько дней получим ответ, что «под оригинальной системой файл „р“ будет создаваться, а под патченной на Криптеру — нет». Выдадим им камень # 10 через несколько дней, ведь работать нужно уже сейчас.<br/>
<br/>
К счастью, или к несчастью, но функции, которые мы используем для проведения операций возвращают уже упомянутую структуру:<br/>
<br/>
<pre><code class="cpp">struct auth_answer{
   int TType;             /**&lt; [in] тип транзакции. см ::OpetationTypes */
   unsigned long Amount;  /**&lt; [in] сумма в копейках                    */
   char RCode[3];         /**&lt; [out] код результата авторизации         */
   char AMessage[16];     /**&lt; [out] текст результата авторизации       */
   int  CType;            /**&lt; [in,out] тип карты                       */
   char* Check;           /**&lt; [out] образ чека, должен освобождаться GlobalFree в вызывающей программе */
};</code></pre><br/>
О, отлично, чек уже есть, можем сами сохранить его в файл или сразу вывести в JSON…<br/>
<br/>
<pre><code class="cpp">printf("%s\n", answer.Check);</code></pre><br/>
И получаем падение приложение из-за обращения по невалидному указателю.<br/>
<br/>
<h2>ГЛАВА 14. Огонь и вода</h2><br/>
4:00. Выполняем Сету Бандха Сарвангасану чтобы успокоиться, и внимательно читаем мануал:<br/>
<blockquote>[out] образ чека, должен освобождаться GlobalFree в вызывающей программе</blockquote> Что это нам дает? Очень многое. Во-первых то, что раз указатель требует очистки с помощью GlobalFree то его саллоцировали с помощью <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winbase/nf-winbase-globalalloc">GlobalAlloc</a>. Следовательно она выдает не указатель на память, как было в 16битной версии, а номер объекта с семантически объявленым типом HGLOBAL, который можно скормить в функции GlobalSize чтобы получить размер выделенного блока и GlobalLock чтобы заблокировать кусок памяти, но получить оригинальный указатель. Кстати, камень #6 в сторону Microsoft за NIH malloc и free, которые есть в стандартной библиотеке.<br/>
<br/>
<pre><code class="cpp">printf("%s\n", GlobalLock(answer.Check));</code></pre><br/>
И все равно получаем падение. Окей, а что показывае GlobalSize? Ноль? Как-то странно. <br/>
<br/>
Проверяем другие функции, которые тоже должны отдавать слип — видим ту же картину.<br/>
<br/>
В голову приходит разве что самостоятельно сгенерировать слип по тем данным, которые может выдать самая крутая функция оплаты (да, у Сбербанка функции именуются card_authorize2..14, камень кидать за это не буду):<br/>
<br/>
<pre><code class="cpp">struct auth_answer14 {
  auth_answer   ans;               /**&lt; [in, out]  Основные параметры операции. См. ::auth_answer */
  char   AuthCode[MAX_AUTHCODE];  /**&lt; [out] Код авторизации. 7 байт.              */
  char   CardID[CARD_ID_LEN];      /**&lt; [out] Идентификатор карты. 25 байт. Для международных карт все символы, кроме первых 6 и последних 4, будут заменены символами ‘*’.*/
  int    ErrorCode;                /**&lt; [out] Код ошибки.                                         */
  char   TransDate[TRANSDATE_LEN]; /**&lt; [out] Дата и время операции                               */
  int    TransNumber;              /**&lt; [out] Номер операции за опер. день, см. номер на чеке     */
  int    SberOwnCard;              /**&lt; [out] Флаг принадлежности карты Сбербанку                 */
  char   Hash[CARD_HASH_LEN];      /**&lt; [in, out] хеш SHA1 от номера карты, в формате ASCII с нулевым байтом в конце. 40 байт.*/
  char   Track3[CARD_TRACK3_LEN];  /**&lt; [out] третья дорожка карты*/
  DWORD  RequestID;                /**&lt; [in,out] Уникальный номер операции. Только PCI DSS решения.*/
  DWORD  Department;              /**&lt; [in] Порядковый номер отдела от 0 до 14-ти, включительно.
                                            При установке номера отдела в 0xFFFFFFFF, номер отдела
                                            будет запрошен через интерфейс терминала после вставки карты.
                                            Если номер отдела будет указан вне настроенного диапазона,
                                            то терминал вернет код ошибки 4191. */
  char   RRN[MAX_REFNUM];          /**&lt; [in,out] Номер ссылки операции, присвоенный хостом. Используется
                                                для операций возврат, множественной авторизации и завершения расчета.
                                                Содержит уникальный 12-значный ссылочный номер.
                                                При предавторизации это поле является выходным
                                                (его заполняет библиотека pilot_nt.dll), а при
                                                завершении расчета – входным (значение должно
                                                быть заполнено вызывающей программой; оно должно
                                                совпадать со значением, возвращенным при предавторизации).*/
  DWORD  CurrencyCode;             /**&lt; [in] Международный код валюты (810, 643, 840, 978 и т.д.) */
  char   CardEntryMode;            /**&lt; [out] Способ чтения карты ('D'-магн.полоса, 'M'-ручной ввод, 'C'-чип, 'E'-бесконтакт EMV, 'R'-бесконтакт magstripe, 'F'-fallback)*/
  char   CardName[MAX_CARD_NAME_LEN]; /**&lt; [out] Название типа карты */
  char   AID[MAX_AID_ASCII_LEN];   /**&lt; [out] Application ID чиповой карты (уже в виде ASCIIZ-строки)*/
  char   FullErrorText[MAX_FULL_ERROR_TEXT]; /**&lt; [out] Полный текст сообщения об ошибке*/
  DWORD  GoodsPrice;                /**&lt; [in] Цена за единицу товара, коп (34.99->3499)*/
  DWORD  GoodsVolume;               /**&lt; [in] Количество товара, в тыс. долях (30.234->30234)*/
  char   GoodsCode[MAX_GOODS_CODE+1]; /**&lt; [in] Код товара во внешней системе.*/
  char   GoodsName[MAX_GOODS_NAME]; /**&lt; [in] Наименование товара во внешней системе. Внимание! В структуре auth_answer14 название товара на один символ короче чем в gate.dll TGoodsData. Зафиксируем эту ошибку как стандарт*/
};
 
 
/** @brief Выполнение операций по картам
 *  @param[in] track2 данные дорожки карты с магнитной полосой. Если NULL, то будет предложено считать карту.
 *  @param[in,out] auth_answer см. ::auth_answer14
 *  @param[in,out] payinfo Информация для платежной системы
 *  @return int Код ошибки.
 */
PILOT_NT_API int  card_authorize14(
  char *track2,
  struct auth_answer14 *auth_answer,
  struct payment_info_item *payinfo
);</code></pre><br/>
Пробуем подбирать поля… Выясняем, что от счастья нас отделяло всего одно — Фамилия и Имя носителя карты. Без них слип не считается <a href="http://www.consultant.ru/cons/cgi/online.cgi?req=doc&amp;base=LAW&amp;n=175637&amp;rnd=8BB65931EED9BDFCF1D781478730CD71#0990802485589001">законным</a>:<br/>
<blockquote>Реквизиты: идентификатор банкомата, электронного терминала или другого технического средства, предназначенного для совершения операций с использованием платежных карт; вид операции; дата совершения операции; сумма операции; валюта операции; сумма комиссионного вознаграждения код авторизации; реквизиты платежной карты.</blockquote> Жаль, но сформировать законный слип с теми данными, что у нас есть не получится.<br/>
<br/>
Покопаемся в документации еще раз.<br/>
<br/>
Находим пример, который Сбербанк поставляет в каталоге «examples»<br/>
<br/>
<pre><code class="cpp">std::cout &lt;&lt; "Authorization completion finished with code '" &lt;&lt; result &lt;&lt; "'" &lt;&lt; std::endl;
 
std::ofstream file(CHEQUE_FILENAME);
file &lt;&lt; argument.auth_answ.Check;
file.close();
 
if (argument.auth_answ.Check) {
  std::cout &lt;&lt; "Cheque saved to file " &lt;&lt; CHEQUE_FILENAME &lt;&lt; std::endl;
  //GlobaFree(argument.auth_answ.Check);
}</code></pre><br/>
Просто выводится текст, находящийся по указателю. Но ведь мы уже убедились, что так оно не работает… На всякий случай скомпилируем их пример и запустим. Вылет на строчке `file &lt;&lt; argument.auth_answ.Check;`, что ж, Сбербанк, держите камень #11 за неработающие примеры.<br/>
<br/>
7:00. Уже можно писать разработчикам другой обертки, которая несколько лет назад была написана на Delphi. Получаем ответ, что у них все работает. Ищем основу их обертки и находим на <a href="https://github.com/kutsoff/pilot_nt.sberbank">github</a>:<br/>
<br/>
<pre><code class="cpp">TAuthAnswer = packed record
  TType: integer;
  Amount: UINT; // IN Сумма операции в копейках
  Rcode: array [0 .. 2] of AnsiChar;
  AMessage: array [0 .. 15] of AnsiChar;
  CType: integer;
  Check: PAnsiChar;
end;
 
 
    Result := Func(nil, @FAuthAnswer);
    FLastError := Result;
    FCheque := PAnsiChar(FAuthAnswer.Check);</code></pre><br/>
Простое преобразование типа в указатель без каких-либо вызовов функций.<br/>
<br/>
Начинаем подозревать злых духов.<br/>
<br/>
<h2>ГЛАВА 17. Гроза разразилась</h2><br/>
Люди начинают возвращаться в офис, сочувственно кивая головой. PO выглядит не очень веселым узнав последние новости. <br/>
<br/>
Тут вспоминается одна деталь. Когда мы выводили поля структуры #14 чтобы увидеть их значения то один байт каждой строки был отрезан. С одной стороны это, с другой <br/>
<blockquote>Внимание! В структуре auth_answer14 название товара на один символ короче чем в gate.dll TGoodsData. Зафиксируем эту ошибку как стандарт</blockquote> Может это все же связано с…<br/>
<br/>
Страшная догадка осеняет мозг словно молния. Объявим структуру как <br/>
<br/>
<pre><code class="cpp">typedef struct __attribute__((packed)) {
   int TType;             /**&lt; [in] тип транзакции. см ::OpetationTypes */
   unsigned long Amount;  /**&lt; [in] сумма в копейках                    */
   char RCode[3];         /**&lt; [out] код результата авторизации         */
   char AMessage[16];     /**&lt; [out] текст результата авторизации       */
   int  CType;            /**&lt; [in,out] тип карты                       */
   char* Check;           /**&lt; [out] образ чека, должен освобождаться GlobalFree в вызывающей программе */
};</code></pre><br/>
И…<br/>
<br/>
Ничего не меняется.<br/>
<br/>
Все так же Size = 0, Все так же Lock = NULL.<br/>
<br/>
Боль.<br/>
<br/>
Тлен.<br/>
<br/>
Невольно ищешь глазами удобную балку на потолке, такую, чтобы выдержала вес. После стольких нон-стоп часов кодинга и изучения документации перед глазами плывут стройные ряды байт. А что если вывести байты, которые вообще возвращаются?<br/>
<br/>
<pre><code class="cpp">    u32 i;
    for (i = 0; i &lt; sizeof(answ); i++) {
        printf("%02x ", *((u8 *)&amp;answ + i));
    }
    printf("\n");
 
 
C:\banks\sber\sb_pilot>sb_pilot.exe 1 1000
01 00 00 00 e8 03 00 00 30 00 00 ce e4 ee e1 f0 e5 ed ee 00 00 00 00 00 00 00 00 02 00 00 00 f8 6c 7a 00 00</code></pre><br/>
`30 00 00 ce` — а это значит, что Сбербанк все же использует Packed структуры. Вот только в хэдерах об этом нет ни слова. Поэтому не работают примеры, поэтому не получается получить указатель на текст в конце — ведь он битый из-за сдвига на 1 байт. Огромный и колючий камень в сторону Сбербанка!<br/>
<br/>
И тут в глаза бросился один мааааленький нюанс. 4 + 4 + 3 + 16 + 4 + 4 = 35. А тут 36 байт, Обеликс.<br/>
<br/>
Раз тут 36 байт, значит компилятор все еще выравнивает структуру. Значит между RCode и AMessage все еще вставлен дополнительный байт. Но почему? Ведь мы указали `__packed__`!<br/>
<br/>
<h2>ГЛАВА 18. Обратный путь</h2><br/>
Причины того, что выравнивание все еще включено появились в 2012м году: <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=52991">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=52991</a>. Починен баг только в GCC 8 (камень за 6 лет забагованности!), обновиться на который пока нет возможности. К счастью существует workaround:<br/>
<br/>
<pre><code class="cpp">-mno-ms-bitfields</code></pre><br/>
Не будем сейчас разбирать механизм работы этого флага, просто передадим его компилятору:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/ve/tr/d4/vetrd4m4rsdhmkyxkgrvxbkepko.png"/><br/>
<br/>
Слип! Родненький! Я по тебе скучал, даже не буду ругаться из-за кракозябр, камень за это я уже кидал.<br/>
<br/>
И скормим, наконец, Майкрософт камень, за то, что GlobalSize/Lock выдают нули на невалидные указатели.<br/>
<br/>
<h2>ГЛАВА 19. Последняя глава</h2><br/>
Чтобы максимально снизить количество ifdef'ов для прослойки для sb_pilot мы написали отдельное приложение, которое полностью имитирует linux-версию sb_pilot. Таким образом оставив код прослойки #1 прежним, оставив лишь одно условие:<br/>
<br/>
<pre><code class="cpp">#if defined(BXI_OS_GLX)
#define GFJ_PILOT_EXECUTABLE "./sb_pilot"
#elif defined(BXI_OS_WIN)
#define GFJ_PILOT_EXECUTABLE "./sb_pilot.exe"
#endif</code></pre><br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/wo/eu/2g/woeu2gk8m1mvtibiepfxwiijrbo.png"/><br/>
<br/>
Итоги сражения:<br/>
<br/>
<ul>
<li>Сбербанк: 12 камней</li>
<li>Майкрософт: 7 камней</li>
<li>GCC: 1 камень</li>
</ul><br/>
Ачивка-воспоминание на нашу командную доску:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/ko/im/3y/koim3ykfftmlltegcqh_rkdkgxc.jpeg" data-src="https://habrastorage.org/webt/ko/im/3y/koim3ykfftmlltegcqh_rkdkgxc.jpeg" data-blurred="true"/></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%81%D0%B1%D0%B5%D1%80%D0%B1%D0%B0%D0%BD%D0%BA%5D" class="tm-tags-list__link">сбербанк</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0%20%D0%BF%D0%BE%D0%B4%20windows%5D" class="tm-tags-list__link">разработка под windows</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%B0%D0%BB%D1%8B%20%D0%BE%D0%BF%D0%BB%D0%B0%D1%82%D1%8B%5D" class="tm-tags-list__link">терминалы оплаты</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BA%D0%B0%D1%81%D1%81%D1%8B%5D" class="tm-tags-list__link">кассы</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/system_programming/" class="tm-hubs-list__link">
    Системное программирование
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/debug/" class="tm-hubs-list__link">
    Отладка
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 102: ↑96 и ↓6</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 102: ↑96 и ↓6" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+90</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">50K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    89
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/staticmain/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/d97/784/45d/d9778445d6ba07ab20d3aceb2613bd1f.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 195 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    1
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">2.3</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/staticmain/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @staticmain
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Программист</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/451188/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 108 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/451188/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/451188/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"451188":{"id":"451188","timePublished":"2019-05-10T07:47:51+00:00","isCorporative":false,"lang":"ru","titleHtml":"Сбербанк или туда и обратно","leadData":{"textHtml":"\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fsi\u002Fbq\u002F2u\u002Fsibq2unjy0i1yoy_7sa0qljphae.jpeg\"\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Ch2\u003EГЛАВА 1. Нежданные гости\u003C\u002Fh2\u003E\u003Cbr\u003E\r\nВсе началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект должен быть готов через 4 дня. Нет, наш PO не зверь, и ничуть не похож на \u003Ca href=\"https:\u002F\u002Ftwitter.com\u002Ftoonsxander\u002Fstatus\u002F1069105064529268737\"\u003Eсову\u003C\u002Fa\u003E (разве что чуть-чуть на ворона), просто так сложилось. Ну раз надо, так надо, тем более что команде (а я являюсь ведущим разработчиком команды «С») было обещано что-то вкусное. На часах и календаре был четверг, 11:00, к понедельнику проект должен быть готов.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nДля начала, чем мы вообще занимаемся. Мы занимаемся автоматизацией кинотеатров — автоматическим и дистанционным управлением оборудования, автоматизацией кинопоказа, мониторингом, видеопанелями, а теперь еще и терминалами продажи билетов и бара. Конкретно последнему пункту и посвящена данная статья.\u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше →","image":null},"editorVersion":"1.0","postType":"article","postLabels":[{"type":"sandbox","data":null}],"author":{"scoreStats":{"score":1,"votesCount":195},"rating":2.3,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1729477","alias":"staticmain","fullname":null,"avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Fd97\u002F784\u002F45d\u002Fd9778445d6ba07ab20d3aceb2613bd1f.jpg","speciality":"Программист"},"statistics":{"commentsCount":108,"favoritesCount":89,"readingCount":49979,"score":90,"votesCount":102},"hubs":[{"relatedData":null,"id":"5767","alias":"system_programming","type":"collective","title":"Системное программирование","titleHtml":"Системное программирование","isProfiled":true},{"relatedData":null,"id":"17716","alias":"debug","type":"collective","title":"Отладка","titleHtml":"Отладка","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fsi\u002Fbq\u002F2u\u002Fsibq2unjy0i1yoy_7sa0qljphae.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fsi\u002Fbq\u002F2u\u002Fsibq2unjy0i1yoy_7sa0qljphae.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 1. Нежданные гости\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nВсе началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект должен быть готов через 4 дня. Нет, наш PO не зверь, и ничуть не похож на \u003Ca href=\"https:\u002F\u002Ftwitter.com\u002Ftoonsxander\u002Fstatus\u002F1069105064529268737\"\u003Eсову\u003C\u002Fa\u003E (разве что чуть-чуть на ворона), просто так сложилось. Ну раз надо, так надо, тем более что команде (а я являюсь ведущим разработчиком команды «С») было обещано что-то вкусное. На часах и календаре был четверг, 11:00, к понедельнику проект должен быть готов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДля начала, чем мы вообще занимаемся. Мы занимаемся автоматизацией кинотеатров — автоматическим и дистанционным управлением оборудования, автоматизацией кинопоказа, мониторингом, видеопанелями, а теперь еще и терминалами продажи билетов и бара. Конкретно последнему пункту и посвящена данная статья.\u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nСам проект, который нужно было завершить до понедельника представляет из себя некую прослойку между основным сервером на Scala и железным терминалом оплаты VeriFone VX 820 (на самом деле терминалов больше, но для примера возьмем только его). Понятно, что просто так проводить через него транзакции нам никто не даст, поэтому используются утилиты и библиотеки Сбербанка\u002FArcus и UCS. Таким образом схема работы в итоге должна быть следующей:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fak\u002Fk4\u002Fdo\u002Fakk4do9scie61w_tobeuwpk6liu.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВнешне он выглядит вот так:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Foh\u002Ful\u002Fts\u002Fohultstzocyw8za06mbxqwmnrma.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Foh\u002Ful\u002Fts\u002Fohultstzocyw8za06mbxqwmnrma.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакже данная подсистема должна использоваться на стандартных кассовых машинах которые все видели в любом кинотеатре у кассиров.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСогласно внутренней традиции каждый проект нашей команды мы называем именем из древнескандинавской мифологии, для данной подсистемы было выбрано имя Gefjon — Имя богини плодородия и изобилия (неплохое название для сервера оплаты, разве нет? Ну и легенда о быках отрезающих остров идеально ложится на текущую архитектуру, отрезая работу с оборудованием от высокоуровневого языка).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nФормат входящих и выходящих сообщений — HTTP сервер с JSON нагрузкой. Это оптимальный компромисс между Scala, которой сложно опуститься до вычленения бинарных данных из socket-потоков и C, которому трудно подняться до передачи объектов через сеть. Возможных операций, которыми необходимо оперировать не так много: оплата, отмена, возврат, разные типы отчетов, открытие сервисного меню и ping. С виду ничего сложного. Так как банковских систем целых три (а в последствии ожидается пополнение семейства), то было решено разделить проект на компоненты:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Frk\u002Fvm\u002Fsc\u002Frkvmscw9ret9atfnts-nezxtaqg.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЗеленым покрашены блоки, которые нам нужно было сделать, синим — те, которые нельзя поменять и которые предоставляет банк.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТак как основные проблемы возникли только с ПО от Сбербанка, то статья в целом будет посвящена подводным камням, которые мы пересчитали своей ладьей.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 2. Баранье жаркое\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fzr\u002F-d\u002Fez\u002Fzr-dez83p56hekuceyiiqka2rdi.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fzr\u002F-d\u002Fez\u002Fzr-dez83p56hekuceyiiqka2rdi.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n(фото: heaclub.ru)\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n… выглядит примерно так. Примерно так же выглядел код того прототипа, который был написан несколько месяцев назад для того, чтобы дать понять всем вышестоящим людям, что мы можем работать с банковскими приложениями.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E        char buf[BUF_KB * 2];\n        char * null;\n        char * grep;\n \n#ifdef _WIN32_WINNT\n        char * ptr;\n        null = \"nul\";\n        grep = \"findstr\";\n#else\n        null = \"\u002Fdev\u002Fnull\";\n        grep = \"grep\";\n#endif\n        sprintf(buf, \"%s %\"PRIi32\"= %sops.ini \u003E%s 2\u003E%s || \"\n                     \"echo %\"PRIi32\"=9,6,PINPAD_TEST \u003E\u003E %sops.ini\",\n               grep,\n               TERM_ARCUS_TEST_PINPAD,\n               TERM_PATH,\n               null,\n               null,\n               TERM_ARCUS_TEST_PINPAD,\n               TERM_PATH);\n \n#ifdef _WIN32_WINNT\n        ptr = buf;\n        while (*ptr)\n        {\n            if (*ptr == '\u002F')\n                *ptr = '\\\\';\n            ptr++;\n        }\n#endif\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nПонятное дело, что для Production варианта это не годилось, поэтому нужно было по сути написать все заново.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКаждый банк, который предоставляет библиотеки для работы с терминалом обычно предоставляет два варианта подключения: через функции библиотеки (.so\u002F.dll) или посредством готовой утилиты, которой всего-то нужно передать два значения — тип операции и сумму (когда нужно). В теории ничего сложного, всего-то\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Echar buffer[100];\nsprintf(buffer, \"%d %d\", atoi(argv[1]), atoi(argv[2]));\nsystem(buffer);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nРезультат операции при этом будет помещен в файл «e», а слип-чек — в файл «p». Просто отправим эти файлы на stdout с преобразованием в JSON, чтобы HTTP-сервер просто отправил их наверх как payload без размышлений о том, что там.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНо эта статья не вышла бы, если бы все было так просто.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 4. Через гору и под горой\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПервоначальный вариант реализации представлял из себя простой вызов приложения — HTTP-сервер вызывал нужную обертку с унифицированными параметрами (например X-отчет это 4), а утилита например gfj_pilot запускала sb_pilot с параметром, который требовался для это операции (например X-отчет это 9). Затем утилита-обертка читала из е-файла результат операции (например 2000 — «отказ оплаты, повторите операцию») и преобразовывала в универсальную ошибку (например 3 — «Ошибка чтения или процессинга карты\u002Fсчета, повторите операцию»). После этого файл «p» преобразовывался в base64 для избежания ломания форматирования и отсылался вместе с результатом в stdout в виде JSON.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВсе это прекрасно работало, пока в один прекрасный момент нам не сообщили, что…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n… это не работает под Windows.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fyp\u002F44\u002Ft_\u002Fyp44t_qwokissyt75mayl71mcdm.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fyp\u002F44\u002Ft_\u002Fyp44t_qwokissyt75mayl71mcdm.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНу точнее у самого Windows проблем нет (кроме того, что слип генерируется в кодировке Cp-1251, а консоль работает в CP866). Просто не генерировался «е» файл. Запустили банковскую утилиту напрямую:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EC:\\banks\\sber\\sb_pilot\u003Edir\n Том в устройстве C не имеет метки.\n Серийный номер тома: B401-6B9D\n \n Содержимое папки C:\\banks\\sber\\sb_pilot\n \n04.02.2019  12:28    &lt;DIR\u003E          .\n04.02.2019  12:28    &lt;DIR\u003E          ..\n31.01.2019  17:12            10 832 F12X24.BIN\n31.01.2019  17:12           128 000 gate.dll\n31.01.2019  17:12            72 192 loadparm.exe\n31.01.2019  17:12            36 204 OPT0.R\n31.01.2019  17:12            20 716 OPT1.R\n31.01.2019  17:12             1 806 OPT3.R\n31.01.2019  17:12           388 608 pilot_nt.dll\n31.01.2019  23:06               463 pinpad.ini\n31.01.2019  17:12            91 136 posScheduler.exe\n31.01.2019  17:12               418 printers.ini\n01.02.2019  16:51            91 646 sbkernel1902.log\n31.01.2019  17:12           653 312 sbrf.dll\n31.01.2019  17:12           840 192 SBRFCOM.dll\n31.01.2019  17:12         3 142 656 sb_kernel.dll\n01.02.2019  16:51                 9 SESS.D\n01.02.2019  16:51               715 SPLC.D\n31.01.2019  17:12            72 192 upwin.exe\n              20 файлов      5 659 718 байт\n               2 папок  37 567 004 672 байт свободно\n \n# Отправляем команду оплаты (1) на 10 рублей (1000 копеек)\nC:\\banks\\sber\\sb_pilot\u003Eloadparm.exe 1 1000\n \nC:\\banks\\sber\\sb_pilot\u003Edir\n Том в устройстве C не имеет метки.\n Серийный номер тома: B401-6B9D\n \n Содержимое папки C:\\banks\\sber\\sb_pilot\n \n04.02.2019  12:28    &lt;DIR\u003E          .\n04.02.2019  12:28    &lt;DIR\u003E          ..\n04.02.2019  12:28               216 commerr.log\n31.01.2019  17:12            10 832 F12X24.BIN\n31.01.2019  17:12           128 000 gate.dll\n31.01.2019  17:12            72 192 loadparm.exe\n31.01.2019  17:12            36 204 OPT0.R\n31.01.2019  17:12            20 716 OPT1.R\n31.01.2019  17:12             1 806 OPT3.R\n01.02.2019  18:51             1 349 p\n31.01.2019  17:12           388 608 pilot_nt.dll\n31.01.2019  23:06               463 pinpad.ini\n31.01.2019  17:12            91 136 posScheduler.exe\n31.01.2019  17:12               418 printers.ini\n04.02.2019  12:28            92 218 sbkernel1902.log\n31.01.2019  17:12           653 312 sbrf.dll\n31.01.2019  17:12           840 192 SBRFCOM.dll\n31.01.2019  17:12         3 142 656 sb_kernel.dll\n01.02.2019  16:51                 9 SESS.D\n01.02.2019  16:51               715 SPLC.D\n31.01.2019  17:12            72 192 upwin.exe\n              19 файлов      5 659 029 байт\n               2 папок  37 567 008 768 байт свободно\n \nC:\\banks\\sber\\sb_pilot\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nДействительно, «e»-файла нет. Камень в сторону Сбербанка #1. Пишем письмо в сбербанк (впоследствии получили ответ, что так и должно быть), а так как времени на переписку нет и надо запускаться вот прям уже, ищем обходные пути получения результата.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E04.02 12:28:55 SBKRNL: Failed to open device \\\\.\\COM1, err 2\n04.02 12:28:56 SBKRNL: Failed to open device \\\\.\\COM1, err 2\n04.02 12:28:56 SBKRNL: Result  = 0\n04.02 12:28:56 GATE: unlock:'00000054'\n04.02 12:28:56 GATE: lock:'00000054' 'UPOSWINMUTEX2'\n04.02 12:28:56 GATE: unlock:'00000054'\n04.02 12:28:56 LOADPARM: Unloading GATE.DLL...\n04.02 12:28:56 GATE: SB_KERNEL.DLL is unloaded\n04.02 12:28:56 LOADPARM: GATE.DLL unloaded\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nАга, результат можно получить из лога sbkernelГГММ.log. Неудобно, плюс нет хеша карты чтобы впоследствии прикрутить «Спасибо» от сбербанка. Не годится.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПридется подключаться к библиотеке pilot_nt.dll и импортировать из нее функции. Все бы ничего, но… Камень в сторону Сбербанка #2: под Linux такой библиотеки нет, придется создавать два разных приложения под разные платформы — для linux вызывать утилиту sb_pilot (аналог loadparm.exe, кстати камень #3 за разное название утилиты под разными платформами), под windows подключаться к библиотеке pilot_nt.dll.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 5. Загадки в темноте\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nНа часах 19:00.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСбербанк — компания крупная, большинство программных решений производятся по ГОСТам и формальным документам. Залезаем в каталог, который поставляет Сбербанк вместе с библиотеками:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ESberbank$ ls -l Docs\nитого 30160\ndrwx------ 2 alex alex    4096 янв 17 19:31 FAQ\n-rw-rw-r-- 1 alex alex 3398465 май  9  2018 Базовая настройка UPOS для автономного решения (АР).docx\n-rw-rw-r-- 1 alex alex 1182078 май  9  2018 Базовая настройка UPOS для ИКР.docx\n-rw-rw-r-- 1 alex alex  853504 май  9  2018 Версии и изменения.doc\ndrwx------ 3 alex alex    4096 янв 31 17:11 Для разработчиков ПО ККМ\n-rw-rw-r-- 1 alex alex 5280787 май  9  2018 Загрузка ПО в POS-терминалы.docx\n-rw-rw-r-- 1 alex alex 1149640 май  9  2018 Коды ошибок.docx\ndrwx------ 2 alex alex    4096 май 28  2018 Настройка UPOS\ndrwx------ 2 alex alex    4096 май 28  2018 Настройка кассовых программ\n-rw-rw-r-- 1 alex alex 3451601 май  9  2018 Определение схемы автономного решения (АР).docx\n-rw-rw-r-- 1 alex alex 1956196 май  9  2018 Определение схемы ИКР.docx\n-rw-rw-r-- 1 alex alex 1043161 май  9  2018 Памятка по настройке функции ОПЛАТА авиабилетов (Аэрофлот)_(ИКР).docx\n-rw-rw-r-- 1 alex alex 4348157 май  9  2018 Параметры POS-терминалов.docx\n-rw-rw-r-- 1 alex alex 3970267 май  9  2018 Подключение отдельных функций.docx\ndrwx------ 3 alex alex    4096 май 28  2018 Руководства пользователя\n-rw-rw-r-- 1 alex alex 2644702 май  9  2018 Руководство по настройке POS-терминалов.docx\ndrwx------ 2 alex alex    4096 май 28  2018 Сопроводительная документация\n-rw-rw-r-- 1 alex alex 1558211 май  9  2018 Схема содержания документов.png\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКуча добра, однако нас интересует только каталог для разработчиков:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ESberbank$ ls -l Docs\u002FДля\\ разработчиков\\ ПО\\ ККМ\u002F\nитого 8704\n-rw-rw-r-- 1 alex alex   47105 май  9  2018 1C.docx\n-rw-rw-r-- 1 alex alex    1824 май  9  2018 cardtype.h\n-rw-rw-r-- 1 alex alex 2590378 май  9  2018 cr_ttk_protocol_ru.rtf\n-rw-rw-r-- 1 alex alex     208 май  9  2018 deprtmnt.h\n-rw-rw-r-- 1 alex alex   16681 май  9  2018 errors.h\ndrwx------ 6 alex alex    4096 май 28  2018 examples\n-rw-rw-r-- 1 alex alex   58575 май  9  2018 gate.h\n-rw-rw-r-- 1 alex alex    4218 май  9  2018 paramsln.h\n-rw-rw-r-- 1 alex alex   61693 май  9  2018 pilot_nt.h\n-rw-rw-r-- 1 alex alex   28160 май  9  2018 ReadTrack2.doc\n-rw-rw-r-- 1 alex alex    7417 май  9  2018 sbkernel.h\n-rw-rw-r-- 1 alex alex  144896 май  9  2018 sb_pilot.doc\n-rw-rw-r-- 1 alex alex 3525323 май  9  2018 Интеграция с ККМ через ole-объект sbrf.dll.rtf\n-rw-rw-r-- 1 alex alex   46683 май  9  2018 Интеграция с ККМ через библиотеку gate.dll.chi\n-rw-rw-r-- 1 alex alex  255414 май  9  2018 Интеграция с ККМ через библиотеку gate.dll.chm\n-rw-rw-r-- 1 alex alex  814653 май  9  2018 Интеграция с ККМ через библиотеку gate.dll.pdf\n-rw-rw-r-- 1 alex alex   41618 май  9  2018 Интеграция с ККМ через библиотеку pilot_nt.chi\n-rw-rw-r-- 1 alex alex  241716 май  9  2018 Интеграция с ККМ через библиотеку pilot_nt.chm\n-rw-rw-r-- 1 alex alex  968753 май  9  2018 Интеграция с ККМ через библиотеку pilot_nt.pdf\n-rw-rw-r-- 1 alex alex      81 май  9  2018 Подтипы пинпадов.txt\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nМного макулатуры, на всякий случай еще раз перечитаем pilot_nt, из которой узнаем следующее:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EТаблица 1. Поддерживаемые sb_pilot ОС.\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"scrollable-table\"\u003E\u003Ctable\u003E\r\n\u003Ctr\u003E\r\n\u003Cth\u003EОС\u003C\u002Fth\u003E\r\n\u003Cth\u003EРазрядность\u003C\u002Fth\u003E\r\n\u003Cth\u003EИмя модуля\u003C\u002Fth\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003EWindows\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E32\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Esb_pilot.exe\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003ELinux\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E32\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Esb_pilot\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003EDOS\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E16\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Esb_pilot.exe\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003C\u002Ftable\u003E\u003C\u002Fdiv\u003E\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\nОказывается утилита под windows должна все-таки называться sb_pilot. Что ж, камень в сторону Сбербанка #4 за несоответствие собственной документации.\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EПередача результатов работы программы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПо окончании работы программы формируются два текстовых файла — файл обмена и файл чека.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПервый имеет имя e и предназначен для передачи вызывающей программе параметров совершенной операции. Первая строка в этом файле содержит код результата операции, и через запятую – поясняющее текстовой сообщение. Код 0 означает успешное проведение платежа, любое другое значение – отказ или невозможность проведения платежа.\u003C\u002Fblockquote\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fc8\u002F7f\u002Fm2\u002Fc87fm26nwcdjtfol6m0vamuvk8e.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fc8\u002F7f\u002Fm2\u002Fc87fm26nwcdjtfol6m0vamuvk8e.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЛениво кидаем еще один камень и начинаем изучать документацию на подключение библиотеки напрямую.\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E\u003Cb\u003EПорядок вызова функций библиотеки\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри оплате (возврате) покупки по банковской карте кассовая программа должна вызвать из библиотеки Сбербанка функцию card_authorize(), заполнив поля TType и Amount и указав нулевые значения в остальных полях. По окончании работы функции необходимо проанализировать поле RCode. Если в нем содержится значение «0» или «00», авторизация считается успешно выполненной, в противном случае отклоненной. Кроме этого, необходимо проверить значение поля Check.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЕсли оно не равно NULL, его необходимо отправить на печать (в нефискальном режиме) и затем\u003Cbr\u002F\u003E\r\nудалить вызовом функции GlobalFree(). При закрытии смены кассовая программа должна вызвать из библиотеки Сбербанка функцию close_day(), заполнив поле TType = 7 и указав нулевые значения в остальных полях. По окончании работы функции необходимо проверить значение поля Check.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЕсли поле Check не равно NULL, его необходимо отправить на печать (в нефискальном режиме) и после этого удалить вызовом функции GlobaFree().\u003C\u002Fblockquote\u003E Звучит несложно, даже хэдер файл предоставлен. Что ж, подключаем его, компилируем и…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E$ cat main.c &amp;&amp; i686-w64-mingw32-gcc main.c -o main.a\n#include \"pilot_nt.h\"\n \nint main(void) {\n    return 0;\n}\n \n \nIn file included from main.c:1:0:\npilot_nt.h:525:3: error: unknown type name ‘auth_answer’\n   auth_answer   ans;                     \u002F**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer *\u002F\n   ^\npilot_nt.h:544:3: error: unknown type name ‘auth_answer’\n   auth_answer   ans;               \u002F**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer *\u002F\n   ^\npilot_nt.h:567:3: error: unknown type name ‘auth_answer’\n   auth_answer   ans;               \u002F**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer *\u002F\n   ^\npilot_nt.h:590:3: error: unknown type name ‘auth_answer’\n   auth_answer   ans;              \u002F**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer *\u002F\n   ^\npilot_nt.h:627:3: error: unknown type name ‘auth_answer’\n   auth_answer   ans;              \u002F**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer *\u002F\n   ^\npilot_nt.h:668:3: error: unknown type name ‘auth_answer’\n   auth_answer   ans;               \u002F**&lt; [in, out]  �������� ��������� ��������. ��. ::auth_answer *\u002F\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nЭммм… Что? Открываем pilot_nt.h:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E#ifdef __cplusplus\nextern \"C\"{\n#endif\n&lt;...\u003E\n\u002F**\n * Основные параметры операции\n * Структура, используемая для описания операции и получения результатов выполнения операции.\n *\u002F\nstruct auth_answer{\n   int TType;             \u002F**&lt; [in] тип транзакции. см ::OpetationTypes *\u002F\n   unsigned long Amount;  \u002F**&lt; [in] сумма в копейках                    *\u002F\n   char RCode[3];         \u002F**&lt; [out] код результата авторизации         *\u002F\n   char AMessage[16];     \u002F**&lt; [out] текст результата авторизации       *\u002F\n   int  CType;            \u002F**&lt; [in,out] тип карты                       *\u002F\n   char* Check;           \u002F**&lt; [out] образ чека, должен освобождаться GlobalFree в вызывающей программе *\u002F\n};\n&lt;...\u003E\nstruct auth_answer7{\n  auth_answer auth_answ;           \u002F**&lt; [in, out]  Основные параметры операции. См. ::auth_answer *\u002F &lt;---- THIS\n  char   AuthCode[MAX_AUTHCODE];  \u002F**&lt; [out] Код авторизации. 7 байт.                            *\u002F\n  char   CardID [CARD_ID_LEN];     \u002F**&lt; [out] Идентификатор карты. 25 байт.                       *\u002F\n  int    SberOwnCard;              \u002F**&lt; [out] Флаг принадлежности карты Сбербанку                 *\u002F\n};\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nСразу, не глядя камень за комментарии на русском в кодировке CP1251.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНу и самый серьезный камень: дорогие разработчики на С++. Если вы пишете extern «C» — это означает, что код внутри блока должен компилироваться С-компилятором. Если вы НЕ сделали `typedef` структуры, то при каждом ее упоминании в качестве указания типа необходимо писать ключевое слово `struct`.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПатчим файл для разработчиков, подставляя везде, где нужно слово `struct`. Линкуемся с библиотекой `pilot_nt.dll`. Победа, не? Запускаем наше приложение.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 6. Из огня да в полымя\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nНу вы поняли, да? Приложение просто падает. Сразу, до main. Медитируем, добавляем NIH-аналог функции errno для windows: GetLastError (камень #3 в сторону Microsoft, первые два за кодировки).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EC:\\banks\\sber\\WIN\u003Esb_pilot.exe 1 1000\nE: !g_sblibrary (0xc0000096)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n0xc0000096? А разве GetLastError не должна возвращать адекватный код ошибки?\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EFor a complete list of error codes provided by the operating system, see System Error Codes.\u003C\u002Fblockquote\u003E Ага, открываем статью по \u003Ca href=\"https:\u002F\u002Fdocs.microsoft.com\u002Fru-ru\u002Fwindows\u002Fdesktop\u002FDebug\u002Fsystem-error-codes\"\u003Eссылке\u003C\u002Fa\u003E: \u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EThe following topics provide lists of system error codes. These values are defined in the WinError.h header file.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003ESystem Error Codes (0-499) (0x0-0x1f3)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (500-999) (0x1f4-0x3e7)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (1000-1299) (0x3e8-0x513)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (1300-1699) (0x514-0x6a3)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (1700-3999) (0x6a4-0xf9f)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (4000-5999) (0xfa0-0x176f)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (6000-8199) (0x1770-0x2007)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (8200-8999) (0x2008-0x2327)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (9000-11999) (0x2328-0x2edf)\u003C\u002Fli\u003E\r\n\u003Cli\u003ESystem Error Codes (12000-15999) (0x2ee0-0x3e7f)\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003C\u002Fblockquote\u003E Отлично, мы получили незадокументированную ошибку, кидаем камень и открываем всезнающий google:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Ca href=\"http:\u002F\u002Fforum.vingrad.ru\u002Fforum\u002Ftopic-346194\u002Fkw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html\"\u003Eforum.vingrad.ru\u002Fforum\u002Ftopic-346194\u002Fkw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fbbs.csdn.net\u002Ftopics\u002F80078275\"\u003Ebbs.csdn.net\u002Ftopics\u002F80078275\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"http:\u002F\u002Fforums.codeguru.com\u002Fshowthread.php?179566-0xC0000096-Privileged-Instruction\"\u003Eforums.codeguru.com\u002Fshowthread.php?179566-0xC0000096-Privileged-Instruction\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fwww.unknowncheats.me\u002Fforum\u002Fgeneral-programming-and-reversing\u002F97763-privileged-instruction-error.html\"\u003Ewww.unknowncheats.me\u002Fforum\u002Fgeneral-programming-and-reversing\u002F97763-privileged-instruction-error.html\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fcboard.cprogramming.com\u002Fwindows-programming\u002F146130-prallel-port-programming.html\"\u003Ecboard.cprogramming.com\u002Fwindows-programming\u002F146130-prallel-port-programming.html\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"http:\u002F\u002Fcomputer-programming-forum.com\u002F82-mfc\u002Fdc2481c0ecead2f2.htm\"\u003Ecomputer-programming-forum.com\u002F82-mfc\u002Fdc2481c0ecead2f2.htm\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nСуть ошибки сводится к тому, что какая-то подпрограмма использует одну из инструкций \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E_inp()\u003C\u002Fli\u003E\r\n\u003Cli\u003E_inpw()\u003C\u002Fli\u003E\r\n\u003Cli\u003E_inpd()\u003C\u002Fli\u003E\r\n\u003Cli\u003E_outp()\u003C\u002Fli\u003E\r\n\u003Cli\u003E_outpw()\u003C\u002Fli\u003E\r\n\u003Cli\u003E_outpd()\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nИспользование которых запрещено под NT-ядрами, так как они пытаются работать с параллельным портом напрямую. Судя по всему этот код вызывается в инициализаторе библиотеки, т.е. библиотека при старте хочет опросить порты на наличие устройств, но NT-ядро требует работы через драйвер.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nБезвыходная ситуация?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 8. Пауки и мухи\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n22:00. На всякий случай возникает идея проверить, что это не из-за того, что мы используем кросскомпиляцию с Linux с помощью mingw. Параллельно понимаем, что Сбербанк поставляет только 32хбитное приложение, поэтому слинковаться с 64хбитным приложением не выйдет, ну ладно, но все равно запустим камень в сторону Сбербанка за 32-only версию в 2019м году.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cb\u003EДано\u003C\u002Fb\u003E: установленная в virtualbox windows 7;\u003Cbr\u002F\u003E\r\n\u003Cb\u003EНеобходимо\u003C\u002Fb\u003E: установить Visual Studio и скопилировать MVP.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЗаходим на сайт Microsoft, качаем Visual Studio 2017. Берем лицензию сообщества, так как мы берем ее для проверки, для бизнеса лицензия будет куплена, если взлетит.\u003Cbr\u002F\u003E\r\nСкачиваем несколько сотен мегабайт и…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВидим, что наша версия ОС (Windows 7) не поддерживается.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОк, идем на всякие непотребные сайты, ищем Visual Studio 2008, скачиваем несколько сотен мегабайт заново и…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПолучаем iso файл.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЛадно, попытаемся установить Daemon Tools 10 (так как это та версия, которую предлагает сайт), чтобы вставить этот виртуальный диск.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЗапускаем скачанный бинарь. Осечка, требуется .NET Framework 4.5, скачиваем, ставим.\u003Cbr\u002F\u003E\r\nЗапускаем скачанный бинарь, установка началась, загрузчик говорит что ему нужна 4.5.2, скачиваем, ставим.\u003Cbr\u002F\u003E\r\nЗапускаем скачанный бинарь, установка началась, загрузчик говорит что никуда не поедет, пока мы не поставим обновление безопасности KB3033929, скачиваем, ставим.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ получаем оплеуху от Microsoft в виде сообщения:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fr6\u002Fqe\u002Fde\u002Fr6qedenl5w3dez4ysscvod8rmjw.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЯростно кидаем очень острый камень в сторону Microsoft, качаем с торрентов старый Daemon Tools, успешно распаковываем Visual Studio, устанавливаем, наконец-таки (00:00) компилируем MVP, получаем такую же ошибку. Что ж, хорошая была версия, но не срослось.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 11. На пороге\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПишем второму программисту, который в этот момент в срочном порядке допиливает сервер и процедуру регистрации. Он вспоминает, есть гит-\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fvyacheslafka\u002Fsb_pilot_nt\"\u003Eрепозиторий\u003C\u002Fa\u003E, который на NT-подключает эту библиотеку и работает с ней.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПодозрительно глядя на репозиторий скачиваем его, компилируем и запускаем. Работает.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fmt\u002Fgl\u002Fq-\u002Fmtglq-c68eyegv74wjnzjvpmddi.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЕще более подозрительно смотрим на код. Код идентичен, разве что написан на C++ а не С.\u003Cbr\u002F\u003E\r\nПонимаем, что язык тут не причем. Смотрим библиотеки сбербанка, которые тянет за собой код.\u003Cbr\u002F\u003E\r\nВидим последний коммит.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ вот тут нас поджидает очередной сюрприз.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОказывается, что версии библиотеки Сбербанка могут быть разными. Последний коммит увеличивает версию с 23 до 27й. Копируем себе на тестовый компьютер версию из гита — РАБОТАЕТ!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПроверяем все архивы, которые присылал Сбербанк, сравниваем версии и строим табличку:\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"scrollable-table\"\u003E\u003Ctable\u003E\r\n\u003Ctr\u003E\r\n\u003Cth\u003EВерсия\u003C\u002Fth\u003E\r\n\u003Cth\u003EРаботает\u003C\u002Fth\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003E26.0.15 — Основная\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Eнет\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003E27.4.12 — Из репозитория\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Eда\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003E23.0.13 — Из репозитория\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Eда\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003E29.0.9 — Самая свежая от СБ\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Eда\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003E23.0.13 — С патчем для системы «Криптера»\u003C\u002Ftd\u003E\r\n\u003Ctd\u003Eда\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003C\u002Ftable\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\nОтлично, вот теперь заживем. На тех системах где стоит 26 обновим до 29 или 27 и все взлетит.\u003Cbr\u002F\u003E\r\nКидаем камень #9 в сторону Сбербанка за то, что сломали поведение на NT системах.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 12. Что ждало их внутри\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nНе хватает «е» файла? Не беда, берем патченные заголовочники, динамически линкуемся с библиотекой чтобы корректно вернуть ошибку, пишем код, который просто запишет код возврата из функции в файл «е», назовем бинарь sb_pilot.exe и…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРаботать-то оно работает.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВот только на версии для системы «Криптера» не создается «р» файл.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ci\u003EГрустно смотрим на капающую по костяшкам кровь и на вмятину в стене.\u003C\u002Fi\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДля начала, что такое система «Криптера». \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nCryptera — это датская компания, выпускающая шифрующее оборудование\u002Fоборудование безопасности\u002Fключи и пр. Думаю, что вы все видели один из экземпляров их продукции:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fpb\u002Fdz\u002F85\u002Fpbdz85atzxiscdkdkq0z97ahhsm.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТак вот Сбербанк использует их криптомодуль для пинпадов и выпускает специальную «патченную» библиотеку, в которой, как мы уже поняли, не создается файл «р». Пишем по этому поводу в Сбербанк и через несколько дней получим ответ, что «под оригинальной системой файл „р“ будет создаваться, а под патченной на Криптеру — нет». Выдадим им камень # 10 через несколько дней, ведь работать нужно уже сейчас.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nК счастью, или к несчастью, но функции, которые мы используем для проведения операций возвращают уже упомянутую структуру:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Estruct auth_answer{\n   int TType;             \u002F**&lt; [in] тип транзакции. см ::OpetationTypes *\u002F\n   unsigned long Amount;  \u002F**&lt; [in] сумма в копейках                    *\u002F\n   char RCode[3];         \u002F**&lt; [out] код результата авторизации         *\u002F\n   char AMessage[16];     \u002F**&lt; [out] текст результата авторизации       *\u002F\n   int  CType;            \u002F**&lt; [in,out] тип карты                       *\u002F\n   char* Check;           \u002F**&lt; [out] образ чека, должен освобождаться GlobalFree в вызывающей программе *\u002F\n};\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nО, отлично, чек уже есть, можем сами сохранить его в файл или сразу вывести в JSON…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eprintf(\"%s\\n\", answer.Check);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nИ получаем падение приложение из-за обращения по невалидному указателю.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 14. Огонь и вода\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n4:00. Выполняем Сету Бандха Сарвангасану чтобы успокоиться, и внимательно читаем мануал:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003E[out] образ чека, должен освобождаться GlobalFree в вызывающей программе\u003C\u002Fblockquote\u003E Что это нам дает? Очень многое. Во-первых то, что раз указатель требует очистки с помощью GlobalFree то его саллоцировали с помощью \u003Ca href=\"https:\u002F\u002Fdocs.microsoft.com\u002Fen-us\u002Fwindows\u002Fdesktop\u002Fapi\u002Fwinbase\u002Fnf-winbase-globalalloc\"\u003EGlobalAlloc\u003C\u002Fa\u003E. Следовательно она выдает не указатель на память, как было в 16битной версии, а номер объекта с семантически объявленым типом HGLOBAL, который можно скормить в функции GlobalSize чтобы получить размер выделенного блока и GlobalLock чтобы заблокировать кусок памяти, но получить оригинальный указатель. Кстати, камень #6 в сторону Microsoft за NIH malloc и free, которые есть в стандартной библиотеке.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eprintf(\"%s\\n\", GlobalLock(answer.Check));\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nИ все равно получаем падение. Окей, а что показывае GlobalSize? Ноль? Как-то странно. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПроверяем другие функции, которые тоже должны отдавать слип — видим ту же картину.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ голову приходит разве что самостоятельно сгенерировать слип по тем данным, которые может выдать самая крутая функция оплаты (да, у Сбербанка функции именуются card_authorize2..14, камень кидать за это не буду):\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Estruct auth_answer14 {\n  auth_answer   ans;               \u002F**&lt; [in, out]  Основные параметры операции. См. ::auth_answer *\u002F\n  char   AuthCode[MAX_AUTHCODE];  \u002F**&lt; [out] Код авторизации. 7 байт.              *\u002F\n  char   CardID[CARD_ID_LEN];      \u002F**&lt; [out] Идентификатор карты. 25 байт. Для международных карт все символы, кроме первых 6 и последних 4, будут заменены символами ‘*’.*\u002F\n  int    ErrorCode;                \u002F**&lt; [out] Код ошибки.                                         *\u002F\n  char   TransDate[TRANSDATE_LEN]; \u002F**&lt; [out] Дата и время операции                               *\u002F\n  int    TransNumber;              \u002F**&lt; [out] Номер операции за опер. день, см. номер на чеке     *\u002F\n  int    SberOwnCard;              \u002F**&lt; [out] Флаг принадлежности карты Сбербанку                 *\u002F\n  char   Hash[CARD_HASH_LEN];      \u002F**&lt; [in, out] хеш SHA1 от номера карты, в формате ASCII с нулевым байтом в конце. 40 байт.*\u002F\n  char   Track3[CARD_TRACK3_LEN];  \u002F**&lt; [out] третья дорожка карты*\u002F\n  DWORD  RequestID;                \u002F**&lt; [in,out] Уникальный номер операции. Только PCI DSS решения.*\u002F\n  DWORD  Department;              \u002F**&lt; [in] Порядковый номер отдела от 0 до 14-ти, включительно.\n                                            При установке номера отдела в 0xFFFFFFFF, номер отдела\n                                            будет запрошен через интерфейс терминала после вставки карты.\n                                            Если номер отдела будет указан вне настроенного диапазона,\n                                            то терминал вернет код ошибки 4191. *\u002F\n  char   RRN[MAX_REFNUM];          \u002F**&lt; [in,out] Номер ссылки операции, присвоенный хостом. Используется\n                                                для операций возврат, множественной авторизации и завершения расчета.\n                                                Содержит уникальный 12-значный ссылочный номер.\n                                                При предавторизации это поле является выходным\n                                                (его заполняет библиотека pilot_nt.dll), а при\n                                                завершении расчета – входным (значение должно\n                                                быть заполнено вызывающей программой; оно должно\n                                                совпадать со значением, возвращенным при предавторизации).*\u002F\n  DWORD  CurrencyCode;             \u002F**&lt; [in] Международный код валюты (810, 643, 840, 978 и т.д.) *\u002F\n  char   CardEntryMode;            \u002F**&lt; [out] Способ чтения карты ('D'-магн.полоса, 'M'-ручной ввод, 'C'-чип, 'E'-бесконтакт EMV, 'R'-бесконтакт magstripe, 'F'-fallback)*\u002F\n  char   CardName[MAX_CARD_NAME_LEN]; \u002F**&lt; [out] Название типа карты *\u002F\n  char   AID[MAX_AID_ASCII_LEN];   \u002F**&lt; [out] Application ID чиповой карты (уже в виде ASCIIZ-строки)*\u002F\n  char   FullErrorText[MAX_FULL_ERROR_TEXT]; \u002F**&lt; [out] Полный текст сообщения об ошибке*\u002F\n  DWORD  GoodsPrice;                \u002F**&lt; [in] Цена за единицу товара, коп (34.99-\u003E3499)*\u002F\n  DWORD  GoodsVolume;               \u002F**&lt; [in] Количество товара, в тыс. долях (30.234-\u003E30234)*\u002F\n  char   GoodsCode[MAX_GOODS_CODE+1]; \u002F**&lt; [in] Код товара во внешней системе.*\u002F\n  char   GoodsName[MAX_GOODS_NAME]; \u002F**&lt; [in] Наименование товара во внешней системе. Внимание! В структуре auth_answer14 название товара на один символ короче чем в gate.dll TGoodsData. Зафиксируем эту ошибку как стандарт*\u002F\n};\n \n \n\u002F** @brief Выполнение операций по картам\n *  @param[in] track2 данные дорожки карты с магнитной полосой. Если NULL, то будет предложено считать карту.\n *  @param[in,out] auth_answer см. ::auth_answer14\n *  @param[in,out] payinfo Информация для платежной системы\n *  @return int Код ошибки.\n *\u002F\nPILOT_NT_API int  card_authorize14(\n  char *track2,\n  struct auth_answer14 *auth_answer,\n  struct payment_info_item *payinfo\n);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nПробуем подбирать поля… Выясняем, что от счастья нас отделяло всего одно — Фамилия и Имя носителя карты. Без них слип не считается \u003Ca href=\"http:\u002F\u002Fwww.consultant.ru\u002Fcons\u002Fcgi\u002Fonline.cgi?req=doc&amp;base=LAW&amp;n=175637&amp;rnd=8BB65931EED9BDFCF1D781478730CD71#0990802485589001\"\u003Eзаконным\u003C\u002Fa\u003E:\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EРеквизиты: идентификатор банкомата, электронного терминала или другого технического средства, предназначенного для совершения операций с использованием платежных карт; вид операции; дата совершения операции; сумма операции; валюта операции; сумма комиссионного вознаграждения код авторизации; реквизиты платежной карты.\u003C\u002Fblockquote\u003E Жаль, но сформировать законный слип с теми данными, что у нас есть не получится.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПокопаемся в документации еще раз.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНаходим пример, который Сбербанк поставляет в каталоге «examples»\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Estd::cout &lt;&lt; \"Authorization completion finished with code '\" &lt;&lt; result &lt;&lt; \"'\" &lt;&lt; std::endl;\n \nstd::ofstream file(CHEQUE_FILENAME);\nfile &lt;&lt; argument.auth_answ.Check;\nfile.close();\n \nif (argument.auth_answ.Check) {\n  std::cout &lt;&lt; \"Cheque saved to file \" &lt;&lt; CHEQUE_FILENAME &lt;&lt; std::endl;\n  \u002F\u002FGlobaFree(argument.auth_answ.Check);\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nПросто выводится текст, находящийся по указателю. Но ведь мы уже убедились, что так оно не работает… На всякий случай скомпилируем их пример и запустим. Вылет на строчке `file &lt;&lt; argument.auth_answ.Check;`, что ж, Сбербанк, держите камень #11 за неработающие примеры.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n7:00. Уже можно писать разработчикам другой обертки, которая несколько лет назад была написана на Delphi. Получаем ответ, что у них все работает. Ищем основу их обертки и находим на \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fkutsoff\u002Fpilot_nt.sberbank\"\u003Egithub\u003C\u002Fa\u003E:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003ETAuthAnswer = packed record\n  TType: integer;\n  Amount: UINT; \u002F\u002F IN Сумма операции в копейках\n  Rcode: array [0 .. 2] of AnsiChar;\n  AMessage: array [0 .. 15] of AnsiChar;\n  CType: integer;\n  Check: PAnsiChar;\nend;\n \n \n    Result := Func(nil, @FAuthAnswer);\n    FLastError := Result;\n    FCheque := PAnsiChar(FAuthAnswer.Check);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nПростое преобразование типа в указатель без каких-либо вызовов функций.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНачинаем подозревать злых духов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 17. Гроза разразилась\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nЛюди начинают возвращаться в офис, сочувственно кивая головой. PO выглядит не очень веселым узнав последние новости. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТут вспоминается одна деталь. Когда мы выводили поля структуры #14 чтобы увидеть их значения то один байт каждой строки был отрезан. С одной стороны это, с другой \u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EВнимание! В структуре auth_answer14 название товара на один символ короче чем в gate.dll TGoodsData. Зафиксируем эту ошибку как стандарт\u003C\u002Fblockquote\u003E Может это все же связано с…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСтрашная догадка осеняет мозг словно молния. Объявим структуру как \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Etypedef struct __attribute__((packed)) {\n   int TType;             \u002F**&lt; [in] тип транзакции. см ::OpetationTypes *\u002F\n   unsigned long Amount;  \u002F**&lt; [in] сумма в копейках                    *\u002F\n   char RCode[3];         \u002F**&lt; [out] код результата авторизации         *\u002F\n   char AMessage[16];     \u002F**&lt; [out] текст результата авторизации       *\u002F\n   int  CType;            \u002F**&lt; [in,out] тип карты                       *\u002F\n   char* Check;           \u002F**&lt; [out] образ чека, должен освобождаться GlobalFree в вызывающей программе *\u002F\n};\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nИ…\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНичего не меняется.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВсе так же Size = 0, Все так же Lock = NULL.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nБоль.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТлен.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНевольно ищешь глазами удобную балку на потолке, такую, чтобы выдержала вес. После стольких нон-стоп часов кодинга и изучения документации перед глазами плывут стройные ряды байт. А что если вывести байты, которые вообще возвращаются?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E    u32 i;\n    for (i = 0; i &lt; sizeof(answ); i++) {\n        printf(\"%02x \", *((u8 *)&amp;answ + i));\n    }\n    printf(\"\\n\");\n \n \nC:\\banks\\sber\\sb_pilot\u003Esb_pilot.exe 1 1000\n01 00 00 00 e8 03 00 00 30 00 00 ce e4 ee e1 f0 e5 ed ee 00 00 00 00 00 00 00 00 02 00 00 00 f8 6c 7a 00 00\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n`30 00 00 ce` — а это значит, что Сбербанк все же использует Packed структуры. Вот только в хэдерах об этом нет ни слова. Поэтому не работают примеры, поэтому не получается получить указатель на текст в конце — ведь он битый из-за сдвига на 1 байт. Огромный и колючий камень в сторону Сбербанка!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ тут в глаза бросился один мааааленький нюанс. 4 + 4 + 3 + 16 + 4 + 4 = 35. А тут 36 байт, Обеликс.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРаз тут 36 байт, значит компилятор все еще выравнивает структуру. Значит между RCode и AMessage все еще вставлен дополнительный байт. Но почему? Ведь мы указали `__packed__`!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 18. Обратный путь\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПричины того, что выравнивание все еще включено появились в 2012м году: \u003Ca href=\"https:\u002F\u002Fgcc.gnu.org\u002Fbugzilla\u002Fshow_bug.cgi?id=52991\"\u003Ehttps:\u002F\u002Fgcc.gnu.org\u002Fbugzilla\u002Fshow_bug.cgi?id=52991\u003C\u002Fa\u003E. Починен баг только в GCC 8 (камень за 6 лет забагованности!), обновиться на который пока нет возможности. К счастью существует workaround:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E-mno-ms-bitfields\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nНе будем сейчас разбирать механизм работы этого флага, просто передадим его компилятору:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fve\u002Ftr\u002Fd4\u002Fvetrd4m4rsdhmkyxkgrvxbkepko.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСлип! Родненький! Я по тебе скучал, даже не буду ругаться из-за кракозябр, камень за это я уже кидал.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ скормим, наконец, Майкрософт камень, за то, что GlobalSize\u002FLock выдают нули на невалидные указатели.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EГЛАВА 19. Последняя глава\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nЧтобы максимально снизить количество ifdef'ов для прослойки для sb_pilot мы написали отдельное приложение, которое полностью имитирует linux-версию sb_pilot. Таким образом оставив код прослойки #1 прежним, оставив лишь одно условие:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E#if defined(BXI_OS_GLX)\n#define GFJ_PILOT_EXECUTABLE \".\u002Fsb_pilot\"\n#elif defined(BXI_OS_WIN)\n#define GFJ_PILOT_EXECUTABLE \".\u002Fsb_pilot.exe\"\n#endif\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fwo\u002Feu\u002F2g\u002Fwoeu2gk8m1mvtibiepfxwiijrbo.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИтоги сражения:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EСбербанк: 12 камней\u003C\u002Fli\u003E\r\n\u003Cli\u003EМайкрософт: 7 камней\u003C\u002Fli\u003E\r\n\u003Cli\u003EGCC: 1 камень\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nАчивка-воспоминание на нашу командную доску:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fko\u002Fim\u002F3y\u002Fkoim3ykfftmlltegcqh_rkdkgxc.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fko\u002Fim\u002F3y\u002Fkoim3ykfftmlltegcqh_rkdkgxc.jpeg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"сбербанк"},{"titleHtml":"разработка под windows"},{"titleHtml":"терминалы оплаты"},{"titleHtml":"кассы"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F451188\u002F445d1f9df3085f8d05efb1abd8fcaad0\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F451188\u002F445d1f9df3085f8d05efb1abd8fcaad0\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F451188\\\u002F\"},\"headline\":\"Сбербанк или туда и обратно\",\"datePublished\":\"2019-05-10T10:47:51+03:00\",\"dateModified\":\"2019-05-11T14:08:18+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"staticmain\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"ГЛАВА 1. Нежданные гости Все началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращ...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F451188\\\u002F#post-content-body\",\"about\":[\"h_system_programming\",\"h_debug\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fsi\\\u002Fbq\\\u002F2u\\\u002Fsibq2unjy0i1yoy_7sa0qljphae.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fak\\\u002Fk4\\\u002Fdo\\\u002Fakk4do9scie61w_tobeuwpk6liu.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Foh\\\u002Ful\\\u002Fts\\\u002Fohultstzocyw8za06mbxqwmnrma.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Frk\\\u002Fvm\\\u002Fsc\\\u002Frkvmscw9ret9atfnts-nezxtaqg.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fzr\\\u002F-d\\\u002Fez\\\u002Fzr-dez83p56hekuceyiiqka2rdi.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fyp\\\u002F44\\\u002Ft_\\\u002Fyp44t_qwokissyt75mayl71mcdm.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fc8\\\u002F7f\\\u002Fm2\\\u002Fc87fm26nwcdjtfol6m0vamuvk8e.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fr6\\\u002Fqe\\\u002Fde\\\u002Fr6qedenl5w3dez4ysscvod8rmjw.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fmt\\\u002Fgl\\\u002Fq-\\\u002Fmtglq-c68eyegv74wjnzjvpmddi.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fpb\\\u002Fdz\\\u002F85\\\u002Fpbdz85atzxiscdkdkq0z97ahhsm.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fve\\\u002Ftr\\\u002Fd4\\\u002Fvetrd4m4rsdhmkyxkgrvxbkepko.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fwo\\\u002Feu\\\u002F2g\\\u002Fwoeu2gk8m1mvtibiepfxwiijrbo.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fko\\\u002Fim\\\u002F3y\\\u002Fkoim3ykfftmlltegcqh_rkdkgxc.jpeg\"]}","metaDescription":"ГЛАВА 1. Нежданные гости\r\nВсе началось в то злополучное утро, когда Project Manager сообщил, что сроки реализации проекта должны быть быстро и решительно сокращены на месяц. Точнее говоря проект...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"system_programming,debug"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
