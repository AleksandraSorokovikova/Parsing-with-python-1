<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>EFORTH для программируемого калькулятора / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/452398\/"},"headline":"EFORTH для программируемого калькулятора","datePublished":"2019-05-18T05:35:47+03:00","dateModified":"2019-09-08T13:16:03+03:00","author":{"@type":"Person","name":"arvi1973"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com\/ru\/post\/452572  Транслятор EFORTH теперь есть и на отечественном калькуляторе &laquo;Электроника...","url":"https:\/\/habr.com\/ru\/post\/452398\/#post-content-body","about":["h_system_programming","h_compilers","h_forth","f_develop"],"image":["https:\/\/habrastorage.org\/webt\/lx\/76\/pw\/lx76pw2yfjmfnqz4wxg9pp_m6ya.jpeg","https:\/\/habrastorage.org\/webt\/ff\/pu\/ry\/ffpury7pflujlbysn28jipoylgg.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="EFORTH для программируемого калькулятора" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="EFORTH для программируемого калькулятора" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="EFORTH для программируемого калькулятора" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com/ru/post/452572

Транслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com/ru/post/452572

Транслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com/ru/post/452572

Транслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com/ru/post/452572

Транслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com/ru/post/452572

Транслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/452398/4c12e637f2da3169655300c9feb6b557/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/452398/4c12e637f2da3169655300c9feb6b557/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/452398/4c12e637f2da3169655300c9feb6b557/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/452398/4c12e637f2da3169655300c9feb6b557/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/452398/4c12e637f2da3169655300c9feb6b557/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="452398" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-18T02:35:47.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/452398/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/452398/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/452398/4c12e637f2da3169655300c9feb6b557/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/arvi1973/" title="arvi1973" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_lilac"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/arvi1973/" class="tm-user-info__username">
      arvi1973
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-18T02:35:47.000Z" title="2019-05-18, 05:35">18  мая  2019 в 05:35</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>EFORTH для программируемого калькулятора</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/system_programming/" class="tm-article-snippet__hubs-item-link"><span>Системное программирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/compilers/" class="tm-article-snippet__hubs-item-link"><span>Компиляторы</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/forth/" class="tm-article-snippet__hubs-item-link"><span>Forth</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><i>Это первая статья цикла про 161eForth v0.5b, окончание здесь:</i> <a href="https://habr.com/ru/post/452572/">habr.com/ru/post/452572</a><br/>
<br/>
Транслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно прошла мои тесты, а также пять авторских тестов TEST-TEST4. Я добился того, что можно сделать в одиночку, но считаю это лишь половиной дела. Настало время представить сообществу новый инструмент, открыв код 161eForth для публичного тестирования. У меня есть список, что улучшить и где «поработать над стабильностью». Ваши предложения и замечания будут учтены при завершении работ и выпуске версии 1.0<br/>
<br/>
При переносе последней версии eForth на отечественную платформу успешно преодолены два препятствия — относительно низкое быстродействие 8-битной машинки, которая программируется на собственном входном языке, и скромный объём доступной двоичной памяти (см. 2.4.1), всего 4096 байт.<br/>
<img src="https://habrastorage.org/r/w780q1/webt/lx/76/pw/lx76pw2yfjmfnqz4wxg9pp_m6ya.jpeg" data-src="https://habrastorage.org/webt/lx/76/pw/lx76pw2yfjmfnqz4wxg9pp_m6ya.jpeg" data-blurred="true"/><br/>
<a name="habracut"></a><br/>
При написании 161eForth применялись готовые решения, подготовленные для Каллисто — входного языка нового поколения для отечественных ПМК. Это технология реализации форт-машины поверх десятичного АЛУ и «гарвардской» архитектуры, драйверы консоли и раскладка алфавитно-цифровой клавиатуры, а также основанный на них программный терминал, работающий по последовательному порту RS-232. Помимо «Электроники МК-161» и дистрибутива 161eForth вам может потребоваться самодельная накладная клавиатура, где на клавишах подписаны буквы русского и английского алфавитов. Буквы расположены по алфавиту построчно, слева направо и сверху вниз.<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/ff/pu/ry/ffpury7pflujlbysn28jipoylgg.png"/><br/>
<br/>
Доктор Чэнь-Хэнсон Тинг, автор современных версий eForth, подчёркивает в своей книге [1] важность понимания двух составляющих Форта. Это внутренний («адресный») интерпретатор, позволяющий оборудованию исполнять шитый код Форта, и внешний («текстовый») интерпретатор, отвечающий за диалог с человеком.<br/>
<br/>
В двух статьях я подробно остановлюсь на наиболее радикальных решениях, использованных при реализации каждого из этих двух интерпретаторов на «Электронике». Изучение этих решений может оказаться полезным и вдохновляющим для переноса eForth на другие устройства с ограниченным объёмом памяти и производительности. Пониманию статей поможет начальное знакомство с программируемыми микрокалькуляторами (ПМК) и Фортом. Я поясню сложные моменты, уникальные для «Электроники МК» и транслятора eForth.<br/>
<br/>
Начну с того, что слова eForth делятся на общеполезные и системные. <b>Размер букв имеет значение. Имена обычных слов определены заглавными буквами, а системных — строчными.</b> Свои нововведения в eForth я также сделал строчными буквами. Автор eForth предлагает вести основной диалог в режиме CAPS. Когда вам нужно использовать системное слово, переключитесь на время в строчные буквы (комбинация клавиш F P).<br/>
<br/>
В статье все слова пишутся заглавными буквами, чтобы выделяться из текста. В нескольких ранних реализациях eForth заголовки системных слов были исключены и не выводились командой WORDS. Это помогало упростить внешний вид eForth и экономить внимание тех, кто впервые пользуется Фортом. В 161eForth заголовки этих слов сохранены в первую очередь из-за наличия декомпилятора слов двоеточия SEE (см. видео №3 в конце статьи), который не покажет имена системных слов, если убрать их заголовки.<br/>
<br/>
Чтобы упорядочить статью и сделать её полезной, как справочник, несколько терминов мне пришлось употребить до их определения. Специалистам по Форту и ПМК эти термины должны быть знакомы. Новичкам иногда придётся заглядывать в соседние разделы (я проставил ссылки в нужных местах) или перечитать статью пару раз.<br/>
<br/>
Сам 161eForth выложен здесь, вместе с исходным текстом, рисунком накладной клавиатуры и справкой words.txt с описанием всех реализованных слов: <a href="http://the-hacker.ru/2019/161eforth0.5b.zip">http://the-hacker.ru/2019/161eforth0.5b.zip</a><br/>
<br/>
Также я выложил 5 маленьких видео на YouTube, иллюстрирующих работу 161eForth для тех, у кого нет МК-161. Можно <a href="https://www.youtube.com/playlist?list=PLr5CZvfCYpd7I0mSe2k61i00E2YZro7BC">посмотреть весь плейлист на YouTube</a>. Ниже первое из них, остальные 4 в конце статьи.<br/>
<br/>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;"><div class="tm-iframe_temp" data-src="https://www.youtube.com/embed/RxarUWHdNTE?rel=0&amp;showinfo=1&amp;hl=en-US" data-style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" id="" width=""></div></div></div></div><br/>
<br/>
<h2>eForth и его реализации</h2><br/>
eForth разрабатывался, как современная замена широко известного транслятора фиг-Форта. Для переноса на МК-161 мною была выбрана 32-битная версия 5.2 транслятора 86eForth с косвенным шитым кодом, написанная в 2016 году на ассемблере MASM для операционной системы Windows. Эта версия подробно описана в третьем издании книги «eForth and Zen» [1]. Знающим английский советую разыскать и изучить эту книгу, она весьма полезна для понимания 161eForth.<br/>
<br/>
В личном письме автор подтвердил, что 86eForth502.asm из этой книги — последняя версия eForth. В Интернете можно найти много англоязычной информации и по этой, и по предыдущим версиям eForth.<br/>
<br/>
Развитие eForth шло по научному пути, которому учит профессор Вирт на примере своего языка программирования Оберон. Каждая последующая версия eForth была упрощением предыдущей версии. Всё, без чего можно обойтись, убиралось из языка. Остался тщательно продуманный набор сильных, выразительных языковых конструкций, чья мощь проверена на более, чем 40 реализациях eForth для разнообразных платформ. Теперь и на калькуляторе!<br/>
<br/>
Будучи минималистичным диалектом Форта, eForth не ставит своей целью победить в гонке на самый крохотный Форт. Предлагаемый им набор слов вполне практичен и может легко расширяться программистом в нужную для его задач сторону.<br/>
<br/>
Первая версия eForth была выпущена в 1990 году на ассемблере MASM для процессоров 8086 и работала под MS-DOS. Она содержала 31 машинно-зависимое слово ядра и 191 слово высокого уровня. Идея была проста — вы переводите на свой ассемблер всего 31 слово, и сразу получаете eForth на своём компьютере.<br/>
<br/>
Такой подход подвергся критике в Интернете, так как путь минимизации количества слов на ассемблере привёл к крайне низкому быстродействию для встроенных систем. Уже во второй версии eForth на ассемблере стало реализовываться максимальное количество слов, что выправило крен в сторону не только легко переносимой, но и практичной системы программирования.<br/>
<br/>
Несколько лет Билл Мунч, первоначальный автор eForth, и его коллега д-р Чэнь-Хэнсон Тинг выпускали свои релизы eForth параллельно. У каждой версии были свои особенности. К вариантам eForth для разных платформ прилагали свои усилия и другие программисты.<br/>
<br/>
Версия 5.2, выпущенная в 2016 году, содержит 71 слово «кода» и 110 слов «двоеточия». Четверть века поиска идеала привели к значительному уменьшению общего количества слов. При этом из соображений производительности увеличился процент слов, реализованных на низком уровне.<br/>
<br/>
Предлагаемый 161eForth пользуется щедрыми плодами этого прогресса, но не претендует на дальнейшее развитие магистральной линии. Моя реализация предоставляет программисту все инструменты, присутствующие в версии 5.2. Когда архитектура МК-161 делает реализацию некоторых слов 86eForth невозможной или бессмысленной, вместо выкидывания лишнего я предоставляю программистам полноценную замену, взяв её из стандарта ANSI/ISO [4]. Ищущие минимализма могут самостоятельно выкинуть «лишние» слова, ведь по традиции 161eForth поставляется с исходным кодом.<br/>
<br/>
При реализации eForth я придерживался авторского понимания. Например, по моему глубокому убеждению цикл FOR NEXT с начальным значением n должен выполняться ровно n раз. К такому же выводу со временем пришёл Чак Мур, автор языков Forth и colorForth. К сожалению, eForth использует устаревшее соглашение и выполняет такой цикл n+1 раз, со счётчиком от n до 0. Я не стал исправлять этот и несколько других недостатков, отдав предпочтение совместимости 161eForth с реализациями для других платформ.<br/>
<br/>
Поскольку 161eForth является первой практичной системой программирования «на борту» для «Электроники МК-161», если не считать заводского языка, я проследил многолетнюю историю eForth и вернул в язык несколько слов, которые были полезными на других платформах и могут оказаться востребованными сейчас.<br/>
<br/>
Например, новая-старая переменная ‘BOOT содержит токен (см. 3.1) слова, который выполняется первым после инициализации среды, но до начала диалога. По умолчанию ‘BOOT содержит токен TLOAD для интерпретации кода из «области текста» (см. 2.4.2). Это позволяет программисту подстраивать eForth под себя без перекомпиляции среды, которую пока невозможно производить на борту «Электроники».<br/>
<br/>
Приоритетными задачами реализации были экономия двоичной памяти (см. 2.4.1) и повышение быстродействия. Их решение привело к драматичному уменьшению количества слов высокого уровня, ведь их код занимает эту драгоценную память, за счёт увеличения количества быстрых слов ядра, реализованных в дешёвой памяти программ (см. 2.4.3).<br/>
<br/>
В итоге 161eForth содержит 129 слов кода, 78 слов высокого уровня и занимает 1816 байт двоичной памяти МК-161, то есть меньше её половины. Это даёт надежду на метакомпиляцию своей высокоуровневой части прямо на борту «Электроники».<br/>
<br/>
Исходный текст eForth для МК-161 разбит на две крупные части. Написанное в системе команд МК-161 ядро содержится в файле eForth0.mkl. Слова высокого уровня определены на языке SP-Forth и размещены в файле eForth.f.<br/>
<br/>
Также в дистрибутиве есть справочный файл words.txt, в котором документированы все слова 161eForth со стековой нотацией и кратким пояснением, в одну строчку.<br/>
<br/>
<h3>1.1 Исходный текст ядра eForth0.mkl</h3><br/>
Ядро eForth содержит исполняемый код, работающий в памяти программ МК-161 (см. 2.4.3), который компилируется на компьютере в файл eForth0.mkp стандартными средствами, например фирменным компилятором MKL2MKP.<br/>
<br/>
Исходный текст ядра, содержащийся в файле eForth0.mkl, написан в <i>латинской мнемонике</i>. Например, команда ИПЕ для чтения регистра Е (он же R14) записывается в этой мнемонике, как RME. Будучи непривычной для владельцев советских ПМК, латинская мнемоника удобна для ввода с клавиатуры компьютеров. Действительно, набрать странное FX^2 проще, чем знакомое с детства Fx².<br/>
<br/>
Файл eForth0.mkp является заготовкой ядра. Помимо кода примитивов он содержит заголовок ядра и таблицу имён tblNames, которую eForth.f во время компиляции переносит в десятичные регистры (см. 2.4.4). Именно на основе eForth0.mkp будет создано ядро eForth.mkp (см. 2.4.3), поэтому eForth0.mkl должен быть откомпилирован первым.<br/>
<br/>
<h3>1.2 Исходный текст слов высокого уровня eForth.f</h3><br/>
Файл eForth.f подаётся на вход замечательного отечественного компилятора SP-Forth [5]. Файл содержит определения всех слов высокого уровня. Со временем их можно будет определить на самом eForth и, возможно, компилировать прямо на борту «Электроники МК-161».<br/>
<br/>
Во время компиляции eForth.f считывает заготовку ядра eForth0.mkp и с её помощью создаёт в текущем каталоге три файла для последующей загрузки в МК-161: eForth.mkp, eForth.mkd и eForth.mkb. Именно eForth.mkb содержит тела слов высокого уровня, хотя их заголовки размещены в файле eForth.mkd.<br/>
<br/>
Четвёртый файл, eForth.mkt, написан на eForth вручную и может редактироваться на борту МК-161 с помощью встроенного редактора текста. Каждый из этих четырёх файлов я подробнее разберу ниже (см. 2.4).<br/>
<br/>
<h2>2. Электроника МК-161</h2><br/>
Производитель из Новосибирска называет МК-161 старинным сокращением ЭКВМ. Так назывались в СССР самые первые калькуляторы. Система команд МК-161 наследует системе команд советских калькуляторов «Электроника Б3-34» и «Электроника МК-61». Это означает, что программы, написанные для советских калькуляторов, пойдут на МК-161 без изменений или с незначительными изменениями.<br/>
<br/>
Обратное неверно. eForth не пойдёт на советских ПМК, т.к. задействует множество ресурсов, появившихся впервые в МК-152/161 и отсутствовавших в предыдущих моделях серии.<br/>
<br/>
Рассмотрим особенности входного языка и архитектуры МК-161, повлиявшие на 161eForth (далее просто eForth) и давшие обсуждаемой реализации eForth «русский акцент».<br/>
<br/>
Первая из этих особенностей — последовательно выдерживающееся в МК-161 <b>соглашение «старшее по младшему адресу»</b>. Например, число 1000=3×256+232 будет записано в двух последовательных байтах, как 3 и 232.<br/>
<br/>
<h3>2.1 Косвенная адресация</h3><br/>
Программировавшие советские ПМК слышали про косвенную адресацию. При <i>прямой адресации</i> мы явно указываем номер регистра, к которому обращаемся. Например Р ИП 44 считает содержимое регистра 44. Клавиша Р, появившаяся в МК-152, используется для обращения к регистрам с номером 15 и больше — эти регистры отсутствовали в советских ПМК.<br/>
<br/>
При <i>косвенной адресации</i> номер нужного регистра заранее не известен. Этот номер содержится в другом регистре. Например, если регистр 8 содержит число 44, команда К ИП 8 считает содержимое регистра 44 (R44).<br/>
<br/>
Клавиши К и Р можно комбинировать. Например, команда Р К БП 20 передаст управление (GOTO в латинской мнемонике) на адрес, хранящийся в R20.<br/>
<br/>
Особенность, оказавшаяся важной для внутреннего интерпретатора eForth, связана с предварительным увеличением / уменьшением регистров при косвенной адресации. Эта особенность унаследована от советских ПМК.<br/>
<br/>
Например, команды косвенного чтения К ИП 0, К ИП 1, К ИП 2 и К ИП 3 перед обращением к нужному регистру уменьшают на единицу содержимое регистров 0, 1, 2 или 3. Команды К ИП 4, К ИП 5 и К ИП 6 перед считыванием увеличивают на единицу содержимое регистров 4, 5 или 6.<br/>
<br/>
Такая «модификация» адресного регистра позволяет обрабатывать в цикле целые группы регистров. Она похожа на ++R и --R в Си. Номер регистра-указателя важен. Именно он определяет, произойдёт его увеличение (регистры 4-6) или уменьшение (регистры 0-3) при косвенной адресации.<br/>
<br/>
На архитектуру 161eForth повлияло то, что увеличение регистров 4-6 при косвенной адресации — <i>предварительное</i>. В результате указатель интерпретации (IP), размещённый в R6, всегда <i>указывает на последний считанный байт</i> шитого кода. В 86eForth IP всегда указывает на последующий байт, ещё не считанный.<br/>
<br/>
Это верно и для указателя стека возвратов (RP), хранящегося в регистре 2. R2 всегда указывает на вершину стека возвратов.<br/>
<br/>
Полезной особенностью МК-161 является отсутствие увеличения / уменьшения регистра, если косвенная адресация происходит с новой клавишей Р. Например, РКИП02 считает число с вершины стека возвратов, не меняя указатель. Это готовая команда Форта R@. Из написанного выше следует, что считанное значение на единицу меньше, чем адрес следующего токена, который выполнится после возврата из слова «двоеточия».<br/>
<br/>
Когда вам придётся разрабатывать или изучать слова, тесно взаимодействующие с внутренним интерпретатором eForth — убедитесь, что до конца поняли этот тонкий момент, связанный с <b>предувеличением</b>.<br/>
<br/>
<h3>2.2 Таблицы, упорядоченные и ассоциативные</h3><br/>
Таблицы МК-161 размещаются в памяти программ (см. 2.4.3). Они появились в новосибирской «Электронике МК» и совершенно незнакомы экспертам по советским ПМК. Адрес используемой таблицы всегда хранится в регистре 9042, а вот обращение к ним различается.<br/>
<br/>
<i>Упорядоченная таблица</i> это массив беззнаковых 16-битных целых. eForth содержит такую таблицу tblTokens с адресами примитивов (см. 3.1.1) — слов Форта, написанных в системе команд МК-161. Адресный интерпретатор (см. 3.2) использует tblTokens для быстрого исполнения шитого кода, поэтому eForth старается, чтобы в R9042 всегда содержался адрес этой таблицы.<br/>
<br/>
Для обращения к упорядоченной таблице надо записать номер нужного элемента в R9210. Число n в регистре X заменится на значение элемента таблицы с номером n, отсчёт начинается с нуля.<br/>
<br/>
<i>Ассоциативные таблицы</i> («поиск по значению») активно используются eForth, в первую очередь примитивом (FIND), ищущим слово по его имени. Также ассоциативная таблица tblCHPUT используется при выводе литеры на экран, чтобы обрабатывать перевод строки и другие управляющие коды.<br/>
<br/>
Для поиска элемента n в ассоциативной таблице требуется записать n в R9212. Число n в регистре X (руководство его называет «индексом») заменится на 16-битное значение, записанное в таблице сразу после его «индекса» n.<br/>
<br/>
Наличие этой быстрой, хотя и простенькой функции поиска, реализованной на ассемблере в «прошивке» МК-161, помогло eForth добиться приемлемого быстродействия при распознавании имён слов и компиляции программ. Конечно, для этого пришлось разработать не самые простые таблицы распознавания имени, «заточенные» под эту функцию. Об этом поговорим подробней во второй статье.<br/>
<br/>
<h3>2.3 Прерывания и консоль</h3><br/>
«Электроника МК» позволяет её владельцам писать программы на входном языке, реагирующие на определённые события — такие, как нажатие или отпускание кнопки, окончание счёта таймера.<br/>
<br/>
eForth активно использует эту <i>систему прерываний</i> как для ввода с клавиатуры и отображения мигающего курсора при запросе такого ввода, так и для ввода-вывода через универсальный последовательный порт (RS-232).<br/>
<br/>
Введённые с клавиатуры литеры ставятся в очередь bufKbd по мере нажатия клавиш. Это очень удобно и экономит время на системах с низким быстродействием. Переключения алфавитов и регистра обрабатываются прерыванием KeyPress и не занимают место в очереди. Долгое нажатие на клавишу вызывает автоповтор.<br/>
<br/>
Когда очередь из 8 литер заполнена, а eForth ещё не готов обработать ввод (ситуация очень редкая), МК-161 издаст недовольный писк. Конечно, всю эту естественную работу клавиатуры хотелось бы не реализовывать в трансляторе, а получить «из коробки» МК-161, как сервис встроенной программы (прошивки). Но уж чем, как говорится, богаты.<br/>
<br/>
После начала работы весь вывод eForth направлен на <i>графический экран</i> МК-161. Вывод литеры на него осуществляет относительно простая подпрограмма ChPut. Единственная сложность здесь связана с реализацией управляющего кода BS, «пробела назад». МК-161 использует пропорциональный шрифт. Поэтому в специальном буфере tblBS приходится запоминать позиции выведенных символов, откуда их позже берёт код вывода BS.<br/>
<br/>
Во время диалога пользователь может с помощью слова IO> перенаправить весь ввод-вывод в последовательный порт RS-232, что даёт возможность <b>программировать МК-161 с привычной клавиатуры компьютера или с другой МК-161</b>. Слово CON> возвращает управление на консоль калькулятора.<br/>
<br/>
<h3>2.4 Области памяти и установка eForth на МК-161</h3><br/>
Память «Электроники МК-161» состоит из отдельно адресуемых памяти программ и регистровой памяти данных. В свою очередь, регистровая память неоднородна и делится на три большие области.<br/>
<br/>
Регистры с номерами от 0 до 999 хранят «десятичные числа». Это обычные регистры, как в «Электронике Б3-34» и других калькуляторах. Просто способны хранить не 8, а 12 десятичных знаков «мантиссы».<br/>
<br/>
Регистры с номерами от 1000 до 8167 хранят целые от 0 до 255. Последние 3 Кбайта этой области с адресами от 5096 до 8167 называются <i>областью текста</i>.<br/>
<br/>
Регистры с номерами от 9000 до 9999 называются <i>регистрами функций</i>. Эта служебная область адресного пространства напоминает порты ввода-вывода микропроцессоров. С помощью команд записи и чтения по этим адресам реализуется доступ к устройствам ввода-вывода, системе прерываний и т.п.<br/>
<br/>
Чтобы установить eForth на «Электронику МК-161», достаточно передать в калькулятор четыре файла, например с помощью программы производителя MK.EXE:<br/>
<ul>
<li>Записать eForth.mkp в память программ, начиная со страницы 0. Версия 0.5b занимает 74 страницы.</li>
<li>Записать eForth.mkd в память десятичных данных</li>
<li>Записать eForth.mkb в память двоичных данных</li>
<li>Записать eForth.mkt в память текста</li>
</ul><br/>
После передачи на калькулятор рекомендую тут же <b>сохранить эти четыре файла в отдельном каталоге</b> встроенного «электронного диска». Поскольку имя у них одинаковое, загрузить eForth можно сразу за один раз, как «пакет».<br/>
<br/>
<h4>2.4.1 Двоичная («байтовая») память МК-161: eForth.mkb</h4><br/>
Регистры «Электроники МК» с номерами от 1000 до 5095 используются для хранения чисел от 0 до 255. Эта область регистровой памяти калькулятора называется двоичной. К двум последовательным двоичным регистрам можно обращаться из eForth, как к одной 16-битной «ячейке», причём (как везде на МК-161) старшие 8 бит находятся в регистре с меньшим номером.<br/>
<br/>
eForth использует эту крошечную «двоичную память», как свою основную. Именно с ней работают слова ! и @, HERE и ALLOT, только отсюда исполняет шитый код адресный интерпретатор (см. 3.2). Здесь расположены переменные eForth, буфер ввода текста (TIB), словарь и стек откатов tblBS для реализации пробела назад.<br/>
<br/>
4096 байт это очень скромно, по современным меркам. Поэтому огромные усилия были затрачены, чтобы вынести в другие области памяти всё, что только возможно.<br/>
<br/>
<h4>2.4.2 Область текста: eForth.mkt</h4><br/>
Сразу за двоичной памятью следует <i>область текста</i>, регистры с номерами от 5095 до 8167. Технически это такие же байтовые регистры, но возможность их записывать на диск и считывать отдельным файлом делают эту область особенной.<br/>
<br/>
Для работы с «текстом» в eForth служит слово TLOAD. Оно подаёт всю эту область на вход текстового интерпретатора, как строку, длиной в 3072 литеры.<br/>
<br/>
Существуют разногласия, как текст разбивать на строки. Редактор, встроенный в «Электронику МК», настаивает на длине строки в 24 литеры. Каллисто использует соглашение Форта, где строка содержит 64 литеры. eForth предоставляет выбор пользователю, считая весь текст одной длинной строкой. Можете использовать встроенный редактор МК-161. Можете написать свой, совместимый с Каллисто.<br/>
<br/>
Вот начальное содержимое eForth.mkt, для удобства разбитое на три строчки:<br/>
<br/>
<pre><code class="plaintext">: hi  ." Привет, %user%!" CR ;
‘ hi  ‘boot !
hi \</code></pre><br/>
Первая строка определяет новое слово hi, приветствующее пользователя. Вторая строка берёт токен этого слова (см. 3.1) и размещает в переменной ‘BOOT (см. 1). Теперь область текста перестанет компилироваться при каждом запуске eForth. Вместо этого выполнится уже скомпилированное приветствие.<br/>
<br/>
Последняя строка запускает слово hi, выводя приветствие на экран. Слово \ заканчивает интерпретацию текста, возвращая управление на пульт.<br/>
<br/>
Чтобы скомпилировать произвольный файл текста, вам надо выйти в калькулятор командой BYE, выйти в главное меню и загрузить нужный файл в режиме ДОС. Также можно передать файл mkt с компьютера. Клавиша С/П вернёт вас в eForth, после чего командой TLOAD вы сможете откомпилировать файл, загруженный в область текста.<br/>
<br/>
<h4>2.4.3 Память программ: eForth.mkp</h4><br/>
Память программ МК-161 — изолированное адресное пространство. Оно тоже хранит байты, но они доступны только для чтения. Память программ содержит 10000 «шагов», что оказалось избыточным для eForth. Больше четверти памяти программ оказалась свободной, что даёт неплохой задел для развития транслятора.<br/>
<br/>
Только в памяти программ могут быть реализованы «слова кода». Также сюда вынесены таблицы распознавания имени и все известные текстовые строки, что экономит двоичную память.<br/>
<br/>
Некоторые слова, например C@, COUNT и TYPE, могут адресовать память программ, если адрес не является положительным числом. Например, фраза 0 C@ считает «шаг» (байт) с адреса 0 памяти программ.<br/>
<br/>
<h4>2.4.4 Десятичная память: eForth.mkd</h4><br/>
Регистры «Электроники МК» с номерами от 0 до 999 называются десятичными и содержат числа, используемые для обычных расчётов на калькуляторе — 12 десятичных знаков «мантиссы» и 2 десятичных знака «порядка». Форт рассчитан на работу с целыми числами до 4 байт длиной, такой ресурс явно избыточен для eForth.<br/>
<br/>
Десятичная память использована для экономии драгоценной двоичной памяти. Сюда вынесены стеки данных и возвратов. Здесь же хранятся заголовки слов — как определяемых пользователем, так и встроенных, по одному регистру на заголовок. Такой подход позволяет переопределять даже слова, имеющие стандартные имена.<br/>
<br/>
Стек в десятичной памяти приводит к ряду особенностей, характерных для Форта на МК-161. Во-первых, диапазон значений элементов стека огромен, он способных вмещать 32-битные целые. Необходимость «двойных целых» на МК-161 отпадает, хотя ради совместимости соответствующие слова eForth мною реализованы. «Двойные целые» представлены на МК-161, как два элемента стека, содержащие числа от 0 до 65535, кодирующие одно 32-битное целое со знаком в дополнительном коде. Старшие 16 бит такого числа размещается сверху, то есть по младшему адресу.<br/>
<br/>
Побитовые логические операции AND, OR, XOR и NOT рассматривают свои аргументы, как 16-битные целые. Результат от 32768 до 65535 преобразуется в отрицательные числа от -32768 до -1. В eForth ложь кодируется нулём, а истина минус единицей. Также истиной считается любое значение, отличное от нуля.<br/>
<br/>
Вторая особенность стека данных 161eForth — он содержит числа со знаком. Когда слово @ считывает число 65535 из 16-битной «ячейки», оно автоматически преобразовывается в -1. Предусмотрено <b>специальное «беззнаковое» слово U@</b> для того, чтобы считать непосредственно 65535, со знаком «плюс».<br/>
<br/>
Упомяну, что ради быстродействия <b>два верхних элемента стека</b> данных расположены не в десятичной памяти, а непосредственно <b>в регистрах X и Y</b>.<br/>
<br/>
Тот факт, что десятичные регистры могут содержать дробные числа и числа с плавающей запятой, никак не используется eForth. Виртуальная машина eForth использует эти регистры для хранения 12-разрядных десятичных целых со знаком. Обращение к десятичным регистрам осуществляют слова C@ и C! — те же самые, что работают с любыми одиночными регистрами.<br/>
<br/>
<h2>3. Внутренний интерпретатор</h2><br/>
Ядро eForth это программа, написанная на входном языке МК-161. Её первая команда БП MAIN передаёт управление коду MAIN, который первым делом выясняет обстоятельства перезагрузки. Если её вызвал неправильный токен, МК-161 пискнет. При первом запуске, а также после включения МК-161, экран очищается. Далее MAIN вызывает подпрограмму Init для инициализации системы прерываний и всего, что нужно драйверам консоли МК-161.<br/>
<br/>
После инициализации стеков данных и возвратов низкоуровневая часть старта завершена. Происходит невероятное для машин с гарвардской архитектурой — eForth переходит к исполнению «шитого кода» из байтовой памяти. Честь быть первым принадлежит слову, адрес заголовка которого записан в R43. Обычно это слово COLD.<br/>
<br/>
Как же устроены <i>слова высокого уровня</i> (СВУ)? Любое слово состоит из двух частей, тела и заголовка. <i>Заголовок</i> хранится в десятичном регистре. Он помогает внешнему интерпретатору и декомпилятору найти имя и тело слова. Заголовок также содержит <i>поле «лексикона»</i> — набор флагов, помогающих внешнему интерпретатору правильно обработать найденное слово. Внутреннему интерпретатору намного важнее тело СВУ, расположенное в двоичной памяти и хранящееся в словаре. Он способен даже исполнять слова, у которых заголовок отсутствует.<br/>
<br/>
<i>Тело</i> СВУ начинается с байта <i>поля кода</i>, который содержит адрес <i>обработчика</i> данного слова. Четыре обработчика СВУ написаны на входном языке МК-161 и начинаются на первой странице памяти программ. Мы разберём их все (см. 3.3), но главный из них называется DOLST и расположен по адресу 02, сразу после уже рассмотренной команды БП MAIN. Этот обработчик исполняет слова Форта, определённые с помощью двоеточия.<br/>
<br/>
После байта поля кода идёт <i>поле параметров</i>, произвольной длины. В «словах двоеточия» поле параметров содержит «шитый код» — последовательность 16-битных токенов, каждый из которых обозначает одно, закреплённое за ним действие.<br/>
<br/>
Сперва мы рассмотрим токен подробнее. Потом изучим внутренний интерпретатор INEXT, осуществляющий переход от одного токена к исполнению следующего. Автор eForth называет INEXT обработчиком примитивов. Завершим мы эту экскурсию по внутреннему интерпретатору разбором всех четырёх обработчиков СВУ.<br/>
<br/>
<h3>3.1 Токены</h3><br/>
<i>Токен</i> представляет слово в шитом коде и стеке, позволяя его быстро выполнить. Токен — указатель на тело слова, но суровая архитектура МК-161 внесла в эту простую идею свои коррективы. Разберём все виды токенов, начиная с токена примитивов.<br/>
<br/>
<h4>3.1.1 Токен примитива</h4><br/>
Всё слова, входящие в дистрибутив eForth, пронумерованы от 0 до 206. Эта нумерация сквозная, учитывающая как примитивы, так и СВУ. Так сделано, чтобы по номеру слова было легко восстановить его <i>имя</i>. Эти имена хранятся в памяти программ. Ссылку на нужное имя легко найти через таблицу заголовков.<br/>
<br/>
<b>Номер примитива и является его токеном</b>. Как любой токен, примитив занимает в шитом коде два байта. Первый равен нулю. Второй содержит его номер. Таблица tblTokens позволяет быстро найти адрес кода примитива по этому номеру. Адрес tblTokens постоянно хранится в R9042 (см. 2.2), то есть для исполнения примитива всё всегда под рукой.<br/>
<br/>
Слово XT> позволяет узнать адрес кода примитива по его номеру (токену). Так как код примитивов всегда располагается в памяти программ, полученный адрес всегда отрицательный (см. 2.4.3).<br/>
<br/>
<h4>3.1.2 Токен СВУ</h4><br/>
СВУ может иметь свой номер и связанное с ним стандартное имя, а может быть совершенно новым, созданным пользователем. Во всех случаях <b>токен СВУ — адрес его поля кода</b> (см. 3), то есть число от 1000 до 5095.<br/>
<br/>
В шитом коде токен СВУ записывается весьма необычным образом. В первый байт записывается число сотен (число от 10 до 50), во второй — остаток от деления токена на 100 (число от 0 до 99).<br/>
<br/>
Например, токен 1234 будет представлен двумя байтами 12 и 34. Компиляцию такого, да и любого другого токена осуществляет взятое из стандарта ANSI слово COMPILE,. Для записи и чтения токенов СВУ в шитом коде служат слова XT! и XT@. Они же осуществляют доступ к адресам (см. 3.1.4), а слово XT@ способно также считать токен примитива.<br/>
<br/>
<h4>3.1.3 Целые литералы</h4><br/>
<i>Целые литералы</i> — разновидность токенов примитивов. Они достаточно необычны, чтобы рассмотреть их отдельно.<br/>
<br/>
В шитом коде токены DOLIT и DOLITM занимают четыре байта. Первые два байта содержат уже рассмотренный токен примитива, то есть 0 и номер примитива. Последующие два байта содержат целое, которое данный литерал при исполнении положит на стек данных.<br/>
<br/>
DOLITM отличается тем, что меняет знак числа перед тем, как положить его на стек. Он предназначен для реализации отрицательных чисел.<br/>
<br/>
<h4>3.1.4 Адресные литералы</h4><br/>
Подобно целым литералам, три <i>адресных литерала</i> BRANCH, ?BRANCH и DONXT занимают в шитом коде по 4 байта каждый. Первые 2 байта содержат токен примитива, последние два — адрес перехода.<br/>
<br/>
Адрес записывается в том же формате, что и токен СВУ (см. 3.1.2). В первом байте идёт количество сотен, во втором — остаток от деления адреса на 100. Напомню, что из-за предувеличения (см. 2.1) адрес перехода содержит не адрес нужного токена, а число, на единицу меньшее.<br/>
<br/>
Токен DONXT помогает реализовать «конечный цикл» FOR-NEXT (см. 1). Безусловный переход BRANCH нужен для реализации бесконечного цикла BEGIN-AGAIN. Условный переход ?BRANCH передаёт управление, если на вершине стека данных находится ноль («ложь»). Он служит для реализации условного оператора IF-THEN, выходов из «неопределённых циклов» BEGIN-UNTIL и BEGIN-WHILE-REPEAT.<br/>
<br/>
<h4>3.1.5 Строковые литералы</h4><br/>
<i>Строковые литералы</i> — разновидность токенов СВУ. В шитом коде строкового литерала после токена идёт байт с длиной строки, после которого — сама строка, от первого байта до последнего.<br/>
<br/>
В eForth три строковых литерала: $"|, ."| и abort"|. Они определены в файле eForth0.mkl, как токены STRQP, DOTQP и ABORQ соответственно. Основную «литеральную» работу выполняет за них слово do$, токен DOSTR.<br/>
<br/>
Чтобы сделать размер статьи разумным, я не могу останавливаться слишком подробно на этой интересной теме, но неплохо знать об их наличии в eForth.<br/>
<br/>
<h3>3.2 Адресный интерпретатор</h3><br/>
Пришло время рассмотреть <i>интерпретатор токенов</i>, адрес которого всегда записан в регистре 9. Большинство примитивов завершают свою работу командой К БП 9, которая передаёт управление на метку INEXT.<br/>
<br/>
<pre><code class="plaintext">INEXT: КИП6 Fx≠0 NPrime
NData: ВП 2 КИП6 + П7 F⟳
КИП7 П8 F⟳ КБП8</code></pre><br/>
Первым делом адресный интерпретатор считывает командой КИП6 первый байт очередного токена. Если он нулевой, это примитив и обработкой токена займётся код под меткой NPrime.<br/>
<br/>
Меткой NData обозначена обработка токена СВУ. Первый байт умножается на сто командой ВП 2, после чего КИП6 + прибавляет к результату второй байт токена (см. 3.1.2). Считанный токен заносится командой П7 в «рабочий регистр» WP (R7).<br/>
<br/>
Мы знаем, что токен СВУ это адрес его поля кода, в котором содержится адрес обработчика. Команды КИП7 П8 считывают байт поля кода в R8, а команда КБП8 передаёт управление обработчику СВУ. Обработчик знает, что в R7 находится число, на единицу меньшее адреса поля параметров обрабатываемого слова.<br/>
<br/>
Команды F⟳ с кодом 25 «прибираются» в стеке. Дело в том, что eForth хранит два верхних элемента стека данных непосредственно в регистрах X и Y стека МК-161. Такое решение ускоряет работу, но заставляет следить, чтобы эти важные данные не потерялись.<br/>
<br/>
Осталось разобрать, как адресный интерпретатор исполняет примитивы.<br/>
<br/>
<pre><code class="plaintext">NPrime: F⟳ КИП6 РРП9210 П8 F⟳ КБП8</code></pre><br/>
Команда КИП6 считывает второй байт токена примитива. Команды РРП9210 П8 считывают из таблицы tblTokens адрес этого примитива (см. 2.2 и 3.1.1), а КБП8 передаёт этому примитиву управление.<br/>
<br/>
Как и выше, F⟳ убирают лишнее из стека, восстанавливая содержимое регистров X и Y.<br/>
<br/>
Адресный интерпретатор eForth такой крохотный, что он несколько раз продублирован в памяти программ. Основная копия исполняется по команде К БП 9, которой завершается большинство примитивов.<br/>
<br/>
В качестве упражнения рекомендую изучить реализацию слова EXECUTE, размещённую после метки EXECU. Это вариант INEXT, который считывает токен не из шитого кода, а берёт его со стека данных.<br/>
<br/>
<h3>3.3 Обработчики СВУ</h3><br/>
Четыре разновидности СВУ имеют четыре разных обработчика: DOLST, DOVAR, DOCON и DOCONM. Выше мы уже видели, что адресный интерпретатор перед вызовом обработчика оставляет в R7 адрес поля кода обрабатываемого слова.<br/>
<br/>
eForth.f узнаёт адреса этих обработчиков, считав заголовок ядра из файла eForth0.mkp. Это помогает ему правильно компилировать СВУ для «Электроники МК-161», размещая результат в файле eForth.mkb.<br/>
<br/>
<h4>3.3.1 Работа слов двоеточия: DOLST и EXIT</h4><br/>
Следующая после INEXT важная тема — что делает внутренний интерпретатор, встретив токен слова, определённого через двоеточия. Поле кода такого слова содержит число 2, поэтому INEXT передаёт управление на обработчик DOLST, который и выполняет нужную работу по началу интерпретации нового списка токенов.<br/>
<br/>
<pre><code class="plaintext">DOLST: ИП6 КП2 F⟳
ИП7 П6 F⟳
INEXT:</code></pre><br/>
Регистр 2, как мы уже разбирали (см. 2.1) содержит указатель стека возвратов RP. Команды ИП6 КП2 записывают в стек возвратов значение R6 — указателя интерпретации (IP). Позже это поможет вспомнить текущую позицию в старом списке токенов, где INEXT наткнулся на слово двоеточия. Теперь же ИП7 П6 переставляет IP на начало нового списка.<br/>
<br/>
Сразу после кода DOLST размещён код INEXT, который исполнит первое слово нового списка токенов. Как везде, команды F⟳ помогают сохранить два верхних элемента стека данных.<br/>
<br/>
Слова двоеточия обычно завершаются токеном EXITT, который делает обратную работу, в сравнении со DOLST — достаёт со стека возврата старое значение IP и возвращается к интерпретации старого списка токенов.<br/>
<br/>
<pre><code class="plaintext">EXITT: РКИП02 П6 Сx 1 ИП2 + П2 F⟳
INEXT:</code></pre><br/>
Команды РКИП02 П6 считывают старое значение IP с вершины стека возвратов (см. 2.1). После чего команды Сx 1 ИП2 + П2 исправляют значение RP, увеличивая его на единицу. Команда F⟳ восстанавливает стек, после чего INEXT исполняет очередное слово из старого списка токенов.<br/>
<br/>
Конечно же, INEXT не может одновременно идти и после DOLST, и после EXITT. Чтобы так сделать, мною применён один древний трюк времён СССР. Вы тоже можете его освоить, изучив соответствующие строки файла eForth0.mkl.<br/>
<br/>
<h4>3.3.2 DOVAR, обработчик переменных и массивов</h4><br/>
Слова, порождённые словами CREATE и VARIABLE, используют одинаковый обработчик DOVAR. Этот обработчик кладёт на стек адрес переменной, размещённой в поле параметров, которое идёт сразу после байта поля кода. Переменные VARIABLE занимают 2 байта, а созданные с помощью CREATE массивы содержат столько байт, сколько захочет программист.<br/>
<br/>
<pre><code class="plaintext">DOVAR: ⇔ КП3 Сx 1 ИП7 + КБП9</code></pre><br/>
Команды ⇔ КП3 сохраняют в стеке данных содержимое регистра Y. Одновременно в RY заносится число с вершины стека, освобождая RX под новое значение. После команд Сx 1 ИП7 + этим новым значением на вершине стека становится адрес поля параметров исполняемого слова. КБП9 передаёт управление INEXT, безо всяких трюков осуществляя переход к следующему слову.<br/>
<br/>
<h4>3.3.3 Обработчики констант: DOCON и DOCONM</h4><br/>
В отличии от DOVAR, <i>обработчик констант</i> обращается к полю параметров своего слова сам. DOCON считывает из него 16-битное значение константы. Это значение всегда положительно.<br/>
<br/>
<pre><code class="plaintext">DOCON: ⇔ КП3 ⇔
ИП7 П5 Сx 256
КИП5 × КИП5 + КБП9</code></pre><br/>
Команды ⇔ КП3 ⇔ сохраняют RY в стеке данных. Но на этот раз старая вершина стека данных возвращается в RX. Команды ИП7 П5 вытесняют её обратно в RY, одновременно готовя регистр-указатель R5 к считыванию значения константы. Далее Сx 256 заменяет мусор в регистре X на число 256.<br/>
<br/>
Команды КИП5 × КИП5 + считывают константу из поля параметров на вершину стека данных, то есть в RX. Как мы помним, в МК-161 первый байт всегда старший. Он и умножается на 256, после чего к произведению прибавляется младший байт константы. Вся работа сделана, КБП9 передаёт управление следующему слову.<br/>
<br/>
DOCONM работает точно также, только знак константы после считывания изменяется на противоположный. Отрицательные константы реализованы на МК-161 отдельным обработчиком ради быстродействия:<br/>
<br/>
<pre><code class="plaintext">DOCONM: ⇔ КП3 ⇔
ИП7 П5 Сx 256
КИП5 × КИП5 + /-/ КБП9</code></pre><br/>
Теперь мы полностью разобрались, как eForth исполняет свой код на «Электронике МК-161» из области данных, даже чуть затронув более глубокую тему строковых литералов (см. 3.1.5).<br/>
<br/>
Во второй статье цикла я расскажу про внешний «текстовый» интерпретатор 161eForth, разберу структуру таблиц заголовков и распознавания имени. Эта часть транслятора потребовала от меня разработки значительно более радикальных решений, на фоне которых разобранное выше — традиционный Форт, старый и добрый.<br/>
<br/>
Счастливого программирования на Форте!<br/>
<br/>
<h2>Литература</h2><br/>
<ol>
<li>Dr. Chen-Hanson Ting. eForth and Zen — 3rd Edition, 2017. Есть на Amazon Kindle.</li>
<li>Баранов С.Н., Ноздрунов Н.Р. Язык Форт и его реализации. — Л.: Машиностроение. Ленингр. отд-ние, 1988.</li>
<li>Семёнов Ю.А. Программирование на языке ФОРТ. — М.: Радио и связь, 1991.</li>
<li>Стандарт ANS Forth. X3.215-1994. <a href="http://oco.org.ua/download/forth/dpans94_ru.html">Перевод</a>.</li>
<li><a href="http://spf.sourceforge.net/docs/readme.ru.html">Документация по SP-Forth</a>.</li>
<li><a href="http://forth.org/OffeteStore/OffeteStore.html">Offete Store (труды Dr. Chen-Hanson Ting)</a>, откуда можно скачать 86eForth v5.2 для Windows, документация на английском языке.</li>
</ol><br/>
<br/>
<h2>Видеоиллюстрации</h2><br/>
Эти четыре небольших видео про 161eForth — продолжение. Первое видео в начале статьи.<br/>
<br/>
Часть 2 из 5. Тесты TEST-TEST4 из книги «eForth and Zen», 3-е издание, на МК-161.<br/>
<br/>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;"><div class="tm-iframe_temp" data-src="https://www.youtube.com/embed/7UuQSozjuJ8?rel=0&amp;showinfo=1&amp;hl=en-US" data-style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" id="" width=""></div></div></div></div><br/>
<br/>
Часть 3 из 5. Декомпилятор SEE.<br/>
<br/>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;"><div class="tm-iframe_temp" data-src="https://www.youtube.com/embed/K-mWJuL1fiQ?rel=0&amp;showinfo=1&amp;hl=en-US" data-style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" id="" width=""></div></div></div></div><br/>
<br/>
Часть 4 из 5. Точка останова BYE, терминал RS-232 и удалённый доступ к МК-161.<br/>
<br/>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;"><div class="tm-iframe_temp" data-src="https://www.youtube.com/embed/Cfj60ICJrHU?rel=0&amp;showinfo=1&amp;hl=en-US" data-style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" id="" width=""></div></div></div></div><br/>
<br/>
Часть 5 из 5. Заключительные слова.<br/>
<br/>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;"><div class="tm-iframe_temp" data-src="https://www.youtube.com/embed/oAAX29TpH9c?rel=0&amp;showinfo=1&amp;hl=en-US" data-style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" id="" width=""></div></div></div></div></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%84%D0%BE%D1%80%D1%82%5D" class="tm-tags-list__link">форт</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BF%D0%BC%D0%BA%5D" class="tm-tags-list__link">пмк</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BC%D0%BA-152%5D" class="tm-tags-list__link">мк-152</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%9C%D0%9A-161%5D" class="tm-tags-list__link">МК-161</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BeForth%5D" class="tm-tags-list__link">eForth</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/system_programming/" class="tm-hubs-list__link">
    Системное программирование
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/compilers/" class="tm-hubs-list__link">
    Компиляторы
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/forth/" class="tm-hubs-list__link">
    Forth
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 40: ↑40 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 40: ↑40 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+40</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">5.8K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    19
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/arvi1973/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_lilac"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 15 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    15
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/arvi1973/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @arvi1973
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Образование</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <div class="tm-article-author__user-contacts"><a href="https://pmk.the-hacker.ru/" rel="noopener" target="_blank" class="tm-article-author__contact">
      Сайт
    </a></div></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/452398/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 42 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/452398/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/452398/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"452398":{"id":"452398","timePublished":"2019-05-18T02:35:47+00:00","isCorporative":false,"lang":"ru","titleHtml":"EFORTH для программируемого калькулятора","leadData":{"textHtml":"\u003Ci\u003EЭто первая статья цикла про 161eForth v0.5b, окончание здесь:\u003C\u002Fi\u003E \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F452572\u002F\"\u003Ehabr.com\u002Fru\u002Fpost\u002F452572\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТранслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно прошла мои тесты, а также пять авторских тестов TEST-TEST4. Я добился того, что можно сделать в одиночку, но считаю это лишь половиной дела. Настало время представить сообществу новый инструмент, открыв код 161eForth для публичного тестирования. У меня есть список, что улучшить и где «поработать над стабильностью». Ваши предложения и замечания будут учтены при завершении работ и выпуске версии 1.0\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри переносе последней версии eForth на отечественную платформу успешно преодолены два препятствия — относительно низкое быстродействие 8-битной машинки, которая программируется на собственном входном языке, и скромный объём доступной двоичной памяти (см. 2.4.1), всего 4096 байт.\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Flx\u002F76\u002Fpw\u002Flx76pw2yfjmfnqz4wxg9pp_m6ya.jpeg\"\u002F\u003E\u003Cbr\u002F\u003E\r\n","imageUrl":null,"buttonTextHtml":null,"image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":15,"votesCount":15},"rating":0,"relatedData":null,"contacts":[{"title":"Сайт","url":"https:\u002F\u002Fpmk.the-hacker.ru\u002F","value":"https:\u002F\u002Fpmk.the-hacker.ru\u002F"}],"authorContacts":[{"title":"Сайт","url":"https:\u002F\u002Fpmk.the-hacker.ru\u002F","value":"https:\u002F\u002Fpmk.the-hacker.ru\u002F"}],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"2034917","alias":"arvi1973","fullname":null,"avatarUrl":null,"speciality":"Образование"},"statistics":{"commentsCount":42,"favoritesCount":19,"readingCount":5841,"score":40,"votesCount":40},"hubs":[{"relatedData":null,"id":"5767","alias":"system_programming","type":"collective","title":"Системное программирование","titleHtml":"Системное программирование","isProfiled":true},{"relatedData":null,"id":"17188","alias":"compilers","type":"collective","title":"Компиляторы","titleHtml":"Компиляторы","isProfiled":true},{"relatedData":null,"id":"19069","alias":"forth","type":"collective","title":"Forth","titleHtml":"Forth","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Ci\u003EЭто первая статья цикла про 161eForth v0.5b, окончание здесь:\u003C\u002Fi\u003E \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fpost\u002F452572\u002F\"\u003Ehabr.com\u002Fru\u002Fpost\u002F452572\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТранслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно прошла мои тесты, а также пять авторских тестов TEST-TEST4. Я добился того, что можно сделать в одиночку, но считаю это лишь половиной дела. Настало время представить сообществу новый инструмент, открыв код 161eForth для публичного тестирования. У меня есть список, что улучшить и где «поработать над стабильностью». Ваши предложения и замечания будут учтены при завершении работ и выпуске версии 1.0\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри переносе последней версии eForth на отечественную платформу успешно преодолены два препятствия — относительно низкое быстродействие 8-битной машинки, которая программируется на собственном входном языке, и скромный объём доступной двоичной памяти (см. 2.4.1), всего 4096 байт.\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Flx\u002F76\u002Fpw\u002Flx76pw2yfjmfnqz4wxg9pp_m6ya.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Flx\u002F76\u002Fpw\u002Flx76pw2yfjmfnqz4wxg9pp_m6ya.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nПри написании 161eForth применялись готовые решения, подготовленные для Каллисто — входного языка нового поколения для отечественных ПМК. Это технология реализации форт-машины поверх десятичного АЛУ и «гарвардской» архитектуры, драйверы консоли и раскладка алфавитно-цифровой клавиатуры, а также основанный на них программный терминал, работающий по последовательному порту RS-232. Помимо «Электроники МК-161» и дистрибутива 161eForth вам может потребоваться самодельная накладная клавиатура, где на клавишах подписаны буквы русского и английского алфавитов. Буквы расположены по алфавиту построчно, слева направо и сверху вниз.\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fff\u002Fpu\u002Fry\u002Fffpury7pflujlbysn28jipoylgg.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДоктор Чэнь-Хэнсон Тинг, автор современных версий eForth, подчёркивает в своей книге [1] важность понимания двух составляющих Форта. Это внутренний («адресный») интерпретатор, позволяющий оборудованию исполнять шитый код Форта, и внешний («текстовый») интерпретатор, отвечающий за диалог с человеком.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ двух статьях я подробно остановлюсь на наиболее радикальных решениях, использованных при реализации каждого из этих двух интерпретаторов на «Электронике». Изучение этих решений может оказаться полезным и вдохновляющим для переноса eForth на другие устройства с ограниченным объёмом памяти и производительности. Пониманию статей поможет начальное знакомство с программируемыми микрокалькуляторами (ПМК) и Фортом. Я поясню сложные моменты, уникальные для «Электроники МК» и транслятора eForth.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНачну с того, что слова eForth делятся на общеполезные и системные. \u003Cb\u003EРазмер букв имеет значение. Имена обычных слов определены заглавными буквами, а системных — строчными.\u003C\u002Fb\u003E Свои нововведения в eForth я также сделал строчными буквами. Автор eForth предлагает вести основной диалог в режиме CAPS. Когда вам нужно использовать системное слово, переключитесь на время в строчные буквы (комбинация клавиш F P).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ статье все слова пишутся заглавными буквами, чтобы выделяться из текста. В нескольких ранних реализациях eForth заголовки системных слов были исключены и не выводились командой WORDS. Это помогало упростить внешний вид eForth и экономить внимание тех, кто впервые пользуется Фортом. В 161eForth заголовки этих слов сохранены в первую очередь из-за наличия декомпилятора слов двоеточия SEE (см. видео №3 в конце статьи), который не покажет имена системных слов, если убрать их заголовки.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы упорядочить статью и сделать её полезной, как справочник, несколько терминов мне пришлось употребить до их определения. Специалистам по Форту и ПМК эти термины должны быть знакомы. Новичкам иногда придётся заглядывать в соседние разделы (я проставил ссылки в нужных местах) или перечитать статью пару раз.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСам 161eForth выложен здесь, вместе с исходным текстом, рисунком накладной клавиатуры и справкой words.txt с описанием всех реализованных слов: \u003Ca href=\"http:\u002F\u002Fthe-hacker.ru\u002F2019\u002F161eforth0.5b.zip\"\u003Ehttp:\u002F\u002Fthe-hacker.ru\u002F2019\u002F161eforth0.5b.zip\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакже я выложил 5 маленьких видео на YouTube, иллюстрирующих работу 161eForth для тех, у кого нет МК-161. Можно \u003Ca href=\"https:\u002F\u002Fwww.youtube.com\u002Fplaylist?list=PLr5CZvfCYpd7I0mSe2k61i00E2YZro7BC\"\u003Eпосмотреть весь плейлист на YouTube\u003C\u002Fa\u003E. Ниже первое из них, остальные 4 в конце статьи.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv\u003E\u003Cdiv style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002FRxarUWHdNTE?rel=0&amp;showinfo=1&amp;hl=en-US\" data-style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" id=\"\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EeForth и его реализации\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\neForth разрабатывался, как современная замена широко известного транслятора фиг-Форта. Для переноса на МК-161 мною была выбрана 32-битная версия 5.2 транслятора 86eForth с косвенным шитым кодом, написанная в 2016 году на ассемблере MASM для операционной системы Windows. Эта версия подробно описана в третьем издании книги «eForth and Zen» [1]. Знающим английский советую разыскать и изучить эту книгу, она весьма полезна для понимания 161eForth.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ личном письме автор подтвердил, что 86eForth502.asm из этой книги — последняя версия eForth. В Интернете можно найти много англоязычной информации и по этой, и по предыдущим версиям eForth.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРазвитие eForth шло по научному пути, которому учит профессор Вирт на примере своего языка программирования Оберон. Каждая последующая версия eForth была упрощением предыдущей версии. Всё, без чего можно обойтись, убиралось из языка. Остался тщательно продуманный набор сильных, выразительных языковых конструкций, чья мощь проверена на более, чем 40 реализациях eForth для разнообразных платформ. Теперь и на калькуляторе!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nБудучи минималистичным диалектом Форта, eForth не ставит своей целью победить в гонке на самый крохотный Форт. Предлагаемый им набор слов вполне практичен и может легко расширяться программистом в нужную для его задач сторону.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПервая версия eForth была выпущена в 1990 году на ассемблере MASM для процессоров 8086 и работала под MS-DOS. Она содержала 31 машинно-зависимое слово ядра и 191 слово высокого уровня. Идея была проста — вы переводите на свой ассемблер всего 31 слово, и сразу получаете eForth на своём компьютере.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакой подход подвергся критике в Интернете, так как путь минимизации количества слов на ассемблере привёл к крайне низкому быстродействию для встроенных систем. Уже во второй версии eForth на ассемблере стало реализовываться максимальное количество слов, что выправило крен в сторону не только легко переносимой, но и практичной системы программирования.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНесколько лет Билл Мунч, первоначальный автор eForth, и его коллега д-р Чэнь-Хэнсон Тинг выпускали свои релизы eForth параллельно. У каждой версии были свои особенности. К вариантам eForth для разных платформ прилагали свои усилия и другие программисты.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВерсия 5.2, выпущенная в 2016 году, содержит 71 слово «кода» и 110 слов «двоеточия». Четверть века поиска идеала привели к значительному уменьшению общего количества слов. При этом из соображений производительности увеличился процент слов, реализованных на низком уровне.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПредлагаемый 161eForth пользуется щедрыми плодами этого прогресса, но не претендует на дальнейшее развитие магистральной линии. Моя реализация предоставляет программисту все инструменты, присутствующие в версии 5.2. Когда архитектура МК-161 делает реализацию некоторых слов 86eForth невозможной или бессмысленной, вместо выкидывания лишнего я предоставляю программистам полноценную замену, взяв её из стандарта ANSI\u002FISO [4]. Ищущие минимализма могут самостоятельно выкинуть «лишние» слова, ведь по традиции 161eForth поставляется с исходным кодом.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри реализации eForth я придерживался авторского понимания. Например, по моему глубокому убеждению цикл FOR NEXT с начальным значением n должен выполняться ровно n раз. К такому же выводу со временем пришёл Чак Мур, автор языков Forth и colorForth. К сожалению, eForth использует устаревшее соглашение и выполняет такой цикл n+1 раз, со счётчиком от n до 0. Я не стал исправлять этот и несколько других недостатков, отдав предпочтение совместимости 161eForth с реализациями для других платформ.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПоскольку 161eForth является первой практичной системой программирования «на борту» для «Электроники МК-161», если не считать заводского языка, я проследил многолетнюю историю eForth и вернул в язык несколько слов, которые были полезными на других платформах и могут оказаться востребованными сейчас.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНапример, новая-старая переменная ‘BOOT содержит токен (см. 3.1) слова, который выполняется первым после инициализации среды, но до начала диалога. По умолчанию ‘BOOT содержит токен TLOAD для интерпретации кода из «области текста» (см. 2.4.2). Это позволяет программисту подстраивать eForth под себя без перекомпиляции среды, которую пока невозможно производить на борту «Электроники».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПриоритетными задачами реализации были экономия двоичной памяти (см. 2.4.1) и повышение быстродействия. Их решение привело к драматичному уменьшению количества слов высокого уровня, ведь их код занимает эту драгоценную память, за счёт увеличения количества быстрых слов ядра, реализованных в дешёвой памяти программ (см. 2.4.3).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ итоге 161eForth содержит 129 слов кода, 78 слов высокого уровня и занимает 1816 байт двоичной памяти МК-161, то есть меньше её половины. Это даёт надежду на метакомпиляцию своей высокоуровневой части прямо на борту «Электроники».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИсходный текст eForth для МК-161 разбит на две крупные части. Написанное в системе команд МК-161 ядро содержится в файле eForth0.mkl. Слова высокого уровня определены на языке SP-Forth и размещены в файле eForth.f.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакже в дистрибутиве есть справочный файл words.txt, в котором документированы все слова 161eForth со стековой нотацией и кратким пояснением, в одну строчку.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E1.1 Исходный текст ядра eForth0.mkl\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nЯдро eForth содержит исполняемый код, работающий в памяти программ МК-161 (см. 2.4.3), который компилируется на компьютере в файл eForth0.mkp стандартными средствами, например фирменным компилятором MKL2MKP.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИсходный текст ядра, содержащийся в файле eForth0.mkl, написан в \u003Ci\u003Eлатинской мнемонике\u003C\u002Fi\u003E. Например, команда ИПЕ для чтения регистра Е (он же R14) записывается в этой мнемонике, как RME. Будучи непривычной для владельцев советских ПМК, латинская мнемоника удобна для ввода с клавиатуры компьютеров. Действительно, набрать странное FX^2 проще, чем знакомое с детства Fx².\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nФайл eForth0.mkp является заготовкой ядра. Помимо кода примитивов он содержит заголовок ядра и таблицу имён tblNames, которую eForth.f во время компиляции переносит в десятичные регистры (см. 2.4.4). Именно на основе eForth0.mkp будет создано ядро eForth.mkp (см. 2.4.3), поэтому eForth0.mkl должен быть откомпилирован первым.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E1.2 Исходный текст слов высокого уровня eForth.f\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nФайл eForth.f подаётся на вход замечательного отечественного компилятора SP-Forth [5]. Файл содержит определения всех слов высокого уровня. Со временем их можно будет определить на самом eForth и, возможно, компилировать прямо на борту «Электроники МК-161».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВо время компиляции eForth.f считывает заготовку ядра eForth0.mkp и с её помощью создаёт в текущем каталоге три файла для последующей загрузки в МК-161: eForth.mkp, eForth.mkd и eForth.mkb. Именно eForth.mkb содержит тела слов высокого уровня, хотя их заголовки размещены в файле eForth.mkd.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧетвёртый файл, eForth.mkt, написан на eForth вручную и может редактироваться на борту МК-161 с помощью встроенного редактора текста. Каждый из этих четырёх файлов я подробнее разберу ниже (см. 2.4).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003E2. Электроника МК-161\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПроизводитель из Новосибирска называет МК-161 старинным сокращением ЭКВМ. Так назывались в СССР самые первые калькуляторы. Система команд МК-161 наследует системе команд советских калькуляторов «Электроника Б3-34» и «Электроника МК-61». Это означает, что программы, написанные для советских калькуляторов, пойдут на МК-161 без изменений или с незначительными изменениями.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОбратное неверно. eForth не пойдёт на советских ПМК, т.к. задействует множество ресурсов, появившихся впервые в МК-152\u002F161 и отсутствовавших в предыдущих моделях серии.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРассмотрим особенности входного языка и архитектуры МК-161, повлиявшие на 161eForth (далее просто eForth) и давшие обсуждаемой реализации eForth «русский акцент».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПервая из этих особенностей — последовательно выдерживающееся в МК-161 \u003Cb\u003Eсоглашение «старшее по младшему адресу»\u003C\u002Fb\u003E. Например, число 1000=3×256+232 будет записано в двух последовательных байтах, как 3 и 232.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E2.1 Косвенная адресация\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nПрограммировавшие советские ПМК слышали про косвенную адресацию. При \u003Ci\u003Eпрямой адресации\u003C\u002Fi\u003E мы явно указываем номер регистра, к которому обращаемся. Например Р ИП 44 считает содержимое регистра 44. Клавиша Р, появившаяся в МК-152, используется для обращения к регистрам с номером 15 и больше — эти регистры отсутствовали в советских ПМК.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри \u003Ci\u003Eкосвенной адресации\u003C\u002Fi\u003E номер нужного регистра заранее не известен. Этот номер содержится в другом регистре. Например, если регистр 8 содержит число 44, команда К ИП 8 считает содержимое регистра 44 (R44).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКлавиши К и Р можно комбинировать. Например, команда Р К БП 20 передаст управление (GOTO в латинской мнемонике) на адрес, хранящийся в R20.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОсобенность, оказавшаяся важной для внутреннего интерпретатора eForth, связана с предварительным увеличением \u002F уменьшением регистров при косвенной адресации. Эта особенность унаследована от советских ПМК.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНапример, команды косвенного чтения К ИП 0, К ИП 1, К ИП 2 и К ИП 3 перед обращением к нужному регистру уменьшают на единицу содержимое регистров 0, 1, 2 или 3. Команды К ИП 4, К ИП 5 и К ИП 6 перед считыванием увеличивают на единицу содержимое регистров 4, 5 или 6.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТакая «модификация» адресного регистра позволяет обрабатывать в цикле целые группы регистров. Она похожа на ++R и --R в Си. Номер регистра-указателя важен. Именно он определяет, произойдёт его увеличение (регистры 4-6) или уменьшение (регистры 0-3) при косвенной адресации.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНа архитектуру 161eForth повлияло то, что увеличение регистров 4-6 при косвенной адресации — \u003Ci\u003Eпредварительное\u003C\u002Fi\u003E. В результате указатель интерпретации (IP), размещённый в R6, всегда \u003Ci\u003Eуказывает на последний считанный байт\u003C\u002Fi\u003E шитого кода. В 86eForth IP всегда указывает на последующий байт, ещё не считанный.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЭто верно и для указателя стека возвратов (RP), хранящегося в регистре 2. R2 всегда указывает на вершину стека возвратов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПолезной особенностью МК-161 является отсутствие увеличения \u002F уменьшения регистра, если косвенная адресация происходит с новой клавишей Р. Например, РКИП02 считает число с вершины стека возвратов, не меняя указатель. Это готовая команда Форта R@. Из написанного выше следует, что считанное значение на единицу меньше, чем адрес следующего токена, который выполнится после возврата из слова «двоеточия».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКогда вам придётся разрабатывать или изучать слова, тесно взаимодействующие с внутренним интерпретатором eForth — убедитесь, что до конца поняли этот тонкий момент, связанный с \u003Cb\u003Eпредувеличением\u003C\u002Fb\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E2.2 Таблицы, упорядоченные и ассоциативные\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nТаблицы МК-161 размещаются в памяти программ (см. 2.4.3). Они появились в новосибирской «Электронике МК» и совершенно незнакомы экспертам по советским ПМК. Адрес используемой таблицы всегда хранится в регистре 9042, а вот обращение к ним различается.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ci\u003EУпорядоченная таблица\u003C\u002Fi\u003E это массив беззнаковых 16-битных целых. eForth содержит такую таблицу tblTokens с адресами примитивов (см. 3.1.1) — слов Форта, написанных в системе команд МК-161. Адресный интерпретатор (см. 3.2) использует tblTokens для быстрого исполнения шитого кода, поэтому eForth старается, чтобы в R9042 всегда содержался адрес этой таблицы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДля обращения к упорядоченной таблице надо записать номер нужного элемента в R9210. Число n в регистре X заменится на значение элемента таблицы с номером n, отсчёт начинается с нуля.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ci\u003EАссоциативные таблицы\u003C\u002Fi\u003E («поиск по значению») активно используются eForth, в первую очередь примитивом (FIND), ищущим слово по его имени. Также ассоциативная таблица tblCHPUT используется при выводе литеры на экран, чтобы обрабатывать перевод строки и другие управляющие коды.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДля поиска элемента n в ассоциативной таблице требуется записать n в R9212. Число n в регистре X (руководство его называет «индексом») заменится на 16-битное значение, записанное в таблице сразу после его «индекса» n.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНаличие этой быстрой, хотя и простенькой функции поиска, реализованной на ассемблере в «прошивке» МК-161, помогло eForth добиться приемлемого быстродействия при распознавании имён слов и компиляции программ. Конечно, для этого пришлось разработать не самые простые таблицы распознавания имени, «заточенные» под эту функцию. Об этом поговорим подробней во второй статье.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E2.3 Прерывания и консоль\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n«Электроника МК» позволяет её владельцам писать программы на входном языке, реагирующие на определённые события — такие, как нажатие или отпускание кнопки, окончание счёта таймера.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\neForth активно использует эту \u003Ci\u003Eсистему прерываний\u003C\u002Fi\u003E как для ввода с клавиатуры и отображения мигающего курсора при запросе такого ввода, так и для ввода-вывода через универсальный последовательный порт (RS-232).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВведённые с клавиатуры литеры ставятся в очередь bufKbd по мере нажатия клавиш. Это очень удобно и экономит время на системах с низким быстродействием. Переключения алфавитов и регистра обрабатываются прерыванием KeyPress и не занимают место в очереди. Долгое нажатие на клавишу вызывает автоповтор.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКогда очередь из 8 литер заполнена, а eForth ещё не готов обработать ввод (ситуация очень редкая), МК-161 издаст недовольный писк. Конечно, всю эту естественную работу клавиатуры хотелось бы не реализовывать в трансляторе, а получить «из коробки» МК-161, как сервис встроенной программы (прошивки). Но уж чем, как говорится, богаты.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосле начала работы весь вывод eForth направлен на \u003Ci\u003Eграфический экран\u003C\u002Fi\u003E МК-161. Вывод литеры на него осуществляет относительно простая подпрограмма ChPut. Единственная сложность здесь связана с реализацией управляющего кода BS, «пробела назад». МК-161 использует пропорциональный шрифт. Поэтому в специальном буфере tblBS приходится запоминать позиции выведенных символов, откуда их позже берёт код вывода BS.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВо время диалога пользователь может с помощью слова IO\u003E перенаправить весь ввод-вывод в последовательный порт RS-232, что даёт возможность \u003Cb\u003Eпрограммировать МК-161 с привычной клавиатуры компьютера или с другой МК-161\u003C\u002Fb\u003E. Слово CON\u003E возвращает управление на консоль калькулятора.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E2.4 Области памяти и установка eForth на МК-161\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nПамять «Электроники МК-161» состоит из отдельно адресуемых памяти программ и регистровой памяти данных. В свою очередь, регистровая память неоднородна и делится на три большие области.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРегистры с номерами от 0 до 999 хранят «десятичные числа». Это обычные регистры, как в «Электронике Б3-34» и других калькуляторах. Просто способны хранить не 8, а 12 десятичных знаков «мантиссы».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРегистры с номерами от 1000 до 8167 хранят целые от 0 до 255. Последние 3 Кбайта этой области с адресами от 5096 до 8167 называются \u003Ci\u003Eобластью текста\u003C\u002Fi\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nРегистры с номерами от 9000 до 9999 называются \u003Ci\u003Eрегистрами функций\u003C\u002Fi\u003E. Эта служебная область адресного пространства напоминает порты ввода-вывода микропроцессоров. С помощью команд записи и чтения по этим адресам реализуется доступ к устройствам ввода-вывода, системе прерываний и т.п.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы установить eForth на «Электронику МК-161», достаточно передать в калькулятор четыре файла, например с помощью программы производителя MK.EXE:\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003EЗаписать eForth.mkp в память программ, начиная со страницы 0. Версия 0.5b занимает 74 страницы.\u003C\u002Fli\u003E\r\n\u003Cli\u003EЗаписать eForth.mkd в память десятичных данных\u003C\u002Fli\u003E\r\n\u003Cli\u003EЗаписать eForth.mkb в память двоичных данных\u003C\u002Fli\u003E\r\n\u003Cli\u003EЗаписать eForth.mkt в память текста\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\nПосле передачи на калькулятор рекомендую тут же \u003Cb\u003Eсохранить эти четыре файла в отдельном каталоге\u003C\u002Fb\u003E встроенного «электронного диска». Поскольку имя у них одинаковое, загрузить eForth можно сразу за один раз, как «пакет».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E2.4.1 Двоичная («байтовая») память МК-161: eForth.mkb\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nРегистры «Электроники МК» с номерами от 1000 до 5095 используются для хранения чисел от 0 до 255. Эта область регистровой памяти калькулятора называется двоичной. К двум последовательным двоичным регистрам можно обращаться из eForth, как к одной 16-битной «ячейке», причём (как везде на МК-161) старшие 8 бит находятся в регистре с меньшим номером.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\neForth использует эту крошечную «двоичную память», как свою основную. Именно с ней работают слова ! и @, HERE и ALLOT, только отсюда исполняет шитый код адресный интерпретатор (см. 3.2). Здесь расположены переменные eForth, буфер ввода текста (TIB), словарь и стек откатов tblBS для реализации пробела назад.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n4096 байт это очень скромно, по современным меркам. Поэтому огромные усилия были затрачены, чтобы вынести в другие области памяти всё, что только возможно.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E2.4.2 Область текста: eForth.mkt\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nСразу за двоичной памятью следует \u003Ci\u003Eобласть текста\u003C\u002Fi\u003E, регистры с номерами от 5095 до 8167. Технически это такие же байтовые регистры, но возможность их записывать на диск и считывать отдельным файлом делают эту область особенной.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДля работы с «текстом» в eForth служит слово TLOAD. Оно подаёт всю эту область на вход текстового интерпретатора, как строку, длиной в 3072 литеры.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСуществуют разногласия, как текст разбивать на строки. Редактор, встроенный в «Электронику МК», настаивает на длине строки в 24 литеры. Каллисто использует соглашение Форта, где строка содержит 64 литеры. eForth предоставляет выбор пользователю, считая весь текст одной длинной строкой. Можете использовать встроенный редактор МК-161. Можете написать свой, совместимый с Каллисто.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВот начальное содержимое eForth.mkt, для удобства разбитое на три строчки:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E: hi  .\" Привет, %user%!\" CR ;\n‘ hi  ‘boot !\nhi \\\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nПервая строка определяет новое слово hi, приветствующее пользователя. Вторая строка берёт токен этого слова (см. 3.1) и размещает в переменной ‘BOOT (см. 1). Теперь область текста перестанет компилироваться при каждом запуске eForth. Вместо этого выполнится уже скомпилированное приветствие.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПоследняя строка запускает слово hi, выводя приветствие на экран. Слово \\ заканчивает интерпретацию текста, возвращая управление на пульт.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы скомпилировать произвольный файл текста, вам надо выйти в калькулятор командой BYE, выйти в главное меню и загрузить нужный файл в режиме ДОС. Также можно передать файл mkt с компьютера. Клавиша С\u002FП вернёт вас в eForth, после чего командой TLOAD вы сможете откомпилировать файл, загруженный в область текста.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E2.4.3 Память программ: eForth.mkp\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nПамять программ МК-161 — изолированное адресное пространство. Оно тоже хранит байты, но они доступны только для чтения. Память программ содержит 10000 «шагов», что оказалось избыточным для eForth. Больше четверти памяти программ оказалась свободной, что даёт неплохой задел для развития транслятора.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТолько в памяти программ могут быть реализованы «слова кода». Также сюда вынесены таблицы распознавания имени и все известные текстовые строки, что экономит двоичную память.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНекоторые слова, например C@, COUNT и TYPE, могут адресовать память программ, если адрес не является положительным числом. Например, фраза 0 C@ считает «шаг» (байт) с адреса 0 памяти программ.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E2.4.4 Десятичная память: eForth.mkd\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nРегистры «Электроники МК» с номерами от 0 до 999 называются десятичными и содержат числа, используемые для обычных расчётов на калькуляторе — 12 десятичных знаков «мантиссы» и 2 десятичных знака «порядка». Форт рассчитан на работу с целыми числами до 4 байт длиной, такой ресурс явно избыточен для eForth.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДесятичная память использована для экономии драгоценной двоичной памяти. Сюда вынесены стеки данных и возвратов. Здесь же хранятся заголовки слов — как определяемых пользователем, так и встроенных, по одному регистру на заголовок. Такой подход позволяет переопределять даже слова, имеющие стандартные имена.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСтек в десятичной памяти приводит к ряду особенностей, характерных для Форта на МК-161. Во-первых, диапазон значений элементов стека огромен, он способных вмещать 32-битные целые. Необходимость «двойных целых» на МК-161 отпадает, хотя ради совместимости соответствующие слова eForth мною реализованы. «Двойные целые» представлены на МК-161, как два элемента стека, содержащие числа от 0 до 65535, кодирующие одно 32-битное целое со знаком в дополнительном коде. Старшие 16 бит такого числа размещается сверху, то есть по младшему адресу.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПобитовые логические операции AND, OR, XOR и NOT рассматривают свои аргументы, как 16-битные целые. Результат от 32768 до 65535 преобразуется в отрицательные числа от -32768 до -1. В eForth ложь кодируется нулём, а истина минус единицей. Также истиной считается любое значение, отличное от нуля.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВторая особенность стека данных 161eForth — он содержит числа со знаком. Когда слово @ считывает число 65535 из 16-битной «ячейки», оно автоматически преобразовывается в -1. Предусмотрено \u003Cb\u003Eспециальное «беззнаковое» слово U@\u003C\u002Fb\u003E для того, чтобы считать непосредственно 65535, со знаком «плюс».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nУпомяну, что ради быстродействия \u003Cb\u003Eдва верхних элемента стека\u003C\u002Fb\u003E данных расположены не в десятичной памяти, а непосредственно \u003Cb\u003Eв регистрах X и Y\u003C\u002Fb\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТот факт, что десятичные регистры могут содержать дробные числа и числа с плавающей запятой, никак не используется eForth. Виртуальная машина eForth использует эти регистры для хранения 12-разрядных десятичных целых со знаком. Обращение к десятичным регистрам осуществляют слова C@ и C! — те же самые, что работают с любыми одиночными регистрами.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003E3. Внутренний интерпретатор\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nЯдро eForth это программа, написанная на входном языке МК-161. Её первая команда БП MAIN передаёт управление коду MAIN, который первым делом выясняет обстоятельства перезагрузки. Если её вызвал неправильный токен, МК-161 пискнет. При первом запуске, а также после включения МК-161, экран очищается. Далее MAIN вызывает подпрограмму Init для инициализации системы прерываний и всего, что нужно драйверам консоли МК-161.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосле инициализации стеков данных и возвратов низкоуровневая часть старта завершена. Происходит невероятное для машин с гарвардской архитектурой — eForth переходит к исполнению «шитого кода» из байтовой памяти. Честь быть первым принадлежит слову, адрес заголовка которого записан в R43. Обычно это слово COLD.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКак же устроены \u003Ci\u003Eслова высокого уровня\u003C\u002Fi\u003E (СВУ)? Любое слово состоит из двух частей, тела и заголовка. \u003Ci\u003EЗаголовок\u003C\u002Fi\u003E хранится в десятичном регистре. Он помогает внешнему интерпретатору и декомпилятору найти имя и тело слова. Заголовок также содержит \u003Ci\u003Eполе «лексикона»\u003C\u002Fi\u003E — набор флагов, помогающих внешнему интерпретатору правильно обработать найденное слово. Внутреннему интерпретатору намного важнее тело СВУ, расположенное в двоичной памяти и хранящееся в словаре. Он способен даже исполнять слова, у которых заголовок отсутствует.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ci\u003EТело\u003C\u002Fi\u003E СВУ начинается с байта \u003Ci\u003Eполя кода\u003C\u002Fi\u003E, который содержит адрес \u003Ci\u003Eобработчика\u003C\u002Fi\u003E данного слова. Четыре обработчика СВУ написаны на входном языке МК-161 и начинаются на первой странице памяти программ. Мы разберём их все (см. 3.3), но главный из них называется DOLST и расположен по адресу 02, сразу после уже рассмотренной команды БП MAIN. Этот обработчик исполняет слова Форта, определённые с помощью двоеточия.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПосле байта поля кода идёт \u003Ci\u003Eполе параметров\u003C\u002Fi\u003E, произвольной длины. В «словах двоеточия» поле параметров содержит «шитый код» — последовательность 16-битных токенов, каждый из которых обозначает одно, закреплённое за ним действие.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСперва мы рассмотрим токен подробнее. Потом изучим внутренний интерпретатор INEXT, осуществляющий переход от одного токена к исполнению следующего. Автор eForth называет INEXT обработчиком примитивов. Завершим мы эту экскурсию по внутреннему интерпретатору разбором всех четырёх обработчиков СВУ.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E3.1 Токены\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EТокен\u003C\u002Fi\u003E представляет слово в шитом коде и стеке, позволяя его быстро выполнить. Токен — указатель на тело слова, но суровая архитектура МК-161 внесла в эту простую идею свои коррективы. Разберём все виды токенов, начиная с токена примитивов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.1.1 Токен примитива\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nВсё слова, входящие в дистрибутив eForth, пронумерованы от 0 до 206. Эта нумерация сквозная, учитывающая как примитивы, так и СВУ. Так сделано, чтобы по номеру слова было легко восстановить его \u003Ci\u003Eимя\u003C\u002Fi\u003E. Эти имена хранятся в памяти программ. Ссылку на нужное имя легко найти через таблицу заголовков.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cb\u003EНомер примитива и является его токеном\u003C\u002Fb\u003E. Как любой токен, примитив занимает в шитом коде два байта. Первый равен нулю. Второй содержит его номер. Таблица tblTokens позволяет быстро найти адрес кода примитива по этому номеру. Адрес tblTokens постоянно хранится в R9042 (см. 2.2), то есть для исполнения примитива всё всегда под рукой.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСлово XT\u003E позволяет узнать адрес кода примитива по его номеру (токену). Так как код примитивов всегда располагается в памяти программ, полученный адрес всегда отрицательный (см. 2.4.3).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.1.2 Токен СВУ\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nСВУ может иметь свой номер и связанное с ним стандартное имя, а может быть совершенно новым, созданным пользователем. Во всех случаях \u003Cb\u003Eтокен СВУ — адрес его поля кода\u003C\u002Fb\u003E (см. 3), то есть число от 1000 до 5095.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ шитом коде токен СВУ записывается весьма необычным образом. В первый байт записывается число сотен (число от 10 до 50), во второй — остаток от деления токена на 100 (число от 0 до 99).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНапример, токен 1234 будет представлен двумя байтами 12 и 34. Компиляцию такого, да и любого другого токена осуществляет взятое из стандарта ANSI слово COMPILE,. Для записи и чтения токенов СВУ в шитом коде служат слова XT! и XT@. Они же осуществляют доступ к адресам (см. 3.1.4), а слово XT@ способно также считать токен примитива.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.1.3 Целые литералы\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EЦелые литералы\u003C\u002Fi\u003E — разновидность токенов примитивов. Они достаточно необычны, чтобы рассмотреть их отдельно.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ шитом коде токены DOLIT и DOLITM занимают четыре байта. Первые два байта содержат уже рассмотренный токен примитива, то есть 0 и номер примитива. Последующие два байта содержат целое, которое данный литерал при исполнении положит на стек данных.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nDOLITM отличается тем, что меняет знак числа перед тем, как положить его на стек. Он предназначен для реализации отрицательных чисел.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.1.4 Адресные литералы\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nПодобно целым литералам, три \u003Ci\u003Eадресных литерала\u003C\u002Fi\u003E BRANCH, ?BRANCH и DONXT занимают в шитом коде по 4 байта каждый. Первые 2 байта содержат токен примитива, последние два — адрес перехода.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nАдрес записывается в том же формате, что и токен СВУ (см. 3.1.2). В первом байте идёт количество сотен, во втором — остаток от деления адреса на 100. Напомню, что из-за предувеличения (см. 2.1) адрес перехода содержит не адрес нужного токена, а число, на единицу меньшее.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТокен DONXT помогает реализовать «конечный цикл» FOR-NEXT (см. 1). Безусловный переход BRANCH нужен для реализации бесконечного цикла BEGIN-AGAIN. Условный переход ?BRANCH передаёт управление, если на вершине стека данных находится ноль («ложь»). Он служит для реализации условного оператора IF-THEN, выходов из «неопределённых циклов» BEGIN-UNTIL и BEGIN-WHILE-REPEAT.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.1.5 Строковые литералы\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\n\u003Ci\u003EСтроковые литералы\u003C\u002Fi\u003E — разновидность токенов СВУ. В шитом коде строкового литерала после токена идёт байт с длиной строки, после которого — сама строка, от первого байта до последнего.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ eForth три строковых литерала: $\"|, .\"| и abort\"|. Они определены в файле eForth0.mkl, как токены STRQP, DOTQP и ABORQ соответственно. Основную «литеральную» работу выполняет за них слово do$, токен DOSTR.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы сделать размер статьи разумным, я не могу останавливаться слишком подробно на этой интересной теме, но неплохо знать об их наличии в eForth.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E3.2 Адресный интерпретатор\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nПришло время рассмотреть \u003Ci\u003Eинтерпретатор токенов\u003C\u002Fi\u003E, адрес которого всегда записан в регистре 9. Большинство примитивов завершают свою работу командой К БП 9, которая передаёт управление на метку INEXT.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EINEXT: КИП6 Fx≠0 NPrime\nNData: ВП 2 КИП6 + П7 F⟳\nКИП7 П8 F⟳ КБП8\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nПервым делом адресный интерпретатор считывает командой КИП6 первый байт очередного токена. Если он нулевой, это примитив и обработкой токена займётся код под меткой NPrime.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nМеткой NData обозначена обработка токена СВУ. Первый байт умножается на сто командой ВП 2, после чего КИП6 + прибавляет к результату второй байт токена (см. 3.1.2). Считанный токен заносится командой П7 в «рабочий регистр» WP (R7).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nМы знаем, что токен СВУ это адрес его поля кода, в котором содержится адрес обработчика. Команды КИП7 П8 считывают байт поля кода в R8, а команда КБП8 передаёт управление обработчику СВУ. Обработчик знает, что в R7 находится число, на единицу меньшее адреса поля параметров обрабатываемого слова.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКоманды F⟳ с кодом 25 «прибираются» в стеке. Дело в том, что eForth хранит два верхних элемента стека данных непосредственно в регистрах X и Y стека МК-161. Такое решение ускоряет работу, но заставляет следить, чтобы эти важные данные не потерялись.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОсталось разобрать, как адресный интерпретатор исполняет примитивы.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ENPrime: F⟳ КИП6 РРП9210 П8 F⟳ КБП8\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКоманда КИП6 считывает второй байт токена примитива. Команды РРП9210 П8 считывают из таблицы tblTokens адрес этого примитива (см. 2.2 и 3.1.1), а КБП8 передаёт этому примитиву управление.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКак и выше, F⟳ убирают лишнее из стека, восстанавливая содержимое регистров X и Y.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nАдресный интерпретатор eForth такой крохотный, что он несколько раз продублирован в памяти программ. Основная копия исполняется по команде К БП 9, которой завершается большинство примитивов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ качестве упражнения рекомендую изучить реализацию слова EXECUTE, размещённую после метки EXECU. Это вариант INEXT, который считывает токен не из шитого кода, а берёт его со стека данных.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003E3.3 Обработчики СВУ\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nЧетыре разновидности СВУ имеют четыре разных обработчика: DOLST, DOVAR, DOCON и DOCONM. Выше мы уже видели, что адресный интерпретатор перед вызовом обработчика оставляет в R7 адрес поля кода обрабатываемого слова.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\neForth.f узнаёт адреса этих обработчиков, считав заголовок ядра из файла eForth0.mkp. Это помогает ему правильно компилировать СВУ для «Электроники МК-161», размещая результат в файле eForth.mkb.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.3.1 Работа слов двоеточия: DOLST и EXIT\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nСледующая после INEXT важная тема — что делает внутренний интерпретатор, встретив токен слова, определённого через двоеточия. Поле кода такого слова содержит число 2, поэтому INEXT передаёт управление на обработчик DOLST, который и выполняет нужную работу по началу интерпретации нового списка токенов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EDOLST: ИП6 КП2 F⟳\nИП7 П6 F⟳\nINEXT:\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nРегистр 2, как мы уже разбирали (см. 2.1) содержит указатель стека возвратов RP. Команды ИП6 КП2 записывают в стек возвратов значение R6 — указателя интерпретации (IP). Позже это поможет вспомнить текущую позицию в старом списке токенов, где INEXT наткнулся на слово двоеточия. Теперь же ИП7 П6 переставляет IP на начало нового списка.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСразу после кода DOLST размещён код INEXT, который исполнит первое слово нового списка токенов. Как везде, команды F⟳ помогают сохранить два верхних элемента стека данных.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСлова двоеточия обычно завершаются токеном EXITT, который делает обратную работу, в сравнении со DOLST — достаёт со стека возврата старое значение IP и возвращается к интерпретации старого списка токенов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EEXITT: РКИП02 П6 Сx 1 ИП2 + П2 F⟳\nINEXT:\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКоманды РКИП02 П6 считывают старое значение IP с вершины стека возвратов (см. 2.1). После чего команды Сx 1 ИП2 + П2 исправляют значение RP, увеличивая его на единицу. Команда F⟳ восстанавливает стек, после чего INEXT исполняет очередное слово из старого списка токенов.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКонечно же, INEXT не может одновременно идти и после DOLST, и после EXITT. Чтобы так сделать, мною применён один древний трюк времён СССР. Вы тоже можете его освоить, изучив соответствующие строки файла eForth0.mkl.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.3.2 DOVAR, обработчик переменных и массивов\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nСлова, порождённые словами CREATE и VARIABLE, используют одинаковый обработчик DOVAR. Этот обработчик кладёт на стек адрес переменной, размещённой в поле параметров, которое идёт сразу после байта поля кода. Переменные VARIABLE занимают 2 байта, а созданные с помощью CREATE массивы содержат столько байт, сколько захочет программист.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EDOVAR: ⇔ КП3 Сx 1 ИП7 + КБП9\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКоманды ⇔ КП3 сохраняют в стеке данных содержимое регистра Y. Одновременно в RY заносится число с вершины стека, освобождая RX под новое значение. После команд Сx 1 ИП7 + этим новым значением на вершине стека становится адрес поля параметров исполняемого слова. КБП9 передаёт управление INEXT, безо всяких трюков осуществляя переход к следующему слову.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch4\u003E3.3.3 Обработчики констант: DOCON и DOCONM\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\nВ отличии от DOVAR, \u003Ci\u003Eобработчик констант\u003C\u002Fi\u003E обращается к полю параметров своего слова сам. DOCON считывает из него 16-битное значение константы. Это значение всегда положительно.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EDOCON: ⇔ КП3 ⇔\nИП7 П5 Сx 256\nКИП5 × КИП5 + КБП9\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nКоманды ⇔ КП3 ⇔ сохраняют RY в стеке данных. Но на этот раз старая вершина стека данных возвращается в RX. Команды ИП7 П5 вытесняют её обратно в RY, одновременно готовя регистр-указатель R5 к считыванию значения константы. Далее Сx 256 заменяет мусор в регистре X на число 256.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКоманды КИП5 × КИП5 + считывают константу из поля параметров на вершину стека данных, то есть в RX. Как мы помним, в МК-161 первый байт всегда старший. Он и умножается на 256, после чего к произведению прибавляется младший байт константы. Вся работа сделана, КБП9 передаёт управление следующему слову.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nDOCONM работает точно также, только знак константы после считывания изменяется на противоположный. Отрицательные константы реализованы на МК-161 отдельным обработчиком ради быстродействия:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EDOCONM: ⇔ КП3 ⇔\nИП7 П5 Сx 256\nКИП5 × КИП5 + \u002F-\u002F КБП9\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nТеперь мы полностью разобрались, как eForth исполняет свой код на «Электронике МК-161» из области данных, даже чуть затронув более глубокую тему строковых литералов (см. 3.1.5).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВо второй статье цикла я расскажу про внешний «текстовый» интерпретатор 161eForth, разберу структуру таблиц заголовков и распознавания имени. Эта часть транслятора потребовала от меня разработки значительно более радикальных решений, на фоне которых разобранное выше — традиционный Форт, старый и добрый.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСчастливого программирования на Форте!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EЛитература\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EDr. Chen-Hanson Ting. eForth and Zen — 3rd Edition, 2017. Есть на Amazon Kindle.\u003C\u002Fli\u003E\r\n\u003Cli\u003EБаранов С.Н., Ноздрунов Н.Р. Язык Форт и его реализации. — Л.: Машиностроение. Ленингр. отд-ние, 1988.\u003C\u002Fli\u003E\r\n\u003Cli\u003EСемёнов Ю.А. Программирование на языке ФОРТ. — М.: Радио и связь, 1991.\u003C\u002Fli\u003E\r\n\u003Cli\u003EСтандарт ANS Forth. X3.215-1994. \u003Ca href=\"http:\u002F\u002Foco.org.ua\u002Fdownload\u002Fforth\u002Fdpans94_ru.html\"\u003EПеревод\u003C\u002Fa\u003E.\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"http:\u002F\u002Fspf.sourceforge.net\u002Fdocs\u002Freadme.ru.html\"\u003EДокументация по SP-Forth\u003C\u002Fa\u003E.\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"http:\u002F\u002Fforth.org\u002FOffeteStore\u002FOffeteStore.html\"\u003EOffete Store (труды Dr. Chen-Hanson Ting)\u003C\u002Fa\u003E, откуда можно скачать 86eForth v5.2 для Windows, документация на английском языке.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EВидеоиллюстрации\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nЭти четыре небольших видео про 161eForth — продолжение. Первое видео в начале статьи.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧасть 2 из 5. Тесты TEST-TEST4 из книги «eForth and Zen», 3-е издание, на МК-161.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv\u003E\u003Cdiv style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002F7UuQSozjuJ8?rel=0&amp;showinfo=1&amp;hl=en-US\" data-style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" id=\"\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧасть 3 из 5. Декомпилятор SEE.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv\u003E\u003Cdiv style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002FK-mWJuL1fiQ?rel=0&amp;showinfo=1&amp;hl=en-US\" data-style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" id=\"\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧасть 4 из 5. Точка останова BYE, терминал RS-232 и удалённый доступ к МК-161.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv\u003E\u003Cdiv style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002FCfj60ICJrHU?rel=0&amp;showinfo=1&amp;hl=en-US\" data-style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" id=\"\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧасть 5 из 5. Заключительные слова.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv\u003E\u003Cdiv style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002FoAAX29TpH9c?rel=0&amp;showinfo=1&amp;hl=en-US\" data-style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" id=\"\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"форт"},{"titleHtml":"пмк"},{"titleHtml":"мк-152"},{"titleHtml":"МК-161"},{"titleHtml":"eForth"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452398\u002F4c12e637f2da3169655300c9feb6b557\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452398\u002F4c12e637f2da3169655300c9feb6b557\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F452398\\\u002F\"},\"headline\":\"EFORTH для программируемого калькулятора\",\"datePublished\":\"2019-05-18T05:35:47+03:00\",\"dateModified\":\"2019-09-08T13:16:03+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"arvi1973\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com\\\u002Fru\\\u002Fpost\\\u002F452572  Транслятор EFORTH теперь есть и на отечественном калькуляторе &laquo;Электроника...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F452398\\\u002F#post-content-body\",\"about\":[\"h_system_programming\",\"h_compilers\",\"h_forth\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Flx\\\u002F76\\\u002Fpw\\\u002Flx76pw2yfjmfnqz4wxg9pp_m6ya.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fff\\\u002Fpu\\\u002Fry\\\u002Fffpury7pflujlbysn28jipoylgg.png\"]}","metaDescription":"Это первая статья цикла про 161eForth v0.5b, окончание здесь: habr.com\u002Fru\u002Fpost\u002F452572\r\n\r\nТранслятор EFORTH теперь есть и на отечественном калькуляторе «Электроника МК-161»! 17 мая версия v0.5b успешно...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"system_programming,compilers,forth"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
