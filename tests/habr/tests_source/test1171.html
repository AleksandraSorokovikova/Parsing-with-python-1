<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Тесты для кода и код для тестов / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/452702\/"},"headline":"Тесты для кода и код для тестов","datePublished":"2019-05-20T23:48:30+03:00","dateModified":"2019-05-21T21:35:02+03:00","author":{"@type":"Person","name":"Михаил Крюков"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов &mdash; можно просто с...","url":"https:\/\/habr.com\/ru\/post\/452702\/#post-content-body","about":["h_it_testing","h_programming","h_refactoring","h_go","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/452702\/bba0dfb9c3384ad7e560481e4a90c88d\/"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Тесты для кода и код для тестов" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Тесты для кода и код для тестов" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Тесты для кода и код для тестов" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить &amp;quot;заплатки&amp;quot;, которые будут..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить &amp;quot;заплатки&amp;quot;, которые будут..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить &amp;quot;заплатки&amp;quot;, которые будут..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить &amp;quot;заплатки&amp;quot;, которые будут..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить &amp;quot;заплатки&amp;quot;, которые будут..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/452702/bba0dfb9c3384ad7e560481e4a90c88d/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/452702/bba0dfb9c3384ad7e560481e4a90c88d/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/452702/bba0dfb9c3384ad7e560481e4a90c88d/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/452702/bba0dfb9c3384ad7e560481e4a90c88d/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/452702/bba0dfb9c3384ad7e560481e4a90c88d/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="452702" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-20T20:48:30.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/452702/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/452702/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/452702/bba0dfb9c3384ad7e560481e4a90c88d/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/michaelkryukov/" title="michaelkryukov" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/8bf/62d/837/8bf62d837a054c879a30c6ac3a12fee4.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/michaelkryukov/" class="tm-user-info__username">
      michaelkryukov
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-20T20:48:30.000Z" title="2019-05-20, 23:48">20  мая  2019 в 23:48</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Тесты для кода и код для тестов</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/it_testing/" class="tm-article-snippet__hubs-item-link"><span>Тестирование IT-систем</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/programming/" class="tm-article-snippet__hubs-item-link"><span>Программирование</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/refactoring/" class="tm-article-snippet__hubs-item-link"><span>Проектирование и рефакторинг</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/go/" class="tm-article-snippet__hubs-item-link"><span>Go</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><p>В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить "заплатки", которые будут исключать тяжёлую или ненужную логику в контексте данного теста.</p><br/>
<p>Но что делать в C++? Go? Java? В этих языках код не получится модифицировать для тестов на лету, а создание заплаток требует отдельных инструментов.</p><br/>
<p>В таких случаях стоит специально писать код так, чтобы он тестировался. Это не просто маниакальное стремление увидеть в своём проекте 100% покрытие. Это шаг к написанию поддерживаемого и качественного кода.</p><br/>
<p>В этой статье я попробую рассказать об основных идеях, стоящих за написанием тестируемого кода и показать, как их можно использовать на примере простой программы на языке go.</p><a name="habracut"></a><br/>
<h2 id="beshitrostnaya-programma">Бесхитростная программа</h2><br/>
<p>Напишем бесхитростную программу для совершения запроса к API ВКонтакте. Это достаточно простая программа, которая формирует запрос, совершает его, считывает ответ, декодирует ответ из JSON в структуру и выводит результат пользователю.</p><br/>
<pre><code class="go">package main

import (
  "encoding/json"
  "fmt"
  "io/ioutil"
  "net/http"
  "net/url"
)

const token = "token here"

func main() {
  // Составляем адрес для запроса
  var requestURL = fmt.Sprintf(
    "https://api.vk.com/method/%s?&amp;access_token=%s&amp;v=5.95",
    "users.get",
    token,
  )

  // Совершаем запрос
  resp, err := http.PostForm(requestURL, nil)

  // Проверяем ошибки
  if err != nil {
    fmt.Println(err)
    return
  }

  // Откладываем закрытие потока чтения тела ответа
  defer resp.Body.Close()

  // Считываем всё тело ответа
  body, err := ioutil.ReadAll(resp.Body)

  // Проверяем ошибки
  if err != nil {
    fmt.Println(err)
    return
  }

  // Формируем структуру для декодирования ответа
  var result struct {
    Response []struct {
      ID        int    `json:"id"`
      FirstName string `json:"first_name"`
      LastName  string `json:"last_name"`
    } `json:"response"`
  }

  // Декодируем ответ и записываем результат в структуру
  err = json.Unmarshal(body, &amp;result)

  // Проверяем ошибки
  if err != nil {
    fmt.Println(err)
    return
  }

  // Проверяем, что данные присутствуют
  if len(result.Response) &lt; 1 {
    fmt.Println("No values in response array")
    return
  }

  // Выводим результат пользователю
  fmt.Printf(
    "Your id: %d\nYour full name: %s %s\n",
    result.Response[0].ID,
    result.Response[0].FirstName,
    result.Response[0].LastName,
  )
}</code></pre><br/>
<p>Будучи профессионалами своего дела, мы решили, что необходимо написать тесты для нашего приложения. Создадим файл с тестами...</p><br/>
<pre><code class="go">package main

import (
  "testing"
)

func Test_Main(t *testing.T) {
  main()
}</code></pre><br/>
<p>Выглядит не очень привлекательно. Эта проверка является простым запуском приложения, на который мы не можем повлиять. Мы не можем исключить работу с сетью, проверить работоспособность при различных ошибках и даже заменить токен для проверки не получится. Попробуем разобраться, как улучшить эту программу.</p><br/>
<h2 id="pattern-vnedrenie-zavisimosti">Паттерн "внедрение зависимости"</h2><br/>
<p>Для начала необходимо реализовать <a href="https://ru.wikipedia.org/wiki/%D0%92%D0%BD%D0%B5%D0%B4%D1%80%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8">паттерн "внедрение зависимости"</a>.</p><br/>
<pre><code class="go">type VKClient struct {
  Token string
}

func (client VKClient) ShowUserInfo() {
  var requestURL = fmt.Sprintf(
    "https://api.vk.com/method/%s?&amp;access_token=%s&amp;v=5.95",
    "users.get",
    client.Token,
  )

  // ...
}</code></pre><br/>
<p>Добавив структуру, мы создали зависимость (ключ доступа) для приложения, которую можно передавать из разных источников, что позволяет избежать "вшитых" значений и упрощает тестирование.</p><br/>
<pre><code class="go">package example

import (
  "testing"
)

const workingToken = "workingToken"

func Test_ShowUserInfo_Successful(t *testing.T) {
  client := VKClient{workingToken}
  client.ShowUserInfo()
}

func Test_ShowUserInfo_EmptyToken(t *testing.T) {
  client := VKClient{""}
  client.ShowUserInfo()
}</code></pre><br/>
<h2 id="razdelenie-polucheniya-informacii-i-eyo-vyvoda">Разделение получения информации и её вывода</h2><br/>
<p>Сейчас ошибку может приметить только человек, и то, только если он знает, каким должен быть вывод. Чтобы решить этот вопрос, необходимо не выводить информацию сразу в поток вывода, а добавить отдельные методы для получения информации и её вывода. Две эти независимые части будет легче проверять и поддерживать.</p><br/>
<p>Создадим метод <code>GetUserInfo()</code>, который будет возвращать структуру с информацией о пользователе и ошибку (если она произошла). Поскольку этот метод ничего не выводит, то происходящие ошибки будут передаваться дальше без вывода, чтобы код, которому нужны данные сам разобрался с ситуацией.</p><br/>
<pre><code class="go">type UserInfo struct {
  ID        int    `json:"id"`
  FirstName string `json:"first_name"`
  LastName  string `json:"last_name"`
}

func (client VKClient) GetUserInfo() (UserInfo, error) {
  var requestURL = fmt.Sprintf(
    "https://api.vk.com/method/%s?&amp;access_token=%s&amp;v=5.95",
    "users.get",
    client.Token,
  )

  resp, err := http.PostForm(requestURL, nil)

  if err != nil {
    return UserInfo{}, err
  }

  // ...

  var result struct {
    Response []UserInfo `json:"response"`
  }

  // ...

  return result.Response[0], nil
}</code></pre><br/>
<p>Изменим <code>ShowUserInfo()</code> так, чтобы он использовал <code>GetUserInfo()</code> и обрабатывал ошибки.</p><br/>
<pre><code class="go">func (client VKClient) ShowUserInfo() {
  userInfo, err := client.GetUserInfo()

  if err != nil {
    fmt.Println(err)
    return
  }

  fmt.Printf(
    "Your id: %d\nYour full name: %s %s\n",
    userInfo.ID,
    userInfo.FirstName,
    userInfo.LastName,
  )
}</code></pre><br/>
<p>Теперь в тестах можно проверять, что от сервера приходит корректный ответ, а при неверном токене возвращается ошибка.</p><br/>
<pre><code class="go">func Test_GetUserInfo_Successful(t *testing.T) {
  client := VKClient{workingToken}

  userInfo, err := client.GetUserInfo()

  if err != nil {
    t.Fatal(err)
  }

  if userInfo.ID == 0 {
    t.Fatal("ID is empty")
  }

  if userInfo.FirstName == "" {
    t.Fatal("FirstName is empty")
  }

  if userInfo.LastName == "" {
    t.Fatal("LastName is empty")
  }
}

func Test_ShowUserInfo_EmptyToken(t *testing.T) {
  client := VKClient{""}

  _, err := client.GetUserInfo()

  if err == nil {
    t.Fatal("Expected error but found &lt;nil>")
  }

  if err.Error() != "No values in response array" {
    t.Fatalf(`Expected "No values in response array", but found "%s"`, err)
  }
}</code></pre><br/>
<p>Помимо обновления существующих тестов, надо добавить новые тесты для метода <code>ShowUserInfo()</code>.</p><br/>
<pre><code class="go">func Test_ShowUserInfo(t *testing.T) {
  client := VKClient{workingToken}
  client.ShowUserInfo()
}

func Test_ShowUserInfo_WithError(t *testing.T) {
  client := VKClient{""}
  client.ShowUserInfo()
}</code></pre><br/>
<h2 id="nastraivaemye-alternativy">Настраиваемые альтернативы</h2><br/>
<p>Тесты для <code>ShowUserInfo()</code> напоминают то, от чего мы пытались уйти изначально. В этом случае единственный смысл метода — выводить информацию в стандартный поток вывода. С одной стороны, можно попробовать переопределять os.Stdout и проверять вывод, это выглядит как слишком избыточное решение, когда можно поступить более элегантно.</p><br/>
<p>Вместо использования <code>fmt.Printf</code>, можно использовать <code>fmt.Fprintf</code>, который позволяет выполнять вывод в любой <code>io.Writer</code>. <code>os.Stdout</code> реализует этот интерфейс, что позволяет нам заменить <code>fmt.Printf(text)</code> на <code>fmt.Fprintf(os.Stdout, text)</code>. После этого мы можем вынести <code>os.Stdout</code> в отдельное поле, которое можно будет устанавливать в нужные значения (для тестов — строка, для работы — стандартный поток вывода).</p><br/>
<p>Поскольку возможность менять Writer для вывода будет использоваться редко, в основном для тестов, есть смысл задать значение по умолчанию. В go для этого мы поступим так — сделаем тип <code>VKClient</code> неэкспортируемым и создадим для него функцию-конструктор.</p><br/>
<pre><code class="go">type vkClient struct {
  Token        string
  OutputWriter io.Writer
}

func CreateVKClient(token string) vkClient {
  return vkClient{
    token,
    os.Stdout,
  }
}</code></pre><br/>
<p>В функции <code>ShowUserInfo()</code> мы заменяем вызовы <code>Print</code> на <code>Fprintf</code>.</p><br/>
<pre><code class="go">func (client vkClient) ShowUserInfo() {
  userInfo, err := client.GetUserInfo()

  if err != nil {
    fmt.Fprintf(client.OutputWriter, err.Error())
    return
  }

  fmt.Fprintf(
    client.OutputWriter,
    "Your id: %d\nYour full name: %s %s\n",
    userInfo.ID,
    userInfo.FirstName,
    userInfo.LastName,
  )
}</code></pre><br/>
<p>Теперь необходимо обновить тесты так, чтобы они создавали клиент с помощью конструктора и там, где надо, устанавливали другого Writer.</p><br/>
<pre><code class="go">func Test_ShowUserInfo(t *testing.T) {
  client := CreateVKClient(workingToken)

  buffer := bytes.NewBufferString("")
  client.OutputWriter = buffer
  client.ShowUserInfo()

  result, _ := ioutil.ReadAll(buffer)

  matched, err := regexp.Match(
    `Your id: \d+\nYour full name: [^\n]+\n`,
    result,
  )

  if err != nil {
    t.Fatal(err)
  }

  if !matched {
    t.Fatalf(`Expected match but failed with "%s"`, result)
  }
}

func Test_ShowUserInfo_WithError(t *testing.T) {
  client := CreateVKClient("")

  buffer := bytes.NewBufferString("")
  client.OutputWriter = buffer
  client.ShowUserInfo()

  result, _ := ioutil.ReadAll(buffer)

  if string(result) != "No values in response array" {
    t.Fatal("Wrong error")
  }
}</code></pre><br/>
<p>Для каждого теста, где мы что-то выводим, мы создаём буфер, который будет играть роль стандартного потока вывода. После выполнения функции происходит проверка, что результаты соответствуют нашим ожиданиям — с помощью регулярных выражений или простого сравнения.</p><br/>
<p>Зачем я использую регулярные выражения? Чтобы тесты работали с любым корректным токеном, который я предоставлю программе, независимо от имени пользователя и его ID.</p><br/>
<h2 id="pattern-vnedrenie-zavisimosti---2">Паттерн "внедрение зависимости" — 2</h2><br/>
<p>На данный момент программа имеет покрытие в 86.4%. Почему не 100%? Мы не можем спровоцировать ошибки из <code>http.PostForm()</code>, <code>ioutil.ReadAll()</code> и <code>json.Unmarshal()</code>, а значит каждый "<code>return UserInfo, err</code>" у нас проверить не получится.</p><br/>
<p>Для того, чтобы дать себе ещё больше контроля над ситуацией, необходимо создать интерфейс, под которых будет подходить <code>http.Client</code>, реализация которого будет находиться в vkClient, и использоваться для сетевых операций. Для нас в интерфейсе важно только наличие одного метода — <code>PostForm</code>.</p><br/>
<pre><code class="go">type Networker interface {
  PostForm(string, url.Values) (*http.Response, error)
}

type vkClient struct {
  Token        string
  OutputWriter io.Writer
  Networker    Networker
}

func CreateVKClient(token string) vkClient {
  return vkClient{
    token,
    os.Stdout,
    &amp;http.Client{},
  }
}</code></pre><br/>
<p>Такой ход позволяет избавиться от необходимости совершать сетевые операции вообще. Теперь мы можем просто возвращать ожидаемые данные от ВКонтакте с помощью подставного <code>Networker</code>. Конечно, не стоит избавляться от тестов, которые будут проверять запросы к серверу, но нет необходимости совершать запросы в каждом тесте.</p><br/>
<p>Создадим реализации для подставных <code>Networker</code> и <code>Reader</code>, чтобы мы могли протестировать ошибки в каждом случае — при запросе, при чтении тела и при десериализации. Если мы хотим ошибку при вызове PostForm, то мы просто возвращает её в этом методе. Если мы хотим ошибку<br/>
при считывании тела ответа — надо возвращать подставной <code>Reader</code>, который выбросит ошибку. И если нам надо, чтобы ошибка проявила себя во время десериализации, то возвращаем ответ с пустой строкой в теле. Если же мы не хотим никаких ошибок — мы просто возвращаем тело с указанным содержимым.</p><br/>
<pre><code class="go">type fakeReader struct{}

func (fakeReader) Read(p []byte) (n int, err error) {
  return 0, errors.New("Error on read")
}

type fakeNetworker struct {
  ErrorOnPostForm  bool
  ErrorOnBodyRead  bool
  ErrorOnUnmarchal bool
  RawBody          string
}

func (fn *fakeNetworker) PostForm(string, url.Values) (*http.Response, error) {
  if fn.ErrorOnPostForm {
    return nil, fmt.Errorf("Error on PostForm")
  }

  if fn.ErrorOnBodyRead {
    return &amp;http.Response{Body: ioutil.NopCloser(fakeReader{})}, nil
  }

  if fn.ErrorOnUnmarchal {
    fakeBody := ioutil.NopCloser(bytes.NewBufferString(""))

    return &amp;http.Response{Body: fakeBody}, nil
  }

  fakeBody := ioutil.NopCloser(bytes.NewBufferString(fn.RawBody))

  return &amp;http.Response{Body: fakeBody}, nil
}</code></pre><br/>
<p>Для каждой проблемной ситуации добавим по тесту. Они будут создавать подставные <code>Networker</code> с нужными настройками, в соответствии с которыми он будет выкидывать ошибку в определённый момент. После этого мы вызываем проверяемую функцию и убеждаемся, что ошибка произошла, и что мы ожидали именно эту ошибку.</p><br/>
<pre><code class="go">func Test_GetUserInfo_ErrorOnPostForm(t *testing.T) {
  client := CreateVKClient(workingToken)
  client.Networker = &amp;fakeNetworker{ErrorOnPostForm: true}

  _, err := client.GetUserInfo()

  if err == nil {
    t.Fatal("Expected error but none found")
  }

  if err.Error() != "Error on PostForm" {
    t.Fatalf(`Expected "Error on PostForm" but got "%s"`, err.Error())
  }
}

func Test_GetUserInfo_ErrorOnBodyRead(t *testing.T) {
  client := CreateVKClient(workingToken)
  client.Networker = &amp;fakeNetworker{ErrorOnBodyRead: true}

  _, err := client.GetUserInfo()

  if err == nil {
    t.Fatal("Expected error but none found")
  }

  if err.Error() != "Error on read" {
    t.Fatalf(`Expected "Error on read" but got "%s"`, err.Error())
  }
}

func Test_GetUserInfo_ErrorOnUnmarchal(t *testing.T) {
  client := CreateVKClient(workingToken)
  client.Networker = &amp;fakeNetworker{ErrorOnUnmarchal: true}

  _, err := client.GetUserInfo()

  if err == nil {
    t.Fatal("Expected error but none found")
  }

  const expectedError = "unexpected end of JSON input"

  if err.Error() != expectedError {
    t.Fatalf(`Expected "%s" but got "%s"`, expectedError, err.Error())
  }
}</code></pre><br/>
<p>С помощью поля <code>RawBody</code> можно избавиться от сетевых запросов (просто возвращать то, что мы ожидаем получить от ВКонтакте). Это может быть необходимо, чтобы избежать превышения лимитов запросов во время тестирования или для ускорения тестов.</p><br/>
<h2 id="itogi">Итоги</h2><br/>
<p>После всех операций над проектом, мы получили пакет длинной в 91 строку (+170 строк тестов), который поддерживает вывод в любые <code>io.Writer</code>, позволяет использовать альтернативные способы работы с сетью (с помощью адаптера к нашему интерфейсу), в котором есть метод как для вывода данных, так и для их получения. Проект обладает 100% покрытием. Тесты полностью проверяют каждую строчку и реакцию приложения на каждую возможную ошибку.</p><br/>
<p>Каждый шаг по дороге к 100% покрытию увеличивал модульность, поддерживаемость и надёжность приложения, поэтому нет ничего плохого в том, что тесты диктовали структуру пакета.</p><br/>
<p>Тестируемость любого кода — это качество, которое не появляется из воздуха. Тестируемость появляется тогда, когда разработчик адекватно использует паттерны в подходящих ситуациях и пишет настраиваемый и модульный код. Основной задачей было показать процесс мышления при выполнении рефакторинга программы. Аналогичное мышление может распространяться на любые приложения и библиотеки, а также и на другие языки.</p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%82%D0%B5%D1%81%D1%82%D1%8B%5D" class="tm-tags-list__link">тесты</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%5D" class="tm-tags-list__link">тестирование</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BE%D0%BF%5D" class="tm-tags-list__link">тестирование оп</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgo%5D" class="tm-tags-list__link">go</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgolang%5D" class="tm-tags-list__link">golang</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BD%D0%BE%D0%B2%D0%B8%D1%87%D0%BA%D0%B0%D0%BC%5D" class="tm-tags-list__link">новичкам</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BD%D0%BE%D0%B2%D0%B8%D1%87%D0%BE%D0%BA%5D" class="tm-tags-list__link">новичок</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%5D" class="tm-tags-list__link">проектирование</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%80%D0%B5%D1%84%D0%B0%D0%BA%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3%5D" class="tm-tags-list__link">рефакторинг</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/it_testing/" class="tm-hubs-list__link">
    Тестирование IT-систем
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/programming/" class="tm-hubs-list__link">
    Программирование
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/refactoring/" class="tm-hubs-list__link">
    Проектирование и рефакторинг
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/go/" class="tm-hubs-list__link">
    Go
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 8: ↑8 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 8: ↑8 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+8</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">7.3K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    42
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/michaelkryukov/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/8bf/62d/837/8bf62d837a054c879a30c6ac3a12fee4.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 8 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    7.2
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Михаил Крюков</span> <a href="/ru/users/michaelkryukov/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @michaelkryukov
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Разработчик</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/452702/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 2 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section data-async-called="true" class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Работа</h2> <!----></header> <div class="tm-block__body"><div class="tm-vacancies-block__item"><a href="https://career.habr.com/vacancies/go_razrabotchik" target="_blank" class="tm-vacancies-block__vacancy-title">
        Go разработчик
      </a> <div class="tm-vacancies-block__vacancies-count">
        113
    вакансий
      </div></div></div> <footer class="tm-block__footer"><a href="https://career.habr.com/vacancies" class="tm-block-extralink">
      Все вакансии
    </a></footer></section></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/452702/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/452702/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"452702":{"id":"452702","timePublished":"2019-05-20T20:48:30+00:00","isCorporative":false,"lang":"ru","titleHtml":"Тесты для кода и код для тестов","leadData":{"textHtml":"\u003Cp\u003EВ динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить \"заплатки\", которые будут исключать тяжёлую или ненужную логику в контексте данного теста.\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EНо что делать в C++? Go? Java? В этих языках код не получится модифицировать для тестов на лету, а создание заплаток требует отдельных инструментов.\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EВ таких случаях стоит специально писать код так, чтобы он тестировался. Это не просто маниакальное стремление увидеть в своём проекте 100% покрытие. Это шаг к написанию поддерживаемого и качественного кода.\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EВ этой статье я попробую рассказать об основных идеях, стоящих за написанием тестируемого кода и показать, как их можно использовать на примере простой программы на языке go.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше →","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":7.2,"votesCount":8},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1735849","alias":"michaelkryukov","fullname":"Михаил Крюков","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F8bf\u002F62d\u002F837\u002F8bf62d837a054c879a30c6ac3a12fee4.jpg","speciality":"Разработчик"},"statistics":{"commentsCount":2,"favoritesCount":42,"readingCount":7315,"score":8,"votesCount":8},"hubs":[{"relatedData":null,"id":"210","alias":"it_testing","type":"collective","title":"Тестирование IT-систем","titleHtml":"Тестирование IT-систем","isProfiled":true},{"relatedData":null,"id":"359","alias":"programming","type":"collective","title":"Программирование","titleHtml":"Программирование","isProfiled":true},{"relatedData":null,"id":"7504","alias":"refactoring","type":"collective","title":"Проектирование и рефакторинг","titleHtml":"Проектирование и рефакторинг","isProfiled":true},{"relatedData":null,"id":"17748","alias":"go","type":"collective","title":"Go","titleHtml":"Go","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003EВ динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить \"заплатки\", которые будут исключать тяжёлую или ненужную логику в контексте данного теста.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНо что делать в C++? Go? Java? В этих языках код не получится модифицировать для тестов на лету, а создание заплаток требует отдельных инструментов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ таких случаях стоит специально писать код так, чтобы он тестировался. Это не просто маниакальное стремление увидеть в своём проекте 100% покрытие. Это шаг к написанию поддерживаемого и качественного кода.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ этой статье я попробую рассказать об основных идеях, стоящих за написанием тестируемого кода и показать, как их можно использовать на примере простой программы на языке go.\u003C\u002Fp\u003E\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"beshitrostnaya-programma\"\u003EБесхитростная программа\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНапишем бесхитростную программу для совершения запроса к API ВКонтакте. Это достаточно простая программа, которая формирует запрос, совершает его, считывает ответ, декодирует ответ из JSON в структуру и выводит результат пользователю.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Epackage main\n\nimport (\n  \"encoding\u002Fjson\"\n  \"fmt\"\n  \"io\u002Fioutil\"\n  \"net\u002Fhttp\"\n  \"net\u002Furl\"\n)\n\nconst token = \"token here\"\n\nfunc main() {\n  \u002F\u002F Составляем адрес для запроса\n  var requestURL = fmt.Sprintf(\n    \"https:\u002F\u002Fapi.vk.com\u002Fmethod\u002F%s?&amp;access_token=%s&amp;v=5.95\",\n    \"users.get\",\n    token,\n  )\n\n  \u002F\u002F Совершаем запрос\n  resp, err := http.PostForm(requestURL, nil)\n\n  \u002F\u002F Проверяем ошибки\n  if err != nil {\n    fmt.Println(err)\n    return\n  }\n\n  \u002F\u002F Откладываем закрытие потока чтения тела ответа\n  defer resp.Body.Close()\n\n  \u002F\u002F Считываем всё тело ответа\n  body, err := ioutil.ReadAll(resp.Body)\n\n  \u002F\u002F Проверяем ошибки\n  if err != nil {\n    fmt.Println(err)\n    return\n  }\n\n  \u002F\u002F Формируем структуру для декодирования ответа\n  var result struct {\n    Response []struct {\n      ID        int    `json:\"id\"`\n      FirstName string `json:\"first_name\"`\n      LastName  string `json:\"last_name\"`\n    } `json:\"response\"`\n  }\n\n  \u002F\u002F Декодируем ответ и записываем результат в структуру\n  err = json.Unmarshal(body, &amp;result)\n\n  \u002F\u002F Проверяем ошибки\n  if err != nil {\n    fmt.Println(err)\n    return\n  }\n\n  \u002F\u002F Проверяем, что данные присутствуют\n  if len(result.Response) &lt; 1 {\n    fmt.Println(\"No values in response array\")\n    return\n  }\n\n  \u002F\u002F Выводим результат пользователю\n  fmt.Printf(\n    \"Your id: %d\\nYour full name: %s %s\\n\",\n    result.Response[0].ID,\n    result.Response[0].FirstName,\n    result.Response[0].LastName,\n  )\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EБудучи профессионалами своего дела, мы решили, что необходимо написать тесты для нашего приложения. Создадим файл с тестами...\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Epackage main\n\nimport (\n  \"testing\"\n)\n\nfunc Test_Main(t *testing.T) {\n  main()\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВыглядит не очень привлекательно. Эта проверка является простым запуском приложения, на который мы не можем повлиять. Мы не можем исключить работу с сетью, проверить работоспособность при различных ошибках и даже заменить токен для проверки не получится. Попробуем разобраться, как улучшить эту программу.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"pattern-vnedrenie-zavisimosti\"\u003EПаттерн \"внедрение зависимости\"\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля начала необходимо реализовать \u003Ca href=\"https:\u002F\u002Fru.wikipedia.org\u002Fwiki\u002F%D0%92%D0%BD%D0%B5%D0%B4%D1%80%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B7%D0%B0%D0%B2%D0%B8%D1%81%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8\"\u003Eпаттерн \"внедрение зависимости\"\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Etype VKClient struct {\n  Token string\n}\n\nfunc (client VKClient) ShowUserInfo() {\n  var requestURL = fmt.Sprintf(\n    \"https:\u002F\u002Fapi.vk.com\u002Fmethod\u002F%s?&amp;access_token=%s&amp;v=5.95\",\n    \"users.get\",\n    client.Token,\n  )\n\n  \u002F\u002F ...\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДобавив структуру, мы создали зависимость (ключ доступа) для приложения, которую можно передавать из разных источников, что позволяет избежать \"вшитых\" значений и упрощает тестирование.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Epackage example\n\nimport (\n  \"testing\"\n)\n\nconst workingToken = \"workingToken\"\n\nfunc Test_ShowUserInfo_Successful(t *testing.T) {\n  client := VKClient{workingToken}\n  client.ShowUserInfo()\n}\n\nfunc Test_ShowUserInfo_EmptyToken(t *testing.T) {\n  client := VKClient{\"\"}\n  client.ShowUserInfo()\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"razdelenie-polucheniya-informacii-i-eyo-vyvoda\"\u003EРазделение получения информации и её вывода\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСейчас ошибку может приметить только человек, и то, только если он знает, каким должен быть вывод. Чтобы решить этот вопрос, необходимо не выводить информацию сразу в поток вывода, а добавить отдельные методы для получения информации и её вывода. Две эти независимые части будет легче проверять и поддерживать.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздадим метод \u003Ccode\u003EGetUserInfo()\u003C\u002Fcode\u003E, который будет возвращать структуру с информацией о пользователе и ошибку (если она произошла). Поскольку этот метод ничего не выводит, то происходящие ошибки будут передаваться дальше без вывода, чтобы код, которому нужны данные сам разобрался с ситуацией.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Etype UserInfo struct {\n  ID        int    `json:\"id\"`\n  FirstName string `json:\"first_name\"`\n  LastName  string `json:\"last_name\"`\n}\n\nfunc (client VKClient) GetUserInfo() (UserInfo, error) {\n  var requestURL = fmt.Sprintf(\n    \"https:\u002F\u002Fapi.vk.com\u002Fmethod\u002F%s?&amp;access_token=%s&amp;v=5.95\",\n    \"users.get\",\n    client.Token,\n  )\n\n  resp, err := http.PostForm(requestURL, nil)\n\n  if err != nil {\n    return UserInfo{}, err\n  }\n\n  \u002F\u002F ...\n\n  var result struct {\n    Response []UserInfo `json:\"response\"`\n  }\n\n  \u002F\u002F ...\n\n  return result.Response[0], nil\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИзменим \u003Ccode\u003EShowUserInfo()\u003C\u002Fcode\u003E так, чтобы он использовал \u003Ccode\u003EGetUserInfo()\u003C\u002Fcode\u003E и обрабатывал ошибки.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc (client VKClient) ShowUserInfo() {\n  userInfo, err := client.GetUserInfo()\n\n  if err != nil {\n    fmt.Println(err)\n    return\n  }\n\n  fmt.Printf(\n    \"Your id: %d\\nYour full name: %s %s\\n\",\n    userInfo.ID,\n    userInfo.FirstName,\n    userInfo.LastName,\n  )\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь в тестах можно проверять, что от сервера приходит корректный ответ, а при неверном токене возвращается ошибка.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc Test_GetUserInfo_Successful(t *testing.T) {\n  client := VKClient{workingToken}\n\n  userInfo, err := client.GetUserInfo()\n\n  if err != nil {\n    t.Fatal(err)\n  }\n\n  if userInfo.ID == 0 {\n    t.Fatal(\"ID is empty\")\n  }\n\n  if userInfo.FirstName == \"\" {\n    t.Fatal(\"FirstName is empty\")\n  }\n\n  if userInfo.LastName == \"\" {\n    t.Fatal(\"LastName is empty\")\n  }\n}\n\nfunc Test_ShowUserInfo_EmptyToken(t *testing.T) {\n  client := VKClient{\"\"}\n\n  _, err := client.GetUserInfo()\n\n  if err == nil {\n    t.Fatal(\"Expected error but found &lt;nil\u003E\")\n  }\n\n  if err.Error() != \"No values in response array\" {\n    t.Fatalf(`Expected \"No values in response array\", but found \"%s\"`, err)\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПомимо обновления существующих тестов, надо добавить новые тесты для метода \u003Ccode\u003EShowUserInfo()\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc Test_ShowUserInfo(t *testing.T) {\n  client := VKClient{workingToken}\n  client.ShowUserInfo()\n}\n\nfunc Test_ShowUserInfo_WithError(t *testing.T) {\n  client := VKClient{\"\"}\n  client.ShowUserInfo()\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"nastraivaemye-alternativy\"\u003EНастраиваемые альтернативы\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТесты для \u003Ccode\u003EShowUserInfo()\u003C\u002Fcode\u003E напоминают то, от чего мы пытались уйти изначально. В этом случае единственный смысл метода — выводить информацию в стандартный поток вывода. С одной стороны, можно попробовать переопределять os.Stdout и проверять вывод, это выглядит как слишком избыточное решение, когда можно поступить более элегантно.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВместо использования \u003Ccode\u003Efmt.Printf\u003C\u002Fcode\u003E, можно использовать \u003Ccode\u003Efmt.Fprintf\u003C\u002Fcode\u003E, который позволяет выполнять вывод в любой \u003Ccode\u003Eio.Writer\u003C\u002Fcode\u003E. \u003Ccode\u003Eos.Stdout\u003C\u002Fcode\u003E реализует этот интерфейс, что позволяет нам заменить \u003Ccode\u003Efmt.Printf(text)\u003C\u002Fcode\u003E на \u003Ccode\u003Efmt.Fprintf(os.Stdout, text)\u003C\u002Fcode\u003E. После этого мы можем вынести \u003Ccode\u003Eos.Stdout\u003C\u002Fcode\u003E в отдельное поле, которое можно будет устанавливать в нужные значения (для тестов — строка, для работы — стандартный поток вывода).\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПоскольку возможность менять Writer для вывода будет использоваться редко, в основном для тестов, есть смысл задать значение по умолчанию. В go для этого мы поступим так — сделаем тип \u003Ccode\u003EVKClient\u003C\u002Fcode\u003E неэкспортируемым и создадим для него функцию-конструктор.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Etype vkClient struct {\n  Token        string\n  OutputWriter io.Writer\n}\n\nfunc CreateVKClient(token string) vkClient {\n  return vkClient{\n    token,\n    os.Stdout,\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ функции \u003Ccode\u003EShowUserInfo()\u003C\u002Fcode\u003E мы заменяем вызовы \u003Ccode\u003EPrint\u003C\u002Fcode\u003E на \u003Ccode\u003EFprintf\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc (client vkClient) ShowUserInfo() {\n  userInfo, err := client.GetUserInfo()\n\n  if err != nil {\n    fmt.Fprintf(client.OutputWriter, err.Error())\n    return\n  }\n\n  fmt.Fprintf(\n    client.OutputWriter,\n    \"Your id: %d\\nYour full name: %s %s\\n\",\n    userInfo.ID,\n    userInfo.FirstName,\n    userInfo.LastName,\n  )\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь необходимо обновить тесты так, чтобы они создавали клиент с помощью конструктора и там, где надо, устанавливали другого Writer.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc Test_ShowUserInfo(t *testing.T) {\n  client := CreateVKClient(workingToken)\n\n  buffer := bytes.NewBufferString(\"\")\n  client.OutputWriter = buffer\n  client.ShowUserInfo()\n\n  result, _ := ioutil.ReadAll(buffer)\n\n  matched, err := regexp.Match(\n    `Your id: \\d+\\nYour full name: [^\\n]+\\n`,\n    result,\n  )\n\n  if err != nil {\n    t.Fatal(err)\n  }\n\n  if !matched {\n    t.Fatalf(`Expected match but failed with \"%s\"`, result)\n  }\n}\n\nfunc Test_ShowUserInfo_WithError(t *testing.T) {\n  client := CreateVKClient(\"\")\n\n  buffer := bytes.NewBufferString(\"\")\n  client.OutputWriter = buffer\n  client.ShowUserInfo()\n\n  result, _ := ioutil.ReadAll(buffer)\n\n  if string(result) != \"No values in response array\" {\n    t.Fatal(\"Wrong error\")\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля каждого теста, где мы что-то выводим, мы создаём буфер, который будет играть роль стандартного потока вывода. После выполнения функции происходит проверка, что результаты соответствуют нашим ожиданиям — с помощью регулярных выражений или простого сравнения.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗачем я использую регулярные выражения? Чтобы тесты работали с любым корректным токеном, который я предоставлю программе, независимо от имени пользователя и его ID.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"pattern-vnedrenie-zavisimosti---2\"\u003EПаттерн \"внедрение зависимости\" — 2\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНа данный момент программа имеет покрытие в 86.4%. Почему не 100%? Мы не можем спровоцировать ошибки из \u003Ccode\u003Ehttp.PostForm()\u003C\u002Fcode\u003E, \u003Ccode\u003Eioutil.ReadAll()\u003C\u002Fcode\u003E и \u003Ccode\u003Ejson.Unmarshal()\u003C\u002Fcode\u003E, а значит каждый \"\u003Ccode\u003Ereturn UserInfo, err\u003C\u002Fcode\u003E\" у нас проверить не получится.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля того, чтобы дать себе ещё больше контроля над ситуацией, необходимо создать интерфейс, под которых будет подходить \u003Ccode\u003Ehttp.Client\u003C\u002Fcode\u003E, реализация которого будет находиться в vkClient, и использоваться для сетевых операций. Для нас в интерфейсе важно только наличие одного метода — \u003Ccode\u003EPostForm\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Etype Networker interface {\n  PostForm(string, url.Values) (*http.Response, error)\n}\n\ntype vkClient struct {\n  Token        string\n  OutputWriter io.Writer\n  Networker    Networker\n}\n\nfunc CreateVKClient(token string) vkClient {\n  return vkClient{\n    token,\n    os.Stdout,\n    &amp;http.Client{},\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТакой ход позволяет избавиться от необходимости совершать сетевые операции вообще. Теперь мы можем просто возвращать ожидаемые данные от ВКонтакте с помощью подставного \u003Ccode\u003ENetworker\u003C\u002Fcode\u003E. Конечно, не стоит избавляться от тестов, которые будут проверять запросы к серверу, но нет необходимости совершать запросы в каждом тесте.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздадим реализации для подставных \u003Ccode\u003ENetworker\u003C\u002Fcode\u003E и \u003Ccode\u003EReader\u003C\u002Fcode\u003E, чтобы мы могли протестировать ошибки в каждом случае — при запросе, при чтении тела и при десериализации. Если мы хотим ошибку при вызове PostForm, то мы просто возвращает её в этом методе. Если мы хотим ошибку\u003Cbr\u002F\u003E\r\nпри считывании тела ответа — надо возвращать подставной \u003Ccode\u003EReader\u003C\u002Fcode\u003E, который выбросит ошибку. И если нам надо, чтобы ошибка проявила себя во время десериализации, то возвращаем ответ с пустой строкой в теле. Если же мы не хотим никаких ошибок — мы просто возвращаем тело с указанным содержимым.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Etype fakeReader struct{}\n\nfunc (fakeReader) Read(p []byte) (n int, err error) {\n  return 0, errors.New(\"Error on read\")\n}\n\ntype fakeNetworker struct {\n  ErrorOnPostForm  bool\n  ErrorOnBodyRead  bool\n  ErrorOnUnmarchal bool\n  RawBody          string\n}\n\nfunc (fn *fakeNetworker) PostForm(string, url.Values) (*http.Response, error) {\n  if fn.ErrorOnPostForm {\n    return nil, fmt.Errorf(\"Error on PostForm\")\n  }\n\n  if fn.ErrorOnBodyRead {\n    return &amp;http.Response{Body: ioutil.NopCloser(fakeReader{})}, nil\n  }\n\n  if fn.ErrorOnUnmarchal {\n    fakeBody := ioutil.NopCloser(bytes.NewBufferString(\"\"))\n\n    return &amp;http.Response{Body: fakeBody}, nil\n  }\n\n  fakeBody := ioutil.NopCloser(bytes.NewBufferString(fn.RawBody))\n\n  return &amp;http.Response{Body: fakeBody}, nil\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля каждой проблемной ситуации добавим по тесту. Они будут создавать подставные \u003Ccode\u003ENetworker\u003C\u002Fcode\u003E с нужными настройками, в соответствии с которыми он будет выкидывать ошибку в определённый момент. После этого мы вызываем проверяемую функцию и убеждаемся, что ошибка произошла, и что мы ожидали именно эту ошибку.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"go\"\u003Efunc Test_GetUserInfo_ErrorOnPostForm(t *testing.T) {\n  client := CreateVKClient(workingToken)\n  client.Networker = &amp;fakeNetworker{ErrorOnPostForm: true}\n\n  _, err := client.GetUserInfo()\n\n  if err == nil {\n    t.Fatal(\"Expected error but none found\")\n  }\n\n  if err.Error() != \"Error on PostForm\" {\n    t.Fatalf(`Expected \"Error on PostForm\" but got \"%s\"`, err.Error())\n  }\n}\n\nfunc Test_GetUserInfo_ErrorOnBodyRead(t *testing.T) {\n  client := CreateVKClient(workingToken)\n  client.Networker = &amp;fakeNetworker{ErrorOnBodyRead: true}\n\n  _, err := client.GetUserInfo()\n\n  if err == nil {\n    t.Fatal(\"Expected error but none found\")\n  }\n\n  if err.Error() != \"Error on read\" {\n    t.Fatalf(`Expected \"Error on read\" but got \"%s\"`, err.Error())\n  }\n}\n\nfunc Test_GetUserInfo_ErrorOnUnmarchal(t *testing.T) {\n  client := CreateVKClient(workingToken)\n  client.Networker = &amp;fakeNetworker{ErrorOnUnmarchal: true}\n\n  _, err := client.GetUserInfo()\n\n  if err == nil {\n    t.Fatal(\"Expected error but none found\")\n  }\n\n  const expectedError = \"unexpected end of JSON input\"\n\n  if err.Error() != expectedError {\n    t.Fatalf(`Expected \"%s\" but got \"%s\"`, expectedError, err.Error())\n  }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EС помощью поля \u003Ccode\u003ERawBody\u003C\u002Fcode\u003E можно избавиться от сетевых запросов (просто возвращать то, что мы ожидаем получить от ВКонтакте). Это может быть необходимо, чтобы избежать превышения лимитов запросов во время тестирования или для ускорения тестов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"itogi\"\u003EИтоги\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПосле всех операций над проектом, мы получили пакет длинной в 91 строку (+170 строк тестов), который поддерживает вывод в любые \u003Ccode\u003Eio.Writer\u003C\u002Fcode\u003E, позволяет использовать альтернативные способы работы с сетью (с помощью адаптера к нашему интерфейсу), в котором есть метод как для вывода данных, так и для их получения. Проект обладает 100% покрытием. Тесты полностью проверяют каждую строчку и реакцию приложения на каждую возможную ошибку.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКаждый шаг по дороге к 100% покрытию увеличивал модульность, поддерживаемость и надёжность приложения, поэтому нет ничего плохого в том, что тесты диктовали структуру пакета.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТестируемость любого кода — это качество, которое не появляется из воздуха. Тестируемость появляется тогда, когда разработчик адекватно использует паттерны в подходящих ситуациях и пишет настраиваемый и модульный код. Основной задачей было показать процесс мышления при выполнении рефакторинга программы. Аналогичное мышление может распространяться на любые приложения и библиотеки, а также и на другие языки.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"тесты"},{"titleHtml":"тестирование"},{"titleHtml":"тестирование оп"},{"titleHtml":"go"},{"titleHtml":"golang"},{"titleHtml":"новичкам"},{"titleHtml":"новичок"},{"titleHtml":"проектирование"},{"titleHtml":"рефакторинг"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452702\u002Fbba0dfb9c3384ad7e560481e4a90c88d\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452702\u002Fbba0dfb9c3384ad7e560481e4a90c88d\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F452702\\\u002F\"},\"headline\":\"Тесты для кода и код для тестов\",\"datePublished\":\"2019-05-20T23:48:30+03:00\",\"dateModified\":\"2019-05-21T21:35:02+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Михаил Крюков\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов &mdash; можно просто с...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F452702\\\u002F#post-content-body\",\"about\":[\"h_it_testing\",\"h_programming\",\"h_refactoring\",\"h_go\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F452702\\\u002Fbba0dfb9c3384ad7e560481e4a90c88d\\\u002F\"]}","metaDescription":"В динамических языках, вроде python и javascript, возможно прямо во время работы заменять методы и классы в модулях. Это очень удобно для тестов — можно просто ставить &quot;заплатки&quot;, которые будут...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[{"title":"Go разработчик","vacanciesCount":113,"itemUrl":"https:\u002F\u002Fcareer.habr.com\u002Fvacancies\u002Fgo_razrabotchik","itemHubs":["go"]}],"hubs":"it_testing,programming,refactoring,go"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
