<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/company\/2gis\/blog\/452638\/"},"headline":"Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем","datePublished":"2019-05-21T08:33:19+03:00","dateModified":"2019-05-22T08:40:51+03:00","author":{"@type":"Person","name":"Shevelev Ivan"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе...","url":"https:\/\/habr.com\/ru\/company\/2gis\/blog\/452638\/#post-content-body","about":["c_2gis","h_ios_dev","h_mobile_dev","h_refactoring","h_autogadgets","f_develop","f_popsci"],"image":["https:\/\/habrastorage.org\/webt\/tt\/jg\/a3\/ttjga3qmefdwknrbj1i351exs3m.jpeg","https:\/\/habrastorage.org\/webt\/hq\/vu\/xw\/hqvuxwo3ms1ivfppuaojrfscvh0.jpeg","https:\/\/habrastorage.org\/webt\/3p\/xn\/rf\/3pxnrf5dlvtq7n8qkuovquqgbbi.png","https:\/\/habrastorage.org\/webt\/hf\/t2\/rw\/hft2rwp8m2d71popp3tus4dif20.jpeg","https:\/\/habrastorage.org\/webt\/vv\/l1\/xx\/vvl1xxebjbdb9ahiuucw1db_rzg.png","https:\/\/habrastorage.org\/webt\/c2\/ql\/u8\/c2qlu8wi-sbkh5zizb7mjab-n7w.png","https:\/\/habrastorage.org\/webt\/5d\/xn\/26\/5dxn263mlspdif8eqhxgc8wjgmc.png","https:\/\/habrastorage.org\/webt\/o0\/wa\/v6\/o0wav6ogb8ofbx7-xqxsamjd6g4.png","https:\/\/habrastorage.org\/webt\/wi\/on\/5r\/wion5rbc8wx75tqwxzn-x72zsqw.png","https:\/\/habrastorage.org\/webt\/30\/uj\/tp\/30ujtpqhaaqkgx1oon7mjxpxiq8.png","https:\/\/habrastorage.org\/webt\/wz\/2-\/cj\/wz2-cjj1rusmnd270gkr5h8tdj0.jpeg","https:\/\/habrastorage.org\/webt\/ns\/-k\/gw\/ns-kgwhubcu9cdqybc4nierpkqe.png","https:\/\/habrastorage.org\/webt\/tl\/sg\/i3\/tlsgi347mdeagljpg7i8ojxcjxc.png","https:\/\/habrastorage.org\/webt\/co\/ri\/ec\/coriec6zvpz0pg5uy72kontsmc8.png","https:\/\/habrastorage.org\/webt\/mh\/iu\/le\/mhiulexz-l0j4snzfhdx8pvx8pa.png","https:\/\/habrastorage.org\/webt\/gj\/jp\/co\/gjjpcobjxxf3q_u3gdcoscfclda.png","https:\/\/habrastorage.org\/webt\/nh\/3v\/tc\/nh3vtc2h-zlu5jutajc6-oyoca4.jpeg","https:\/\/habrastorage.org\/webt\/ql\/1h\/j0\/ql1hj02fnqottbo5fstubt65pss.jpeg","https:\/\/habrastorage.org\/webt\/uf\/t7\/rx\/uft7rxuuaqu7ape9ehifdi6r6ki.png","https:\/\/habrastorage.org\/webt\/_t\/k7\/u6\/_tk7u6wbcv55zig2n-b1dlbm9hu.png","https:\/\/habrastorage.org\/webt\/vo\/m7\/qw\/vom7qwpkpnxqf9a7wk6arc8-gtm.png","https:\/\/habrastorage.org\/webt\/q7\/kq\/fh\/q7kqfhk7rrtwdzmergpd9yobbz0.png","https:\/\/habrastorage.org\/webt\/di\/tt\/ov\/dittovwssqwrbku8rfd7fxpqlqo.png","https:\/\/habrastorage.org\/webt\/td\/co\/z-\/tdcoz-1fk1-x880os0muqc_2iso.png","https:\/\/habrastorage.org\/getpro\/habr\/post_images\/e5c\/b97\/dc2\/e5cb97dc248ebb9ffa0ff46147c290d7.jpg"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/452638/582dcf4b981d319491597f2107da5295/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/452638/582dcf4b981d319491597f2107da5295/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/452638/582dcf4b981d319491597f2107da5295/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/452638/582dcf4b981d319491597f2107da5295/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/452638/582dcf4b981d319491597f2107da5295/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="452638" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-21T05:33:19.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/452638/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/company/2gis/blog/452638/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/452638/582dcf4b981d319491597f2107da5295/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" companyName="2gis" data-async-called="true" class="tm-page"><div class="tm-page-width"><div class="tm-page__header"><!----></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><div class="tm-company-card tm-company-article__company-card"><div class="tm-company-card__info"><div class="tm-company-card__header"><a href="/ru/company/2gis/profile/" class="tm-company-card__avatar"><div class="tm-entity-image"><img alt="" height="48" src="//habrastorage.org/getpro/habr/company/995/27f/562/99527f562a8700893d39f73e6d2e7e07.png" width="48" class="tm-entity-image__pic"></div></a> <!----> <div class="tm-rating tm-company-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">187.42</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div> <div class="tm-company-card__info"><a href="/ru/company/2gis/profile/" class="tm-company-card__name">
        2ГИС
      </a> <div class="tm-company-card__description">Главные по городской навигации</div></div></div> <div class="tm-company-card__buttons"><!----> <!----></div></div> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/autoclosure/" title="autoclosure" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/f77/bc9/537/f77bc95378a560b6bfa8e5768a80be4d.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/autoclosure/" class="tm-user-info__username">
      autoclosure
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-21T05:33:19.000Z" title="2019-05-21, 08:33">21  мая  2019 в 08:33</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/company/2gis/blog/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании 2ГИС</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/ios_dev/" class="tm-article-snippet__hubs-item-link"><span>Разработка под iOS</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/mobile_dev/" class="tm-article-snippet__hubs-item-link"><span>Разработка мобильных приложений</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/refactoring/" class="tm-article-snippet__hubs-item-link"><span>Проектирование и рефакторинг</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/autogadgets/" class="tm-article-snippet__hubs-item-link"><span>Автомобильные гаджеты</span> <!----></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><p><img src="https://habrastorage.org/r/w780q1/webt/tt/jg/a3/ttjga3qmefdwknrbj1i351exs3m.jpeg" data-src="https://habrastorage.org/webt/tt/jg/a3/ttjga3qmefdwknrbj1i351exs3m.jpeg" data-blurred="true"/></p><br/>
<p>Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными инструментами мы создали рабочий продукт и разместили его в AppStore.</p><a name="habracut"></a><br/>
<h2 id="para-slov-o-carplay">Пара слов о CarPlay</h2><br/>
<p><img src="https://habrastorage.org/r/w780q1/webt/hq/vu/xw/hqvuxwo3ms1ivfppuaojrfscvh0.jpeg" data-src="https://habrastorage.org/webt/hq/vu/xw/hqvuxwo3ms1ivfppuaojrfscvh0.jpeg" data-blurred="true"/></p><br/>
<p>Сначала немного матчасти для понимания некоторых аспектов работы CarPlay и причин, по которым мы приняли те или иные решения.</p><br/>
<p>CarPlay — это не ОС внутри другой ОС, как об этом пишут в очень многих статьях. Если грубо, то CarPlay — это протокол для работы с внешним дисплеем экрана головного устройства; звуком из динамиков автомобиля; тач-скринами, тач-панелями, шайбами и другими устройствами ввода.</p><br/>
<p>То есть весь исполняемый код находится непосредственно в основном приложении (даже не в отдельном extension’е!) Это очень круто: чтобы получить новые фичи, не нужно обновлять магнитолу или даже машину, нужно просто обновить iOS.</p><br/>
<p>На WWDC 2018 Keynote нам представили возможность создания навигационных приложений под CarPlay, что нас очень обрадовало. Сразу после презентации мы отправили <a href="https://developer.apple.com/carplay/">запрос</a> на разрешение разработки под CarPlay. В запросе необходимо было показать, что наше приложение умеет в навигацию.</p><br/>
<p>Пока мы ждали ответа от Apple, вышла <a href="https://developer.apple.com/videos/play/wwdc2018/213/">лекция</a>, в которой на примере sample-приложения CountryRoads рассказывали о работе с CarPlay.framework. В лекции не рассказали о подводных камнях и тонкостях при работе с CarPlay, но упомянули, что после подключения к CarPlay-магнитоле приложение будет работать в режиме background. </p><br/>
<h2 id="pervaya-palka-v-kolyosa">Первая палка в колёса</h2><br/>
<p>Работа приложения в background’е нас разочаровала. На это было две причины:</p><br/>
<ol>
<li>Мы не работаем в background’е. Когда-то оставили это ограничение по техническим причинам и ради энергосбережения.</li>
<li>Наша карта написана на OpenGL (да, deprecated, да, не Metal, мы всё это знаем), а OpenGL в background state’е не работает. В лучшем случае вы получите чёрную вьюху, а в худшем — краш.</li>
</ol><br/>
<p>С работой в background’е ещё можно было справиться, но с картой определённо нужно было что-то решать. Тогда-то и пришла идея сделать её через стандартную MKMapView. Пока вы не начали закидывать нас камнями за идею использовать стандартные карты Apple, объясню: мы собирались использовать MKMapView, но не карты Apple.</p><br/>
<p>Дело в том, что MKMapView умеет в загрузку сторонних тайлов. Тайлы — это специальные прямоугольные контейнеры для текстур. У нас как раз оказался сервачок, который умеет отдавать тайлы. На GitHub <a href="https://github.com/2gis/iOS-SDKs-for-tiles">есть код</a> с реализацией.</p><br/>
<h2 id="otvet-ot-apple">Ответ от Apple</h2><br/>
<p>Нам пришёл ответ от Apple, в котором, кроме разрешения на разработку, мы получили ещё и документацию «для избранных», код sample-приложения CountryRoads (его показывали на лекции WWDC) и, самое важное, приватный capability-ключ <code>com.apple.developer.carplay-maps</code>. Этот ключ прописывают в entitlements-файле со значением YES, чтобы система поняла, что вы можете обработать события от CarPlay при запуске вашего приложения.</p><br/>
<p>Не дождавшись спринта с выделенными под разработку сториками, я полез качать Xcode Beta. Первая попытка собрать 2ГИС была провальной. Зато проект sample-приложения CoutryRoads удалось собрать под симулятор. </p><br/>
<p>Перед каждым открытием окна симулятора CarPlay, последний должен был кастомизироваться через такое вот окно:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/3p/xn/rf/3pxnrf5dlvtq7n8qkuovquqgbbi.png"/></p><br/>
<p>Для этого нужно было прописать в терминале строчку: <code>defaults write com.apple.iphonesimulator CarPlayExtraOptions -bool YES</code></p><br/>
<p>По какой-то причине это не сработало — пришлось запускать почти на самом маленьком симуляторе с разрешением 800×480 поинтов и скейлом ×2. В данный момент эта настройка работает и отлично помогает.</p><br/>
<p>Создав свой sample-проект и вооружившись документацией, я начал разбираться, что к чему.<br/>
Первое, что я понял: навигационные приложения для CarPlay состоят из слоёв base view и templates. </p><br/>
<p><img src="https://habrastorage.org/r/w780q1/webt/hf/t2/rw/hft2rwp8m2d71popp3tus4dif20.jpeg" data-src="https://habrastorage.org/webt/hf/t2/rw/hft2rwp8m2d71popp3tus4dif20.jpeg" data-blurred="true"/></p><br/>
<p>Base view — это ваша карта. На этом слое должна быть только карта, никаких других вьюх и контролов.</p><br/>
<p>Templates — это почти не кастомизирующийся обязательный набор UI-элементов для отображения маршрутов, манёвров, всяких списочков и так далее.</p><br/>
<h2 id="razrabotka-bety">Разработка беты</h2><br/>
<p>Перейдём уже к написанию кода. Первое, что необходимо сделать, — реализовать парочку обязательных методов CPApplicationDelegate в файле ApplicationDelegate.</p><br/>
<pre><code class="swift">func application(
   _ application: UIApplication,
   didConnectCarInterfaceController controller: CPInterfaceController,
   to window: CPWindow
) {}

func application(
  _ application: UIApplication,
  didDisconnectCarInterfaceController controller: CPInterfaceController,
  from window: CPWindow
) {}</code></pre><br/>
<p>Давайте рассмотрим сигнатуру:</p><br/>
<p>С UIApplication всё понятно.<br/>
CPWindow — наследник UIWindow, окно для внешнего дисплея головного устройства магнитолы.<br/>
CPInterfaceController — что-то типа аналога UINavigationController’а, только из CarPlay.framework.</p><br/>
<p>Теперь перейдём непосредственно к реализации метода.</p><br/>
<pre><code class="swift">func application(
   _ application: UIApplication,
   didConnectCarInterfaceController controller: CPInterfaceController,
   to window: CPWindow
) {
  let carMapViewController = CarMapViewController(
    interfaceController: controller
  )
  let navigationController = UINavigationController(
    rootViewController: carMapViewController
  )
  window.rootViewController = navigationController
}</code></pre><br/>
<p>В didConnect необходимо написать код, похожий на тот, который мы привыкли видеть в didFinishLaunching. CarMapViewController — это base view (контроллер на самом деле, но ладно), как по документации.</p><br/>
<p>Вот такую картинку в итоге я получил:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/vv/l1/xx/vvl1xxebjbdb9ahiuucw1db_rzg.png"/></p><br/>
<p>Где-то в это время до меня дошло, что в новом Xcode new build system включена по умолчанию и, скорее всего, из-за этого 2ГИС не собирается.</p><br/>
<p>Я открыл Xcode, поставил legacy (а точнее stable, давайте называть вещи своими именами) build system, и моя теория подтвердилась: 2ГИС собрался.</p><br/>
<p>Выставив тот самый capability-ключ, я запустил 2ГИС под CarPlay и не увидел логов о переходе приложения в режим background. Стало ещё непонятнее, ведь инженеры Apple со сцены сказали про background-режим, но, с другой стороны, нам обещали contentView у UIAlertView, а в итоге UIAlertView стал deprecated.</p><br/>
<p>Решив, что так и должно быть, я не стал заморачиваться с MKMapView. Она лишила бы нас оффлайна и заставила заново писать отрисовку маршрутов.</p><br/>
<h2 id="problema-odnoy-karty">Проблема одной карты</h2><br/>
<p>Не успел я обрадоваться новости о том, что в CarPlay будет наша карта, как передо мной встала следующая проблема: из-за технических особенностей карта может быть только одна.<br/>
Быстрое решение этой проблемы было, хоть и не очень элегантное.</p><br/>
<p>Обычно в момент использования 2ГИС на CarPlay телефон заблокирован и лежит где-нибудь на полочке. А значит карта в этот момент на телефоне не сильно-то и нужна (не помешает для поиска, конечно). Поэтому мы решили при подсоединении телефона к CarPlay забирать карту из основного приложения и выводить её на экран CarPlay магнитолы. А при отсоединении, соответственно, возвращать обратно в приложение на телефон.</p><br/>
<p>Да, решение такое себе, но оно быстрое, до сих пор работает и не пришлось пинать пару других команд, чтобы склепать MVP.</p><br/>
<h2 id="kontroly-na-karte">Контролы на карте</h2><br/>
<p>Итак, мы получили нашу карту на экране магнитолы. Теперь необходимо было сделать первые и очевидные для любой карты вещи: контролы зума, текущего местоположения и перемещения карты.</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/c2/ql/u8/c2qlu8wi-sbkh5zizb7mjab-n7w.png"/></p><br/>
<p>Начнём с зума и текущего местоположения, ведь эти контролы находятся на самой карте и это не обычные UIControl. Как я писал выше, на base view находится только карта.</p><br/>
<p>Для того, что бы поместить эти контролы на карту, пришлось снова лезть в документацию и sample-приложение. Там я вычитал про первый темплейт — CPMapTemplate.</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/5d/xn/26/5dxn263mlspdif8eqhxgc8wjgmc.png"/></p><br/>
<p>CPMapTemplate — прозрачный темплейт для отображения некоторых контролов на карте и аналога navigationBar’а. Создаётся и выставляется он так:</p><br/>
<pre><code class="swift">let mapTemplate = CPMapTemplate()
self.interfaceController.setRootTemplate(mapTemplate, animated: false)</code></pre><br/>
<p>Далее необходимо создать эти контролы и положить их на карту.</p><br/>
<pre><code class="swift">let zoomInButton = CPMapButton(…)
let zoomOutButton = CPMapButton(…)
let myLocationButton = CPMapButton(…)

self.mapTemplate.mapButtons = [
  zoomInButton, 
  zoomOutButton, 
  myLocationButton
]</code></pre><br/>
<p>Но массив mapButtons оказался с приколом, ведь сколько в него элементов ни клади, он возьмёт только первые три элемента и отобразит их на экране. Ни ошибок в лог, ни ассертов вы не получите.</p><br/>
<p>Дальше я полез смотреть, как мне заставить двигаться карту, и нашёл в документации вот такое: </p><br/>
<pre><code class="plaintext">Navigation apps are designed to work with a variety of car input devices, and CarPlay does not support direct user interaction in the base view (apps do not directly receive tap or drag events). </code></pre><br/>
<p>Странно, подумал я, и полез смотреть, как это сделано в sample-приложении CountryRoads. Ответ — через вот такой интерфейс:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/o0/wa/v6/o0wav6ogb8ofbx7-xqxsamjd6g4.png"/></p><br/>
<p>Не очень удобно, но по-другому никак, документация же не будет врать, верно?</p><br/>
<p>Поскольку место для контролов на карте у нас закончилось, необходимо было сделать кнопку для перевода карты в режим «таскания» в этом аналоге navigationBar’а.</p><br/>
<pre><code class="swift">let panButton = CPBarButton(…)
self.mapTemplate.leadingNavigationBarButtons = [panButton]
self.mapTemplate.trailingNavigationBarButtons = []</code></pre><br/>
<p>Но вот массивы leadingNavigationBarButtons и trailingNavigationBarButtons тоже оказались не без прикола: сколько элементов в них ни пихай, они возьмут только первые два. Тоже без ошибок в логе и ассертов.</p><br/>
<p>А для активации и деактивации режима перетаскивания карты необходимо написать:</p><br/>
<pre><code class="swift">self.mapTemplate.showPanningInterface(animated: true)
self.mapTemplate.dismissPanningInterface(animated: true)</code></pre><br/>
<h2 id="postroenie-i-otobrazhenie-marshrutov-na-karte">Построение и отображение маршрутов на карте</h2><br/>
<p>Далее я приступил к тому, чтобы наше уже существующее API переиспользовать для построения маршрутов.</p><br/>
<p>Просто для демки и понимания, что и как делать, решил взять две точки и строить между ними маршрут. Точкой А было местоположение пользователя, а точкой Б — наш главный офис в Новосибирске.</p><br/>
<div class="spoiler"><b class="spoiler_title">Код</b><div class="spoiler_text"><pre><code class="swift">let choice0 = CPRouteChoice(
  summaryVariants: ["46 км"],
  additionalInformationVariants: ["с учетом пробок"],
  selectionSummaryVariants: ["1 час 7 мин"]
)
let choice1 = CPRouteChoice(
   summaryVariants: ["46 км"],
   additionalInformationVariants: ["с учетом пробок"],
   selectionSummaryVariants: [“1 час 11 мин"]
)

let startItem = MKMapItem(…)
let endItem = MKMapItem(…)
endItem.name = "Толмачёво, международный аэропорт”

let trip = CPTrip(
   origin: startItem,
   destination: endItem,
   routeChoices: [choice0, choice1]
)

let tripPreviewTextConfiguration = CPTripPreviewTextConfiguration(
   startButtonTitle: "В путь”,
   additionalRoutesButtonTitle: “Ещё”,
   overviewButtonTitle: "Назад"
)

self.mapTemplate.showTripPreviews(
  [trip],
  textConfiguration: tripPreviewTextConfiguration
)</code></pre></div></div><br/>
<p>На экране мы получили контрол с описанием маршрута:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/wi/on/5r/wion5rbc8wx75tqwxzn-x72zsqw.png"/></p><br/>
<h2 id="rezhim-navigacii">Режим навигации</h2><br/>
<p>Маршруты — это хорошо, но главная фишка навигатора всё же в навигации. Чтобы она появилась, необходимо написать следующее:</p><br/>
<pre><code class="swift">func mapTemplate(
  _ mapTemplate: CPMapTemplate,
  startedTrip trip: CPTrip,
  using routeChoice: CPRouteChoice
) {
   self.navigationSession = 
       self.mapTemplate.startNavigationSession(for: trip)
}</code></pre><br/>
<p>CPNavigationSession — класс, с помощью которого можно отображать некоторые UI-элементы, необходимые только в режиме навигации.</p><br/>
<p>Чтобы отобразить манёвр, необходимо:</p><br/>
<pre><code class="swift">let maneuver = CPManeuver()
maneuver.symbolSet = CPImageSet(
  lightContentImage: icon, 
  darkContentImage: darkIcon
)
maneuver.instructionVariants = ["Ул. Кутателадзе"]
maneuver.initialTravelEstimates = CPTravelEstimates(…)

self.navigationSession?.upcomingManeuvers = [maneuver]</code></pre><br/>
<p>После чего на экране магнитолы мы получим вот это:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/30/uj/tp/30ujtpqhaaqkgx1oon7mjxpxiq8.png"/></p><br/>
<p>Чтобы обновлять метраж до манёвра, необходимо:</p><br/>
<pre><code class="swift">let estimates = CPTravelEstimates(…)
self.navigationSession?.updateEstimates(estimates, for: maneuver)</code></pre><br/>
<h2 id="it-just-works">It just works!</h2><br/>
<p>Когда основная функциональность для навигатора был готова, я решил показать эту поделку на внутренней презентации. Презентация удалась: все загорелись идеей доделать, потестировать и запустить навигатор как можно скорее.</p><br/>
<p>Первым делом мы заказали реальное головное устройство с поддержкой CarPlay. И тут, как говорится, пошла жара.</p><br/>
<p><img src="https://habrastorage.org/r/w780q1/webt/wz/2-/cj/wz2-cjj1rusmnd270gkr5h8tdj0.jpeg" alt="PIONEER AVH-Z500BT" data-src="https://habrastorage.org/webt/wz/2-/cj/wz2-cjj1rusmnd270gkr5h8tdj0.jpeg" data-blurred="true"/></p><br/>
<h3 id="provision-profiles">Provision Profiles</h3><br/>
<p>Из-за добавления нового capability-ключа необходимо перегенерировать профили. В обычной разработке мы не думаем об этом, ведь Xcode сделает всё сам. Но не в случае с приватным ключом.</p><br/>
<pre><code class="plaintext">Code Signing Error: Automatic signing is unable to resolve an issue with the "v4ios" target's entitlements. Automatic signing can't add the com.apple.developer.carplay-maps entitlement to your provisioning profile. Switch to manual signing and resolve the issue by downloading a matching provisioning profile from the developer website.</code></pre><br/>
<p>Это так же сломало нам CI, так как для локальной дистрибуции версий приложения мы используем enterprise-аккаунт, в который мы не запрашивали разрешение на разработку приложения под CarPlay. Но это уже совсем другая история</p><br/>
<h3 id="debugging">Debugging</h3><br/>
<p>Подключиться к CarPlay можно через Bluetooth или Lightning. Практика показывает, что второй способ гораздо популярнее. Наша магнитола в Bluetooth не умела, поэтому во время разработки пришлось пользоваться Wi-Fi дебагом. Если вы пробовали его на проектах сложнее, чем hello world, то вы знаете, какой это ад.</p><br/>
<div class="spoiler"><b class="spoiler_title">А для тех, кто не пробовал, рассказываю:</b><div class="spoiler_text"><p>Я собирал приложение по проводу на телефон, а только потом, подключив телефон к CarPlay, через Wi-Fi, заливал на телефон и запускал по несколько минут.<br/>
Копирование приложения на телефон было около 3 минут, запуск приложения ещё около минуты и только потом после запуска остановка на брейкпоинтах была только секунд через 15. </p></div></div><br/>
<p>И тут мне стало очень интересно, почему Apple не сделала никакой DevKit (чтобы Apple-way, it just works и вот это всё). Без него собирать тестовый стенд было не очень удобно. До сих пор раз в пару недель что-нибудь отваливается — приходится по фоткам вспоминать, что куда втыкать. Хорошо, что админ при сборке этого стенда рассказал, что и зачем.</p><br/>
<h2 id="the-best-framework-we-ever-made">The best framework we ever made</h2><br/>
<p>В конце концов, когда всё собралось на реальное устройство, стало понятно, что фиче «2ГИС под CarPlay» точно быть. Настало время делать по красоте.</p><br/>
<h3 id="problemy-s-vyuportom">Проблемы с вьюпортом</h3><br/>
<p>Необходимо было настроить вьюпорт карты, чтобы рисовать маршруты в области без лишних контролов, а не просто посередине. Короче говоря, чтобы это выглядело не так:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/ns/-k/gw/ns-kgwhubcu9cdqybc4nierpkqe.png"/></p><br/>
<p>А так:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/tl/sg/i3/tlsgi347mdeagljpg7i8ojxcjxc.png"/></p><br/>
<p>Я рассчитывал, что получу какой-нибудь layoutGuide с текущей видимой областью. Чтобы он учитывал и navigationBar, и вьюшку с маршрутом, и контролы на карте. На деле я не получил ничего. До сих пор непонятно, как настраивать вьюпорт, поэтому у нас в коде есть хардкод типа:</p><br/>
<pre><code class="swift">let routeControlsWidth = self.view.frame.width * 0.48 
let zoomControlWidth = self.view.frame.width * 0.15</code></pre><br/>
<h3 id="postroenie-proezda-ne-tolko-mezhdu-dvumya-tochkami">Построение проезда не только между двумя точками</h3><br/>
<p>В первый релиз мы решили взять наш рубрикатор, сделанный через CPGridTemplate: </p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/co/ri/ec/coriec6zvpz0pg5uy72kontsmc8.png"/></p><br/>
<p>Избранное и Дом/Работа через CPListTemplate. </p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/mh/iu/le/mhiulexz-l0j4snzfhdx8pvx8pa.png"/></p><br/>
<p>И клавиатурный поиск через CPSearchTemplate: </p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/gj/jp/co/gjjpcobjxxf3q_u3gdcoscfclda.png"/></p><br/>
<p>Код я показывать про темплейты не буду, так как он простой и про него хорошо написана документация (хоть про что-то).</p><br/>
<div class="spoiler"><b class="spoiler_title">Однако стоит упомянуть, какие проблемы были обнаружены при работе с ними.</b><div class="spoiler_text"><p>CPInterfaceController может в навигацию, похожую на UIKit. т. е.</p><br/>
<pre><code class="swift">self.interfaceController.pushTemplate(listTemplate, animated: true)
self.interfaceController.presentTemplate(alertTemplate, animated: true)</code></pre><br/>
<p>Но если вы попытаетесь запушить, например CPAlertTemplate, то получите ассерт в логах, что CPAlertTemplate может быть только модально представлен.</p><br/>
<p>Непонятно, почему Apple не спрятали логику транзишенов под капотом, не сделав тогда интерфейс типа:</p><br/>
<pre><code class="swift">self.interfaceController.showTemplate(listTemplate, animated: true)</code></pre><br/>
<p>Это также сломало возможность пользоваться наследниками CPTemplate, словно контроллерами в UIKit.</p><br/>
<p>При попытке, например, положить в стек темплейтов ваш наследник, вы получите вот это:</p><br/>
<pre><code class="plaintext">Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: 'Unsupported object &lt;YourAwesomeGridTemplate: 0x60000060dce0> &lt;identifier: 6CAC7E3B-FE70-43FC-A8B1-8FC39334A61D, userInfo: (null)> passed to pushTemplate:animated:. Allowed classes: {(
    CPListTemplate,
    CPGridTemplate,
    CPSearchTemplate,
    CPMapTemplate
)}’</code></pre></div></div><br/>
<h3 id="testirovanie-i-bagi">Тестирование и баги</h3><br/>
<p>Тестированием занимался <a href="https://habr.com/ru/users/artemenko-a-a/" class="user_link">artemenko-a-a</a>. Один из первых багов, который он нашёл, мы до сих пор не можем починить.</p><br/>
<p>Дело в том, что при отсоединении телефона от CarPlay-магнитолы спорадически нас прибивает Watchdog — без объяснении причины. Даже syslogs открывали, ничего не понятно. Так что если есть идея, как починить или понять причину, то велкам в комменты.</p><br/>
<p>Следующий баг был в этом же месте, но с особенным поведением. Я писал выше, что метод didDisconnect у CPApplicationDelegate вызывается в момент отсоединения телефона от CarPlay. И в этом методе мы возвращаем карту с экрана магнитолы обратно в основное приложение. Представьте себе, сколько бы мы словили проблем, если бы этот метод не вызывался хотя бы раз из пяти.</p><br/>
<p>Стало понятно, что это проблема iOS, а не конкретно нашего приложения, так как вся система считала, что она подключена к CarPlay. </p><br/>
<p><img src="https://habrastorage.org/r/w780q1/webt/nh/3v/tc/nh3vtc2h-zlu5jutajc6-oyoca4.jpeg" data-src="https://habrastorage.org/webt/nh/3v/tc/nh3vtc2h-zlu5jutajc6-oyoca4.jpeg" data-blurred="true"/></p><br/>
<p>Я даже зарепортил это как radar (как и все остальные баги). Меня попросили скинуть логи с таким-то профилем, но я не мог ответить поддержке в течение некоторого времени, поэтому они закрыли radar.</p><br/>
<p>Раз Apple делать ничего не планировала, проблему пришлось обходить самостоятельно, так как воспроизводилась она достаточно часто.</p><br/>
<p>И тут я вспомнил, что львиная доля подключений к CarPlay идёт через Lightning. Это значит, что телефон в момент подключения заряжается, а в момент отключения заряжаться перестаёт. А если так, то можно подписаться на состояние батареи и точно узнать, когда телефон перестал заряжаться и отключился от CarPlay.</p><br/>
<p>Схема хиленькая, но выбора у нас не было. Мы пошли этим путём, и всё сработало! </p><br/>
<p><img src="https://habrastorage.org/r/w780q1/webt/ql/1h/j0/ql1hj02fnqottbo5fstubt65pss.jpeg" data-src="https://habrastorage.org/webt/ql/1h/j0/ql1hj02fnqottbo5fstubt65pss.jpeg" data-blurred="true"/></p><br/>
<p>К счастью, этот костыль из кода давно уже удалён: разработчики Apple починили всё в одном из релизов iOS.</p><br/>
<h2 id="istoriya-dvuh-redzhektov">История двух реджектов</h2><br/>
<p><strong>Первый реджект</strong> был связан с метадатой. В тексте реджекта говорилось, что у нас в описании (не release notes) не сказано о том, что мы поддерживаем CarPlay. Как вы можете догадаться, ни в review guideline’ах, ни у того же Google Maps такого не было. Мы не стали спорить (потому что это обычно дольше, чем править метадату), скопировали строчку из Release Notes в Description и стали ждали нового ревью.</p><br/>
<p><strong>Второй реджект</strong> случился из-за списка городов. У 2ГИСа есть очень крутая фича — полный офлайн-режим работы. Эта фича стрельнула нам в ногу.</p><br/>
<p>При подключении приложения без установленного города к CarPlay, мы не показываем карту, потому что показывать нечего. За это нас и зареджектили. Решение было простым: алерт без кнопок, в котором написано, что нужно скачать город. </p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/uf/t7/rx/uft7rxuuaqu7ape9ehifdi6r6ki.png"/></p><br/>
<h2 id="to-o-chyom-nelzya-govorit">То, о чём нельзя говорить</h2><br/>
<h3 id="peremeschenie-karty-zhestami">Перемещение карты жестами</h3><br/>
<p>Примерно в это же время вышел навигатор под CarPlay от Google Maps — и там можно было передвигать карту жестами по экрану. Приватные API, подумал я, это очевидно! Ребята из Google просто пришли из соседнего здания и сказали, что им надо. Ведь документация гласит:</p><br/>
<pre><code class="plaintext">Navigation apps are designed to work with a variety of car input devices, and CarPlay does not support direct user interaction in the base view (apps do not directly receive tap or drag events). </code></pre><br/>
<p>Однако я всё-таки решил убедиться и полез гуглить, хоть это и было почти бессмысленно, ведь никаких технических статей про CarPlay Navigation Apps не было. Однако я умудрился найти что-то полезное и, ВНЕЗАПНО, <a href="https://developer.apple.com/design/human-interface-guidelines/carplay/interaction/touchscreen/">на сайте Apple</a>.</p><br/>
<p>В гайдлайнах я нашел видео, которое говорит, что документация нагло врёт. На видео видно, как карту всё-таки можно перетаскивать жестами. Я понял, что ничего не понял, и единственное, что мне оставалось, — открыть CarPlay.framework и пересмотреть все .h файлы.</p><br/>
<p>И о чудо! Я нахожу в CPMapTemplate’е его делегат CPMapTemplateDelegate, в котором есть 3 метода, которые как будто кричат о том, что если их реализовать, то можно будет получить управление жестами картой.</p><br/>
<div class="spoiler"><b class="spoiler_title">3 метода</b><div class="spoiler_text"><p>/*<em>Called when a pan gesture begins. May not be called when connected to some CarPlay systems.<br/>
</em>/<br/>
optional public func mapTemplateDidBeginPanGesture(_ mapTemplate: CPMapTemplate)</p><br/>
<p>/*<em>Called when a pan gesture changes. May not be called when connected to some CarPlay systems.<br/>
</em>/<br/>
optional public func mapTemplate(_ mapTemplate: CPMapTemplate, didUpdatePanGestureWithTranslation translation: CGPoint, velocity: CGPoint)</p><br/>
<p>/*<em>Called when a pan gesture ends. May not be called when connected to some CarPlay systems.<br/>
</em>/<br/>
optional public func mapTemplate(_ mapTemplate: CPMapTemplate, didEndPanGestureWithVelocity velocity: CGPoint<br/>
)</p></div></div><br/>
<p>Я реализовал их и запустил приложение на симуляторе — ничего не сработало. Не успев расстроиться, я понял, что симулятор может быть такого же качества, как и документация, и собрал на девайс. Всё завелось, счастью не было предела!</p><br/>
<p>Забавный факт: CarPlay-магнитоле необходима четверть экрана, чтобы понять, что начался pan-жест. Хочу заметить, что UIPanGestureRecognizer’у нужно всего 10 поинтов.</p><br/>
<h3 id="neodinakovost-ui-na-raznyh-magnitolah">Неодинаковость UI на разных магнитолах</h3><br/>
<p>Нам в поддержку поступило обращение: у пользователя в поиске вылезает всего один саджест, хотя могло бы быть и больше. Странно, подумал я, ведь на всех экранах помещается всего одна строка. Запросили скриншот:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/_t/k7/u6/_tk7u6wbcv55zig2n-b1dlbm9hu.png"/></p><br/>
<p>И это совсем отличается от UI CPSearchTemplate, который я показывал выше. И это нужно учитывать при разработке, хоть и никак нельзя понять, сколько ячеек в табличке внизу может вместиться в экран.</p><br/>
<h3 id="kontrol-ogranicheniya-skorosti">Контрол ограничения скорости</h3><br/>
<p>Мы посмотрели на статистику и поняли, что навигатором для CarPlay пользуются и надо довести его хотя бы до уровня навигатора в основном приложении. В первую очередь решили добавить контрол ограничения скорости. Без проблем, конечно, не обошлось. </p><br/>
<p>Вопрос номер один: где размещать? </p><br/>
<p>Пошарив снова по .h файлам в CPWindow, я нашел любопытный layoutGuide:<br/>
var mapButtonSafeAreaLayoutGuide: UILayoutGuide</p><br/>
<p>И это оказалось тем, что нужно. Наш контрол отлично туда вписался:</p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/vo/m7/qw/vom7qwpkpnxqf9a7wk6arc8-gtm.png"/></p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/q7/kq/fh/q7kqfhk7rrtwdzmergpd9yobbz0.png"/></p><br/>
<p>Вопрос номер два: это, вообще, законно?</p><br/>
<p>Дело в том, что технически контрол находится на base view. А base view по документации не может содержать в себе ничего, кроме карты:</p><br/>
<pre><code class="plaintext">The base view is where the map is drawn. The base view must be used exclusively to draw a map, and may not be used to display other UI elements. Instead, navigation apps overlay UI elements such as the navigation bar and map buttons using the provided templates. </code></pre><br/>
<p>Но ревьюверы пропустили нас в AppStore, а значит контролы, которые касаются навигации, встраивать всё-таки можно.</p><br/>
<h3 id="golosovoy-poisk">Голосовой поиск</h3><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/di/tt/ov/dittovwssqwrbku8rfd7fxpqlqo.png"/></p><br/>
<p><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/td/co/z-/tdcoz-1fk1-x880os0muqc_2iso.png"/></p><br/>
<p>По-хорошему, эту фичу нужно было сделать в первую очередь, но у нас накопилось несколько задач из техдолга, которые мешали реализовать голосовой поиск для CarPlay. И эта задача оказалась не такой простой, как казалось.</p><br/>
<p><strong>Проблема первая: анимации.</strong> Дело в том, что в CPVoiceControlTemplate нет возможности сделать стандартные анимации. Анимацию для распознавания речи и поиска пришлось собирать покадрово из картинок и указывать, сколько они идут по времени.</p><br/>
<pre><code class="swift">for i in 1...12 {
   if let image = UIImage(named: "carplay_searching_\(i)") {
      images.append(image)
   }
}

let image = UIImage.animatedImage(with: images, duration: 0.96)</code></pre><br/>
<p>Выглядит, как можете догадаться, не очень, но и размер приложения раздувать не хочется.</p><br/>
<p><strong>Проблема вторая: доступы.</strong> Алерты на доступ к микрофону и распознаванию речи появляются на дисплее телефона. Пришлось писать на дисплее магнитолы, что пользователю необходимо взять телефон в руки, дать разрешение и только потом пользоваться навигатором на магнитоле. Очень удобно!</p><br/>
<h3 id="pravorulnye-avtomobili">Праворульные автомобили.</h3><br/>
<p>Нам прислали скриншот, в котором UI всего приложения был перевёрнут!</p><br/>
<p><img src="https://habrastorage.org/r/w780q1/getpro/habr/post_images/e5c/b97/dc2/e5cb97dc248ebb9ffa0ff46147c290d7.jpg" data-src="https://habrastorage.org/getpro/habr/post_images/e5c/b97/dc2/e5cb97dc248ebb9ffa0ff46147c290d7.jpg" data-blurred="true"/></p><br/>
<p>И, естественно, вьюпорт карты оставался таким, как мы его захардкодили, ведь никто не ожидал, что есть отдельная настройка для праворульных автомобилей. Как «правильно» это обойти, я не нашёл, но заметил, что, поскольку наш контрол ограничения скорости лежит в layoutGuide’е для контролов карты, он переместился в левую сторону. </p><br/>
<p>Ультрафикс не заставил себя ждать. Сделали грубо, но это работает.</p><br/>
<pre><code class="swift">let isLeftWheelCar = self.speedControlViewController.view.frame.origin.x > self.view.frame.size.width / 2.0</code></pre><br/>
<p>Очень надеюсь, что есть правильное решение, и я просто не дочитал.</p><br/>
<p>На этом у меня всё. Если вдруг соберётесь делать свой навигатор под CarPlay, учтите, что документация и фреймворк несовершенны. Платформа абсолютно новая, никто ничего не знает, а Apple делиться знаниями не торопятся.</p></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B2%D0%B3%D0%B8%D1%81%5D" class="tm-tags-list__link">2гис</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BCarPlay%5D" class="tm-tags-list__link">CarPlay</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BApple%5D" class="tm-tags-list__link">Apple</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B0%D0%B2%D1%82%D0%BE%D0%BC%D0%BE%D0%B1%D0%B8%D0%BB%D1%8C%5D" class="tm-tags-list__link">автомобиль</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BC%D0%B0%D0%B3%D0%BD%D0%B8%D1%82%D0%BE%D0%BB%D0%B0%5D" class="tm-tags-list__link">магнитола</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bwwds%5D" class="tm-tags-list__link">wwds</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bcountryroads%5D" class="tm-tags-list__link">countryroads</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bbackground%5D" class="tm-tags-list__link">background</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bopengl%5D" class="tm-tags-list__link">opengl</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bmkmapview%5D" class="tm-tags-list__link">mkmapview</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bcpapplicationdelegate%5D" class="tm-tags-list__link">cpapplicationdelegate</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bxcode%5D" class="tm-tags-list__link">xcode</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bcpmaptemplate%5D" class="tm-tags-list__link">cpmaptemplate</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%B2%D1%8C%D1%8E%D0%BF%D0%BE%D1%80%D1%82%5D" class="tm-tags-list__link">вьюпорт</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BF%D0%BE%D1%81%D1%82%D0%BE%D1%80%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B0%5D" class="tm-tags-list__link">посторение маршрута</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D1%80%D0%B5%D0%B4%D0%B6%D0%B5%D0%BA%D1%82%5D" class="tm-tags-list__link">реджект</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/company/2gis/blog/" class="tm-hubs-list__link router-link-active">
    Блог компании 2ГИС
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/ios_dev/" class="tm-hubs-list__link">
    Разработка под iOS
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/mobile_dev/" class="tm-hubs-list__link">
    Разработка мобильных приложений
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/refactoring/" class="tm-hubs-list__link">
    Проектирование и рефакторинг
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/autogadgets/" class="tm-hubs-list__link">
    Автомобильные гаджеты
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 107: ↑106 и ↓1</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 107: ↑106 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+105</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">44K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    55
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a href="/ru/company/2gis/profile/" class="tm-company-snippet__logo-link"><div class="tm-entity-image"><img alt="" height="40" src="//habrastorage.org/getpro/habr/company/995/27f/562/99527f562a8700893d39f73e6d2e7e07.png" width="40" class="tm-entity-image__pic"></div></a> <div class="tm-company-snippet__info"><a href="/ru/company/2gis/profile/" class="tm-company-snippet__title">2ГИС</a> <div class="tm-company-snippet__description">Главные по городской навигации</div></div></div> <div class="tm-article-author__buttons"><!----> <!----></div></div> <!----> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/autoclosure/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/f77/bc9/537/f77bc95378a560b6bfa8e5768a80be4d.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 34 голоса " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    34
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Shevelev Ivan</span> <a href="/ru/users/autoclosure/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @autoclosure
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">iOS Разработчик</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/company/2gis/blog/452638/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 86 
    </span></a> <!----></div></div></div>  <!---->  <!----> <!----></div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Информация</h2> <!----></header> <div class="tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="1999-04-24T20:00:00.000Z" title="1999-04-25, 00:00">25  апреля  1999</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="http://2gis.ru/" target="_blank" class="tm-company-basic-info__link">
      2gis.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    1 001–5 000 человек
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2008-08-09T07:43:03.000Z" title="2008-08-09, 11:43">9  августа  2008</time></dd></dl> <!----></div></div> <!----></section> <div class="tm-company-widgets"></div> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/company/2gis/blog/452638/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/company/2gis/blog/452638/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"452638":{"id":"452638","timePublished":"2019-05-21T05:33:19+00:00","isCorporative":true,"lang":"ru","titleHtml":"Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем","leadData":{"textHtml":"\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ftt\u002Fjg\u002Fa3\u002Fttjga3qmefdwknrbj1i351exs3m.jpeg\"\u003E\u003C\u002Fp\u003E\u003Cbr\u003E\r\n\u003Cp\u003EПривет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными инструментами мы создали рабочий продукт и разместили его в AppStore.\u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Поехали!","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":34,"votesCount":34},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"456436","alias":"autoclosure","fullname":"Shevelev Ivan","avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002Ff77\u002Fbc9\u002F537\u002Ff77bc95378a560b6bfa8e5768a80be4d.jpg","speciality":"iOS Разработчик"},"statistics":{"commentsCount":86,"favoritesCount":55,"readingCount":44319,"score":105,"votesCount":107},"hubs":[{"relatedData":null,"id":"5374","alias":"2gis","type":"corporative","title":"Блог компании 2ГИС","titleHtml":"Блог компании 2ГИС","isProfiled":false},{"relatedData":null,"id":"548","alias":"ios_dev","type":"collective","title":"Разработка под iOS","titleHtml":"Разработка под iOS","isProfiled":true},{"relatedData":null,"id":"6345","alias":"mobile_dev","type":"collective","title":"Разработка мобильных приложений","titleHtml":"Разработка мобильных приложений","isProfiled":true},{"relatedData":null,"id":"7504","alias":"refactoring","type":"collective","title":"Проектирование и рефакторинг","titleHtml":"Проектирование и рефакторинг","isProfiled":true},{"relatedData":null,"id":"21994","alias":"autogadgets","type":"collective","title":"Автомобильные гаджеты","titleHtml":"Автомобильные гаджеты","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"},{"id":"7","alias":"popsci","title":"Научпоп"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Ftt\u002Fjg\u002Fa3\u002Fttjga3qmefdwknrbj1i351exs3m.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ftt\u002Fjg\u002Fa3\u002Fttjga3qmefdwknrbj1i351exs3m.jpeg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПривет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными инструментами мы создали рабочий продукт и разместили его в AppStore.\u003C\u002Fp\u003E\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"para-slov-o-carplay\"\u003EПара слов о CarPlay\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fhq\u002Fvu\u002Fxw\u002Fhqvuxwo3ms1ivfppuaojrfscvh0.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fhq\u002Fvu\u002Fxw\u002Fhqvuxwo3ms1ivfppuaojrfscvh0.jpeg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСначала немного матчасти для понимания некоторых аспектов работы CarPlay и причин, по которым мы приняли те или иные решения.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003ECarPlay — это не ОС внутри другой ОС, как об этом пишут в очень многих статьях. Если грубо, то CarPlay — это протокол для работы с внешним дисплеем экрана головного устройства; звуком из динамиков автомобиля; тач-скринами, тач-панелями, шайбами и другими устройствами ввода.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТо есть весь исполняемый код находится непосредственно в основном приложении (даже не в отдельном extension’е!) Это очень круто: чтобы получить новые фичи, не нужно обновлять магнитолу или даже машину, нужно просто обновить iOS.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНа WWDC 2018 Keynote нам представили возможность создания навигационных приложений под CarPlay, что нас очень обрадовало. Сразу после презентации мы отправили \u003Ca href=\"https:\u002F\u002Fdeveloper.apple.com\u002Fcarplay\u002F\"\u003Eзапрос\u003C\u002Fa\u003E на разрешение разработки под CarPlay. В запросе необходимо было показать, что наше приложение умеет в навигацию.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПока мы ждали ответа от Apple, вышла \u003Ca href=\"https:\u002F\u002Fdeveloper.apple.com\u002Fvideos\u002Fplay\u002Fwwdc2018\u002F213\u002F\"\u003Eлекция\u003C\u002Fa\u003E, в которой на примере sample-приложения CountryRoads рассказывали о работе с CarPlay.framework. В лекции не рассказали о подводных камнях и тонкостях при работе с CarPlay, но упомянули, что после подключения к CarPlay-магнитоле приложение будет работать в режиме background. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"pervaya-palka-v-kolyosa\"\u003EПервая палка в колёса\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРабота приложения в background’е нас разочаровала. На это было две причины:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EМы не работаем в background’е. Когда-то оставили это ограничение по техническим причинам и ради энергосбережения.\u003C\u002Fli\u003E\r\n\u003Cli\u003EНаша карта написана на OpenGL (да, deprecated, да, не Metal, мы всё это знаем), а OpenGL в background state’е не работает. В лучшем случае вы получите чёрную вьюху, а в худшем — краш.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EС работой в background’е ещё можно было справиться, но с картой определённо нужно было что-то решать. Тогда-то и пришла идея сделать её через стандартную MKMapView. Пока вы не начали закидывать нас камнями за идею использовать стандартные карты Apple, объясню: мы собирались использовать MKMapView, но не карты Apple.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДело в том, что MKMapView умеет в загрузку сторонних тайлов. Тайлы — это специальные прямоугольные контейнеры для текстур. У нас как раз оказался сервачок, который умеет отдавать тайлы. На GitHub \u003Ca href=\"https:\u002F\u002Fgithub.com\u002F2gis\u002FiOS-SDKs-for-tiles\"\u003Eесть код\u003C\u002Fa\u003E с реализацией.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"otvet-ot-apple\"\u003EОтвет от Apple\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНам пришёл ответ от Apple, в котором, кроме разрешения на разработку, мы получили ещё и документацию «для избранных», код sample-приложения CountryRoads (его показывали на лекции WWDC) и, самое важное, приватный capability-ключ \u003Ccode\u003Ecom.apple.developer.carplay-maps\u003C\u002Fcode\u003E. Этот ключ прописывают в entitlements-файле со значением YES, чтобы система поняла, что вы можете обработать события от CarPlay при запуске вашего приложения.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНе дождавшись спринта с выделенными под разработку сториками, я полез качать Xcode Beta. Первая попытка собрать 2ГИС была провальной. Зато проект sample-приложения CoutryRoads удалось собрать под симулятор. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПеред каждым открытием окна симулятора CarPlay, последний должен был кастомизироваться через такое вот окно:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F3p\u002Fxn\u002Frf\u002F3pxnrf5dlvtq7n8qkuovquqgbbi.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля этого нужно было прописать в терминале строчку: \u003Ccode\u003Edefaults write com.apple.iphonesimulator CarPlayExtraOptions -bool YES\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПо какой-то причине это не сработало — пришлось запускать почти на самом маленьком симуляторе с разрешением 800×480 поинтов и скейлом ×2. В данный момент эта настройка работает и отлично помогает.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздав свой sample-проект и вооружившись документацией, я начал разбираться, что к чему.\u003Cbr\u002F\u003E\r\nПервое, что я понял: навигационные приложения для CarPlay состоят из слоёв base view и templates. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fhf\u002Ft2\u002Frw\u002Fhft2rwp8m2d71popp3tus4dif20.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fhf\u002Ft2\u002Frw\u002Fhft2rwp8m2d71popp3tus4dif20.jpeg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EBase view — это ваша карта. На этом слое должна быть только карта, никаких других вьюх и контролов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003ETemplates — это почти не кастомизирующийся обязательный набор UI-элементов для отображения маршрутов, манёвров, всяких списочков и так далее.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"razrabotka-bety\"\u003EРазработка беты\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПерейдём уже к написанию кода. Первое, что необходимо сделать, — реализовать парочку обязательных методов CPApplicationDelegate в файле ApplicationDelegate.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Efunc application(\n   _ application: UIApplication,\n   didConnectCarInterfaceController controller: CPInterfaceController,\n   to window: CPWindow\n) {}\n\nfunc application(\n  _ application: UIApplication,\n  didDisconnectCarInterfaceController controller: CPInterfaceController,\n  from window: CPWindow\n) {}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДавайте рассмотрим сигнатуру:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EС UIApplication всё понятно.\u003Cbr\u002F\u003E\r\nCPWindow — наследник UIWindow, окно для внешнего дисплея головного устройства магнитолы.\u003Cbr\u002F\u003E\r\nCPInterfaceController — что-то типа аналога UINavigationController’а, только из CarPlay.framework.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь перейдём непосредственно к реализации метода.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Efunc application(\n   _ application: UIApplication,\n   didConnectCarInterfaceController controller: CPInterfaceController,\n   to window: CPWindow\n) {\n  let carMapViewController = CarMapViewController(\n    interfaceController: controller\n  )\n  let navigationController = UINavigationController(\n    rootViewController: carMapViewController\n  )\n  window.rootViewController = navigationController\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ didConnect необходимо написать код, похожий на тот, который мы привыкли видеть в didFinishLaunching. CarMapViewController — это base view (контроллер на самом деле, но ладно), как по документации.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВот такую картинку в итоге я получил:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fvv\u002Fl1\u002Fxx\u002Fvvl1xxebjbdb9ahiuucw1db_rzg.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EГде-то в это время до меня дошло, что в новом Xcode new build system включена по умолчанию и, скорее всего, из-за этого 2ГИС не собирается.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЯ открыл Xcode, поставил legacy (а точнее stable, давайте называть вещи своими именами) build system, и моя теория подтвердилась: 2ГИС собрался.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВыставив тот самый capability-ключ, я запустил 2ГИС под CarPlay и не увидел логов о переходе приложения в режим background. Стало ещё непонятнее, ведь инженеры Apple со сцены сказали про background-режим, но, с другой стороны, нам обещали contentView у UIAlertView, а в итоге UIAlertView стал deprecated.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРешив, что так и должно быть, я не стал заморачиваться с MKMapView. Она лишила бы нас оффлайна и заставила заново писать отрисовку маршрутов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"problema-odnoy-karty\"\u003EПроблема одной карты\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНе успел я обрадоваться новости о том, что в CarPlay будет наша карта, как передо мной встала следующая проблема: из-за технических особенностей карта может быть только одна.\u003Cbr\u002F\u003E\r\nБыстрое решение этой проблемы было, хоть и не очень элегантное.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EОбычно в момент использования 2ГИС на CarPlay телефон заблокирован и лежит где-нибудь на полочке. А значит карта в этот момент на телефоне не сильно-то и нужна (не помешает для поиска, конечно). Поэтому мы решили при подсоединении телефона к CarPlay забирать карту из основного приложения и выводить её на экран CarPlay магнитолы. А при отсоединении, соответственно, возвращать обратно в приложение на телефон.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДа, решение такое себе, но оно быстрое, до сих пор работает и не пришлось пинать пару других команд, чтобы склепать MVP.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"kontroly-na-karte\"\u003EКонтролы на карте\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИтак, мы получили нашу карту на экране магнитолы. Теперь необходимо было сделать первые и очевидные для любой карты вещи: контролы зума, текущего местоположения и перемещения карты.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fc2\u002Fql\u002Fu8\u002Fc2qlu8wi-sbkh5zizb7mjab-n7w.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНачнём с зума и текущего местоположения, ведь эти контролы находятся на самой карте и это не обычные UIControl. Как я писал выше, на base view находится только карта.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля того, что бы поместить эти контролы на карту, пришлось снова лезть в документацию и sample-приложение. Там я вычитал про первый темплейт — CPMapTemplate.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F5d\u002Fxn\u002F26\u002F5dxn263mlspdif8eqhxgc8wjgmc.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003ECPMapTemplate — прозрачный темплейт для отображения некоторых контролов на карте и аналога navigationBar’а. Создаётся и выставляется он так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet mapTemplate = CPMapTemplate()\nself.interfaceController.setRootTemplate(mapTemplate, animated: false)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДалее необходимо создать эти контролы и положить их на карту.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet zoomInButton = CPMapButton(…)\nlet zoomOutButton = CPMapButton(…)\nlet myLocationButton = CPMapButton(…)\n\nself.mapTemplate.mapButtons = [\n  zoomInButton, \n  zoomOutButton, \n  myLocationButton\n]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНо массив mapButtons оказался с приколом, ведь сколько в него элементов ни клади, он возьмёт только первые три элемента и отобразит их на экране. Ни ошибок в лог, ни ассертов вы не получите.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДальше я полез смотреть, как мне заставить двигаться карту, и нашёл в документации вот такое: \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ENavigation apps are designed to work with a variety of car input devices, and CarPlay does not support direct user interaction in the base view (apps do not directly receive tap or drag events). \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСтранно, подумал я, и полез смотреть, как это сделано в sample-приложении CountryRoads. Ответ — через вот такой интерфейс:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fo0\u002Fwa\u002Fv6\u002Fo0wav6ogb8ofbx7-xqxsamjd6g4.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНе очень удобно, но по-другому никак, документация же не будет врать, верно?\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПоскольку место для контролов на карте у нас закончилось, необходимо было сделать кнопку для перевода карты в режим «таскания» в этом аналоге navigationBar’а.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet panButton = CPBarButton(…)\nself.mapTemplate.leadingNavigationBarButtons = [panButton]\nself.mapTemplate.trailingNavigationBarButtons = []\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНо вот массивы leadingNavigationBarButtons и trailingNavigationBarButtons тоже оказались не без прикола: сколько элементов в них ни пихай, они возьмут только первые два. Тоже без ошибок в логе и ассертов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EА для активации и деактивации режима перетаскивания карты необходимо написать:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Eself.mapTemplate.showPanningInterface(animated: true)\nself.mapTemplate.dismissPanningInterface(animated: true)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"postroenie-i-otobrazhenie-marshrutov-na-karte\"\u003EПостроение и отображение маршрутов на карте\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДалее я приступил к тому, чтобы наше уже существующее API переиспользовать для построения маршрутов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПросто для демки и понимания, что и как делать, решил взять две точки и строить между ними маршрут. Точкой А было местоположение пользователя, а точкой Б — наш главный офис в Новосибирске.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\"\u003E\u003Cb class=\"spoiler_title\"\u003EКод\u003C\u002Fb\u003E\u003Cdiv class=\"spoiler_text\"\u003E\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet choice0 = CPRouteChoice(\n  summaryVariants: [\"46 км\"],\n  additionalInformationVariants: [\"с учетом пробок\"],\n  selectionSummaryVariants: [\"1 час 7 мин\"]\n)\nlet choice1 = CPRouteChoice(\n   summaryVariants: [\"46 км\"],\n   additionalInformationVariants: [\"с учетом пробок\"],\n   selectionSummaryVariants: [“1 час 11 мин\"]\n)\n\nlet startItem = MKMapItem(…)\nlet endItem = MKMapItem(…)\nendItem.name = \"Толмачёво, международный аэропорт”\n\nlet trip = CPTrip(\n   origin: startItem,\n   destination: endItem,\n   routeChoices: [choice0, choice1]\n)\n\nlet tripPreviewTextConfiguration = CPTripPreviewTextConfiguration(\n   startButtonTitle: \"В путь”,\n   additionalRoutesButtonTitle: “Ещё”,\n   overviewButtonTitle: \"Назад\"\n)\n\nself.mapTemplate.showTripPreviews(\n  [trip],\n  textConfiguration: tripPreviewTextConfiguration\n)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНа экране мы получили контрол с описанием маршрута:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fwi\u002Fon\u002F5r\u002Fwion5rbc8wx75tqwxzn-x72zsqw.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"rezhim-navigacii\"\u003EРежим навигации\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМаршруты — это хорошо, но главная фишка навигатора всё же в навигации. Чтобы она появилась, необходимо написать следующее:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Efunc mapTemplate(\n  _ mapTemplate: CPMapTemplate,\n  startedTrip trip: CPTrip,\n  using routeChoice: CPRouteChoice\n) {\n   self.navigationSession = \n       self.mapTemplate.startNavigationSession(for: trip)\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003ECPNavigationSession — класс, с помощью которого можно отображать некоторые UI-элементы, необходимые только в режиме навигации.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧтобы отобразить манёвр, необходимо:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet maneuver = CPManeuver()\nmaneuver.symbolSet = CPImageSet(\n  lightContentImage: icon, \n  darkContentImage: darkIcon\n)\nmaneuver.instructionVariants = [\"Ул. Кутателадзе\"]\nmaneuver.initialTravelEstimates = CPTravelEstimates(…)\n\nself.navigationSession?.upcomingManeuvers = [maneuver]\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПосле чего на экране магнитолы мы получим вот это:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F30\u002Fuj\u002Ftp\u002F30ujtpqhaaqkgx1oon7mjxpxiq8.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧтобы обновлять метраж до манёвра, необходимо:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet estimates = CPTravelEstimates(…)\nself.navigationSession?.updateEstimates(estimates, for: maneuver)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"it-just-works\"\u003EIt just works!\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКогда основная функциональность для навигатора был готова, я решил показать эту поделку на внутренней презентации. Презентация удалась: все загорелись идеей доделать, потестировать и запустить навигатор как можно скорее.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПервым делом мы заказали реальное головное устройство с поддержкой CarPlay. И тут, как говорится, пошла жара.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fwz\u002F2-\u002Fcj\u002Fwz2-cjj1rusmnd270gkr5h8tdj0.jpeg\" alt=\"PIONEER AVH-Z500BT\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fwz\u002F2-\u002Fcj\u002Fwz2-cjj1rusmnd270gkr5h8tdj0.jpeg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"provision-profiles\"\u003EProvision Profiles\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИз-за добавления нового capability-ключа необходимо перегенерировать профили. В обычной разработке мы не думаем об этом, ведь Xcode сделает всё сам. Но не в случае с приватным ключом.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ECode Signing Error: Automatic signing is unable to resolve an issue with the \"v4ios\" target's entitlements. Automatic signing can't add the com.apple.developer.carplay-maps entitlement to your provisioning profile. Switch to manual signing and resolve the issue by downloading a matching provisioning profile from the developer website.\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЭто так же сломало нам CI, так как для локальной дистрибуции версий приложения мы используем enterprise-аккаунт, в который мы не запрашивали разрешение на разработку приложения под CarPlay. Но это уже совсем другая история\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"debugging\"\u003EDebugging\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПодключиться к CarPlay можно через Bluetooth или Lightning. Практика показывает, что второй способ гораздо популярнее. Наша магнитола в Bluetooth не умела, поэтому во время разработки пришлось пользоваться Wi-Fi дебагом. Если вы пробовали его на проектах сложнее, чем hello world, то вы знаете, какой это ад.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\"\u003E\u003Cb class=\"spoiler_title\"\u003EА для тех, кто не пробовал, рассказываю:\u003C\u002Fb\u003E\u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003EЯ собирал приложение по проводу на телефон, а только потом, подключив телефон к CarPlay, через Wi-Fi, заливал на телефон и запускал по несколько минут.\u003Cbr\u002F\u003E\r\nКопирование приложения на телефон было около 3 минут, запуск приложения ещё около минуты и только потом после запуска остановка на брейкпоинтах была только секунд через 15. \u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИ тут мне стало очень интересно, почему Apple не сделала никакой DevKit (чтобы Apple-way, it just works и вот это всё). Без него собирать тестовый стенд было не очень удобно. До сих пор раз в пару недель что-нибудь отваливается — приходится по фоткам вспоминать, что куда втыкать. Хорошо, что админ при сборке этого стенда рассказал, что и зачем.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"the-best-framework-we-ever-made\"\u003EThe best framework we ever made\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ конце концов, когда всё собралось на реальное устройство, стало понятно, что фиче «2ГИС под CarPlay» точно быть. Настало время делать по красоте.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"problemy-s-vyuportom\"\u003EПроблемы с вьюпортом\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНеобходимо было настроить вьюпорт карты, чтобы рисовать маршруты в области без лишних контролов, а не просто посередине. Короче говоря, чтобы это выглядело не так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fns\u002F-k\u002Fgw\u002Fns-kgwhubcu9cdqybc4nierpkqe.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EА так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ftl\u002Fsg\u002Fi3\u002Ftlsgi347mdeagljpg7i8ojxcjxc.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЯ рассчитывал, что получу какой-нибудь layoutGuide с текущей видимой областью. Чтобы он учитывал и navigationBar, и вьюшку с маршрутом, и контролы на карте. На деле я не получил ничего. До сих пор непонятно, как настраивать вьюпорт, поэтому у нас в коде есть хардкод типа:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet routeControlsWidth = self.view.frame.width * 0.48 \nlet zoomControlWidth = self.view.frame.width * 0.15\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"postroenie-proezda-ne-tolko-mezhdu-dvumya-tochkami\"\u003EПостроение проезда не только между двумя точками\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ первый релиз мы решили взять наш рубрикатор, сделанный через CPGridTemplate: \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fco\u002Fri\u002Fec\u002Fcoriec6zvpz0pg5uy72kontsmc8.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИзбранное и Дом\u002FРабота через CPListTemplate. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fmh\u002Fiu\u002Fle\u002Fmhiulexz-l0j4snzfhdx8pvx8pa.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИ клавиатурный поиск через CPSearchTemplate: \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fgj\u002Fjp\u002Fco\u002Fgjjpcobjxxf3q_u3gdcoscfclda.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКод я показывать про темплейты не буду, так как он простой и про него хорошо написана документация (хоть про что-то).\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\"\u003E\u003Cb class=\"spoiler_title\"\u003EОднако стоит упомянуть, какие проблемы были обнаружены при работе с ними.\u003C\u002Fb\u003E\u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003ECPInterfaceController может в навигацию, похожую на UIKit. т. е.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Eself.interfaceController.pushTemplate(listTemplate, animated: true)\nself.interfaceController.presentTemplate(alertTemplate, animated: true)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНо если вы попытаетесь запушить, например CPAlertTemplate, то получите ассерт в логах, что CPAlertTemplate может быть только модально представлен.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНепонятно, почему Apple не спрятали логику транзишенов под капотом, не сделав тогда интерфейс типа:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Eself.interfaceController.showTemplate(listTemplate, animated: true)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЭто также сломало возможность пользоваться наследниками CPTemplate, словно контроллерами в UIKit.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПри попытке, например, положить в стек темплейтов ваш наследник, вы получите вот это:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ETerminating app due to uncaught exception 'NSInvalidArgumentException', reason: 'Unsupported object &lt;YourAwesomeGridTemplate: 0x60000060dce0\u003E &lt;identifier: 6CAC7E3B-FE70-43FC-A8B1-8FC39334A61D, userInfo: (null)\u003E passed to pushTemplate:animated:. Allowed classes: {(\n    CPListTemplate,\n    CPGridTemplate,\n    CPSearchTemplate,\n    CPMapTemplate\n)}’\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"testirovanie-i-bagi\"\u003EТестирование и баги\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТестированием занимался \u003Ca href=\"https:\u002F\u002Fhabr.com\u002Fru\u002Fusers\u002Fartemenko-a-a\u002F\" class=\"user_link\"\u003Eartemenko-a-a\u003C\u002Fa\u003E. Один из первых багов, который он нашёл, мы до сих пор не можем починить.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДело в том, что при отсоединении телефона от CarPlay-магнитолы спорадически нас прибивает Watchdog — без объяснении причины. Даже syslogs открывали, ничего не понятно. Так что если есть идея, как починить или понять причину, то велкам в комменты.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСледующий баг был в этом же месте, но с особенным поведением. Я писал выше, что метод didDisconnect у CPApplicationDelegate вызывается в момент отсоединения телефона от CarPlay. И в этом методе мы возвращаем карту с экрана магнитолы обратно в основное приложение. Представьте себе, сколько бы мы словили проблем, если бы этот метод не вызывался хотя бы раз из пяти.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСтало понятно, что это проблема iOS, а не конкретно нашего приложения, так как вся система считала, что она подключена к CarPlay. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fnh\u002F3v\u002Ftc\u002Fnh3vtc2h-zlu5jutajc6-oyoca4.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fnh\u002F3v\u002Ftc\u002Fnh3vtc2h-zlu5jutajc6-oyoca4.jpeg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЯ даже зарепортил это как radar (как и все остальные баги). Меня попросили скинуть логи с таким-то профилем, но я не мог ответить поддержке в течение некоторого времени, поэтому они закрыли radar.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРаз Apple делать ничего не планировала, проблему пришлось обходить самостоятельно, так как воспроизводилась она достаточно часто.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИ тут я вспомнил, что львиная доля подключений к CarPlay идёт через Lightning. Это значит, что телефон в момент подключения заряжается, а в момент отключения заряжаться перестаёт. А если так, то можно подписаться на состояние батареи и точно узнать, когда телефон перестал заряжаться и отключился от CarPlay.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСхема хиленькая, но выбора у нас не было. Мы пошли этим путём, и всё сработало! \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fql\u002F1h\u002Fj0\u002Fql1hj02fnqottbo5fstubt65pss.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fql\u002F1h\u002Fj0\u002Fql1hj02fnqottbo5fstubt65pss.jpeg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EК счастью, этот костыль из кода давно уже удалён: разработчики Apple починили всё в одном из релизов iOS.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"istoriya-dvuh-redzhektov\"\u003EИстория двух реджектов\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cstrong\u003EПервый реджект\u003C\u002Fstrong\u003E был связан с метадатой. В тексте реджекта говорилось, что у нас в описании (не release notes) не сказано о том, что мы поддерживаем CarPlay. Как вы можете догадаться, ни в review guideline’ах, ни у того же Google Maps такого не было. Мы не стали спорить (потому что это обычно дольше, чем править метадату), скопировали строчку из Release Notes в Description и стали ждали нового ревью.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cstrong\u003EВторой реджект\u003C\u002Fstrong\u003E случился из-за списка городов. У 2ГИСа есть очень крутая фича — полный офлайн-режим работы. Эта фича стрельнула нам в ногу.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПри подключении приложения без установленного города к CarPlay, мы не показываем карту, потому что показывать нечего. За это нас и зареджектили. Решение было простым: алерт без кнопок, в котором написано, что нужно скачать город. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fuf\u002Ft7\u002Frx\u002Fuft7rxuuaqu7ape9ehifdi6r6ki.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"to-o-chyom-nelzya-govorit\"\u003EТо, о чём нельзя говорить\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"peremeschenie-karty-zhestami\"\u003EПеремещение карты жестами\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПримерно в это же время вышел навигатор под CarPlay от Google Maps — и там можно было передвигать карту жестами по экрану. Приватные API, подумал я, это очевидно! Ребята из Google просто пришли из соседнего здания и сказали, что им надо. Ведь документация гласит:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003ENavigation apps are designed to work with a variety of car input devices, and CarPlay does not support direct user interaction in the base view (apps do not directly receive tap or drag events). \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EОднако я всё-таки решил убедиться и полез гуглить, хоть это и было почти бессмысленно, ведь никаких технических статей про CarPlay Navigation Apps не было. Однако я умудрился найти что-то полезное и, ВНЕЗАПНО, \u003Ca href=\"https:\u002F\u002Fdeveloper.apple.com\u002Fdesign\u002Fhuman-interface-guidelines\u002Fcarplay\u002Finteraction\u002Ftouchscreen\u002F\"\u003Eна сайте Apple\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ гайдлайнах я нашел видео, которое говорит, что документация нагло врёт. На видео видно, как карту всё-таки можно перетаскивать жестами. Я понял, что ничего не понял, и единственное, что мне оставалось, — открыть CarPlay.framework и пересмотреть все .h файлы.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИ о чудо! Я нахожу в CPMapTemplate’е его делегат CPMapTemplateDelegate, в котором есть 3 метода, которые как будто кричат о том, что если их реализовать, то можно будет получить управление жестами картой.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"spoiler\"\u003E\u003Cb class=\"spoiler_title\"\u003E3 метода\u003C\u002Fb\u003E\u003Cdiv class=\"spoiler_text\"\u003E\u003Cp\u003E\u002F*\u003Cem\u003ECalled when a pan gesture begins. May not be called when connected to some CarPlay systems.\u003Cbr\u002F\u003E\r\n\u003C\u002Fem\u003E\u002F\u003Cbr\u002F\u003E\r\noptional public func mapTemplateDidBeginPanGesture(_ mapTemplate: CPMapTemplate)\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u002F*\u003Cem\u003ECalled when a pan gesture changes. May not be called when connected to some CarPlay systems.\u003Cbr\u002F\u003E\r\n\u003C\u002Fem\u003E\u002F\u003Cbr\u002F\u003E\r\noptional public func mapTemplate(_ mapTemplate: CPMapTemplate, didUpdatePanGestureWithTranslation translation: CGPoint, velocity: CGPoint)\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u002F*\u003Cem\u003ECalled when a pan gesture ends. May not be called when connected to some CarPlay systems.\u003Cbr\u002F\u003E\r\n\u003C\u002Fem\u003E\u002F\u003Cbr\u002F\u003E\r\noptional public func mapTemplate(_ mapTemplate: CPMapTemplate, didEndPanGestureWithVelocity velocity: CGPoint\u003Cbr\u002F\u003E\r\n)\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЯ реализовал их и запустил приложение на симуляторе — ничего не сработало. Не успев расстроиться, я понял, что симулятор может быть такого же качества, как и документация, и собрал на девайс. Всё завелось, счастью не было предела!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЗабавный факт: CarPlay-магнитоле необходима четверть экрана, чтобы понять, что начался pan-жест. Хочу заметить, что UIPanGestureRecognizer’у нужно всего 10 поинтов.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"neodinakovost-ui-na-raznyh-magnitolah\"\u003EНеодинаковость UI на разных магнитолах\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНам в поддержку поступило обращение: у пользователя в поиске вылезает всего один саджест, хотя могло бы быть и больше. Странно, подумал я, ведь на всех экранах помещается всего одна строка. Запросили скриншот:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F_t\u002Fk7\u002Fu6\u002F_tk7u6wbcv55zig2n-b1dlbm9hu.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИ это совсем отличается от UI CPSearchTemplate, который я показывал выше. И это нужно учитывать при разработке, хоть и никак нельзя понять, сколько ячеек в табличке внизу может вместиться в экран.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"kontrol-ogranicheniya-skorosti\"\u003EКонтрол ограничения скорости\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМы посмотрели на статистику и поняли, что навигатором для CarPlay пользуются и надо довести его хотя бы до уровня навигатора в основном приложении. В первую очередь решили добавить контрол ограничения скорости. Без проблем, конечно, не обошлось. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВопрос номер один: где размещать? \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПошарив снова по .h файлам в CPWindow, я нашел любопытный layoutGuide:\u003Cbr\u002F\u003E\r\nvar mapButtonSafeAreaLayoutGuide: UILayoutGuide\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИ это оказалось тем, что нужно. Наш контрол отлично туда вписался:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fvo\u002Fm7\u002Fqw\u002Fvom7qwpkpnxqf9a7wk6arc8-gtm.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fq7\u002Fkq\u002Ffh\u002Fq7kqfhk7rrtwdzmergpd9yobbz0.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВопрос номер два: это, вообще, законно?\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДело в том, что технически контрол находится на base view. А base view по документации не может содержать в себе ничего, кроме карты:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003EThe base view is where the map is drawn. The base view must be used exclusively to draw a map, and may not be used to display other UI elements. Instead, navigation apps overlay UI elements such as the navigation bar and map buttons using the provided templates. \u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНо ревьюверы пропустили нас в AppStore, а значит контролы, которые касаются навигации, встраивать всё-таки можно.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"golosovoy-poisk\"\u003EГолосовой поиск\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fdi\u002Ftt\u002Fov\u002Fdittovwssqwrbku8rfd7fxpqlqo.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ftd\u002Fco\u002Fz-\u002Ftdcoz-1fk1-x880os0muqc_2iso.png\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПо-хорошему, эту фичу нужно было сделать в первую очередь, но у нас накопилось несколько задач из техдолга, которые мешали реализовать голосовой поиск для CarPlay. И эта задача оказалась не такой простой, как казалось.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cstrong\u003EПроблема первая: анимации.\u003C\u002Fstrong\u003E Дело в том, что в CPVoiceControlTemplate нет возможности сделать стандартные анимации. Анимацию для распознавания речи и поиска пришлось собирать покадрово из картинок и указывать, сколько они идут по времени.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Efor i in 1...12 {\n   if let image = UIImage(named: \"carplay_searching_\\(i)\") {\n      images.append(image)\n   }\n}\n\nlet image = UIImage.animatedImage(with: images, duration: 0.96)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВыглядит, как можете догадаться, не очень, но и размер приложения раздувать не хочется.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cstrong\u003EПроблема вторая: доступы.\u003C\u002Fstrong\u003E Алерты на доступ к микрофону и распознаванию речи появляются на дисплее телефона. Пришлось писать на дисплее магнитолы, что пользователю необходимо взять телефон в руки, дать разрешение и только потом пользоваться навигатором на магнитоле. Очень удобно!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"pravorulnye-avtomobili\"\u003EПраворульные автомобили.\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНам прислали скриншот, в котором UI всего приложения был перевёрнут!\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe5c\u002Fb97\u002Fdc2\u002Fe5cb97dc248ebb9ffa0ff46147c290d7.jpg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fpost_images\u002Fe5c\u002Fb97\u002Fdc2\u002Fe5cb97dc248ebb9ffa0ff46147c290d7.jpg\" data-blurred=\"true\"\u002F\u003E\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИ, естественно, вьюпорт карты оставался таким, как мы его захардкодили, ведь никто не ожидал, что есть отдельная настройка для праворульных автомобилей. Как «правильно» это обойти, я не нашёл, но заметил, что, поскольку наш контрол ограничения скорости лежит в layoutGuide’е для контролов карты, он переместился в левую сторону. \u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EУльтрафикс не заставил себя ждать. Сделали грубо, но это работает.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Elet isLeftWheelCar = self.speedControlViewController.view.frame.origin.x \u003E self.view.frame.size.width \u002F 2.0\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EОчень надеюсь, что есть правильное решение, и я просто не дочитал.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНа этом у меня всё. Если вдруг соберётесь делать свой навигатор под CarPlay, учтите, что документация и фреймворк несовершенны. Платформа абсолютно новая, никто ничего не знает, а Apple делиться знаниями не торопятся.\u003C\u002Fp\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"2гис"},{"titleHtml":"CarPlay"},{"titleHtml":"Apple"},{"titleHtml":"автомобиль"},{"titleHtml":"магнитола"},{"titleHtml":"wwds"},{"titleHtml":"countryroads"},{"titleHtml":"background"},{"titleHtml":"opengl"},{"titleHtml":"mkmapview"},{"titleHtml":"cpapplicationdelegate"},{"titleHtml":"xcode"},{"titleHtml":"cpmaptemplate"},{"titleHtml":"вьюпорт"},{"titleHtml":"посторение маршрута"},{"titleHtml":"реджект"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452638\u002F582dcf4b981d319491597f2107da5295\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452638\u002F582dcf4b981d319491597f2107da5295\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002F2gis\\\u002Fblog\\\u002F452638\\\u002F\"},\"headline\":\"Как мы запустили 2ГИС под CarPlay и до сих пор расхлёбываем\",\"datePublished\":\"2019-05-21T08:33:19+03:00\",\"dateModified\":\"2019-05-22T08:40:51+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Shevelev Ivan\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fcompany\\\u002F2gis\\\u002Fblog\\\u002F452638\\\u002F#post-content-body\",\"about\":[\"c_2gis\",\"h_ios_dev\",\"h_mobile_dev\",\"h_refactoring\",\"h_autogadgets\",\"f_develop\",\"f_popsci\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ftt\\\u002Fjg\\\u002Fa3\\\u002Fttjga3qmefdwknrbj1i351exs3m.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fhq\\\u002Fvu\\\u002Fxw\\\u002Fhqvuxwo3ms1ivfppuaojrfscvh0.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F3p\\\u002Fxn\\\u002Frf\\\u002F3pxnrf5dlvtq7n8qkuovquqgbbi.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fhf\\\u002Ft2\\\u002Frw\\\u002Fhft2rwp8m2d71popp3tus4dif20.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fvv\\\u002Fl1\\\u002Fxx\\\u002Fvvl1xxebjbdb9ahiuucw1db_rzg.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fc2\\\u002Fql\\\u002Fu8\\\u002Fc2qlu8wi-sbkh5zizb7mjab-n7w.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F5d\\\u002Fxn\\\u002F26\\\u002F5dxn263mlspdif8eqhxgc8wjgmc.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fo0\\\u002Fwa\\\u002Fv6\\\u002Fo0wav6ogb8ofbx7-xqxsamjd6g4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fwi\\\u002Fon\\\u002F5r\\\u002Fwion5rbc8wx75tqwxzn-x72zsqw.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F30\\\u002Fuj\\\u002Ftp\\\u002F30ujtpqhaaqkgx1oon7mjxpxiq8.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fwz\\\u002F2-\\\u002Fcj\\\u002Fwz2-cjj1rusmnd270gkr5h8tdj0.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fns\\\u002F-k\\\u002Fgw\\\u002Fns-kgwhubcu9cdqybc4nierpkqe.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ftl\\\u002Fsg\\\u002Fi3\\\u002Ftlsgi347mdeagljpg7i8ojxcjxc.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fco\\\u002Fri\\\u002Fec\\\u002Fcoriec6zvpz0pg5uy72kontsmc8.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fmh\\\u002Fiu\\\u002Fle\\\u002Fmhiulexz-l0j4snzfhdx8pvx8pa.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fgj\\\u002Fjp\\\u002Fco\\\u002Fgjjpcobjxxf3q_u3gdcoscfclda.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fnh\\\u002F3v\\\u002Ftc\\\u002Fnh3vtc2h-zlu5jutajc6-oyoca4.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fql\\\u002F1h\\\u002Fj0\\\u002Fql1hj02fnqottbo5fstubt65pss.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fuf\\\u002Ft7\\\u002Frx\\\u002Fuft7rxuuaqu7ape9ehifdi6r6ki.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F_t\\\u002Fk7\\\u002Fu6\\\u002F_tk7u6wbcv55zig2n-b1dlbm9hu.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fvo\\\u002Fm7\\\u002Fqw\\\u002Fvom7qwpkpnxqf9a7wk6arc8-gtm.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fq7\\\u002Fkq\\\u002Ffh\\\u002Fq7kqfhk7rrtwdzmergpd9yobbz0.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fdi\\\u002Ftt\\\u002Fov\\\u002Fdittovwssqwrbku8rfd7fxpqlqo.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ftd\\\u002Fco\\\u002Fz-\\\u002Ftdcoz-1fk1-x880os0muqc_2iso.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fgetpro\\\u002Fhabr\\\u002Fpost_images\\\u002Fe5c\\\u002Fb97\\\u002Fdc2\\\u002Fe5cb97dc248ebb9ffa0ff46147c290d7.jpg\"]}","metaDescription":"Привет! Меня зовут Ваня, я пишу мобильное приложение 2ГИС под iOS. Сегодня будет история о том, как наш навигатор появился в CarPlay. Расскажу, как с такой себе документацией и недоделанными...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"2gis":{"alias":"2gis","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002F995\u002F27f\u002F562\u002F99527f562a8700893d39f73e6d2e7e07.png","titleHtml":"2ГИС","descriptionHtml":"Главные по городской навигации","relatedData":null,"statistics":{"postsCount":205,"newsCount":2,"vacanciesCount":29,"employeesCount":96,"careerRating":null,"subscribersCount":68070,"rating":187.42,"invest":null},"foundationDate":{"year":"1999","month":"04","day":"25"},"location":{"city":{"id":"447315","title":"Новосибирск"},"region":{"id":"1906","title":"Новосибирская обл."},"country":{"id":"168","title":"Россия"}},"siteUrl":"http:\u002F\u002F2gis.ru\u002F","staffNumber":"1 001–5 000 человек","registrationDate":"2008-08-09T07:43:03+00:00","representativeUser":null,"contacts":[],"settings":{"analyticsSettings":[{"type":"ga","trackingId":"UA-107124300-1"}],"branding":null,"status":"active"},"metadata":{"titleHtml":"2ГИС, Новосибирск - Главные по городской навигации с 25 апреля 1999 г.","title":"2ГИС, Новосибирск - Главные по городской навигации с 25 апреля 1999 г.","keywords":["Разработка мобильных приложений","Геоинформационные сервисы","JavaScript","Разработка под iOS","Разработка под Android"],"descriptionHtml":"205 статей от авторов компании 2ГИС","description":"205 статей от авторов компании 2ГИС"},"aDeskSettings":null,"careerAlias":"2gis","maxCustomTrackerLinks":0}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
