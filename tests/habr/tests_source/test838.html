<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>К вопросу о TI / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/451918\/"},"headline":"К вопросу о TI","datePublished":"2019-05-15T13:01:55+03:00","dateModified":"2019-05-16T11:54:35+03:00","author":{"@type":"Person","name":"Автушенко Игорь"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"&laquo;Сейчас я покажу вам портрет&hellip; Хм&hellip; Я предупреждаю вас, что это именно портрет&hellip; Во всяком случае, прошу отнестись к нему, как к портрету...  В данном посте пойдет...","url":"https:\/\/habr.com\/ru\/post\/451918\/#post-content-body","about":["h_controllers","f_develop"],"image":["https:\/\/habr.com\/share\/publication\/451918\/2f222cbdc4d182d18ec64ce74b6bca79\/"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="К вопросу о TI" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="К вопросу о TI" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="К вопросу о TI" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...

В данном посте пойдет речь о разработке и отладке программ..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...

В данном посте пойдет речь о разработке и отладке программ..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...

В данном посте пойдет речь о разработке и отладке программ..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...

В данном посте пойдет речь о разработке и отладке программ..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...

В данном посте пойдет речь о разработке и отладке программ..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/451918/2f222cbdc4d182d18ec64ce74b6bca79/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/451918/2f222cbdc4d182d18ec64ce74b6bca79/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/451918/2f222cbdc4d182d18ec64ce74b6bca79/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/451918/2f222cbdc4d182d18ec64ce74b6bca79/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/451918/2f222cbdc4d182d18ec64ce74b6bca79/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="451918" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-15T10:01:55.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/451918/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/451918/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/451918/2f222cbdc4d182d18ec64ce74b6bca79/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/GarryC/" title="GarryC" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_blue"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/GarryC/" class="tm-user-info__username">
      GarryC
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-15T10:01:55.000Z" title="2019-05-15, 13:01">15  мая  2019 в 13:01</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>К вопросу о TI</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/controllers/" class="tm-article-snippet__hubs-item-link"><span>Программирование микроконтроллеров</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><b>«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...</b><br/>
<br/>
В данном посте пойдет речь о разработке и отладке программ для МК СС1350 в рекомендованной производителем среде разработки CCS. Будут затронуты достоинства (а они есть) и недостатки (а как же без них) вышеупомянутых продуктов. В тексте не будет скриншотов, призванных показать (обведенное кружочком) расположение иконки компиляции в интегрированной среде программирования или выбора файла в директории. Признавая принципиальную возможность статей в подобном стиле, я постараюсь сосредоточиться на концептуальных моментах в надежде, что мой читатель сам сможет разобраться в деталях.<br/>
<br/>
Целью данного опуса, помимо передачи полученного опыта, является попытка возбудить здоровую зависть у отечественных производителей МК, являющихся прямыми конкурентами TI (»на территории страны, где мы с Вами и процветаем") — задача откровенно неблагодарная, но говорят, что капля камень точит.<br/>
<a name="habracut"></a><br/>
Сразу подчеркну — речь будет идти только о Windows (более того, только) 7 версии, хотя на сайте TI есть вариант и под Мак и под Линух, я их не пробовал, вполне готов поверить, что там все не так здорово, но зачем думать о плохом (или наоборот, там все великолепно, но тогда зачем завидовать).<br/>
<br/>
Итак, чему нас учит сайт TI — для начала работы с оценочными модулями следует выполнить три необходимых шага:<br/>
<br/>
<ol>
<li>Купить оценочные модули — выполнено. <br/>
<br/>
Примечание на полях(Пнп): Вам тоже придется это сделать, поскольку в рассматриваемой среде программирования лично мне (к глубокому сожалению) не удалось найти возможность эмуляции аппаратных средств для отладки, по крайней мере там, где я искал.</li>
<li>Установить среду разработки — скачиваем, запускаем инсталлятор, все получилось. Подключаем оценочный модуль к USB — дрова поднимаются сами и все опять получилось — выполнено. При попытке запрограммировать устройство получаем сообщение о необходимости обновить прошивку, соглашаемся и опять все получилось. В общем писать-то и не о чем, если бы так было всегда и везде ...</li>
<li>Пойти и изучить курс TI SimpleLink Academy 3.10.01 for SimpleLink CC13x0 SDK 3.10 — странное предложение, вроде как меня учить — только портить, но так уж и быть, открываю соответствующую ссылку и тихо обалдеваю — сколько тут всего понапихано. </li>
</ol><br/>
Здесь мы видим обучающие материалы по работе с драйверами аппаратуры SYS/BIOS и с операционной системой TI-RTOS и по использованию сетевого стека NDK, включая USB, и по использованию беспроводных протоколов и по еще множеству аспектов работы с представителями разнообразных семейств МК, выпускаемых фирмой. И сопровождается все это богатство готовыми к применению примерами, а если еще учесть наличие руководств пользователя и описания модулей, то, пожалуй, больше и пожелать нечего. А ведь еще есть и утилиты, облегчающие работу по подготовке и конфигурированию программного кода, прошивке и отладке различными способами, и это богатство тоже достаточно документировано. <br/>
<br/>
Пнп: если кто-либо склонен рассматривать данный материал как рекламный в отношении фирмы, ее продукции и системы программирования, то он будет, скорее всего, прав и я действительно очень впечатлен объемом обнаруженного софта. О его качестве речь пойдет дальше и, надеюсь, подозрения в предвзятости будут развеяны, меня совершенно не ослепило чувство и я продолжаю прекрасно видеть и недочеты объекта описания, так что это не влюбленность юности, а серьезное чувство взрослого специалиста. Мне страшно представить объем материальных затрат, необходимый для создания и поддержания такого объема софта и документации к нему, но это было сделано явно не за один месяц, ну и фирма наверняка понимает, что делает.<br/>
<br/>
Ладно, пока отложим изучение материалов на потом, будем все постигать «по ходу дела нутром самородка» и смело открываем CCS. Здесь реализована концепция рабочих пространств, полученная от родителя — Eclipse. Лично мне ближе концепция проекта, но нам никто не мешает держать в пространстве ровно один проект, так что идем дальше.<br/>
<br/>
А вот дальше дела становятся несколько хуже — открываем рабочее пространство (РП) для нашей отладочной платы и видим множество проектов (как правило, в двух вариантах — под РТОС и для «голого железа»). Как я сказал ранее, это не криминал, но вот то, что многие проекты содержат одинаковые файлы с идентичными программными модулями — это совсем не здорово. Код многократно дублируется и поддержка изменений становится весьма нетривиальной задачей. Да, при таком решении намного проще переносить проект, просто скопировав директорию, но для подобных вещей есть экспорт проекта, и он вполне себе неплохо реализован. Ссылки на файлы в дереве проекта поддерживаются адекватно, так что решение с включением самих файлов в предоставляемых примерах нельзя считать удовлетворительным.<br/>
<br/>
Продолжаем исследования — начнем работу с готовым проектом, но не мигание светодиодом, хотя их на отладочной плате целых два, а работу с последовательным портом, готовый пример uartecho. Создаем новое РП, включаем в него интересующий нас проект и… ничего не получается, из сообщения ясно, что требуется включить в РП связанный проект. Не очень понятно, зачем это делать, но выполнить требования среды нетрудно, после чего проект начинает собираться.<br/>
<br/>
Пнп: на домашней машине я воспользовался командой «Импорт проекта» и все необходимые включения произошли сами по себе. Где именно указываются связанные проекты, я не знаю, оставим разбор данного аспекта на будущее.<br/>
<br/>
Компилируем, прошиваем и начинаем отладку. Обнаруживаем интересное явление — исполнение по шагам не вполне адекватно отображается при рассмотрении библиотеки работы с последовательным портом — издержки оптимизации. Отключаем оптимизацию в настройках компилятора (каких только настроек там нет, неужели есть люди, которые все их знают и, более того, всеми ими пользуются), собираем проект заново — и ничего не меняется. Оказывается, перекомпилируются только те файлы, которые включены в дерево проекта, хотя бы в виде ссылок. Добавляем ссылки на исходники библиотеки и после пересборки все отлаживается правильно (при условии, что у нас включена опция генерации отладочной информации).<br/>
<br/>
Пнп: зато я нашел опции включения проверки на соответствие MISRA-C.<br/>
<br/>
Пнп: другой способ — воспользоваться командой «Clean...» с последующей сборкой, команда «Build All» почему-то на связанный проект не влияет.<br/>
<br/>
Далее обнаруживаем, что не всегда и не все отлаживается нормально, иногда мы оказываемся в таких областях машинного кода, для которых компилятор не находит исходников. Поскольку среда программирования предоставляет нам все необходимые для работы файлы — результат работы препроцессора, ассемблерный код и карту линкера (надо только не забыть включить соответствующие опции), обращаемся к последней. Обнаруживаем две области кода программы — начиная с 0х0000. и начиная с 0х1000. (всем хороши 32- разрядные архитектуры, но запись адресов — не их сильное место). Обращаемся к документации на микросхему и выясняем, что внутри имеется область ПЗУ, картированная именно на 0х1000., и в ней расположена встроенная часть библиотек. Утверждается, что использование подпрограмм из нее повышает быстродействие и снижает потребление по сравнению с адресным пространством 0х000. Пока мы осваиваем МК, нас не столь интересуют последние параметры, а вот удобство отладки является определяющим. Отключить использование ПЗУ можно (а для наших целей нужно), задав компилятору опцию NO_ROM, что мы делаем и пересобираем проект.<br/>
<br/>
Пнп: весьма забавно выглядит переход на подпрограмму в ПЗУ — в системе команд нет длинного перехода, поэтому сначала выполняется переход с возвратом на промежуточную точку в области малых адресов (0х0000), а уже там лежит команда загрузки PC, параметры которой дизассемблером не распознаются. Что-то мне не верится, будто бы при таких накладных расходах можно выиграть в быстродействии, хотя для длинных подпрограмм — почему бы и нет.<br/>
<br/>
Кстати, интересный вопрос — а чем вообще гарантируется, что содержимое ПЗУ соответствует исходным кодам, любезно представленным фирмой. Я сразу могу предложить механизм встраивания в ПЗУ дополнительных (конечно же, отладочных и сервисных) функций, которые для пользователя — программиста МК будут совершенно не заметны. И лично я не сомневаюсь, что разработчики микросхемы знают и множество других механизмов, реализующих подобный функционал, но закончим приступ паранойи.<br/>
<br/>
С другой стороны, я могу только приветствовать появление подобного аналога BIOS, ведь в перспективе это позволит сделать реальностью мечту разработчиков о настоящей переносимости кода между разными семейства МК с одним ядром. Отметим также особенность реализации взаимодействия со «вшитыми» программными модулями. Если в ранних попытках создать подобный механизм, реализованных в моделях TivaC, имел место супервизор вызовов, к которому обращались с номером группы и номером точки входа в подпрограмму, что вызывало значительный оверхед, то здесь разрешение связей идет на уровне линкера за счет двойных наименований функций и вставлены прямые длинные переходы на подпрограммы в ПЗУ. Это намного быстрее в исполнении, но требует перекомпиляции проекта при изменении модели использования.<br/>
<br/>
Теперь, когда мы полностью готовы к удобной отладке, возвращаемся к нашему проекту и начинаем спокойно отлаживать программу с доступом к исходным кодам модулей (ну это я так думал ...), что позволит нам составить свое мнение о качестве этих текстов. Исследуемый проект осуществляет зеркало последовательного канала связи и исключительно удобен для целей обучения. Разумеется, мы взяли вариант с применением РТОС, я не вижу ни малейших оснований не использовать ее в нашей конфигурации (много памяти и памяти программ).<br/>
<br/>
Сразу отметим, что исходные коды представлены на языке С, часто это не слишком удобно, многие языковые конструкции выглядят громоздко, по сравнению с аналогами на плюсах, но создателей больше волновала совместимость кода, нежели синтаксический сахар. Хотя, можно было бы создать и С++ версию библиотек, условная компиляция известна давно и используется повсеместно, но это влечет за собой дополнительные материальные издержки. Наверняка, руководство фирмы знает, что делает, а мои замечания являются некоей «диванной аналитикой», но мне кажется, что я тоже имею право на свое мнение. <br/>
<br/>
Мне известен и обратный подход, когда библиотека проектируется с использованием новейших средств языка С++, а на вопрос, что делать тем разработчикам, у кого в инструментах используются компиляторы, не отвечающие новейшим спецификациям, следует прекрасный ответ — переходить на новые версии либо не юзать данную библиотеку (я настоятельно рекомендую в таких случаях второй вариант). Мое личное мнение — если мы действительно хотим, чтобы наш продукт использовали (а фирма TI этого явно желает, а не делает библиотеку по принципу «от… валите на фиг от меня, вот вам новый барабан»), то ее подход является безусловно верным.<br/>
<br/>
Исходный текст программы выглядит классически — инициализация железа и программного окружения, создание задач и запуск шедулера в основном модуле, текст задачи в отдельном модуле компиляции. В рассматриваемом примере задача ровно одна — mainThread, назначение не вполне понятно из названия, и еще, что меня несколько смущает — имя файла, содержащего исходный текст, не совпадает с именем функции (uartecho.c — хотя как раз тут имя говорящее) ну да поиск в среде программирования реализован стандартным образом (контекстное меню либо F3 на имени сущности) и с этим проблем нет.<br/>
<br/>
Процесс настройки параметров задачи перед запуском довольно-таки ожидаем: <br/>
<br/>
<ol>
<li>создаем структуру параметров (локальную, конечно), </li>
<li>присваиваем ей значения по умолчанию, </li>
<li>задаем параметры, отличные от стандартных, и </li>
<li>используем структуру при создании задачи.</li>
</ol><br/>
Несмотря на вроде как естественность этих операций, не для всех авторов библиотек она очевидна, и я видел разные реализации, в которых не было, например, стадии 2, что приводило к забавному (для постороннего наблюдателя, не для программиста) поведению программы. В рассматриваемом случае все хорошо, единственный возникший вопрос — почему значения по умолчанию не константны, наверное, это наследие проклятого прошлого. <br/>
<br/>
Пнп: в широко известной FREE-RTOS принят несколько иной подход с указанием параметров задачи непосредственно в теле вызова АПИ функции создании задачи. Плюсы и минусы данных подходов следующие: <br/>
<br/>
<ol>
<li>+позволяет не указывать явно параметры, совпадающие со значениями по умолчанию, +не требует запоминания порядка параметров, -более многословен, -бОльшие затраты памяти, -надо знать параметры по умолчанию, -создает именованный промежуточный объект </li>
<li> — требует указания всех параметров, -требует запоминания порядка параметров, +более компактен, +требует меньше памяти, +не требует именованных промежуточных объектов. <br/>
<br/>
Есть третий способ, пропагандируемый автором данного поста (в стиле ТУРБО), у которого свой набор </li>
<li>+позволяет не указывать явно параметры, совпадающие со стандартным, +не требует запоминания порядка параметров, -многословен, -бОльшие затраты памяти, -надо знать параметры по умолчанию, +работает в стиля «лямбда», +делает труднореализуемыми стандартные ошибки, -выглядит несколько странновато из за множества правых скобок. </li>
</ol><br/>
Ну и есть еще четвертый вариант, лишенный каких либо недостатков, но требующий С++ не ниже 14 – облизываемся и проходим мимо. <br/>
<br/>
Начинаем отладку, запускаем программу и открываем один из двух последовательных портов, предоставляемых отладочной платой, в терминальном окне, предоставляемой средой программирования. Какой именно из двух портов (один — отладочный, наверное, второй — пользовательский, номера их можно посмотреть в системе) заранее сказать трудно, иногда младший, иногда старший, хорошо хоть, он не меняется при переподключении платы, поэтому его можно на плате написать. Ну и еще одно неудобство — открытые терминалы не сохраняются вместе с проектом и не восстанавливаются при открытии отладочной сессии, хотя и не закрываются при выходе из нее. Проверяем работу программы и сразу обнаруживаем еще один недостаток — терминал невозможно настроить, он, например, принципиально работает в Unix стиле с закрывающим /r, отвык я от подобного минимализма, хотя никто не мешает нам пользоваться внешней терминальной программой.<br/>
<br/>
Пнп: Отметим еще одну особенность отладки, ну это верно для любой среды разработки — при переключении задачи шедулером мы теряем фокус трассировки, точки останова нам помогут решить эту проблему.<br/>
<br/>
Для начала рассмотрим процесс создания экземпляра последовательного порта — тут вроде все стандартно, используется структура, полям которой присваиваем требуемые параметры объекта. Отметим, что на плюсах у нас есть возможность, полностью отсутствующая на С, всю инициализацию очень красиво спрятать «под капот», но возможные аргументы в пользу второго решения я уже озвучил. Есть функция инициализация настроечной структуры, и это хорошо (как это ни парадоксально прозвучит, данная функция не представляется обязательной для авторов некоторых библиотек). В этой точке повествования медовый месяц заканчивается и начинается обыкновенная <strike>(супружеская)</strike> жизнь.<br/>
<br/>
Внимательное изучение исходников показывает, что не все уж настолько хорошо. В чем проблема — функция инициализации копирует в нашу управляющую структуру значения по умолчанию из объекта, который лежит в области констант, и это замечательно, но почему-то:<br/>
<br/>
<ol>
<li>объект глобальный, хотя используется единственной функцией инициализации параметров (в свое время похожая практика обошлась Тойоте в приличную сумму) — ладно, добавить директиву static несложно;</li>
<li>управляющий объект именован, в С красивого решения этой проблемы нет, вернее, решение с анонимным экземпляром есть и я его давал в давнем посте, но множество правых скобок не дает назвать этот вариант по-настоящему красивым, в плюсах есть решение обалденной красоты, но что мечтать о несбыточном;</li>
<li>все поля объекта явно избыточны по разрядности, даже битовые поля (перечисления из двух возможных значений) хранятся в 32-разрядных словах;</li>
<li>перечислимые константы режимов заданы в виде дефайнов, что делает невозможной проверку на этапе компиляции и необходимой — в ран-тайме;</li>
<li>повтор секции бесконечного цикла в разных местах возможных отказов, намного правильнее было бы сделать один (в данном случае пустой) обработчик;</li>
<li>ну и все операции по настройке и запуску задачи можно (и нужно) спрятать в одну функцию или даже макрос.</li>
</ol><br/>
Зато хорошо сделана инициализация буфера приема — используем заранее зарезервированную память, никаких манипуляций с хипом, цепочка вызовов несколько сложна, но все вполне читаемо.<br/>
<br/>
Пнп: в окне отладки у нас перед глазами стек вызова, все сделано как положено и добротно — респект и уважуха. Единственное, что несколько удивляет — попытка скрыть это окно приводит к завершению сеанса отладки.<br/>
<br/>
Ну и еще одно несколько неожиданное решение — задание возможного количества объектов в перечислении, для последовательных портов и для данной отладочной платы равного 1, в стиле <br/>
<br/>
<pre><code class="cpp">typedef enum CC1310_LAUNCHXL_UARTName {
    CC1310_LAUNCHXL_UART0 = 0,
    CC1310_LAUNCHXL_UARTCOUNT
} CC1310_LAUNCHXL_UARTName;</code></pre><br/>
Такие решения стандартны для настоящих перечислений, но для описания аппаратных объектов — а я и не знал, что так можно, хотя вполне себе работает. С инициализацией железа покончили, идем дальше.<br/>
<br/>
Мы наблюдаем в запущенной задаче классический бесконечный цикл, в котором читаются данные из последовательного порта функцией <pre><code class="cpp">UART_read(uart, &amp;input, 1);</code></pre> и тут же отправляются обратно функцией <pre><code class="cpp">UART_write(uart, &amp;input, 1);</code></pre>. Войдем в первую из них и видим попытку чтения символов из приемного буфера <pre><code class="cpp">return (handle->fxnTablePtr->readPollingFxn(handle, buffer, size))</code></pre> (как же я ненавижу такие вещи, но в С иначе просто нельзя), проходим глубже и оказываемся в UARTCC26XX_read, а из нее попадаем в реализации кольцевого буфера — функция <pre><code class="cpp">RingBuf_get(&amp;object->ringBuffer, &amp;readIn)</code></pre>. Здесь обычная жизнь переходит в острую фазу.<br/>
<br/>
Сказать, что данный конкретный модуль (файл ringbuf.c) мне не понравился — это не сказать ничего, написано просто ужасно и лично я бы на месте такой уважаемой компании авторов данной части выгнал с позором (можно еще взять меня на их место, но боюсь что уровень зарплат наших индийских коллег меня не устроит), но, наверное, я чего то не знаю. Следите за руками:<br/>
<br/>
1) ре-ролл указателей чтения/записи реализован через остаток от деления <br/>
<br/>
<pre><code class="cpp">object->tail = (object->tail + 1) % object->length;</code></pre><br/>
и никаких оптимизаций компилятора при выполнении этой операции вроде наложения битовой маски тут нет и быть не может, поскольку длина буфера не есть константа. Да, в данном МК есть аппаратная операция деления и она довольно-таки быстрая (я об этом писал), но все равно она никогда не займет 2 такта, как в правильной реализации с честным ре-роллом (и об этом я тоже писал),<br/>
<br/>
Пнп: недавно видел описание новой архитектуры М7 в реализации уж и не помню кого, так там почему-то деление 32 на 32 стало выполняться за 2-12 тактов вместо 2-7. Или это ошибка перевода, или… даже и не знаю, что придумать.<br/>
<br/>
2) мало того, этот фрагмент кода повторен более чем в одном месте — макросы и инлайны для слабаков, ctrl+C и ctrl+V рулят, принцип DRY идет лесом,<br/>
<br/>
3) реализован совершенно излишний счетчик заполненных мест в буфере, что повлекло за собой следующий недостаток,<br/>
<br/>
4) критические секции как в чтении, так и в записи. Ну ладно, я еще могу поверить, что авторы данного модуля не читают мои посты на Хабре (хотя для профессионалов в области прошивки такое поведение недопустимо), но с «Книгой мустанга» они должны быть знакомы, там этот вопрос рассмотрен подробно,<br/>
<br/>
5) как вишенка на торте, введен еще индикатор максимального размера буфера, причем с весьма невнятным именем и полностью отсутствующим описанием (последнее относится вообще ко всему модулю). Я не исключаю, что данный параметр может быть полезен при отладке, но зачем тащить его в релиз — нам что, такты процессора вообще девать некуда вместе с оперативкой?<br/>
<br/>
6) при этом полностью отсутствует обработка переполнения буфера (есть возврат -1, сигнализирующей о данной ситуации)- даже в Ардуино она есть, оставим в стороне качество этой обработки, но ее отсутствие еще хуже. Или же авторов вдохновлял известный факт о том, что относительно пустого множества справедливы любые предположения, в том числе и то, что оно не пусто?<br/>
<br/>
В общем, мои замечания полностью соответствуют первой строчке демотиватора на тему ревью кода «10 строк кода — 10 замечаний».<br/>
<br/>
Кстати, предпоследний из отмеченных недостатков заставляет задуматься о более глобальных вещах — а как нам вообще реализовывать базовый класс, чтобы иметь возможность проводить его глубокую модификацию. Делать все поля защищенными — сомнительная идея (хотя, наверное, единственно правильная), вставлять вызов дружественных функций в наследников — очень сильно похоже на костыли. Если в данном конкретном случае есть простой ответ на вопрос о введении индикатора наполненности буфера — порожденный класс с перекрытыми записью и чтением и дополнительный счетчик, то для реализации чтения без продвижения буфера (как в данном случае) или замены последнего помещенного символа (видел я и такие реализации кольцевого буфера) без доступа к внутренним данным родительского класса не обойтись.<br/>
<br/>
При этом к реализации собственно чтения из последовательного интерфейса претензий нет — ввод блокирующий, при отсутствии в приемном буфере достаточного количества символов взводится семафор и управление передается шедулеру — все реализовано аккуратно и правильно. Лично мне не очень нравится управление аппаратурой в процедуре общего назначения, но это позволяет снизить вложенность процедур и уменьшает индекс цикломатической сложности, что бы это ни значило.<br/>
<br/>
Обратим теперь внимание на передачу принятых данных в последовательный канал, поскольку при создании объекта ему предоставили только один кольцевой буфер — приемный. И действительно, для передачи символов используется внутренний буфер аппаратной части и при его заполнении вводится ожидание готовности (по крайней мере в блокирующем режиме работы). Не могу не удержаться, чтобы не покритиковать стиль соответствующих функций: 1) в объекте почему-то имеется обобщенный указатель, который внутри функции постоянно превращается в указатель на символы <pre><code class="cpp">*(unsigned char *)object->writeBuf);</code></pre> 2) логика работы совершенно непрозрачна и слегка запутана. Но все это не столь важно, поскольку остается спрятанным от пользователя и «на максимальную скорость не влияет».<br/>
<br/>
В процессе исследований наталкиваемся еще на одну особенность — мы не видим исходного кода некоторых внутренних функций в режиме отладки — это связано с изменением имен для разных вариантов компиляции (ROM/NO_ROM). Подменить требуемый файл исходного текста (C:\Jenkins\jobs\FWGroup-DriverLib\workspace\modules\output\cc13xx_cha_2_0_ext\driverlib\bin\ccs/./../../../driverlib/uart.c--) мне не удалось (но я не очень то и старался), хотя исходник я нашел (естественно, в файле в файле uart.c, спасибо, капитан), по счастью, этот фрагмент несложен и однозначно отождествить ассемблерный код с исходным текстом на С несложно (особенно если знать особенности команды ITxxx). Как решать эту проблему для библиотек со сложными функциями пока не знаю, будем думать, когда возникнет необходимость.<br/>
<br/>
Ну и напоследок небольшое замечание — я готов поверить, что аппаратная часть реализации последовательного канала для моделей МК СС13х0 совпадает с таковой для СС26х0, и дублирование содержимого файла с названием UARTCC26XX.c--- нельзя назвать правильным решением, но создание промежуточного файла определений с включением исходного файла, переопределением функций и соответствующим комментарием приветствовал бы, поскольку это сделало бы программу более понятной, а это всегда должно приветствоваться, воут.<br/>
<br/>
Итак, тестовый пример работает, мы узнали многое о внутреннем устройстве стандартных библиотек, отметили их сильные и не очень стороны, в заключение обзора попробуем найти ответ на вопрос, который обычно волнует программиста в дилемме «ОС или не ОС» — время переключения контекста. Здесь возможны два пути: 1) рассмотрение исходного кода — это скорее теоретический путь, он требует такого уровня погружения в предмет, который я продемонстрировать не готов, и 2) практический эксперимент. Конечно, второй метод, в отличие от первого, не дает абсолютно верных результатов, но «истина всегда конкретна» и полученные данные вполне можно рассматривать как адекватные, если измерения организованы правильно.<br/>
<br/>
Для начала, чтобы оценить время переключения, нам необходимо научиться оценивать вообще время исполнения различных фрагментов программы. В рассматриваемой архитектуре имеется модуль отладки, частью которого является системный счетчик. Информация о данном модуле вполне доступна, но дьявол, как всегда, прячется в деталях. Для начала попробуем настроить необходимый режим ручками напрямую через доступ к регистрам. Быстро находим блок регистров CPU_DWT и в нем обнаруживаем как собственно счетчик CYCCNT, так и управляющий регистр к нему CTRL с битом CYCCNTENA. Естественно, или, как еще говорят, разумеется, ничего не получилось и на сайте ARM есть ответ на вопрос, почему — необходимо разрешить работу модуля отладки битом TRCENA в регистре DEMCR. А вот с последним регистром не все так просто — в блоке DWT его нет, в других блоках искать лениво — они достаточно длинные, а никакого поиска по имени в окне регистров я не нашел (а было бы неплохо его иметь). Идем в окно памяти, вводим адрес регистра (он нам известен из дата) (кстати, почему-то шестнадцатеричный формат адреса не является дефолтным, надо ручками добавлять префикс 0х) и, внезапно, видим именованную ячейку памяти с именем CPU_CSC_DEMCR. Забавно, если не сказать больше, зачем фирма переименовала регистры по сравнению с предлагаемой лицензиатором архитектуры названиями, наверное, так надо было. И точно, в блоке регистров CPU_CSC находим наш регистр, ставим в нем нужный бит, возвращаемся к счетчику, разрешаем его и все заработало.<br/>
<br/>
Пнп: поиск по имени все-таки есть, вызывается (естественно) комбинацией Ctrl-F, просто он есть только в контекстном меню, а в обычном погашен, приношу извинения разработчикам. <br/>
<br/>
Сразу отмечу еще недостаток окна памяти — печать содержимого прерывается указанием именованных ячеек, что делает выдачу рваной и ни фига не сегментированной по 16 (8,32,64, нужное подставить) слов. Более того, формат выдачи меняется при изменении размера окна. Может быть, все это можно настроить так, как пользователю нужно, но, исходя из собственного опыта (а из чего еще мне исходить) заявляю, что к интуитивно-очевидным решениям настройка формата выдачи окна просмотра памяти не относится. Я полностью за то, чтобы такая удобная фича, как показ именованных областей памяти в окне просмотра, была включена по умолчанию, иначе о ней многие пользователи и не узнали бы никогда, но надо позаботиться и о тех, кто сознательно ее хочет отключить.<br/>
<br/>
Кстати, я бы совсем не отказался от возможности создания макросов (или скриптов) по работе со средой, ведь такую настройку регистров (для включения измерения времени) приходилось делать всякий раз после сброса МК, поскольку корректировать код путем вставления манипуляций с регистрами для целей отладки считаю не очень правильным. Но, хотя макросов я так и не нашел, работу с регистрами можно сильно упростить за счет того, что отдельные (необходимые) регистры можно включить в окно выражений, и тем самым существенно облегчить и ускорить работу с ними.<br/>
<br/>
Чтобы подчеркнуть, что чувство инженера к семейству МК не охладело (а то я все ругаю разные аспекты среды разработки), отмечу, что счетчик работает прекрасно — никаких лишних тактов ни в одном из режимов отладки я обнаружить не смог, а раньше такое явление имело место быть, по крайней мере в серии МК разработки LuminaryMicro.<br/>
<br/>
Итак, намечаем план эксперимента по определению времени переключения контекста — создаем вторую задачу, которая будет инкрементировать некий внутренний счетчик (в бесконечном цикле), запускаем МК на определенное время, находим соотношение между системным счетчиком и счетчиком задачи. Далее запускаем МК на аналогичное время (не обязательно точно такое же) и вводим 10 символов в темпе приблизительно раз в секунду. Можно ожидать, что при этом произойдет 10 переключений на задачу эха и 10 переключений обратно на задачу счетчика. Да, эти переключения контекста будут производится не по таймеру шедулера, а по событию, но на общее время исполнения исследуемой функции это не должно повлиять, так что начинаем претворять план в жизнь, создаем задачу счетчика и запускаем ее.<br/>
 <br/>
Тут же обнаруживаем одну особенность РТОС, по крайней мере в стандартной конфигурации — она не является вытесняющей «по настоящему»: если более приоритетная задача постоянно готова к выполнению (а задача счетчика такова) и не отдает управление шедулеру (не ожидает сигналов, не засыпает, не блокируется по флагам и т.д.) то ни одна задача более низкого приоритета не будет исполняться от слова совсем. Это не Линукс, в котором применяются различные методы для гарантии получения кванта всеми, «и чтобы никто не ушел обиженным». Данное поведение вполне ожидаемо, многие легкие ОСРВ ведут себя так, но проблема оказывается глубже, поскольку управление не получают и задачи равного с постоянно готовой приоритета. Именно поэтому в рассматриваемом примере я ставлю задаче эха, которая входит в ожидание, приоритет выше, чем постоянно готовой задаче счетчика, иначе последняя захватит все ресурсы процессора по времени.<br/>
<br/>
Начинаем эксперимент, первая часть (просто ожидание времени исполнения) дала данные отношения счетчиков 406181к/58015к = 7 — вполне ожидаемо. Вторая часть (с 10 последовательными символами в течении ~10 секунд) дает результаты 351234к-50167к*7 = 63к/20=3160 тактов, последняя цифра и есть время, связанное с процедурой переключения контекста в тактах МК. Лично мне данная величина кажется несколько большей, чем ожидалось, продолжаем исследования, похоже, что есть еще какие-то действия, которые портят статистику.<br/>
<br/>
Пнп: частая ошибка экспериментатора — не оценить предварительно ожидаемые результаты и поверить в полученный мусор (привет разработчикам 737).<br/>
<br/>
Очевидно («ну да, совершенно очевидно»), что в полученном результате, помимо времени собственно переключения контекста, содержится еще и время, необходимое для выполнения операций чтения символа из буфера и вывода его в последовательный порт. Менее очевидно, что в нем есть еще и время, необходимое для обработки прерывания при приеме и помещения символа в приемный буфер). Как нам отделить кошку от мяса — для этого у нас есть хитрый трюк — останавливаем программу, вводим 10 символов и запускаем ее. Можно ожидать (надо бы посмотреть исходники), что прерывание по приему произойдет только 1 раз и сразу все символы будут пересланы из приемного буфера в кольцевой, значит и мы увидим меньшие накладные расходы. Определить время выдачи в последовательный порт также несложно — будем выводить каждый второй символ и решим получившиеся 2 линейных уравнения с 2 неизвестны. А можно и еще проще – ничего не выводить, что я и сделал.<br/>
<br/>
И вот результаты подобных хитрых манипуляций: делаем ввод пакетом и пропавших тактов становится меньше – 2282, отключаем вывод и затраты падают до 1222 тактов – уже лучше, хотя я надеялся тактов на 300.<br/>
<br/>
А вот со временем выполнения считывания ничего подобного придумать не удастся, оно масштабируется одновременно с искомым временем переключения контекста. Единственное, что я могу предложить — это отключать внутренний таймер при начале ввода принятого символа и снова включать его перед входом в ожидание очередного. Тогда два счетчика будут работать синхронно (за исключением переключения) и его легко можно определить. Но такой подход требует глубокого внедрения в тексты системных программ и все равно составляющая обработки прерываний останется. Поэтому я предлагаю ограничиться уже полученными данными, которые позволяют твердо утверждать, что время переключения задач в рассматриваемой TI-RTOS не превосходит 1222 тактов, что при заданной тактовой частоте составляет 30 мксек.<br/>
<br/>
Пнп: все равно очень много – я рассчитывал тактов на 100: 30 на сохранение контекста, 40 на определение готовой задачи и 30 на восстановление контекста, а у нас получается на порядок больше. Хотя сейчас отключена оптимизация, включим –o2 и посмотрим результат: почти не изменился – стало 2894 вместо 3160.<br/>
<br/>
Есть еще одна идея — если бы в ОС поддерживалось переключение равноранговых задач, то можно было бы запустить две задачи со счетчиками, некоторым волшебным образом получить данные о количестве переключений за некое время и рассчитать убыль системного счетчика, но в силу особенностей шедулера, о которой я уже говорил, данный подход не приведет к успеху. Хотя возможен другой вариант — делать пинг-понг между двумя одноранговыми (или даже разноранговыми) задачами через семафор, здесь легко посчитать число переключений контекста — надо будет попробовать, но это уже завтра.<br/>
<br/>
Традиционный опрос в конце поста на этот раз будет посвящен не уровню изложения (любому непредвзятому читателю ясно, что он вне всяких похвал и превосходит любые ожидания), а теме очередного поста.</div></div> <!----> <div class="tm-article-poll"><div class="tm-notice tm-article-poll__notice tm-notice_positive"><!----> <div class="tm-notice__inner"><!----> <div class="tm-notice__content"><span>Только зарегистрированные пользователи могут участвовать в опросе. <a rel="nofollow" href="/kek/v1/auth/habrahabr/?back=/ru/post/451918/&hl=ru">Войдите</a>, пожалуйста.</span></div></div></div> <div class="tm-article-poll__header">Вы предпочтете либо:</div> <div class="tm-article-poll__answers"><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent tm-article-poll__answer-percent_winning">
            52.17%
          </span> <span class="tm-article-poll__answer-label">продолжить знакомиться с средой от TI и TI-RTOS,</span> <span class="tm-article-poll__answer-votes">
            12
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress tm-article-poll__answer-progress_winning" style="width:52.17%;"></div></div></div><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent">
            34.78%
          </span> <span class="tm-article-poll__answer-label">описание отладочных плат от TI для данного семейства</span> <span class="tm-article-poll__answer-votes">
            8
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress" style="width:34.78%;"></div></div></div><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent">
            47.83%
          </span> <span class="tm-article-poll__answer-label">увидеть обзор отечественной РТОС МАКС (если Вы думаете, что ТИ я ругал, то поймете, что ошибались, я и беличьим хвостиком гладил)</span> <span class="tm-article-poll__answer-votes">
            11
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress" style="width:47.83%;"></div></div></div></div> <div class="tm-article-poll__stats">
       Проголосовали 23 пользователя.  

       Воздержались 12 пользователей. 
    </div></div><div class="tm-article-poll"><div class="tm-notice tm-article-poll__notice tm-notice_positive"><!----> <div class="tm-notice__inner"><!----> <div class="tm-notice__content"><span>Только зарегистрированные пользователи могут участвовать в опросе. <a rel="nofollow" href="/kek/v1/auth/habrahabr/?back=/ru/post/451918/&hl=ru">Войдите</a>, пожалуйста.</span></div></div></div> <div class="tm-article-poll__header">Вы предпочтете либо:</div> <div class="tm-article-poll__answers"><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent tm-article-poll__answer-percent_winning">
            75%
          </span> <span class="tm-article-poll__answer-label">продолжить знакомиться с средой от TI и TI-RTOS,</span> <span class="tm-article-poll__answer-votes">
            3
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress tm-article-poll__answer-progress_winning" style="width:75%;"></div></div></div><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent">
            50%
          </span> <span class="tm-article-poll__answer-label">описание отладочных плат от TI для данного семейства</span> <span class="tm-article-poll__answer-votes">
            2
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress" style="width:50%;"></div></div></div><div class="tm-article-poll__answer"><div class="tm-article-poll__answer-data"><span class="tm-article-poll__answer-percent">
            0%
          </span> <span class="tm-article-poll__answer-label">увидеть обзор отечественной РТОС МАКС (если Вы думаете, что ТИ я ругал, то поймете, что ошибались, я и беличьим хвостиком гладил)</span> <span class="tm-article-poll__answer-votes">
            0
          </span></div> <div class="tm-article-poll__answer-bar"><div class="tm-article-poll__answer-progress" style="width:0%;"></div></div></div></div> <div class="tm-article-poll__stats">
       Проголосовали 4 пользователя.  

       Воздержались 4 пользователя. 
    </div></div></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5B%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BC%D0%B8%D0%BA%D1%80%D0%BE%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%BE%D0%BB%D0%BB%D0%B5%D1%80%D0%BE%D0%B2%5D" class="tm-tags-list__link">программирование микроконтроллеров</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/controllers/" class="tm-hubs-list__link">
    Программирование микроконтроллеров
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 18: ↑16 и ↓2</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 18: ↑16 и ↓2" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+14</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">4.1K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    27
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/GarryC/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_blue"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 224 голоса " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    98
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">1</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Автушенко Игорь</span> <a href="/ru/users/GarryC/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @GarryC
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/451918/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 11 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/451918/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/451918/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"451918":{"id":"451918","timePublished":"2019-05-15T10:01:55+00:00","isCorporative":false,"lang":"ru","titleHtml":"К вопросу о TI","leadData":{"textHtml":"\u003Cb\u003E«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...\u003C\u002Fb\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nВ данном посте пойдет речь о разработке и отладке программ для МК СС1350 в рекомендованной производителем среде разработки CCS. Будут затронуты достоинства (а они есть) и недостатки (а как же без них) вышеупомянутых продуктов. В тексте не будет скриншотов, призванных показать (обведенное кружочком) расположение иконки компиляции в интегрированной среде программирования или выбора файла в директории. Признавая принципиальную возможность статей в подобном стиле, я постараюсь сосредоточиться на концептуальных моментах в надежде, что мой читатель сам сможет разобраться в деталях.\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nЦелью данного опуса, помимо передачи полученного опыта, является попытка возбудить здоровую зависть у отечественных производителей МК, являющихся прямыми конкурентами TI (»на территории страны, где мы с Вами и процветаем\") — задача откровенно неблагодарная, но говорят, что капля камень точит.\u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше →","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":98,"votesCount":224},"rating":1,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"589407","alias":"GarryC","fullname":"Автушенко Игорь","avatarUrl":null,"speciality":null},"statistics":{"commentsCount":11,"favoritesCount":27,"readingCount":4094,"score":14,"votesCount":18},"hubs":[{"relatedData":null,"id":"19737","alias":"controllers","type":"collective","title":"Программирование микроконтроллеров","titleHtml":"Программирование микроконтроллеров","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cb\u003E«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...\u003C\u002Fb\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ данном посте пойдет речь о разработке и отладке программ для МК СС1350 в рекомендованной производителем среде разработки CCS. Будут затронуты достоинства (а они есть) и недостатки (а как же без них) вышеупомянутых продуктов. В тексте не будет скриншотов, призванных показать (обведенное кружочком) расположение иконки компиляции в интегрированной среде программирования или выбора файла в директории. Признавая принципиальную возможность статей в подобном стиле, я постараюсь сосредоточиться на концептуальных моментах в надежде, что мой читатель сам сможет разобраться в деталях.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЦелью данного опуса, помимо передачи полученного опыта, является попытка возбудить здоровую зависть у отечественных производителей МК, являющихся прямыми конкурентами TI (»на территории страны, где мы с Вами и процветаем\") — задача откровенно неблагодарная, но говорят, что капля камень точит.\u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nСразу подчеркну — речь будет идти только о Windows (более того, только) 7 версии, хотя на сайте TI есть вариант и под Мак и под Линух, я их не пробовал, вполне готов поверить, что там все не так здорово, но зачем думать о плохом (или наоборот, там все великолепно, но тогда зачем завидовать).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИтак, чему нас учит сайт TI — для начала работы с оценочными модулями следует выполнить три необходимых шага:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EКупить оценочные модули — выполнено. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПримечание на полях(Пнп): Вам тоже придется это сделать, поскольку в рассматриваемой среде программирования лично мне (к глубокому сожалению) не удалось найти возможность эмуляции аппаратных средств для отладки, по крайней мере там, где я искал.\u003C\u002Fli\u003E\r\n\u003Cli\u003EУстановить среду разработки — скачиваем, запускаем инсталлятор, все получилось. Подключаем оценочный модуль к USB — дрова поднимаются сами и все опять получилось — выполнено. При попытке запрограммировать устройство получаем сообщение о необходимости обновить прошивку, соглашаемся и опять все получилось. В общем писать-то и не о чем, если бы так было всегда и везде ...\u003C\u002Fli\u003E\r\n\u003Cli\u003EПойти и изучить курс TI SimpleLink Academy 3.10.01 for SimpleLink CC13x0 SDK 3.10 — странное предложение, вроде как меня учить — только портить, но так уж и быть, открываю соответствующую ссылку и тихо обалдеваю — сколько тут всего понапихано. \u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nЗдесь мы видим обучающие материалы по работе с драйверами аппаратуры SYS\u002FBIOS и с операционной системой TI-RTOS и по использованию сетевого стека NDK, включая USB, и по использованию беспроводных протоколов и по еще множеству аспектов работы с представителями разнообразных семейств МК, выпускаемых фирмой. И сопровождается все это богатство готовыми к применению примерами, а если еще учесть наличие руководств пользователя и описания модулей, то, пожалуй, больше и пожелать нечего. А ведь еще есть и утилиты, облегчающие работу по подготовке и конфигурированию программного кода, прошивке и отладке различными способами, и это богатство тоже достаточно документировано. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: если кто-либо склонен рассматривать данный материал как рекламный в отношении фирмы, ее продукции и системы программирования, то он будет, скорее всего, прав и я действительно очень впечатлен объемом обнаруженного софта. О его качестве речь пойдет дальше и, надеюсь, подозрения в предвзятости будут развеяны, меня совершенно не ослепило чувство и я продолжаю прекрасно видеть и недочеты объекта описания, так что это не влюбленность юности, а серьезное чувство взрослого специалиста. Мне страшно представить объем материальных затрат, необходимый для создания и поддержания такого объема софта и документации к нему, но это было сделано явно не за один месяц, ну и фирма наверняка понимает, что делает.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЛадно, пока отложим изучение материалов на потом, будем все постигать «по ходу дела нутром самородка» и смело открываем CCS. Здесь реализована концепция рабочих пространств, полученная от родителя — Eclipse. Лично мне ближе концепция проекта, но нам никто не мешает держать в пространстве ровно один проект, так что идем дальше.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nА вот дальше дела становятся несколько хуже — открываем рабочее пространство (РП) для нашей отладочной платы и видим множество проектов (как правило, в двух вариантах — под РТОС и для «голого железа»). Как я сказал ранее, это не криминал, но вот то, что многие проекты содержат одинаковые файлы с идентичными программными модулями — это совсем не здорово. Код многократно дублируется и поддержка изменений становится весьма нетривиальной задачей. Да, при таком решении намного проще переносить проект, просто скопировав директорию, но для подобных вещей есть экспорт проекта, и он вполне себе неплохо реализован. Ссылки на файлы в дереве проекта поддерживаются адекватно, так что решение с включением самих файлов в предоставляемых примерах нельзя считать удовлетворительным.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПродолжаем исследования — начнем работу с готовым проектом, но не мигание светодиодом, хотя их на отладочной плате целых два, а работу с последовательным портом, готовый пример uartecho. Создаем новое РП, включаем в него интересующий нас проект и… ничего не получается, из сообщения ясно, что требуется включить в РП связанный проект. Не очень понятно, зачем это делать, но выполнить требования среды нетрудно, после чего проект начинает собираться.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: на домашней машине я воспользовался командой «Импорт проекта» и все необходимые включения произошли сами по себе. Где именно указываются связанные проекты, я не знаю, оставим разбор данного аспекта на будущее.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКомпилируем, прошиваем и начинаем отладку. Обнаруживаем интересное явление — исполнение по шагам не вполне адекватно отображается при рассмотрении библиотеки работы с последовательным портом — издержки оптимизации. Отключаем оптимизацию в настройках компилятора (каких только настроек там нет, неужели есть люди, которые все их знают и, более того, всеми ими пользуются), собираем проект заново — и ничего не меняется. Оказывается, перекомпилируются только те файлы, которые включены в дерево проекта, хотя бы в виде ссылок. Добавляем ссылки на исходники библиотеки и после пересборки все отлаживается правильно (при условии, что у нас включена опция генерации отладочной информации).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: зато я нашел опции включения проверки на соответствие MISRA-C.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: другой способ — воспользоваться командой «Clean...» с последующей сборкой, команда «Build All» почему-то на связанный проект не влияет.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДалее обнаруживаем, что не всегда и не все отлаживается нормально, иногда мы оказываемся в таких областях машинного кода, для которых компилятор не находит исходников. Поскольку среда программирования предоставляет нам все необходимые для работы файлы — результат работы препроцессора, ассемблерный код и карту линкера (надо только не забыть включить соответствующие опции), обращаемся к последней. Обнаруживаем две области кода программы — начиная с 0х0000. и начиная с 0х1000. (всем хороши 32- разрядные архитектуры, но запись адресов — не их сильное место). Обращаемся к документации на микросхему и выясняем, что внутри имеется область ПЗУ, картированная именно на 0х1000., и в ней расположена встроенная часть библиотек. Утверждается, что использование подпрограмм из нее повышает быстродействие и снижает потребление по сравнению с адресным пространством 0х000. Пока мы осваиваем МК, нас не столь интересуют последние параметры, а вот удобство отладки является определяющим. Отключить использование ПЗУ можно (а для наших целей нужно), задав компилятору опцию NO_ROM, что мы делаем и пересобираем проект.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: весьма забавно выглядит переход на подпрограмму в ПЗУ — в системе команд нет длинного перехода, поэтому сначала выполняется переход с возвратом на промежуточную точку в области малых адресов (0х0000), а уже там лежит команда загрузки PC, параметры которой дизассемблером не распознаются. Что-то мне не верится, будто бы при таких накладных расходах можно выиграть в быстродействии, хотя для длинных подпрограмм — почему бы и нет.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКстати, интересный вопрос — а чем вообще гарантируется, что содержимое ПЗУ соответствует исходным кодам, любезно представленным фирмой. Я сразу могу предложить механизм встраивания в ПЗУ дополнительных (конечно же, отладочных и сервисных) функций, которые для пользователя — программиста МК будут совершенно не заметны. И лично я не сомневаюсь, что разработчики микросхемы знают и множество других механизмов, реализующих подобный функционал, но закончим приступ паранойи.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nС другой стороны, я могу только приветствовать появление подобного аналога BIOS, ведь в перспективе это позволит сделать реальностью мечту разработчиков о настоящей переносимости кода между разными семейства МК с одним ядром. Отметим также особенность реализации взаимодействия со «вшитыми» программными модулями. Если в ранних попытках создать подобный механизм, реализованных в моделях TivaC, имел место супервизор вызовов, к которому обращались с номером группы и номером точки входа в подпрограмму, что вызывало значительный оверхед, то здесь разрешение связей идет на уровне линкера за счет двойных наименований функций и вставлены прямые длинные переходы на подпрограммы в ПЗУ. Это намного быстрее в исполнении, но требует перекомпиляции проекта при изменении модели использования.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТеперь, когда мы полностью готовы к удобной отладке, возвращаемся к нашему проекту и начинаем спокойно отлаживать программу с доступом к исходным кодам модулей (ну это я так думал ...), что позволит нам составить свое мнение о качестве этих текстов. Исследуемый проект осуществляет зеркало последовательного канала связи и исключительно удобен для целей обучения. Разумеется, мы взяли вариант с применением РТОС, я не вижу ни малейших оснований не использовать ее в нашей конфигурации (много памяти и памяти программ).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСразу отметим, что исходные коды представлены на языке С, часто это не слишком удобно, многие языковые конструкции выглядят громоздко, по сравнению с аналогами на плюсах, но создателей больше волновала совместимость кода, нежели синтаксический сахар. Хотя, можно было бы создать и С++ версию библиотек, условная компиляция известна давно и используется повсеместно, но это влечет за собой дополнительные материальные издержки. Наверняка, руководство фирмы знает, что делает, а мои замечания являются некоей «диванной аналитикой», но мне кажется, что я тоже имею право на свое мнение. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nМне известен и обратный подход, когда библиотека проектируется с использованием новейших средств языка С++, а на вопрос, что делать тем разработчикам, у кого в инструментах используются компиляторы, не отвечающие новейшим спецификациям, следует прекрасный ответ — переходить на новые версии либо не юзать данную библиотеку (я настоятельно рекомендую в таких случаях второй вариант). Мое личное мнение — если мы действительно хотим, чтобы наш продукт использовали (а фирма TI этого явно желает, а не делает библиотеку по принципу «от… валите на фиг от меня, вот вам новый барабан»), то ее подход является безусловно верным.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИсходный текст программы выглядит классически — инициализация железа и программного окружения, создание задач и запуск шедулера в основном модуле, текст задачи в отдельном модуле компиляции. В рассматриваемом примере задача ровно одна — mainThread, назначение не вполне понятно из названия, и еще, что меня несколько смущает — имя файла, содержащего исходный текст, не совпадает с именем функции (uartecho.c — хотя как раз тут имя говорящее) ну да поиск в среде программирования реализован стандартным образом (контекстное меню либо F3 на имени сущности) и с этим проблем нет.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПроцесс настройки параметров задачи перед запуском довольно-таки ожидаем: \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003Eсоздаем структуру параметров (локальную, конечно), \u003C\u002Fli\u003E\r\n\u003Cli\u003Eприсваиваем ей значения по умолчанию, \u003C\u002Fli\u003E\r\n\u003Cli\u003Eзадаем параметры, отличные от стандартных, и \u003C\u002Fli\u003E\r\n\u003Cli\u003Eиспользуем структуру при создании задачи.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nНесмотря на вроде как естественность этих операций, не для всех авторов библиотек она очевидна, и я видел разные реализации, в которых не было, например, стадии 2, что приводило к забавному (для постороннего наблюдателя, не для программиста) поведению программы. В рассматриваемом случае все хорошо, единственный возникший вопрос — почему значения по умолчанию не константны, наверное, это наследие проклятого прошлого. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: в широко известной FREE-RTOS принят несколько иной подход с указанием параметров задачи непосредственно в теле вызова АПИ функции создании задачи. Плюсы и минусы данных подходов следующие: \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003E+позволяет не указывать явно параметры, совпадающие со значениями по умолчанию, +не требует запоминания порядка параметров, -более многословен, -бОльшие затраты памяти, -надо знать параметры по умолчанию, -создает именованный промежуточный объект \u003C\u002Fli\u003E\r\n\u003Cli\u003E — требует указания всех параметров, -требует запоминания порядка параметров, +более компактен, +требует меньше памяти, +не требует именованных промежуточных объектов. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЕсть третий способ, пропагандируемый автором данного поста (в стиле ТУРБО), у которого свой набор \u003C\u002Fli\u003E\r\n\u003Cli\u003E+позволяет не указывать явно параметры, совпадающие со стандартным, +не требует запоминания порядка параметров, -многословен, -бОльшие затраты памяти, -надо знать параметры по умолчанию, +работает в стиля «лямбда», +делает труднореализуемыми стандартные ошибки, -выглядит несколько странновато из за множества правых скобок. \u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nНу и есть еще четвертый вариант, лишенный каких либо недостатков, но требующий С++ не ниже 14 – облизываемся и проходим мимо. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНачинаем отладку, запускаем программу и открываем один из двух последовательных портов, предоставляемых отладочной платой, в терминальном окне, предоставляемой средой программирования. Какой именно из двух портов (один — отладочный, наверное, второй — пользовательский, номера их можно посмотреть в системе) заранее сказать трудно, иногда младший, иногда старший, хорошо хоть, он не меняется при переподключении платы, поэтому его можно на плате написать. Ну и еще одно неудобство — открытые терминалы не сохраняются вместе с проектом и не восстанавливаются при открытии отладочной сессии, хотя и не закрываются при выходе из нее. Проверяем работу программы и сразу обнаруживаем еще один недостаток — терминал невозможно настроить, он, например, принципиально работает в Unix стиле с закрывающим \u002Fr, отвык я от подобного минимализма, хотя никто не мешает нам пользоваться внешней терминальной программой.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: Отметим еще одну особенность отладки, ну это верно для любой среды разработки — при переключении задачи шедулером мы теряем фокус трассировки, точки останова нам помогут решить эту проблему.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДля начала рассмотрим процесс создания экземпляра последовательного порта — тут вроде все стандартно, используется структура, полям которой присваиваем требуемые параметры объекта. Отметим, что на плюсах у нас есть возможность, полностью отсутствующая на С, всю инициализацию очень красиво спрятать «под капот», но возможные аргументы в пользу второго решения я уже озвучил. Есть функция инициализация настроечной структуры, и это хорошо (как это ни парадоксально прозвучит, данная функция не представляется обязательной для авторов некоторых библиотек). В этой точке повествования медовый месяц заканчивается и начинается обыкновенная \u003Cstrike\u003E(супружеская)\u003C\u002Fstrike\u003E жизнь.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВнимательное изучение исходников показывает, что не все уж настолько хорошо. В чем проблема — функция инициализации копирует в нашу управляющую структуру значения по умолчанию из объекта, который лежит в области констант, и это замечательно, но почему-то:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003Eобъект глобальный, хотя используется единственной функцией инициализации параметров (в свое время похожая практика обошлась Тойоте в приличную сумму) — ладно, добавить директиву static несложно;\u003C\u002Fli\u003E\r\n\u003Cli\u003Eуправляющий объект именован, в С красивого решения этой проблемы нет, вернее, решение с анонимным экземпляром есть и я его давал в давнем посте, но множество правых скобок не дает назвать этот вариант по-настоящему красивым, в плюсах есть решение обалденной красоты, но что мечтать о несбыточном;\u003C\u002Fli\u003E\r\n\u003Cli\u003Eвсе поля объекта явно избыточны по разрядности, даже битовые поля (перечисления из двух возможных значений) хранятся в 32-разрядных словах;\u003C\u002Fli\u003E\r\n\u003Cli\u003Eперечислимые константы режимов заданы в виде дефайнов, что делает невозможной проверку на этапе компиляции и необходимой — в ран-тайме;\u003C\u002Fli\u003E\r\n\u003Cli\u003Eповтор секции бесконечного цикла в разных местах возможных отказов, намного правильнее было бы сделать один (в данном случае пустой) обработчик;\u003C\u002Fli\u003E\r\n\u003Cli\u003Eну и все операции по настройке и запуску задачи можно (и нужно) спрятать в одну функцию или даже макрос.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\nЗато хорошо сделана инициализация буфера приема — используем заранее зарезервированную память, никаких манипуляций с хипом, цепочка вызовов несколько сложна, но все вполне читаемо.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: в окне отладки у нас перед глазами стек вызова, все сделано как положено и добротно — респект и уважуха. Единственное, что несколько удивляет — попытка скрыть это окно приводит к завершению сеанса отладки.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНу и еще одно несколько неожиданное решение — задание возможного количества объектов в перечислении, для последовательных портов и для данной отладочной платы равного 1, в стиле \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Etypedef enum CC1310_LAUNCHXL_UARTName {\n    CC1310_LAUNCHXL_UART0 = 0,\n    CC1310_LAUNCHXL_UARTCOUNT\n} CC1310_LAUNCHXL_UARTName;\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nТакие решения стандартны для настоящих перечислений, но для описания аппаратных объектов — а я и не знал, что так можно, хотя вполне себе работает. С инициализацией железа покончили, идем дальше.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nМы наблюдаем в запущенной задаче классический бесконечный цикл, в котором читаются данные из последовательного порта функцией \u003Cpre\u003E\u003Ccode class=\"cpp\"\u003EUART_read(uart, &amp;input, 1);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E и тут же отправляются обратно функцией \u003Cpre\u003E\u003Ccode class=\"cpp\"\u003EUART_write(uart, &amp;input, 1);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E. Войдем в первую из них и видим попытку чтения символов из приемного буфера \u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Ereturn (handle-\u003EfxnTablePtr-\u003EreadPollingFxn(handle, buffer, size))\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E (как же я ненавижу такие вещи, но в С иначе просто нельзя), проходим глубже и оказываемся в UARTCC26XX_read, а из нее попадаем в реализации кольцевого буфера — функция \u003Cpre\u003E\u003Ccode class=\"cpp\"\u003ERingBuf_get(&amp;object-\u003EringBuffer, &amp;readIn)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E. Здесь обычная жизнь переходит в острую фазу.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСказать, что данный конкретный модуль (файл ringbuf.c) мне не понравился — это не сказать ничего, написано просто ужасно и лично я бы на месте такой уважаемой компании авторов данной части выгнал с позором (можно еще взять меня на их место, но боюсь что уровень зарплат наших индийских коллег меня не устроит), но, наверное, я чего то не знаю. Следите за руками:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n1) ре-ролл указателей чтения\u002Fзаписи реализован через остаток от деления \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eobject-\u003Etail = (object-\u003Etail + 1) % object-\u003Elength;\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nи никаких оптимизаций компилятора при выполнении этой операции вроде наложения битовой маски тут нет и быть не может, поскольку длина буфера не есть константа. Да, в данном МК есть аппаратная операция деления и она довольно-таки быстрая (я об этом писал), но все равно она никогда не займет 2 такта, как в правильной реализации с честным ре-роллом (и об этом я тоже писал),\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: недавно видел описание новой архитектуры М7 в реализации уж и не помню кого, так там почему-то деление 32 на 32 стало выполняться за 2-12 тактов вместо 2-7. Или это ошибка перевода, или… даже и не знаю, что придумать.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n2) мало того, этот фрагмент кода повторен более чем в одном месте — макросы и инлайны для слабаков, ctrl+C и ctrl+V рулят, принцип DRY идет лесом,\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n3) реализован совершенно излишний счетчик заполненных мест в буфере, что повлекло за собой следующий недостаток,\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n4) критические секции как в чтении, так и в записи. Ну ладно, я еще могу поверить, что авторы данного модуля не читают мои посты на Хабре (хотя для профессионалов в области прошивки такое поведение недопустимо), но с «Книгой мустанга» они должны быть знакомы, там этот вопрос рассмотрен подробно,\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n5) как вишенка на торте, введен еще индикатор максимального размера буфера, причем с весьма невнятным именем и полностью отсутствующим описанием (последнее относится вообще ко всему модулю). Я не исключаю, что данный параметр может быть полезен при отладке, но зачем тащить его в релиз — нам что, такты процессора вообще девать некуда вместе с оперативкой?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n6) при этом полностью отсутствует обработка переполнения буфера (есть возврат -1, сигнализирующей о данной ситуации)- даже в Ардуино она есть, оставим в стороне качество этой обработки, но ее отсутствие еще хуже. Или же авторов вдохновлял известный факт о том, что относительно пустого множества справедливы любые предположения, в том числе и то, что оно не пусто?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ общем, мои замечания полностью соответствуют первой строчке демотиватора на тему ревью кода «10 строк кода — 10 замечаний».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКстати, предпоследний из отмеченных недостатков заставляет задуматься о более глобальных вещах — а как нам вообще реализовывать базовый класс, чтобы иметь возможность проводить его глубокую модификацию. Делать все поля защищенными — сомнительная идея (хотя, наверное, единственно правильная), вставлять вызов дружественных функций в наследников — очень сильно похоже на костыли. Если в данном конкретном случае есть простой ответ на вопрос о введении индикатора наполненности буфера — порожденный класс с перекрытыми записью и чтением и дополнительный счетчик, то для реализации чтения без продвижения буфера (как в данном случае) или замены последнего помещенного символа (видел я и такие реализации кольцевого буфера) без доступа к внутренним данным родительского класса не обойтись.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри этом к реализации собственно чтения из последовательного интерфейса претензий нет — ввод блокирующий, при отсутствии в приемном буфере достаточного количества символов взводится семафор и управление передается шедулеру — все реализовано аккуратно и правильно. Лично мне не очень нравится управление аппаратурой в процедуре общего назначения, но это позволяет снизить вложенность процедур и уменьшает индекс цикломатической сложности, что бы это ни значило.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОбратим теперь внимание на передачу принятых данных в последовательный канал, поскольку при создании объекта ему предоставили только один кольцевой буфер — приемный. И действительно, для передачи символов используется внутренний буфер аппаратной части и при его заполнении вводится ожидание готовности (по крайней мере в блокирующем режиме работы). Не могу не удержаться, чтобы не покритиковать стиль соответствующих функций: 1) в объекте почему-то имеется обобщенный указатель, который внутри функции постоянно превращается в указатель на символы \u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E*(unsigned char *)object-\u003EwriteBuf);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E 2) логика работы совершенно непрозрачна и слегка запутана. Но все это не столь важно, поскольку остается спрятанным от пользователя и «на максимальную скорость не влияет».\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ процессе исследований наталкиваемся еще на одну особенность — мы не видим исходного кода некоторых внутренних функций в режиме отладки — это связано с изменением имен для разных вариантов компиляции (ROM\u002FNO_ROM). Подменить требуемый файл исходного текста (C:\\Jenkins\\jobs\\FWGroup-DriverLib\\workspace\\modules\\output\\cc13xx_cha_2_0_ext\\driverlib\\bin\\ccs\u002F.\u002F..\u002F..\u002F..\u002Fdriverlib\u002Fuart.c--) мне не удалось (но я не очень то и старался), хотя исходник я нашел (естественно, в файле в файле uart.c, спасибо, капитан), по счастью, этот фрагмент несложен и однозначно отождествить ассемблерный код с исходным текстом на С несложно (особенно если знать особенности команды ITxxx). Как решать эту проблему для библиотек со сложными функциями пока не знаю, будем думать, когда возникнет необходимость.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНу и напоследок небольшое замечание — я готов поверить, что аппаратная часть реализации последовательного канала для моделей МК СС13х0 совпадает с таковой для СС26х0, и дублирование содержимого файла с названием UARTCC26XX.c--- нельзя назвать правильным решением, но создание промежуточного файла определений с включением исходного файла, переопределением функций и соответствующим комментарием приветствовал бы, поскольку это сделало бы программу более понятной, а это всегда должно приветствоваться, воут.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИтак, тестовый пример работает, мы узнали многое о внутреннем устройстве стандартных библиотек, отметили их сильные и не очень стороны, в заключение обзора попробуем найти ответ на вопрос, который обычно волнует программиста в дилемме «ОС или не ОС» — время переключения контекста. Здесь возможны два пути: 1) рассмотрение исходного кода — это скорее теоретический путь, он требует такого уровня погружения в предмет, который я продемонстрировать не готов, и 2) практический эксперимент. Конечно, второй метод, в отличие от первого, не дает абсолютно верных результатов, но «истина всегда конкретна» и полученные данные вполне можно рассматривать как адекватные, если измерения организованы правильно.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nДля начала, чтобы оценить время переключения, нам необходимо научиться оценивать вообще время исполнения различных фрагментов программы. В рассматриваемой архитектуре имеется модуль отладки, частью которого является системный счетчик. Информация о данном модуле вполне доступна, но дьявол, как всегда, прячется в деталях. Для начала попробуем настроить необходимый режим ручками напрямую через доступ к регистрам. Быстро находим блок регистров CPU_DWT и в нем обнаруживаем как собственно счетчик CYCCNT, так и управляющий регистр к нему CTRL с битом CYCCNTENA. Естественно, или, как еще говорят, разумеется, ничего не получилось и на сайте ARM есть ответ на вопрос, почему — необходимо разрешить работу модуля отладки битом TRCENA в регистре DEMCR. А вот с последним регистром не все так просто — в блоке DWT его нет, в других блоках искать лениво — они достаточно длинные, а никакого поиска по имени в окне регистров я не нашел (а было бы неплохо его иметь). Идем в окно памяти, вводим адрес регистра (он нам известен из дата) (кстати, почему-то шестнадцатеричный формат адреса не является дефолтным, надо ручками добавлять префикс 0х) и, внезапно, видим именованную ячейку памяти с именем CPU_CSC_DEMCR. Забавно, если не сказать больше, зачем фирма переименовала регистры по сравнению с предлагаемой лицензиатором архитектуры названиями, наверное, так надо было. И точно, в блоке регистров CPU_CSC находим наш регистр, ставим в нем нужный бит, возвращаемся к счетчику, разрешаем его и все заработало.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: поиск по имени все-таки есть, вызывается (естественно) комбинацией Ctrl-F, просто он есть только в контекстном меню, а в обычном погашен, приношу извинения разработчикам. \u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nСразу отмечу еще недостаток окна памяти — печать содержимого прерывается указанием именованных ячеек, что делает выдачу рваной и ни фига не сегментированной по 16 (8,32,64, нужное подставить) слов. Более того, формат выдачи меняется при изменении размера окна. Может быть, все это можно настроить так, как пользователю нужно, но, исходя из собственного опыта (а из чего еще мне исходить) заявляю, что к интуитивно-очевидным решениям настройка формата выдачи окна просмотра памяти не относится. Я полностью за то, чтобы такая удобная фича, как показ именованных областей памяти в окне просмотра, была включена по умолчанию, иначе о ней многие пользователи и не узнали бы никогда, но надо позаботиться и о тех, кто сознательно ее хочет отключить.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nКстати, я бы совсем не отказался от возможности создания макросов (или скриптов) по работе со средой, ведь такую настройку регистров (для включения измерения времени) приходилось делать всякий раз после сброса МК, поскольку корректировать код путем вставления манипуляций с регистрами для целей отладки считаю не очень правильным. Но, хотя макросов я так и не нашел, работу с регистрами можно сильно упростить за счет того, что отдельные (необходимые) регистры можно включить в окно выражений, и тем самым существенно облегчить и ускорить работу с ними.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЧтобы подчеркнуть, что чувство инженера к семейству МК не охладело (а то я все ругаю разные аспекты среды разработки), отмечу, что счетчик работает прекрасно — никаких лишних тактов ни в одном из режимов отладки я обнаружить не смог, а раньше такое явление имело место быть, по крайней мере в серии МК разработки LuminaryMicro.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИтак, намечаем план эксперимента по определению времени переключения контекста — создаем вторую задачу, которая будет инкрементировать некий внутренний счетчик (в бесконечном цикле), запускаем МК на определенное время, находим соотношение между системным счетчиком и счетчиком задачи. Далее запускаем МК на аналогичное время (не обязательно точно такое же) и вводим 10 символов в темпе приблизительно раз в секунду. Можно ожидать, что при этом произойдет 10 переключений на задачу эха и 10 переключений обратно на задачу счетчика. Да, эти переключения контекста будут производится не по таймеру шедулера, а по событию, но на общее время исполнения исследуемой функции это не должно повлиять, так что начинаем претворять план в жизнь, создаем задачу счетчика и запускаем ее.\u003Cbr\u002F\u003E\r\n \u003Cbr\u002F\u003E\r\nТут же обнаруживаем одну особенность РТОС, по крайней мере в стандартной конфигурации — она не является вытесняющей «по настоящему»: если более приоритетная задача постоянно готова к выполнению (а задача счетчика такова) и не отдает управление шедулеру (не ожидает сигналов, не засыпает, не блокируется по флагам и т.д.) то ни одна задача более низкого приоритета не будет исполняться от слова совсем. Это не Линукс, в котором применяются различные методы для гарантии получения кванта всеми, «и чтобы никто не ушел обиженным». Данное поведение вполне ожидаемо, многие легкие ОСРВ ведут себя так, но проблема оказывается глубже, поскольку управление не получают и задачи равного с постоянно готовой приоритета. Именно поэтому в рассматриваемом примере я ставлю задаче эха, которая входит в ожидание, приоритет выше, чем постоянно готовой задаче счетчика, иначе последняя захватит все ресурсы процессора по времени.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nНачинаем эксперимент, первая часть (просто ожидание времени исполнения) дала данные отношения счетчиков 406181к\u002F58015к = 7 — вполне ожидаемо. Вторая часть (с 10 последовательными символами в течении ~10 секунд) дает результаты 351234к-50167к*7 = 63к\u002F20=3160 тактов, последняя цифра и есть время, связанное с процедурой переключения контекста в тактах МК. Лично мне данная величина кажется несколько большей, чем ожидалось, продолжаем исследования, похоже, что есть еще какие-то действия, которые портят статистику.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: частая ошибка экспериментатора — не оценить предварительно ожидаемые результаты и поверить в полученный мусор (привет разработчикам 737).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОчевидно («ну да, совершенно очевидно»), что в полученном результате, помимо времени собственно переключения контекста, содержится еще и время, необходимое для выполнения операций чтения символа из буфера и вывода его в последовательный порт. Менее очевидно, что в нем есть еще и время, необходимое для обработки прерывания при приеме и помещения символа в приемный буфер). Как нам отделить кошку от мяса — для этого у нас есть хитрый трюк — останавливаем программу, вводим 10 символов и запускаем ее. Можно ожидать (надо бы посмотреть исходники), что прерывание по приему произойдет только 1 раз и сразу все символы будут пересланы из приемного буфера в кольцевой, значит и мы увидим меньшие накладные расходы. Определить время выдачи в последовательный порт также несложно — будем выводить каждый второй символ и решим получившиеся 2 линейных уравнения с 2 неизвестны. А можно и еще проще – ничего не выводить, что я и сделал.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nИ вот результаты подобных хитрых манипуляций: делаем ввод пакетом и пропавших тактов становится меньше – 2282, отключаем вывод и затраты падают до 1222 тактов – уже лучше, хотя я надеялся тактов на 300.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nА вот со временем выполнения считывания ничего подобного придумать не удастся, оно масштабируется одновременно с искомым временем переключения контекста. Единственное, что я могу предложить — это отключать внутренний таймер при начале ввода принятого символа и снова включать его перед входом в ожидание очередного. Тогда два счетчика будут работать синхронно (за исключением переключения) и его легко можно определить. Но такой подход требует глубокого внедрения в тексты системных программ и все равно составляющая обработки прерываний останется. Поэтому я предлагаю ограничиться уже полученными данными, которые позволяют твердо утверждать, что время переключения задач в рассматриваемой TI-RTOS не превосходит 1222 тактов, что при заданной тактовой частоте составляет 30 мксек.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПнп: все равно очень много – я рассчитывал тактов на 100: 30 на сохранение контекста, 40 на определение готовой задачи и 30 на восстановление контекста, а у нас получается на порядок больше. Хотя сейчас отключена оптимизация, включим –o2 и посмотрим результат: почти не изменился – стало 2894 вместо 3160.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЕсть еще одна идея — если бы в ОС поддерживалось переключение равноранговых задач, то можно было бы запустить две задачи со счетчиками, некоторым волшебным образом получить данные о количестве переключений за некое время и рассчитать убыль системного счетчика, но в силу особенностей шедулера, о которой я уже говорил, данный подход не приведет к успеху. Хотя возможен другой вариант — делать пинг-понг между двумя одноранговыми (или даже разноранговыми) задачами через семафор, здесь легко посчитать число переключений контекста — надо будет попробовать, но это уже завтра.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nТрадиционный опрос в конце поста на этот раз будет посвящен не уровню изложения (любому непредвзятому читателю ясно, что он вне всяких похвал и превосходит любые ожидания), а теме очередного поста.\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"программирование микроконтроллеров"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F451918\u002F2f222cbdc4d182d18ec64ce74b6bca79\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F451918\u002F2f222cbdc4d182d18ec64ce74b6bca79\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F451918\\\u002F\"},\"headline\":\"К вопросу о TI\",\"datePublished\":\"2019-05-15T13:01:55+03:00\",\"dateModified\":\"2019-05-16T11:54:35+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Автушенко Игорь\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"&laquo;Сейчас я покажу вам портрет&hellip; Хм&hellip; Я предупреждаю вас, что это именно портрет&hellip; Во всяком случае, прошу отнестись к нему, как к портрету...  В данном посте пойдет...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F451918\\\u002F#post-content-body\",\"about\":[\"h_controllers\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabr.com\\\u002Fshare\\\u002Fpublication\\\u002F451918\\\u002F2f222cbdc4d182d18ec64ce74b6bca79\\\u002F\"]}","metaDescription":"«Сейчас я покажу вам портрет… Хм… Я предупреждаю вас, что это именно портрет… Во всяком случае, прошу отнестись к нему, как к портрету...\r\n\r\nВ данном посте пойдет речь о разработке и отладке программ...","mainImageUrl":null,"amp":false},"polls":[{"id":"30324","timeElapsed":null,"answersType":"checkbox","votesCount":23,"passCount":12,"textHtml":"Вы предпочтете либо:","relatedData":null,"variants":[{"id":"145286","textHtml":"продолжить знакомиться с средой от TI и TI-RTOS,","votesCount":12,"percent":52.17,"selected":false},{"id":"145288","textHtml":"описание отладочных плат от TI для данного семейства","votesCount":8,"percent":34.78,"selected":false},{"id":"145290","textHtml":"увидеть обзор отечественной РТОС МАКС (если Вы думаете, что ТИ я ругал, то поймете, что ошибались, я и беличьим хвостиком гладил)","votesCount":11,"percent":47.83,"selected":false}]},{"id":"30326","timeElapsed":null,"answersType":"checkbox","votesCount":4,"passCount":4,"textHtml":"Вы предпочтете либо:","relatedData":null,"variants":[{"id":"145294","textHtml":"продолжить знакомиться с средой от TI и TI-RTOS,","votesCount":3,"percent":75,"selected":false},{"id":"145296","textHtml":"описание отладочных плат от TI для данного семейства","votesCount":2,"percent":50,"selected":false},{"id":"145298","textHtml":"увидеть обзор отечественной РТОС МАКС (если Вы думаете, что ТИ я ругал, то поймете, что ошибались, я и беличьим хвостиком гладил)","votesCount":0,"percent":0,"selected":false}]}],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"controllers"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
