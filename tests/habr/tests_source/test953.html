<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Модульное тестирование Json сериализации в Spring Boot / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/452188\/"},"headline":"Модульное тестирование Json сериализации в Spring Boot","datePublished":"2019-05-16T17:30:27+03:00","dateModified":"2019-05-16T18:01:53+03:00","author":{"@type":"Person","name":"Виктор Боровлёв"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Введение Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень а...","url":"https:\/\/habr.com\/ru\/post\/452188\/#post-content-body","about":["h_java","f_develop"],"image":["https:\/\/habrastorage.org\/webt\/wb\/jv\/d1\/wbjvd1ajjlmxvobtph6_9p6sutk.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Модульное тестирование Json сериализации в Spring Boot" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Модульное тестирование Json сериализации в Spring Boot" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Модульное тестирование Json сериализации в Spring Boot" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Введение
Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень абстракции, позволяя разработчику..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Введение
Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень абстракции, позволяя разработчику..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Введение
Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень абстракции, позволяя разработчику..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Введение
Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень абстракции, позволяя разработчику..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Введение
Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень абстракции, позволяя разработчику..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/452188/4af28e6ed6b3479c0d715d01e2fd6e12/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/452188/4af28e6ed6b3479c0d715d01e2fd6e12/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/452188/4af28e6ed6b3479c0d715d01e2fd6e12/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/452188/4af28e6ed6b3479c0d715d01e2fd6e12/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/452188/4af28e6ed6b3479c0d715d01e2fd6e12/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="452188" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-16T14:30:27.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/452188/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/452188/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/452188/4af28e6ed6b3479c0d715d01e2fd6e12/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Frechet/" title="Frechet" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_pink"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/Frechet/" class="tm-user-info__username">
      Frechet
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-16T14:30:27.000Z" title="2019-05-16, 17:30">16  мая  2019 в 17:30</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Модульное тестирование Json сериализации в Spring Boot</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/java/" class="tm-article-snippet__hubs-item-link"><span>Java</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <div class="tm-article-snippet__labels"><div class="tm-article-snippet__label"><span>
        Из песочницы
      </span></div></div> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/wb/jv/d1/wbjvd1ajjlmxvobtph6_9p6sutk.png"/><br/>
<br/>
<h2>Введение</h2><br/>
Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае <i>Spring Boot</i> предоставляет удобный уровень абстракции, позволяя разработчику оставаться на уровне работы с моделями, а сам процесс сериализации модели оставлять вне исходного кода программы. Но как быть, если сама сериализация становится частью бизнес-логики приложения и, следовательно, требует покрытия тестовыми сценариями?<br/>
<br/>
В данной статье будет рассмотрен один из сценариев, когда нам может понадобиться учесть особенности бизнес-логики приложения при сериализации (сценарий округления денежных сумм), на примере которого мы столкнёмся с механизмом сериализации в Spring Boot, а также описан возможный способ тестирования.<br/>
<a name="habracut"></a><br/>
<h2>Постановка задачи</h2><br/>
Пусть наш веб-сервис отвечает за предоставление информации о расходах клиента, и нам требуется предоставлять данные с конфигурируемой точностью. Логичным решением будет вынести все преобразования модели на перефирию сервиса, при этом сохранив наглядность применения логики округления.<br/>
<br/>
<h2>Рассмотрим возможное решение</h2><br/>
Представим контроллер нашего приложения, который будет возвращать требуемую модель.<br/>
<br/>
<pre><code class="java">@RestController
public class AccountController {

    // Поскольку нас не интересует сам процесс получения модели,
    // оставим его за кадром некоторого внутреннего сервиса.
    @Autowired
    private AccountService accountService;

    @RequestMapping(value = "/account/{clientId}", method = RequestMethod.GET, produces = "application/json")
    public Account getAccount(@PathVariable long clientId) throws Exception {
        Account result = accountService.getAccount(clientId);
        // Как видим, результат работы контролера -
        // это всё ещё модель нашего сервиса, а не итоговый json,
        // который получит клиентское приложение.
        return result; 
    }
}
</code></pre><br/>
Теперь посмотрим на нашу модель.<br/>
<br/>
<pre><code class="java">public class Account {

    private Long clientId;
    
    // По умолчанию в Spring Boot сериализацией занимается FasterXML/jackson,
    // в котором предусмотрено API для кастомизации, им и воспользуемся.
    // Укажем, что сериализацией расходов мы хотим управлять
    // посредством некоторого нашего сервиса MoneySerializer
    @JsonSerialize(using = MoneySerializer.class)
    private BigDecimal value;
    
    // Пропустим описание набора getter'ов и setter'ов для полей модели
}
</code></pre><br/>
Возможно, вам уже приходилось иметь дело с другими аннотациями для кастомизации. Особенность данной аннотации — возможность определить свой сервис, ответственный за сериализацию аннотированного поля модели.<br/>
<br/>
Прежде чем посмотреть, что из себя представляет сериализатор, усложним задачу: пусть параметры округления будут конфигурируемы через некоторый внутренний сервис, абстрагирующий любое проявление динамического разрешения параметров.<br/>
<br/>
Это усложнение наш ключевой момент, который мы хотим рассмотреть. Как мы могли видеть по реализации модели, API нашего фреймворка принимает в аргументе класс сериализации, а значит жизненый цикл сериализатора переходит под контроль фреймворка сериализатора. Отсюда возникает вопрос, что делать в том случае, если мы хотим внедрить зависимость из контекста нашего приложения в сериализатор? Для этого рассмотрим реализацию приведённого выше сериализатора.<br/>
<br/>
<pre><code class="java">// Обратите внимание на данную аннотацию,
// поскольку Jackson интегрирован с Spring,
// API позволяет проинформировать фреймворк
// для возможности использования Spring DI
@JsonComponent
public class MoneySerializer extends JsonSerializer&lt;BigDecimal> {

    // Данный сервис, абстрагирующий параметры округления,
    // является частью контекста Spring Boot являясь одним из Bean'ов.
    private RoundingHolder roundingHolder;

    @Autowired
    public MoneySerializer(RoundingHolder roundingHolder) {
        this.roundingHolder = roundingHolder;
    }

    // Сам процесс сериализации не будет в новинку,
    // всё, что нам надо, это в переопределённом методе сериализации -
    // реализовать итоговое представление интересующего нас объекта.
    @Override
    public void serialize(BigDecimal value, JsonGenerator jsonGenerator, SerializerProvider serializerProvider) throws IOException {
        jsonGenerator.writeNumber(value.setScale(roundingHolder.getPrecision(), roundingHolder.getRoundingMode()));
    }
}
</code></pre><br/>
Наш сервис готов, но, как ответственные разработчики, мы хотим убедиться, что собранная нами кухня работает.<br/>
<br/>
<h2>Перейдём к тестированию</h2><br/>
Давайте посмотрим, что предлагает нам API фреймворка для тестирования.<br/>
<br/>
<pre><code class="java">
// Поскольку мы хотим протестировать механизм, работа которого
// строится на контексте Spring, то нам требуется запустить и сам контекст.
// Что же касается аннотации JsonTest, то она отвечает за наполнение
// запускаемого нами контекста только тем окружением,
// которое требуется для JSON-сериализации.
@JsonTest
@ContextConfiguration(classes = {AccountSerializationTest.Config.class})
@RunWith(SpringRunner.class)
public class AccountSerializationTest {

    // Важно убедиться, что в тестовом сценарии используется
    // тот же объект класса ObjectMapper, что и в приложении.
    // Для этого воспользуемся инъекцией маппера из контекста.
    // При использовании кастомизированнго маппера,
    // его следует добавить в тестовый контекст.
    @Autowired
    private ObjectMapper objectMapper;

    @Test
    public void testAccountMoneyRounding() throws Exception {
        Account account = new Account();
        account.setClientId(1L);
        account.setValue(BigDecimal.valueOf(1.123456789));

        String expectedResult = "{\"clientId\":1,\"value\":\1.123\}";

        // Теперь, когда у нас в руках необходимый маппер модели в JSON,
        // убедимся в корректном исполнении бизнес-сценария.
        assertEquals(expectedResult, objectMapper.writeValueAsString(account));
    }

    // Поскольку класс MoneySerializer передаётся в API фреймворка 
    // через аннотацию в модели, то жизненным циклом объекта этого класса
    // уже будет заниматься Jackson. Но наш сервис, отвечающий за округление,
    // порождается контекстом Spring и, следовательно, необходимо
    // добавить его в изолированный тестовый контекст.
    @TestConfiguration
    public static class Config {
        @Bean
        public static RoundingHolder roundingHolder() {
            RoundingHolder roundingHolder = Mockito.mock(RoundingHolder.class);
            // позаботимся о том, чтобы сервис обладал логикой для проведения тестового сценария
            Mockito.when(roundingHolder.getMathContext()).thenReturn(new MathContext(3, RoundingMode.HALF_EVEN));
            return roundingHolder;
        }
    }
}
</code></pre><br/>
Остановимся на этом моменте поподробнее. Для сериализации и десериализации моделей в Jackson используется класс <a href="https://static.javadoc.io/com.fasterxml.jackson.core/jackson-databind/2.9.8/com/fasterxml/jackson/databind/ObjectMapper.html">ObjectMapper</a>. Это именно тот объект контекста, который отвечает за преобразование моделей, следовательно, чтобы убедиться в том, как модель будет представлена, надо проверить как её обработает ObjectMapper из контекста.<br/>
<br/>
При желании создать свой кастомный ObjectMapper, вы можете встретить следующий типичный пример: <i>ObjectMapper mapper = new ObjectMapper</i>. Однако, посмотрим на то, как Spring Boot создаёт экземпляр этого класса по умолчанию. Для этого обратимся к исходному коду автоконфигурации <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/autoconfigure/jackson/JacksonAutoConfiguration.html">JacksonAutoConfiguration</a>, отвечающей за создание объекта:<br/>
<br/>
<pre><code class="java">@Bean
public ObjectMapper jacksonObjectMapper(Jackson2ObjectMapperBuilder builder) {
    return builder.createXmlMapper(false).build();
}
</code></pre><br/>
И если пойти ещё дальше и заглянуть в <i>build()</i>, то обнаружим, что для работы сериализации, к которой мы могли привыкнуть при работе с дефолтным маппером (как например инъекция сервисов в кастомный сериализатор) мало просто создать Bean маппера, следует обратиться к предоставляемому билдеру. Кстати, в самой <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-spring-mvc.html#howto-customize-the-jackson-objectmapper">документации</a> к Spring Boot это указано явно.<br/>
<br/>
Отступлением хотелось бы добавить отсылку к <a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/test/json/JacksonTester.html">JacksonTester</a>. Как к представителю оболочки для BDD тестирования сериализации в контексте Mockito.<br/>
<br/>
<h2>Подведём итоги</h2><br/>
<ul>
<li> Spring Boot предоставляет возможность кастомизировать сериализацию модели посредством аннотации JsonSerializer</li>
<li> Для тестирования сериализации используйте маппер в той же конфигурации, что и в приложении</li>
<li> При переопределении бина из автоконфигурации Spring Boot, обратите внимание на то, как этот бин создаёт сам Spring Boot, чтобы не упустить возможностей, которыми обладал дефолтный бин</li>
<li> Для задания ограниченного контекста, необходимого для тестирования сериализации, можно воспользоваться аннотацией JsonTest</li>
</ul><br/>
<h2>Заключение</h2><br/>
Спасибо за внимание! Данный пример будет актуален как для текущей версии Spring Boot 2.1.x, так и для более ранних версий вплоть до 1.4.x. Также техника подойдёт для ситуаций с десериализацией модели. Смотрите под капот ваших основных фреймворков для лучшего понимания механизма работы приложения и ответственно подходите к тестированию.</div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bjava%5D" class="tm-tags-list__link">java</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bspring%20boot%5D" class="tm-tags-list__link">spring boot</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bserialization%5D" class="tm-tags-list__link">serialization</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bunit%20testing%5D" class="tm-tags-list__link">unit testing</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/java/" class="tm-hubs-list__link">
    Java
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 10: ↑9 и ↓1</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 10: ↑9 и ↓1" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+8</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">4.8K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    43
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Frechet/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_pink"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 4 голоса " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    4
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><span class="tm-user-card__name tm-user-card__name_variant-article">Виктор Боровлёв</span> <a href="/ru/users/Frechet/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Frechet
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Разработчик</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/452188/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментировать 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/452188/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/452188/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"452188":{"id":"452188","timePublished":"2019-05-16T14:30:27+00:00","isCorporative":false,"lang":"ru","titleHtml":"Модульное тестирование Json сериализации в Spring Boot","leadData":{"textHtml":"\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fwb\u002Fjv\u002Fd1\u002Fwbjvd1ajjlmxvobtph6_9p6sutk.png\"\u003E\u003Cbr\u003E\r\n\u003Cbr\u003E\r\n\u003Ch2\u003EВведение\u003C\u002Fh2\u003E\u003Cbr\u003E\r\nОдной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае \u003Ci\u003ESpring Boot\u003C\u002Fi\u003E предоставляет удобный уровень абстракции, позволяя разработчику оставаться на уровне работы с моделями, а сам процесс сериализации модели оставлять вне исходного кода программы. Но как быть, если сама сериализация становится частью бизнес-логики приложения и, следовательно, требует покрытия тестовыми сценариями?\u003Cbr\u003E\r\n\u003Cbr\u003E\r\nВ данной статье будет рассмотрен один из сценариев, когда нам может понадобиться учесть особенности бизнес-логики приложения при сериализации (сценарий округления денежных сумм), на примере которого мы столкнёмся с механизмом сериализации в Spring Boot, а также описан возможный способ тестирования.\u003Cbr\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше →","image":null},"editorVersion":"1.0","postType":"article","postLabels":[{"type":"sandbox","data":null}],"author":{"scoreStats":{"score":4,"votesCount":4},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"1687593","alias":"Frechet","fullname":"Виктор Боровлёв","avatarUrl":null,"speciality":"Разработчик"},"statistics":{"commentsCount":0,"favoritesCount":43,"readingCount":4761,"score":8,"votesCount":10},"hubs":[{"relatedData":null,"id":"375","alias":"java","type":"collective","title":"Java","titleHtml":"Java","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fwb\u002Fjv\u002Fd1\u002Fwbjvd1ajjlmxvobtph6_9p6sutk.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EВведение\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nОдной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае \u003Ci\u003ESpring Boot\u003C\u002Fi\u003E предоставляет удобный уровень абстракции, позволяя разработчику оставаться на уровне работы с моделями, а сам процесс сериализации модели оставлять вне исходного кода программы. Но как быть, если сама сериализация становится частью бизнес-логики приложения и, следовательно, требует покрытия тестовыми сценариями?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nВ данной статье будет рассмотрен один из сценариев, когда нам может понадобиться учесть особенности бизнес-логики приложения при сериализации (сценарий округления денежных сумм), на примере которого мы столкнёмся с механизмом сериализации в Spring Boot, а также описан возможный способ тестирования.\u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EПостановка задачи\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПусть наш веб-сервис отвечает за предоставление информации о расходах клиента, и нам требуется предоставлять данные с конфигурируемой точностью. Логичным решением будет вынести все преобразования модели на перефирию сервиса, при этом сохранив наглядность применения логики округления.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EРассмотрим возможное решение\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nПредставим контроллер нашего приложения, который будет возвращать требуемую модель.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E@RestController\npublic class AccountController {\n\n    \u002F\u002F Поскольку нас не интересует сам процесс получения модели,\n    \u002F\u002F оставим его за кадром некоторого внутреннего сервиса.\n    @Autowired\n    private AccountService accountService;\n\n    @RequestMapping(value = \"\u002Faccount\u002F{clientId}\", method = RequestMethod.GET, produces = \"application\u002Fjson\")\n    public Account getAccount(@PathVariable long clientId) throws Exception {\n        Account result = accountService.getAccount(clientId);\n        \u002F\u002F Как видим, результат работы контролера -\n        \u002F\u002F это всё ещё модель нашего сервиса, а не итоговый json,\n        \u002F\u002F который получит клиентское приложение.\n        return result; \n    }\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nТеперь посмотрим на нашу модель.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epublic class Account {\n\n    private Long clientId;\n    \n    \u002F\u002F По умолчанию в Spring Boot сериализацией занимается FasterXML\u002Fjackson,\n    \u002F\u002F в котором предусмотрено API для кастомизации, им и воспользуемся.\n    \u002F\u002F Укажем, что сериализацией расходов мы хотим управлять\n    \u002F\u002F посредством некоторого нашего сервиса MoneySerializer\n    @JsonSerialize(using = MoneySerializer.class)\n    private BigDecimal value;\n    \n    \u002F\u002F Пропустим описание набора getter'ов и setter'ов для полей модели\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nВозможно, вам уже приходилось иметь дело с другими аннотациями для кастомизации. Особенность данной аннотации — возможность определить свой сервис, ответственный за сериализацию аннотированного поля модели.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПрежде чем посмотреть, что из себя представляет сериализатор, усложним задачу: пусть параметры округления будут конфигурируемы через некоторый внутренний сервис, абстрагирующий любое проявление динамического разрешения параметров.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nЭто усложнение наш ключевой момент, который мы хотим рассмотреть. Как мы могли видеть по реализации модели, API нашего фреймворка принимает в аргументе класс сериализации, а значит жизненый цикл сериализатора переходит под контроль фреймворка сериализатора. Отсюда возникает вопрос, что делать в том случае, если мы хотим внедрить зависимость из контекста нашего приложения в сериализатор? Для этого рассмотрим реализацию приведённого выше сериализатора.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E\u002F\u002F Обратите внимание на данную аннотацию,\n\u002F\u002F поскольку Jackson интегрирован с Spring,\n\u002F\u002F API позволяет проинформировать фреймворк\n\u002F\u002F для возможности использования Spring DI\n@JsonComponent\npublic class MoneySerializer extends JsonSerializer&lt;BigDecimal\u003E {\n\n    \u002F\u002F Данный сервис, абстрагирующий параметры округления,\n    \u002F\u002F является частью контекста Spring Boot являясь одним из Bean'ов.\n    private RoundingHolder roundingHolder;\n\n    @Autowired\n    public MoneySerializer(RoundingHolder roundingHolder) {\n        this.roundingHolder = roundingHolder;\n    }\n\n    \u002F\u002F Сам процесс сериализации не будет в новинку,\n    \u002F\u002F всё, что нам надо, это в переопределённом методе сериализации -\n    \u002F\u002F реализовать итоговое представление интересующего нас объекта.\n    @Override\n    public void serialize(BigDecimal value, JsonGenerator jsonGenerator, SerializerProvider serializerProvider) throws IOException {\n        jsonGenerator.writeNumber(value.setScale(roundingHolder.getPrecision(), roundingHolder.getRoundingMode()));\n    }\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nНаш сервис готов, но, как ответственные разработчики, мы хотим убедиться, что собранная нами кухня работает.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EПерейдём к тестированию\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nДавайте посмотрим, что предлагает нам API фреймворка для тестирования.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E\n\u002F\u002F Поскольку мы хотим протестировать механизм, работа которого\n\u002F\u002F строится на контексте Spring, то нам требуется запустить и сам контекст.\n\u002F\u002F Что же касается аннотации JsonTest, то она отвечает за наполнение\n\u002F\u002F запускаемого нами контекста только тем окружением,\n\u002F\u002F которое требуется для JSON-сериализации.\n@JsonTest\n@ContextConfiguration(classes = {AccountSerializationTest.Config.class})\n@RunWith(SpringRunner.class)\npublic class AccountSerializationTest {\n\n    \u002F\u002F Важно убедиться, что в тестовом сценарии используется\n    \u002F\u002F тот же объект класса ObjectMapper, что и в приложении.\n    \u002F\u002F Для этого воспользуемся инъекцией маппера из контекста.\n    \u002F\u002F При использовании кастомизированнго маппера,\n    \u002F\u002F его следует добавить в тестовый контекст.\n    @Autowired\n    private ObjectMapper objectMapper;\n\n    @Test\n    public void testAccountMoneyRounding() throws Exception {\n        Account account = new Account();\n        account.setClientId(1L);\n        account.setValue(BigDecimal.valueOf(1.123456789));\n\n        String expectedResult = \"{\\\"clientId\\\":1,\\\"value\\\":\\1.123\\}\";\n\n        \u002F\u002F Теперь, когда у нас в руках необходимый маппер модели в JSON,\n        \u002F\u002F убедимся в корректном исполнении бизнес-сценария.\n        assertEquals(expectedResult, objectMapper.writeValueAsString(account));\n    }\n\n    \u002F\u002F Поскольку класс MoneySerializer передаётся в API фреймворка \n    \u002F\u002F через аннотацию в модели, то жизненным циклом объекта этого класса\n    \u002F\u002F уже будет заниматься Jackson. Но наш сервис, отвечающий за округление,\n    \u002F\u002F порождается контекстом Spring и, следовательно, необходимо\n    \u002F\u002F добавить его в изолированный тестовый контекст.\n    @TestConfiguration\n    public static class Config {\n        @Bean\n        public static RoundingHolder roundingHolder() {\n            RoundingHolder roundingHolder = Mockito.mock(RoundingHolder.class);\n            \u002F\u002F позаботимся о том, чтобы сервис обладал логикой для проведения тестового сценария\n            Mockito.when(roundingHolder.getMathContext()).thenReturn(new MathContext(3, RoundingMode.HALF_EVEN));\n            return roundingHolder;\n        }\n    }\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nОстановимся на этом моменте поподробнее. Для сериализации и десериализации моделей в Jackson используется класс \u003Ca href=\"https:\u002F\u002Fstatic.javadoc.io\u002Fcom.fasterxml.jackson.core\u002Fjackson-databind\u002F2.9.8\u002Fcom\u002Ffasterxml\u002Fjackson\u002Fdatabind\u002FObjectMapper.html\"\u003EObjectMapper\u003C\u002Fa\u003E. Это именно тот объект контекста, который отвечает за преобразование моделей, следовательно, чтобы убедиться в том, как модель будет представлена, надо проверить как её обработает ObjectMapper из контекста.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nПри желании создать свой кастомный ObjectMapper, вы можете встретить следующий типичный пример: \u003Ci\u003EObjectMapper mapper = new ObjectMapper\u003C\u002Fi\u003E. Однако, посмотрим на то, как Spring Boot создаёт экземпляр этого класса по умолчанию. Для этого обратимся к исходному коду автоконфигурации \u003Ca href=\"https:\u002F\u002Fdocs.spring.io\u002Fspring-boot\u002Fdocs\u002Fcurrent\u002Fapi\u002Forg\u002Fspringframework\u002Fboot\u002Fautoconfigure\u002Fjackson\u002FJacksonAutoConfiguration.html\"\u003EJacksonAutoConfiguration\u003C\u002Fa\u003E, отвечающей за создание объекта:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E@Bean\npublic ObjectMapper jacksonObjectMapper(Jackson2ObjectMapperBuilder builder) {\n    return builder.createXmlMapper(false).build();\n}\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nИ если пойти ещё дальше и заглянуть в \u003Ci\u003Ebuild()\u003C\u002Fi\u003E, то обнаружим, что для работы сериализации, к которой мы могли привыкнуть при работе с дефолтным маппером (как например инъекция сервисов в кастомный сериализатор) мало просто создать Bean маппера, следует обратиться к предоставляемому билдеру. Кстати, в самой \u003Ca href=\"https:\u002F\u002Fdocs.spring.io\u002Fspring-boot\u002Fdocs\u002Fcurrent\u002Freference\u002Fhtml\u002Fhowto-spring-mvc.html#howto-customize-the-jackson-objectmapper\"\u003Eдокументации\u003C\u002Fa\u003E к Spring Boot это указано явно.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nОтступлением хотелось бы добавить отсылку к \u003Ca href=\"https:\u002F\u002Fdocs.spring.io\u002Fspring-boot\u002Fdocs\u002Fcurrent\u002Fapi\u002Forg\u002Fspringframework\u002Fboot\u002Ftest\u002Fjson\u002FJacksonTester.html\"\u003EJacksonTester\u003C\u002Fa\u003E. Как к представителю оболочки для BDD тестирования сериализации в контексте Mockito.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EПодведём итоги\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E Spring Boot предоставляет возможность кастомизировать сериализацию модели посредством аннотации JsonSerializer\u003C\u002Fli\u003E\r\n\u003Cli\u003E Для тестирования сериализации используйте маппер в той же конфигурации, что и в приложении\u003C\u002Fli\u003E\r\n\u003Cli\u003E При переопределении бина из автоконфигурации Spring Boot, обратите внимание на то, как этот бин создаёт сам Spring Boot, чтобы не упустить возможностей, которыми обладал дефолтный бин\u003C\u002Fli\u003E\r\n\u003Cli\u003E Для задания ограниченного контекста, необходимого для тестирования сериализации, можно воспользоваться аннотацией JsonTest\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2\u003EЗаключение\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\nСпасибо за внимание! Данный пример будет актуален как для текущей версии Spring Boot 2.1.x, так и для более ранних версий вплоть до 1.4.x. Также техника подойдёт для ситуаций с десериализацией модели. Смотрите под капот ваших основных фреймворков для лучшего понимания механизма работы приложения и ответственно подходите к тестированию.\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"java"},{"titleHtml":"spring boot"},{"titleHtml":"serialization"},{"titleHtml":"unit testing"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452188\u002F4af28e6ed6b3479c0d715d01e2fd6e12\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452188\u002F4af28e6ed6b3479c0d715d01e2fd6e12\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F452188\\\u002F\"},\"headline\":\"Модульное тестирование Json сериализации в Spring Boot\",\"datePublished\":\"2019-05-16T17:30:27+03:00\",\"dateModified\":\"2019-05-16T18:01:53+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Виктор Боровлёв\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Введение Одной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень а...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F452188\\\u002F#post-content-body\",\"about\":[\"h_java\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fwb\\\u002Fjv\\\u002Fd1\\\u002Fwbjvd1ajjlmxvobtph6_9p6sutk.png\"]}","metaDescription":"Введение\r\nОдной из основных задач каждого веб-сервиса является возврат модели на клиентскую сторону, и в этом случае Spring Boot предоставляет удобный уровень абстракции, позволяя разработчику...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"java"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
