<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Breaking UC Browser / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/en\/company\/drweb\/blog\/452076\/"},"headline":"Breaking UC Browser","datePublished":"2019-05-16T10:39:48+03:00","dateModified":"2019-05-17T13:02:52+03:00","author":{"@type":"Person","name":"doctorweb"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Introduction At the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it...","url":"https:\/\/habr.com\/en\/company\/drweb\/blog\/452076\/#post-content-body","about":["c_drweb","h_browsers","f_develop"],"image":["https:\/\/habrastorage.org\/webt\/ke\/e0\/rd\/kee0rdupth-kalljz9gfxpjndnk.jpeg","https:\/\/habrastorage.org\/webt\/j0\/i1\/c1\/j0i1c1n_nwf_gnauzbudnqor5oi.png","https:\/\/habrastorage.org\/webt\/go\/tj\/tz\/gotjtzkpg2owfmk8jrnznox_vdg.jpeg","https:\/\/habrastorage.org\/webt\/g5\/7k\/iv\/g57kivkwrysmcqvptmhclqzzipq.png","https:\/\/habrastorage.org\/webt\/6r\/lt\/ns\/6rltnsrtyd-_5ekwis68qn-vydc.png","https:\/\/habrastorage.org\/webt\/_k\/bz\/5c\/_kbz5cbedw6g1jnsj047rtqudli.jpeg","https:\/\/habrastorage.org\/webt\/2y\/xh\/vk\/2yxhvksp30f016gfyhrlfh0pklc.jpeg","https:\/\/habrastorage.org\/webt\/m6\/dp\/iw\/m6dpiwaonfuyri-jg8thppcfgqe.jpeg","https:\/\/habrastorage.org\/webt\/eq\/wp\/p3\/eqwpp3exmqnybi7r_tdvvan4jls.png","https:\/\/habrastorage.org\/webt\/bo\/9b\/rn\/bo9brnkfvauy3ntm2dnucnsxqhs.png","https:\/\/habrastorage.org\/webt\/nz\/95\/4x\/nz954xqtjmky6tnpaqeejhvecus.png","https:\/\/habrastorage.org\/webt\/52\/rf\/fx\/52rffxhzmtrfdhfrznsr8dovfim.png","https:\/\/habrastorage.org\/webt\/ct\/d9\/kv\/ctd9kvewm9l1blmw3pqipi8mnqm.png","https:\/\/habrastorage.org\/webt\/o7\/wi\/4-\/o7wi4-imrothkr6qpkbrklj40aw.png","https:\/\/habrastorage.org\/webt\/ev\/hb\/a8\/evhba8ty8dtnv8niuxyfue0nkfk.png","https:\/\/habrastorage.org\/webt\/lv\/mp\/oo\/lvmpoow5agndjnbbl-t3imyaisq.jpeg","https:\/\/habrastorage.org\/webt\/dk\/nn\/rw\/dknnrwaye18zzz0xipny0_gdqfq.png","https:\/\/habrastorage.org\/webt\/fn\/bw\/uz\/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg","https:\/\/habrastorage.org\/webt\/tm\/fq\/yo\/tmfqyogtdhbje0atjckosbrgide.jpeg","https:\/\/habrastorage.org\/webt\/xg\/jk\/l1\/xgjkl1uhzmibo-nhmha3kpivf5a.png","https:\/\/habrastorage.org\/webt\/7i\/fx\/86\/7ifx86mr4yph41jsxukpjqvxmfa.png","https:\/\/habrastorage.org\/webt\/fa\/62\/6j\/fa626jaylcaaewtslff_-byaseo.jpeg","https:\/\/habrastorage.org\/webt\/co\/rk\/s1\/corks1o2dp75elfvdsxjimrohuo.png","https:\/\/habrastorage.org\/webt\/36\/uu\/xn\/36uuxnabf3xesptr8qisxzzfutk.jpeg","https:\/\/habrastorage.org\/webt\/-d\/pt\/3a\/-dpt3akb_yckinmdheczkktzlem.jpeg","https:\/\/habrastorage.org\/webt\/rn\/_1\/i4\/rn_1i4avl8oki83hslk5u19ygoe.jpeg","https:\/\/habrastorage.org\/webt\/hy\/lk\/qr\/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg","https:\/\/habrastorage.org\/webt\/68\/ss\/kf\/68sskfcymjorl_flpf8mg9wwej4.png","https:\/\/habrastorage.org\/webt\/d1\/yt\/iz\/d1ytiz_jx7byflntqxxec2nece0.jpeg","https:\/\/habrastorage.org\/webt\/me\/vy\/kz\/mevykztpkcwdr6xkpnenauxqccs.jpeg","https:\/\/habrastorage.org\/webt\/9k\/m7\/un\/9km7unymy_ybx1lwnflfbqd36ke.png","https:\/\/habrastorage.org\/webt\/e2\/-v\/ua\/e2-vuahng86h0bt0vm84f3xhqrg.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Breaking UC Browser" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Breaking UC Browser" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Breaking UC Browser" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Introduction
At the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Introduction
At the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Introduction
At the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Introduction
At the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Introduction
At the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/452076/7bcd7451e10f6276c67c858c7a79d2d8/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/452076/7bcd7451e10f6276c67c858c7a79d2d8/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/452076/7bcd7451e10f6276c67c858c7a79d2d8/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/452076/7bcd7451e10f6276c67c858c7a79d2d8/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/452076/7bcd7451e10f6276c67c858c7a79d2d8/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="452076" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-16T07:39:48.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="en_US" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/452076/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/en/company/drweb/blog/452076/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/452076/7bcd7451e10f6276c67c858c7a79d2d8/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" companyName="drweb" data-async-called="true" class="tm-page"><div class="tm-page-width"><div class="tm-page__header"><!----></div> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"><div class="tm-company-card tm-company-article__company-card"><div class="tm-company-card__info"><div class="tm-company-card__header"><a href="/ru/company/drweb/profile/" class="tm-company-card__avatar"><div class="tm-entity-image"><img alt="" height="48" src="//habrastorage.org/getpro/habr/company/002/8a7/c16/0028a7c16cc021fea7f86c13e082f507.gif" width="48" class="tm-entity-image__pic"></div></a> <!----> <div class="tm-rating tm-company-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">53.82</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div> <div class="tm-company-card__info"><a href="/ru/company/drweb/profile/" class="tm-company-card__name">
        Доктор Веб
      </a> <div class="tm-company-card__description"></div></div></div> <div class="tm-company-card__buttons"><!----> <!----></div></div> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/doctorweb/" title="doctorweb" class="tm-user-info__userpic"><div class="tm-entity-image"><img alt="" height="24" loading="lazy" src="//habrastorage.org/r/w32/getpro/habr/avatars/3c5/026/15b/3c502615b845bc7d9a930778c9e7f1da.jpg" width="24" class="tm-entity-image__pic"></div></a> <span class="tm-user-info__user"><a href="/ru/users/doctorweb/" class="tm-user-info__username">
      doctorweb
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-16T07:39:48.000Z" title="2019-05-16, 10:39">16  мая  2019 в 10:39</time></span></div> <!----></div> <h1 lang="en" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Breaking UC Browser</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/company/drweb/blog/" class="tm-article-snippet__hubs-item-link router-link-active"><span>Блог компании Доктор Веб</span> <!----></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/browsers/" class="tm-article-snippet__hubs-item-link"><span>Браузеры</span> <!----></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="en" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><img src="https://habrastorage.org/r/w780q1/webt/ke/e0/rd/kee0rdupth-kalljz9gfxpjndnk.jpeg" data-src="https://habrastorage.org/webt/ke/e0/rd/kee0rdupth-kalljz9gfxpjndnk.jpeg" data-blurred="true"/><br/>
<br/>
<h3>Introduction</h3><br/>
At the end of March we <a href="https://news.drweb.ru/show/?i=13176">reported</a> on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use it.<br/>
<br/>
Some time ago, UC Browser was promoted and distributed quite aggressively. It was installed on devices by malware, distributed via websites under the guise of video files (i.e., users thought they were downloading pornography or something, but instead were getting APK files with this browser), advertised using worrisome banners about a user’s browser being outdated or vulnerable. The official UC Browser VK group had a <a href="https://vk.com/topic-27170131_31448404?offset=0">topic</a> where users could complain about false advertising and many users provided examples. In 2016, there was even a <a href="https://www.youtube.com/watch?v=VRFOl7k5axc">commercial</a> in Russian (yes, a commercial of a browser that blocks commercials).<br/>
<br/>
As we write this article, UC Browser was installed 500,000,000 times from Google Play. This is impressive since only Google Chrome managed to top that. Among the reviews, you can see a lot of user complaints about advertising and being redirected to other applications on Google Play. This was the reason for our study: we wanted to see if UC Browser is doing something wrong. And it is! The application is able to download and run executable code, which <a href="https://play.google.com/about/privacy-security-deception/malicious-behavior/">violates Google Play’s policy for app publishing </a>. And UC Browser doesn’t only download executable code; it does this unsafely, which can be used for a MitM attack. Let's see if we can use it this way.<br/>
<a name="habracut"></a><br/>
Everything that follows applies to the version of UC Browser that was distributed via Google Play at the time of our study:<br/>
<br/>
<pre><code class="plaintext">package: com.UCMobile.intl
versionName: 12.10.8.1172
versionCode: 10598
sha1 APK-file: f5edb2243413c777172f6362876041eb0c3a928c</code></pre><br/>
<h3>Attack Vector</h3><br/>
UC Browser’s manifest contains a service with a telltale name of <i>com.uc.deployment.UpgradeDeployService</i>.<br/>
<br/>
<pre><code class="plaintext">    &lt;service android:exported="false" android:name="com.uc.deployment.UpgradeDeployService" android:process=":deploy" />
</code></pre><br/>
When this service launches, the browser makes a POST request to <a href="http://puds.ucweb.com/upgrade/index.xhtml">puds.ucweb.com/upgrade/index.xhtml</a> that can be seen in traffic for some time after the launch. In response, the browser may receive a command to download any update or a new module. During our analysis, we never received such commands from the server, but we noticed that when trying to open a PDF file in the browser, it repeats the request to the above address, then downloads a native library. To simulate an attack, we decided to use this feature of UC Browser—the ability to open PDF files using a native library — not present in the APK file, but downloadable from the Internet. Technically, UC Browser can download something without a user’s permission when given an appropriate response to a request sent upon startup. But for this we need to study the interaction protocol with the server in more detail, so we thought it was easier to just hook and edit the response and then replace the library needed to open PDF files with something different.<br/>
<br/>
So when a user wants to open a PDF file directly in the browser, traffic may contain the following requests:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/j0/i1/c1/j0i1c1n_nwf_gnauzbudnqor5oi.png"/><br/>
<br/>
First, there is a POST request to <a href="http://puds.ucweb.com/upgrade/index.xhtml">puds.ucweb.com/upgrade/index.xhtml</a>, then the compressed library for viewing PDF files and office documents is downloaded. Logically, we can assume that the first request sends information about the system (at least the architecture, because the server needs to select an appropriate library), and the server responds with some information about the library that needs to be downloaded, like its address and maybe something else. The problem is that this request is encrypted.<br/>
<br/>
<div class="scrollable-table"><table>
<tr>
<td> Request fragment<br/>
<br/>
</td>
<td> Response fragment<br/>
<br/>
</td>
</tr>
<tr>
<td><img src="https://habrastorage.org/r/w780q1/webt/go/tj/tz/gotjtzkpg2owfmk8jrnznox_vdg.jpeg" data-src="https://habrastorage.org/webt/go/tj/tz/gotjtzkpg2owfmk8jrnznox_vdg.jpeg" data-blurred="true"/><br/>
<br/>
</td>
<td><img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/g5/7k/iv/g57kivkwrysmcqvptmhclqzzipq.png"/><br/>
<br/>
</td>
</tr>
</table></div><br/>
The library is compressed in a ZIP file and not encrypted.<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/6r/lt/ns/6rltnsrtyd-_5ekwis68qn-vydc.png"/><br/>
<br/>
<h3>Searching for traffic decryption code</h3><br/>
Let’s try and decrypt the server’s response. Take a look at the code of the <i>com.uc.deployment.UpgradeDeployService class</i>: from the <i>onStartCommand method</i>, we navigate to <i>com.uc.deployment.b.x</i>, and then to <i>com.uc.browser.core.d.c.f.e</i>:<br/>
<br/>
<pre><code class="java">    public final void e(l arg9) {
        int v4_5;
        String v3_1;
        byte[] v3;
        byte[] v1 = null;
        if(arg9 == null) {
            v3 = v1;
        }
        else {
            v3_1 = arg9.iGX.ipR;
            StringBuilder v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]product:");
            v4.append(arg9.iGX.ipR);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]version:");
            v4.append(arg9.iGX.iEn);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]upgrade_type:");
            v4.append(arg9.iGX.mMode);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]force_flag:");
            v4.append(arg9.iGX.iEo);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]silent_mode:");
            v4.append(arg9.iGX.iDQ);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]silent_type:");
            v4.append(arg9.iGX.iEr);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]silent_state:");
            v4.append(arg9.iGX.iEp);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]silent_file:");
            v4.append(arg9.iGX.iEq);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]apk_md5:");
            v4.append(arg9.iGX.iEl);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]download_type:");
            v4.append(arg9.mDownloadType);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]download_group:");
            v4.append(arg9.mDownloadGroup);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]download_path:");
            v4.append(arg9.iGH);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]apollo_child_version:");
            v4.append(arg9.iGX.iEx);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]apollo_series:");
            v4.append(arg9.iGX.iEw);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]apollo_cpu_arch:");
            v4.append(arg9.iGX.iEt);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]apollo_cpu_vfp3:");
            v4.append(arg9.iGX.iEv);
            v4 = new StringBuilder("[");
            v4.append(v3_1);
            v4.append("]apollo_cpu_vfp:");
            v4.append(arg9.iGX.iEu);
            ArrayList v3_2 = arg9.iGX.iEz;
            if(v3_2 != null &amp;&amp; v3_2.size() != 0) {
                Iterator v3_3 = v3_2.iterator();
                while(v3_3.hasNext()) {
                    Object v4_1 = v3_3.next();
                    StringBuilder v5 = new StringBuilder("[");
                    v5.append(((au)v4_1).getName());
                    v5.append("]component_name:");
                    v5.append(((au)v4_1).getName());
                    v5 = new StringBuilder("[");
                    v5.append(((au)v4_1).getName());
                    v5.append("]component_ver_name:");
                    v5.append(((au)v4_1).aDA());
                    v5 = new StringBuilder("[");
                    v5.append(((au)v4_1).getName());
                    v5.append("]component_ver_code:");
                    v5.append(((au)v4_1).gBl);
                    v5 = new StringBuilder("[");
                    v5.append(((au)v4_1).getName());
                    v5.append("]component_req_type:");
                    v5.append(((au)v4_1).gBq);
                }
            }
 
            j v3_4 = new j();
            m.b(v3_4);
            h v4_2 = new h();
            m.b(v4_2);
            ay v5_1 = new ay();
            v3_4.hS("");
            v3_4.setImsi("");
            v3_4.hV("");
            v5_1.bPQ = v3_4;
            v5_1.bPP = v4_2;
            v5_1.yr(arg9.iGX.ipR);
            v5_1.gBF = arg9.iGX.mMode;
            v5_1.gBI = arg9.iGX.iEz;
            v3_2 = v5_1.gAr;
            c.aBh();
            v3_2.add(g.fs("os_ver", c.getRomInfo()));
            v3_2.add(g.fs("processor_arch", com.uc.b.a.a.c.getCpuArch()));
            v3_2.add(g.fs("cpu_arch", com.uc.b.a.a.c.Pb()));
            String v4_3 = com.uc.b.a.a.c.Pd();
            v3_2.add(g.fs("cpu_vfp", v4_3));
            v3_2.add(g.fs("net_type", String.valueOf(com.uc.base.system.a.Jo())));
            v3_2.add(g.fs("fromhost", arg9.iGX.iEm));
            v3_2.add(g.fs("plugin_ver", arg9.iGX.iEn));
            v3_2.add(g.fs("target_lang", arg9.iGX.iEs));
            v3_2.add(g.fs("vitamio_cpu_arch", arg9.iGX.iEt));
            v3_2.add(g.fs("vitamio_vfp", arg9.iGX.iEu));
            v3_2.add(g.fs("vitamio_vfp3", arg9.iGX.iEv));
            v3_2.add(g.fs("plugin_child_ver", arg9.iGX.iEx));
            v3_2.add(g.fs("ver_series", arg9.iGX.iEw));
            v3_2.add(g.fs("child_ver", r.aVw()));
            v3_2.add(g.fs("cur_ver_md5", arg9.iGX.iEl));
            v3_2.add(g.fs("cur_ver_signature", SystemHelper.getUCMSignature()));
            v3_2.add(g.fs("upgrade_log", i.bjt()));
            v3_2.add(g.fs("silent_install", String.valueOf(arg9.iGX.iDQ)));
            v3_2.add(g.fs("silent_state", String.valueOf(arg9.iGX.iEp)));
            v3_2.add(g.fs("silent_file", arg9.iGX.iEq));
            v3_2.add(g.fs("silent_type", String.valueOf(arg9.iGX.iEr)));
            v3_2.add(g.fs("cpu_archit", com.uc.b.a.a.c.Pc()));
            v3_2.add(g.fs("cpu_set", SystemHelper.getCpuInstruction()));
            boolean v4_4 = v4_3 == null || !v4_3.contains("neon") ? false : true;
            v3_2.add(g.fs("neon", String.valueOf(v4_4)));
            v3_2.add(g.fs("cpu_cores", String.valueOf(com.uc.b.a.a.c.Jl())));
            v3_2.add(g.fs("ram_1", String.valueOf(com.uc.b.a.a.h.Po())));
            v3_2.add(g.fs("totalram", String.valueOf(com.uc.b.a.a.h.OL())));
            c.aBh();
            v3_2.add(g.fs("rom_1", c.getRomInfo()));
            v4_5 = e.getScreenWidth();
            int v6 = e.getScreenHeight();
            StringBuilder v7 = new StringBuilder();
            v7.append(v4_5);
            v7.append("*");
            v7.append(v6);
            v3_2.add(g.fs("ss", v7.toString()));
            v3_2.add(g.fs("api_level", String.valueOf(Build$VERSION.SDK_INT)));
            v3_2.add(g.fs("uc_apk_list", SystemHelper.getUCMobileApks()));
            Iterator v4_6 = arg9.iGX.iEA.entrySet().iterator();
            while(v4_6.hasNext()) {
                Object v6_1 = v4_6.next();
                v3_2.add(g.fs(((Map$Entry)v6_1).getKey(), ((Map$Entry)v6_1).getValue()));
            }
 
            v3 = v5_1.toByteArray();
        }
 
        if(v3 == null) {
            this.iGY.iGI.a(arg9, "up_encode", "yes", "fail");
            return;
        }
 
        v4_5 = this.iGY.iGw ? 0x1F : 0;
        if(v3 == null) {
        }
        else {
            v3 = g.i(v4_5, v3);
            if(v3 == null) {
            }
            else {
                v1 = new byte[v3.length + 16];
                byte[] v6_2 = new byte[16];
                Arrays.fill(v6_2, 0);
                v6_2[0] = 0x5F;
                v6_2[1] = 0;
                v6_2[2] = ((byte)v4_5);
                v6_2[3] = -50;
                System.arraycopy(v6_2, 0, v1, 0, 16);
                System.arraycopy(v3, 0, v1, 16, v3.length);
            }
        }
 
        if(v1 == null) {
            this.iGY.iGI.a(arg9, "up_encrypt", "yes", "fail");
            return;
        }
 
        if(TextUtils.isEmpty(this.iGY.mUpgradeUrl)) {
            this.iGY.iGI.a(arg9, "up_url", "yes", "fail");
            return;
        }
 
        StringBuilder v0 = new StringBuilder("[");
        v0.append(arg9.iGX.ipR);
        v0.append("]url:");
        v0.append(this.iGY.mUpgradeUrl);
        com.uc.browser.core.d.c.i v0_1 = this.iGY.iGI;
        v3_1 = this.iGY.mUpgradeUrl;
        com.uc.base.net.e v0_2 = new com.uc.base.net.e(new com.uc.browser.core.d.c.i$a(v0_1, arg9));
        v3_1 = v3_1.contains("?") ? v3_1 + "&amp;dataver=pb" : v3_1 + "?dataver=pb";
        n v3_5 = v0_2.uc(v3_1);
        m.b(v3_5, false);
        v3_5.setMethod("POST");
        v3_5.setBodyProvider(v1);
        v0_2.b(v3_5);
        this.iGY.iGI.a(arg9, "up_null", "yes", "success");
        this.iGY.iGI.b(arg9);
    }</code></pre><br/>
We can see this is where the POST request is made. Have a look at the 16-byte array that contains: 0x5F, 0, 0x1F, -50 (=0xCE). Values are the same as in the above request.<br/>
<br/>
The same class contains a nested class with another interesting method:<br/>
<br/>
<pre><code class="java">        public final void a(l arg10, byte[] arg11) {
            f v0 = this.iGQ;
            StringBuilder v1 = new StringBuilder("[");
            v1.append(arg10.iGX.ipR);
            v1.append("]:UpgradeSuccess");
            byte[] v1_1 = null;
            if(arg11 == null) {
            }
            else if(arg11.length &lt; 16) {
            }
            else {
                if(arg11[0] != 0x60 &amp;&amp; arg11[3] != 0xFFFFFFD0) {
                    goto label_57;
                }
                int v3 = 1;
                int v5 = arg11[1] == 1 ? 1 : 0;
                if(arg11[2] != 1 &amp;&amp; arg11[2] != 11) {
                    if(arg11[2] == 0x1F) {
                    }
                    else {
                        v3 = 0;
                    }
                }
                byte[] v7 = new byte[arg11.length - 16];
                System.arraycopy(arg11, 16, v7, 0, v7.length);
                if(v3 != 0) {
                    v7 = g.j(arg11[2], v7);
                }
                if(v7 == null) {
                    goto label_57;
                }
                if(v5 != 0) {
                    v1_1 = g.P(v7);
                    goto label_57;
                }
                v1_1 = v7;
            }
        label_57:
            if(v1_1 == null) {
                v0.iGY.iGI.a(arg10, "up_decrypt", "yes", "fail");
                return;
            }
            q v11 = g.b(arg10, v1_1);
            if(v11 == null) {
                v0.iGY.iGI.a(arg10, "up_decode", "yes", "fail");
                return;
            }
            if(v0.iGY.iGt) {
                v0.d(arg10);
            }
            if(v0.iGY.iGo != null) {
                v0.iGY.iGo.a(0, ((o)v11));
            }
            if(v0.iGY.iGs) {
                v0.iGY.a(((o)v11));
                v0.iGY.iGI.a(v11, "up_silent", "yes", "success");
                v0.iGY.iGI.a(v11);
                return;
            }
            v0.iGY.iGI.a(v11, "up_silent", "no", "success");
        }
    }</code></pre><br/>
This method receives an input of a bytes array and checks whether the zero byte is 0x60, or the third byte is 0xD0 and if the second byte is 1, 11, or 0x1F. Check out the server response: zero byte is 0x60, the second byte is 0x1F, the third byte is 0x60. It looks like what we need. Judging by the strings («up_decrypt», for example), a method is supposed to be called here to decrypt the server response. Now let’s look at the g.j method. Note that the first argument is a byte at offset 2 (that is, 0x1F in our case), and the second is the server response without the first 16 bytes.<br/>
<br/>
<pre><code class="java">     public static byte[] j(int arg1, byte[] arg2) {
        if(arg1 == 1) {
            arg2 = c.c(arg2, c.adu);
        }
        else if(arg1 == 11) {
            arg2 = m.aF(arg2);
        }
        else if(arg1 != 0x1F) {
        }
        else {
            arg2 = EncryptHelper.decrypt(arg2);
        }
        return arg2;
    }</code></pre><br/>
Obviously, it is selecting the decryption algorithm, and the byte that in our case equals 0x1F indicates one of three possible options.<br/>
<br/>
Let’s go back to the code analysis. After a couple of jumps, we get to the method with the telltale name, <i>decryptBytesByKey</i>. Now, two more bytes are separated from our response and form a string. It’s clear this is how the key is selected to decrypt the message.<br/>
<br/>
<pre><code class="java">    private static byte[] decryptBytesByKey(byte[] bytes) {
        byte[] v0 = null;
        if(bytes != null) {
            try {
                if(bytes.length &lt; EncryptHelper.PREFIX_BYTES_SIZE) {
                }
                else if(bytes.length == EncryptHelper.PREFIX_BYTES_SIZE) {
                    return v0;
                }
                else {
                    byte[] prefix = new byte[EncryptHelper.PREFIX_BYTES_SIZE];  // 2 байта
                    System.arraycopy(bytes, 0, prefix, 0, prefix.length);
                    String keyId = c.ayR().d(ByteBuffer.wrap(prefix).getShort()); // Выбор ключа
                    if(keyId == null) {
                        return v0;
                    }
                    else {
                        a v2 = EncryptHelper.ayL();
                        if(v2 == null) {
                            return v0;
                        }
                        else {
                            byte[] enrypted = new byte[bytes.length - EncryptHelper.PREFIX_BYTES_SIZE];
                            System.arraycopy(bytes, EncryptHelper.PREFIX_BYTES_SIZE, enrypted, 0, enrypted.length);
                            return v2.l(keyId, enrypted);
                        }
                    }
                }
            }
            catch(SecException v7_1) {
                EncryptHelper.handleDecryptException(((Throwable)v7_1), v7_1.getErrorCode());
                return v0;
            }
            catch(Throwable v7) {
                EncryptHelper.handleDecryptException(v7, 2);
                return v0;
            }
        }
 
        return v0;
    }</code></pre><br/>
Jumping ahead a bit, note that at this stage, it’s only the key identifier, not the key itself. Key selection is going to be a little more complicated.<br/>
<br/>
In the next method, two more parameters are added to the existing ones, so we get a total of four. The magic number 16, the key identifier, the encrypted data, and a string is added there for some reason (empty in our case).<br/>
<br/>
<pre><code class="java">    public final byte[] l(String keyId, byte[] encrypted) throws SecException {
        return this.ayJ().staticBinarySafeDecryptNoB64(16, keyId, encrypted, "");
    }</code></pre><br/>
After a series of jumps, we see the <i>staticBinarySafeDecryptNoB64</i> method of the <i>com.alibaba.wireless.security.open.staticdataencrypt.IStaticDataEncryptComponent</i> interface. The main application code has no classes that implement this interface. This class is contained in the file <b><i>lib/armeabi-v7a/libsgmain.so</i></b>, which is not really .SO, but rather .JAR. The method we are interested in is implemented as follows:<br/>
<br/>
<pre><code class="java">package com.alibaba.wireless.security.a.i;
 
// ...
 
public class a implements IStaticDataEncryptComponent {
    private ISecurityGuardPlugin a;
// ...
    private byte[] a(int mode, int magicInt, int xzInt, String keyId, byte[] encrypted, String magicString) {
        return this.a.getRouter().doCommand(10601, new Object[]{Integer.valueOf(mode), Integer.valueOf(magicInt), Integer.valueOf(xzInt), keyId, encrypted, magicString});
    }
// ...
    private byte[] b(int magicInt, String keyId, byte[] encrypted, String magicString) {
        return this.a(2, magicInt, 0, keyId, encrypted, magicString);
    }
// ...
    public byte[] staticBinarySafeDecryptNoB64(int magicInt, String keyId, byte[] encrypted, String magicString) throws SecException {
        if(keyId != null &amp;&amp; keyId.length() > 0 &amp;&amp; magicInt >= 0 &amp;&amp; magicInt &lt; 19 &amp;&amp; encrypted != null &amp;&amp; encrypted.length > 0) {
            return this.b(magicInt, keyId, encrypted, magicString);
        }
 
        throw new SecException("", 301);
    }
//...
}</code></pre><br/>
Here, our parameter list is supplemented with two more integers: 2 and 0. Apparently, 2 means decryption, as in the <i>doFinal method</i> of the <i>javax.crypto.Cipher system</i> class. Then, this information is transmitted to a certain Router along with the number 10601, which is apparently the command number.<br/>
<br/>
After the next chain of jumps, we find a class that implements the <i>RouterComponent</i> interface and the <i>doCommand</i> method:<br/>
<br/>
<pre><code class="java">package com.alibaba.wireless.security.mainplugin;

import com.alibaba.wireless.security.framework.IRouterComponent;
import com.taobao.wireless.security.adapter.JNICLibrary;
 
public class a implements IRouterComponent {
    public a() {
        super();
    }
    public Object doCommand(int arg2, Object[] arg3) {
        return JNICLibrary.doCommandNative(arg2, arg3);
    }
}</code></pre><br/>
There is also the <i>JNICLibrary</i> class, where the native <i>doCommandNative</i> method is declared:<br/>
<br/>
<pre><code class="java">package com.taobao.wireless.security.adapter;
 
public class JNICLibrary {
    public static native Object doCommandNative(int arg0, Object[] arg1);
}</code></pre><br/>
So, we need to find the <i>doCommandNative</i> method in the native code. That’s where the fun begins.<br/>
<br/>
<h3>Machine code obfuscation</h3><br/>
There is one native library in the <i>libsgmain.so</i> file (which is actually a .JAR file and, like we said above, implements some encryption related interfaces): <i><b>libsgmainso-6.4.36.so</b></i>. We load it in IDA and get a bunch of dialogs with error messages. The problem is that the section header table is invalid. This is done on purpose to complicate the analysis.<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/_k/bz/5c/_kbz5cbedw6g1jnsj047rtqudli.jpeg" data-src="https://habrastorage.org/webt/_k/bz/5c/_kbz5cbedw6g1jnsj047rtqudli.jpeg" data-blurred="true"/><br/>
<br/>
But we don’t really need it anyway. The program header table is enough to correctly load the ELF file and analyze it. So we simply delete the section header table, nulling the corresponding fields in the header.<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/2y/xh/vk/2yxhvksp30f016gfyhrlfh0pklc.jpeg" data-src="https://habrastorage.org/webt/2y/xh/vk/2yxhvksp30f016gfyhrlfh0pklc.jpeg" data-blurred="true"/><br/>
<br/>
Then we open the file in IDA again.<br/>
<br/>
We have two ways to tell the Java virtual machine exactly where the native library contains the implementation of the method declared as native in the Java code. The first is to give it a name like this: <i>Java_package_name_ClassName_methodName</i>. The second one is to register it when loading the library (in the JNI_OnLoad function) by calling the RegisterNatives function. In our case, if you use the first method, the name should be like this: <i>Java_com_taobao_wireless_security_adapter_JNICLibrary_doCommandNative</i>. The list of exported functions doesn’t contain this name, which means we need to look for the RegisterNatives. Thus, we go to the JNI_OnLoad function and see the following:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/m6/dp/iw/m6dpiwaonfuyri-jg8thppcfgqe.jpeg" data-src="https://habrastorage.org/webt/m6/dp/iw/m6dpiwaonfuyri-jg8thppcfgqe.jpeg" data-blurred="true"/><br/>
<br/>
What’s going on here? At first glance, the beginning and end of the function are typical of the ARM architecture. The first instruction pushes the contents of the registers that the function will use to the stack (in this case, R0, R1, and R2), as well as the contents of the LR register with the function’s return address. The last instruction restores the saved registers and puts the return address to the PC register, thus returning from the function. But if we take a closer look, we may notice that the penultimate instruction changes the return address, stored on the stack. Let’s calculate what it will be when the code is executed. The address 0xB130 loads in R1, has 5 subtracted from it, then is moved to R0 and receives an addition of 0x10. In the end, it equals 0xB13B. Thus, IDA thinks that the final instruction performs a normal function return, while in fact, it performs a transfer to the calculated address 0xB13B.<br/>
<br/>
Now let us remind you that ARM processors have two modes and two sets of instructions — ARM and Thumb. The low-order bit of the address determines which instruction set the processor will use That is, the address is actually 0xB13A, while the value in the low-order bit indicates the Thumb mode.<br/>
A similar “adapter” and some semantic garbage are added to the beginning of each function in this library. But we won’t dwell on them in detail. Just remember that the real beginning of almost all functions is a little further.<br/>
<br/>
Since no explicit transition to 0xB13A in the code exists, IDA cannot recognize that there is code there. For the same reason, it does not recognize most of the code in the library as code, which makes analyzing a bit trickier. So, we tell IDA that there is code, and this is what happens:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/eq/wp/p3/eqwpp3exmqnybi7r_tdvvan4jls.png"/><br/>
<br/>
Starting from 0xB144, we clearly have the table. But what about sub_494C?<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/bo/9b/rn/bo9brnkfvauy3ntm2dnucnsxqhs.png"/><br/>
<br/>
When calling this function in the LR register, we get the address of the above-mentioned table (0xB144). R0 contains the index in this table. That is, we take the value from the table, add it to LR, and obtain the address we need to go to. Let's try to calculate it: 0xB144 + [0xB144 + 8 * 4] = 0xB144 + 0x120 = 0xB264. We navigate to this address and see a couple of useful instructions, then go to 0xB140:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/nz/95/4x/nz954xqtjmky6tnpaqeejhvecus.png"/><br/>
<br/>
Now there will be a transition at offset with the index 0x20 from the table.<br/>
Judging by the size of the table, there will be many such transitions in the code. So we would want to deal with this automatically and avoid manually calculating addresses. Thus, scripts and the ability to patch code in IDA come to our rescue:<br/>
<br/>
<pre><code class="python">def put_unconditional_branch(source, destination):
    offset = (destination - source - 4) >> 1
    if offset > 2097151 or offset &lt; -2097152:
        raise RuntimeError("Invalid offset")
    if offset > 1023 or offset &lt; -1024:
        instruction1 = 0xf000 | ((offset >> 11) &amp; 0x7ff)
        instruction2 = 0xb800 | (offset &amp; 0x7ff)
        patch_word(source, instruction1)
        patch_word(source + 2, instruction2)
    else:
        instruction = 0xe000 | (offset &amp; 0x7ff)
        patch_word(source, instruction)
 
ea = here()
if get_wide_word(ea) == 0xb503: #PUSH {R0,R1,LR}
    ea1 = ea + 2
    if get_wide_word(ea1) == 0xbf00: #NOP
        ea1 += 2
    if get_operand_type(ea1, 0) == 1 and get_operand_value(ea1, 0) == 0 and get_operand_type(ea1, 1) == 2:
        index = get_wide_dword(get_operand_value(ea1, 1))
        print "index =", hex(index)
        ea1 += 2
        if get_operand_type(ea1, 0) == 7:
            table = get_operand_value(ea1, 0) + 4
        elif get_operand_type(ea1, 1) == 2:
            table = get_operand_value(ea1, 1) + 4
        else:
            print "Wrong operand type on", hex(ea1), "-", get_operand_type(ea1, 0), get_operand_type(ea1, 1)
            table = None
        if table is None:
            print "Unable to find table"
        else:
            print "table =", hex(table)
            offset = get_wide_dword(table + (index &lt;&lt; 2))
            put_unconditional_branch(ea, table + offset)
    else:
        print "Unknown code", get_operand_type(ea1, 0), get_operand_value(ea1, 0), get_operand_type(ea1, 1) == 2
else:
    print "Unable to detect first instruction"</code></pre><br/>
We put the cursor on the 0xB26A string, run the script, and see the transition to 0xB4B0:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/52/rf/fx/52rffxhzmtrfdhfrznsr8dovfim.png"/><br/>
<br/>
Again, IDA does not recognize this place as code. We help it and see another structure there:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/ct/d9/kv/ctd9kvewm9l1blmw3pqipi8mnqm.png"/><br/>
<br/>
Instructions that go after BLX do not appear very meaningful; they are more like some kind of offset. We look at sub_4964:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/o7/wi/4-/o7wi4-imrothkr6qpkbrklj40aw.png"/><br/>
<br/>
Indeed, it takes DWORD at the address from LR, adds it to this address, then takes the value at the resulting address and stores it in the stack. Additionally, it adds 4 to LR to jump this same offset after returning from the function. Then the POP {R1} command takes the resulting value from the stack. Looking at what is located at the address 0xB4BA + 0xEA = 0xB5A4, we can see something similar to the address table:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/ev/hb/a8/evhba8ty8dtnv8niuxyfue0nkfk.png"/><br/>
<br/>
To patch this structure, we need to get two parameters from the code: the offset and the register number where we want to push the result. We will have to prepare a piece of code in advance for each possible register.<br/>
<br/>
<pre><code class="python">patches = {}
patches[0] = (0x00, 0xbf, 0x01, 0x48, 0x00, 0x68, 0x02, 0xe0)
patches[1] = (0x00, 0xbf, 0x01, 0x49, 0x09, 0x68, 0x02, 0xe0)
patches[2] = (0x00, 0xbf, 0x01, 0x4a, 0x12, 0x68, 0x02, 0xe0)
patches[3] = (0x00, 0xbf, 0x01, 0x4b, 0x1b, 0x68, 0x02, 0xe0)
patches[4] = (0x00, 0xbf, 0x01, 0x4c, 0x24, 0x68, 0x02, 0xe0)
patches[5] = (0x00, 0xbf, 0x01, 0x4d, 0x2d, 0x68, 0x02, 0xe0)
patches[8] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0x80, 0xd8, 0xf8, 0x00, 0x80, 0x01, 0xe0)
patches[9] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0x90, 0xd9, 0xf8, 0x00, 0x90, 0x01, 0xe0)
patches[10] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0xa0, 0xda, 0xf8, 0x00, 0xa0, 0x01, 0xe0)
patches[11] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0xb0, 0xdb, 0xf8, 0x00, 0xb0, 0x01, 0xe0)
 
ea = here()
if (get_wide_word(ea) == 0xb082 #SUB SP, SP, #8
        and get_wide_word(ea + 2) == 0xb503): #PUSH {R0,R1,LR}
    if get_operand_type(ea + 4, 0) == 7:
        pop = get_bytes(ea + 12, 4, 0)
        if pop[1] == '\xbc':
            register = -1
            r = get_wide_byte(ea + 12)
            for i in range(8):
                if r == (1 &lt;&lt; i):
                    register = i
                    break
            if register == -1:
                print "Unable to detect register"
            else:
                address = get_wide_dword(ea + 8) + ea + 8
                for b in patches[register]:
                    patch_byte(ea, b)
                    ea += 1
                if ea % 4 != 0:
                    ea += 2
                patch_dword(ea, address)
        elif pop[:3] == '\x5d\xf8\x04':
            register = ord(pop[3]) >> 4
            if register in patches:
                address = get_wide_dword(ea + 8) + ea + 8
                for b in patches[register]:
                    patch_byte(ea, b)
                    ea += 1
                patch_dword(ea, address)
        else:
            print "POP instruction not found"
    else:
        print "Wrong operand type on +4:", get_operand_type(ea + 4, 0)
else:
    print "Unable to detect first instructions"</code></pre><br/>
We put the cursor at the beginning of the structure we want to replace (i.e. 0xB4B2) and run the script:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/lv/mp/oo/lvmpoow5agndjnbbl-t3imyaisq.jpeg" data-src="https://habrastorage.org/webt/lv/mp/oo/lvmpoow5agndjnbbl-t3imyaisq.jpeg" data-blurred="true"/><br/>
<br/>
In addition to the already mentioned structures, the code includes the following:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/dk/nn/rw/dknnrwaye18zzz0xipny0_gdqfq.png"/><br/>
<br/>
As in the previous case, there is an offset after the BLX instruction:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/fn/bw/uz/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg" data-src="https://habrastorage.org/webt/fn/bw/uz/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg" data-blurred="true"/><br/>
<br/>
We take the offset at the address from LR, add it to LR, and navigate there. 0x72044 + 0xC = 0x72050. The script for this structure is quite simple:<br/>
<br/>
<pre><code class="python">def put_unconditional_branch(source, destination):
    offset = (destination - source - 4) >> 1
    if offset > 2097151 or offset &lt; -2097152:
        raise RuntimeError("Invalid offset")
    if offset > 1023 or offset &lt; -1024:
        instruction1 = 0xf000 | ((offset >> 11) &amp; 0x7ff)
        instruction2 = 0xb800 | (offset &amp; 0x7ff)
        patch_word(source, instruction1)
        patch_word(source + 2, instruction2)
    else:
        instruction = 0xe000 | (offset &amp; 0x7ff)
        patch_word(source, instruction)
 
 
ea = here()
if get_wide_word(ea) == 0xb503: #PUSH {R0,R1,LR}
    ea1 = ea + 6
    if get_wide_word(ea + 2) == 0xbf00: #NOP
        ea1 += 2
    offset = get_wide_dword(ea1)
    put_unconditional_branch(ea, (ea1 + offset) &amp; 0xffffffff)
else:
    print "Unable to detect first instruction"</code></pre><br/>
The result of executing the script:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/tm/fq/yo/tmfqyogtdhbje0atjckosbrgide.jpeg" data-src="https://habrastorage.org/webt/tm/fq/yo/tmfqyogtdhbje0atjckosbrgide.jpeg" data-blurred="true"/><br/>
<br/>
After we patch everything in this function, we can point the IDA to its real beginning. It will collect the entire function code piece by piece and we’ll be able to decompile it using HexRays.<br/>
<br/>
<h3>Decrypting the strings</h3><br/>
We’ve learned how to deal with machine code obfuscation in the <b><i>libsgmainso-6.4.36.so</i></b> library from UC Browser and obtained the function code <i>JNI_OnLoad</i>.<br/>
<br/>
<pre><code class="cpp">int __fastcall real_JNI_OnLoad(JavaVM *vm)
{
  int result; // r0
  jclass clazz; // r0 MAPDST
  int v4; // r0
  JNIEnv *env; // r4
  int v6; // [sp-40h] [bp-5Ch]
  int v7; // [sp+Ch] [bp-10h]
  v7 = *(_DWORD *)off_8AC00;
  if ( !vm )
    goto LABEL_39;
  sub_7C4F4();
  env = (JNIEnv *)sub_7C5B0(0);
  if ( !env )
    goto LABEL_39;
  v4 = sub_72CCC();
  sub_73634(v4);
  sub_73E24(&amp;unk_83EA6, &amp;v6, 49);
  clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)->FindClass)(env, &amp;v6);
  if ( clazz
    &amp;&amp; (sub_9EE4(),
        sub_71D68(env),
        sub_E7DC(env) >= 0
     &amp;&amp; sub_69D68(env) >= 0
     &amp;&amp; sub_197B4(env, clazz) >= 0
     &amp;&amp; sub_E240(env, clazz) >= 0
     &amp;&amp; sub_B8B0(env, clazz) >= 0
     &amp;&amp; sub_5F0F4(env, clazz) >= 0
     &amp;&amp; sub_70640(env, clazz) >= 0
     &amp;&amp; sub_11F3C(env) >= 0
     &amp;&amp; sub_21C3C(env, clazz) >= 0
     &amp;&amp; sub_2148C(env, clazz) >= 0
     &amp;&amp; sub_210E0(env, clazz) >= 0
     &amp;&amp; sub_41B58(env, clazz) >= 0
     &amp;&amp; sub_27920(env, clazz) >= 0
     &amp;&amp; sub_293E8(env, clazz) >= 0
     &amp;&amp; sub_208F4(env, clazz) >= 0) )
  {
    result = (sub_B7B0(env, clazz) >> 31) | 0x10004;
  }
  else
  {
LABEL_39:
    result = -1;
  }
  return result;
}</code></pre><br/>
Let’s look into the following strings:<br/>
<br/>
<pre><code class="cpp">  sub_73E24(&amp;unk_83EA6, &amp;v6, 49);
  clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)->FindClass)(env, &amp;v6);</code></pre><br/>
It’s quite clear that the <i>sub_73E24</i> function decrypts the class name. Parameters of this function contain a pointer to the data that look similar to those encrypted, a kind of buffer, and a number. Obviously, a decrypted string will be in the buffer after a call to the function, since the buffer goes to the <i>FindClass</i> function, which receives the same class name as the second parameter. So the number is the size of the buffer or the length of the string. Let’s try to decrypt the name of the class. It should indicate if we are going in the right direction. Let’s take a closer look at what happens in <i>sub_73E24</i>.<br/>
<br/>
<pre><code class="cpp">int __fastcall sub_73E56(unsigned __int8 *in, unsigned __int8 *out, size_t size)
{
  int v4; // r6
  int v7; // r11
  int v8; // r9
  int v9; // r4
  size_t v10; // r5
  int v11; // r0
  struc_1 v13; // [sp+0h] [bp-30h]
  int v14; // [sp+1Ch] [bp-14h]
  int v15; // [sp+20h] [bp-10h]
  v4 = 0;
  v15 = *(_DWORD *)off_8AC00;
  v14 = 0;
  v7 = sub_7AF78(17);
  v8 = sub_7AF78(size);
  if ( !v7 )
  {
    v9 = 0;
    goto LABEL_12;
  }
  (*(void (__fastcall **)(int, const char *, int))(v7 + 12))(v7, "DcO/lcK+h?m3c*q@", 16);
  if ( !v8 )
  {
LABEL_9:
    v4 = 0;
    goto LABEL_10;
  }
  v4 = 0;
  if ( !in )
  {
LABEL_10:
    v9 = 0;
    goto LABEL_11;
  }
  v9 = 0;
  if ( out )
  {
    memset(out, 0, size);
    v10 = size - 1;
    (*(void (__fastcall **)(int, unsigned __int8 *, size_t))(v8 + 12))(v8, in, v10);
    memset(&amp;v13, 0, 0x14u);
    v13.field_4 = 3;
    v13.field_10 = v7;
    v13.field_14 = v8;
    v11 = sub_6115C(&amp;v13, &amp;v14);
    v9 = v11;
    if ( v11 )
    {
      if ( *(_DWORD *)(v11 + 4) == v10 )
      {
        qmemcpy(out, *(const void **)v11, v10);
        v4 = *(_DWORD *)(v9 + 4);
      }
      else
      {
        v4 = 0;
      }
      goto LABEL_11;
    }
    goto LABEL_9;
  }
LABEL_11:
  sub_7B148(v7);
LABEL_12:
  if ( v8 )
    sub_7B148(v8);
  if ( v9 )
    sub_7B148(v9);
  return v4;
}</code></pre><br/>
The sub_7AF78 function creates a container instance for byte arrays of the specified size (we will not focus on them in detail). Two such containers are created here: one contains the string "<b><i>DcO/lcK+h?m3c*q@</i></b>" (it is easy to guess that this is the key), the other has the encrypted data. Both objects are then placed in a certain structure, which transfers to the <i>sub_6115C</i> function. We may also note that this structure contains a field with a value of 3. Let’s see what happens next.<br/>
<br/>
<pre><code class="cpp">int __fastcall sub_611B4(struc_1 *a1, _DWORD *a2)
{
  int v3; // lr
  unsigned int v4; // r1
  int v5; // r0
  int v6; // r1
  int result; // r0
  int v8; // r0
  *a2 = 820000;
  if ( a1 )
  {
    v3 = a1->field_14;
    if ( v3 )
    {
      v4 = a1->field_4;
      if ( v4 &lt; 0x19 )
      {
        switch ( v4 )
        {
          case 0u:
            v8 = sub_6419C(a1->field_0, a1->field_10, v3);
            goto LABEL_17;
          case 3u:
            v8 = sub_6364C(a1->field_0, a1->field_10, v3);
            goto LABEL_17;
          case 0x10u:
          case 0x11u:
          case 0x12u:
            v8 = sub_612F4(
                   a1->field_0,
                   v4,
                   *(_QWORD *)&amp;a1->field_8,
                   *(_QWORD *)&amp;a1->field_8 >> 32,
                   a1->field_10,
                   v3,
                   a2);
            goto LABEL_17;
          case 0x14u:
            v8 = sub_63A28(a1->field_0, v3);
            goto LABEL_17;
          case 0x15u:
            sub_61A60(a1->field_0, v3, a2);
            return result;
          case 0x16u:
            v8 = sub_62440(a1->field_14);
            goto LABEL_17;
          case 0x17u:
            v8 = sub_6226C(a1->field_10, v3);
            goto LABEL_17;
          case 0x18u:
            v8 = sub_63530(a1->field_14);
LABEL_17:
            v6 = 0;
            if ( v8 )
            {
              *a2 = 0;
              v6 = v8;
            }
            return v6;
          default:
            LOWORD(v5) = 28032;
            goto LABEL_5;
        }
      }
    }
  }
  LOWORD(v5) = -27504;
LABEL_5:
  HIWORD(v5) = 13;
  v6 = 0;
  *a2 = v5;
  return v6;
}</code></pre><br/>
The field with the previously assigned value 3 is transitioned as the switch parameter. Let’s take a look at case 3 — parameters that the previous function added to the structure (i.e., the key and the encrypted data) are transitioned to the sub_6364C function. If we look closely at sub_6364C, we can recognize the RC4 algorithm.<br/>
<br/>
So we have an algorithm and a key. Let’s try to decrypt the name of the class. This is what we’ve got: com/taobao/wireless/security/adapter/JNICLibrary. Brilliant! We are on the right track.<br/>
<br/>
<h3>Command tree</h3><br/>
Now we need to find the call to <i>RegisterNatives</i>, which will point us to the <i>doCommandNative</i> function. So we look through the functions called from <i>JNI_OnLoad</i>, and find it in <i>sub_B7B0</i>:<br/>
<br/>
<pre><code class="cpp">int __fastcall sub_B7F6(JNIEnv *env, jclass clazz)
{
  char signature[41]; // [sp+7h] [bp-55h]
  char name[16]; // [sp+30h] [bp-2Ch]
  JNINativeMethod method; // [sp+40h] [bp-1Ch]
  int v8; // [sp+4Ch] [bp-10h]
 
  v8 = *(_DWORD *)off_8AC00;
  decryptString((unsigned __int8 *)&amp;unk_83ED9, (unsigned __int8 *)name, 0x10u);// doCommandNative
  decryptString((unsigned __int8 *)&amp;unk_83EEA, (unsigned __int8 *)signature, 0x29u);// (I[Ljava/lang/Object;)Ljava/lang/Object;
  method.name = name;
  method.signature = signature;
  method.fnPtr = sub_B69C;
  return ((int (__fastcall *)(JNIEnv *, jclass, JNINativeMethod *, int))(*env)->RegisterNatives)(env, clazz, &amp;method, 1) >> 31;
}</code></pre><br/>
And indeed, a native method with the name <i>doCommandNative</i> is registered here. Now we know its address. Let’s have a look at what it does.<br/>
<br/>
<pre><code class="cpp">int __fastcall doCommandNative(JNIEnv *env, jobject obj, int command, jarray args)
{
  int v5; // r5
  struc_2 *a5; // r6
  int v9; // r1
  int v11; // [sp+Ch] [bp-14h]
  int v12; // [sp+10h] [bp-10h]
  v5 = 0;
  v12 = *(_DWORD *)off_8AC00;
  v11 = 0;
  a5 = (struc_2 *)malloc(0x14u);
  if ( a5 )
  {
    a5->field_0 = 0;
    a5->field_4 = 0;
    a5->field_8 = 0;
    a5->field_C = 0;
    v9 = command % 10000 / 100;
    a5->field_0 = command / 10000;
    a5->field_4 = v9;
    a5->field_8 = command % 100;
    a5->field_C = env;
    a5->field_10 = args;
    v5 = sub_9D60(command / 10000, v9, command % 100, 1, (int)a5, &amp;v11);
  }
  free(a5);
  if ( !v5 &amp;&amp; v11 )
    sub_7CF34(env, v11, &amp;byte_83ED7);
  return v5;
}</code></pre><br/>
The name suggests that it is the entry point for all functions the developers transferred to the native library. We’re specifically interested in function number 10601.<br/>
<br/>
From the code, we can see that the command number gives us three numbers: command / 10000, command % 10000 / 100, and command % 10 (in our case, 1, 6, and 1). These three numbers, as well as the pointer to JNIEnv and the arguments transferred to the function, make up a structure and are passed on. With these three numbers (we’ll denote them N1, N2, and N3), a command tree is constructed. Something like this:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/xg/jk/l1/xgjkl1uhzmibo-nhmha3kpivf5a.png"/><br/>
<br/>
The tree is created dynamically in JNI_OnLoad. Three numbers encode the path in the tree. Each leaf of the tree contains the corresponding function’s xorred address. The key is in the parent node. It is quite easy to find a place in the code where the function we need is added to the tree if we understand all the structures there (we won’t spend time describing them in this article).<br/>
<br/>
<h3>More obfuscation</h3><br/>
We’ve got the address of the function that is supposed to decrypt the traffic: 0x5F1AC. But it’s still too early to relax — the UC Browser developers have another surprise for us.<br/>
<br/>
After receiving the parameters from an array in the Java code, we go to the function at 0x4D070. Another type of code obfuscation is already waiting.<br/>
<br/>
We then push two indices in R7 and R4:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/7i/fx/86/7ifx86mr4yph41jsxukpjqvxmfa.png"/><br/>
<br/>
The first index moves to R11:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/fa/62/6j/fa626jaylcaaewtslff_-byaseo.jpeg" data-src="https://habrastorage.org/webt/fa/62/6j/fa626jaylcaaewtslff_-byaseo.jpeg" data-blurred="true"/><br/>
<br/>
We use this index to obtain the address from the table:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/co/rk/s1/corks1o2dp75elfvdsxjimrohuo.png"/><br/>
<br/>
After transferring to the first address, we use the second index from R4. The table contains 230 elements.<br/>
<br/>
What do we do with it? We could tell the IDA that it is a sort of a switch: Edit -> Other -> Specify switch idiom.<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/36/uu/xn/36uuxnabf3xesptr8qisxzzfutk.jpeg" data-src="https://habrastorage.org/webt/36/uu/xn/36uuxnabf3xesptr8qisxzzfutk.jpeg" data-blurred="true"/><br/>
<br/>
The resulting code is horrendous. However, we can see the call to the familiar <i>sub_6115C</i> function in its tangles:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/-d/pt/3a/-dpt3akb_yckinmdheczkktzlem.jpeg" data-src="https://habrastorage.org/webt/-d/pt/3a/-dpt3akb_yckinmdheczkktzlem.jpeg" data-blurred="true"/><br/>
<br/>
There was the switch parameter with the RC4 decryption in case 3. In this case, the structure that transfers to the function is filled with the parameters transferred to doCommandNative. We recall that we had magicInt there with value 16. We look at the corresponding case and after several transitions, find the code that helps us identify the algorithm.<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/rn/_1/i4/rn_1i4avl8oki83hslk5u19ygoe.jpeg" data-src="https://habrastorage.org/webt/rn/_1/i4/rn_1i4avl8oki83hslk5u19ygoe.jpeg" data-blurred="true"/><br/>
<br/>
It’s AES!<br/>
<br/>
We have an algorithm and only need to get its parameters, such as mode, key, and (possibly) the initialization vector (its presence depends on the AES algorithm operation mode). The structure that contains them should be created somewhere before calling the sub_6115C function. But since this part of the code is particularly well obfuscated, we decided to patch the code so all parameters of the decryption function could be dumped into a file.<br/>
<br/>
<h3>Patch</h3><br/>
If you don’t want to manually write all the patch code in the assembly language, you can run Android Studio, code a function that receives the same parameters as our decryption function and writes to the file, then copy the resulting code generated by the compiler.<br/>
<br/>
Our good friends from the UC Browser team also “ensured” the convenience of adding code. We do remember that we have garbage code at the beginning of each function, which can easily be replaced with any other code. Very convenient :) However, there is not enough room at the beginning of the target function for the code that saves all parameters to a file. We had to divide it into parts and use the garbage blocks of neighboring functions. We got four parts in total.<br/>
Part one:<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/hy/lk/qr/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg" data-src="https://habrastorage.org/webt/hy/lk/qr/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg" data-blurred="true"/><br/>
<br/>
The first four function parameters in the ARM architecture are indicated in the R0-R3 registers, while the rest, if any, goes via the stack. The LR register indicates the return address. We need to save all this data so the function can work after we dump its parameters. We also need to save all the registers that we use in the process, so we use PUSH.W {R0-R10,LR}. In R7, we get the address of the list of parameters transferred to the function via the stack.<br/>
<br/>
Using the fopen function, we open the /data/local/tmp/aes file in the “ab” mode (so that we could add something). We then load the file name address in R0 and the string address that indicates the mode in R1. This is where the garbage code ends, so we navigate to the next function. Since we want it to continue working, we put the transition to the actual function code in the beginning, before the garbage, and replace the garbage with the rest of the patch.<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/68/ss/kf/68sskfcymjorl_flpf8mg9wwej4.png"/><br/>
<br/>
We then call fopen.<br/>
<br/>
The first three parameters of the aes function are of the int type. Since we pushed the registers to the stack at the beginning, we can simply transfer their addresses in the stack to the fwrite function.<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/d1/yt/iz/d1ytiz_jx7byflntqxxec2nece0.jpeg" data-src="https://habrastorage.org/webt/d1/yt/iz/d1ytiz_jx7byflntqxxec2nece0.jpeg" data-blurred="true"/><br/>
<br/>
Next, we have three structures that indicate the size of the data and contain a pointer to the data for the key, the initialization vector, and the encrypted data.<br/>
<br/>
<img src="https://habrastorage.org/r/w780q1/webt/me/vy/kz/mevykztpkcwdr6xkpnenauxqccs.jpeg" data-src="https://habrastorage.org/webt/me/vy/kz/mevykztpkcwdr6xkpnenauxqccs.jpeg" data-blurred="true"/><br/>
<br/>
At the end, we close the file, restore the registers, and give control back to the actual aes function.<br/>
We compile the APK file with the patched library, sign it, download it onto a device or emulator, and run it. Now we see the dump has been created with a lot of data. The browser does not just decrypt traffic, but other data too, and all decryption is performed via this function. For some reason, we don’t see the data we need, and the request we are expecting is not visible in the traffic. Let’s skip waiting until UC Browser has the chance to make this request and take the encrypted response obtained earlier from the server to patch the application again. We’ll add the decryption to the onCreate of the main activity.<br/>
<br/>
<pre><code class="plaintext">    const/16 v1, 0x62
    new-array v1, v1, [B
    fill-array-data v1, :encrypted_data
    const/16 v0, 0x1f
    invoke-static {v0, v1}, Lcom/uc/browser/core/d/c/g;->j(I[B)[B
    move-result-object v1
    array-length v2, v1
    invoke-static {v2}, Ljava/lang/String;->valueOf(I)Ljava/lang/String;
    move-result-object v2
    const-string v0, "ololo"
    invoke-static {v0, v2}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I</code></pre><br/>
We compile it, sign, install, and run. Thus, we get a NullPointerException since the method returns a null value.<br/>
<br/>
After analyzing of the code further, we found a function with rather interesting strings: “META-INF/” and “.RSA”. Looks like the app verifies its certificate, or even generates keys from it. We don’t really want to dig into what is happening with the certificate, so let’s just give it the correct certificate. We’ll patch the encrypted string, so instead of “META-INF/” we get “BLABLINF/”, we create a folder with this name in the APK file, and save the browser certificate in it.<br/>
<br/>
We compile it, sign, install, and run. Bingo! We have the key!<br/>
<br/>
<h3>MitM</h3><br/>
Now we’ve got the key and an equal initialization vector. Let’s try to decrypt the server response in the CBC mode.<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/9k/m7/un/9km7unymy_ybx1lwnflfbqd36ke.png"/><br/>
<br/>
We see the archive URL, something like MD5, “extract_unzipsize”, and a number. Let us check. The MD5 of the archive is the same; the size of the unzipped library is the same. Now we’ll try to patch this library and transmit it to the browser. To show that our patched library has loaded, we’ll build an Intent to create the text message «PWNED!» We’ll replace two responses from the server: <a href="http://puds.ucweb.com/upgrade/index.xhtml">puds.ucweb.com/upgrade/index.xhtml</a> and the one that prompts the archive download. In the first, we substitute MD5 (the size remains the same after unzipping); in the second, we send the archive with the patched library.<br/>
<br/>
The browser makes several attempts to download the archive, resulting in an error. Apparently, something fishy is happening there. Analyzing this bizarre format, we found that the server also transmits the archive size:<br/>
<br/>
<img src="/img/image-loader.svg" data-src="https://habrastorage.org/webt/e2/-v/ua/e2-vuahng86h0bt0vm84f3xhqrg.png"/><br/>
<br/>
It is LEB128 encoded. The patch slightly changes the size of the compressed library, so the browser decided that the archive broke upon download and displayed an error after several attempts.<br/>
So we fix the archive size and… voila! :) See the result in the video.<br/>
<br/>
<div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;"><div class="tm-iframe_temp" data-src="https://www.youtube.com/embed/Nfns7uH03J8?rel=0&amp;showinfo=1&amp;hl=en-US" data-style="border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;" id="" width=""></div></div></div></div><br/>
<h3>Consequences and developer’s response</h3><br/>
In the same way, hackers can use this insecure feature of UC Browser to distribute and launch malicious libraries. These libraries will work in the context of the browser, resulting in full system privileges that the browser has. This grants them free reign to display phishing windows, as well as access to the browser’s working files including logins, passwords, and cookies in the database.<br/>
<br/>
We contacted the UC Browser developers and informed them about the problem we had found, tried to point out the vulnerability and its danger, but they refused to discuss the matter. Meanwhile, the browser with the dangerous function remained in plain sight. Though as soon as we revealed the details of the vulnerability, it was impossible to ignore it as before. A new version of UC Browser 12.10.9.1193 was released on March 27, which accessed the server via HTTPS <a href="https://puds.ucweb.com/upgrade/index.xhtml">puds.ucweb.com/upgrade/index.xhtml</a>. In addition, between the “bug fixing” and the time we wrote this article, an attempt to open a PDF in the browser resulted in an error message with the text, “Oops, something is wrong.” There was no request to the server when trying to open the PDF file. This was performed upon startup, though, which is a sign that the ability to download the executable code in violation of Google Play policies is still present.</div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BUC%20Browser%5D" class="tm-tags-list__link">UC Browser</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/company/drweb/blog/" class="tm-hubs-list__link router-link-active">
    Блог компании Доктор Веб
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/browsers/" class="tm-hubs-list__link">
    Браузеры
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 14: ↑11 и ↓3</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 14: ↑11 и ↓3" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+8</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">10K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    0
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"><div class="tm-article-author__company"><div class="tm-article-author__company-card"><div class="tm-company-snippet"><a href="/ru/company/drweb/profile/" class="tm-company-snippet__logo-link"><div class="tm-entity-image"><img alt="" height="40" src="//habrastorage.org/getpro/habr/company/002/8a7/c16/0028a7c16cc021fea7f86c13e082f507.gif" width="40" class="tm-entity-image__pic"></div></a> <div class="tm-company-snippet__info"><a href="/ru/company/drweb/profile/" class="tm-company-snippet__title">Доктор Веб</a> <div class="tm-company-snippet__description">Компания</div></div></div> <div class="tm-article-author__buttons"><!----> <!----></div></div> <!----> <div class="tm-article-author__separator"></div></div> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/doctorweb/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><img alt="" src="//habrastorage.org/getpro/habr/avatars/3c5/026/15b/3c502615b845bc7d9a930778c9e7f1da.jpg" class="tm-entity-image__pic"></div></a> <div class="tm-user-card__meta"><div title=" 126 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    28
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/doctorweb/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @doctorweb
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/company/drweb/blog/452076/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментарии 5 
    </span></a> <!----></div></div></div>  <!---->  <!----> <!----></div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__placeholder_initial"></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <section class="tm-block tm-block_spacing-bottom"><header class="tm-block__header"><h2 class="tm-block__title">Информация</h2> <!----></header> <div class="tm-block__body"><div class="tm-company-basic-info"><dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата основания</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2003-12-21T21:00:00.000Z" title="2003-12-22, 00:00">22  декабря  2003</time></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Местоположение</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Россия
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Сайт</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><a href="http://www.drweb.ru/" target="_blank" class="tm-company-basic-info__link">
      www.drweb.ru
    </a></dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Численность</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap">
    Неизвестно
  </dd></dl> <dl class="tm-description-list tm-description-list_variant-columns-nowrap"><dt class="tm-description-list__title tm-description-list__title_variant-columns-nowrap">Дата регистрации</dt> <dd class="tm-description-list__body tm-description-list__body_variant-columns-nowrap"><time datetime="2008-08-09T07:42:52.000Z" title="2008-08-09, 11:42">9  августа  2008</time></dd></dl> <!----></div></div> <!----></section> <div class="tm-company-widgets"></div> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/company/drweb/blog/452076/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/company/drweb/blog/452076/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"452076":{"id":"452076","timePublished":"2019-05-16T07:39:48+00:00","isCorporative":true,"lang":"en","titleHtml":"Breaking UC Browser","leadData":{"textHtml":"\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fke\u002Fe0\u002Frd\u002Fkee0rdupth-kalljz9gfxpjndnk.jpeg\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EIntroduction\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nAt the end of March we \u003Ca href=\"https:\u002F\u002Fnews.drweb.ru\u002Fshow\u002F?i=13176\"\u003Ereported\u003C\u002Fa\u003E on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use it.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nSome time ago, UC Browser was promoted and distributed quite aggressively. It was installed on devices by malware, distributed via websites under the guise of video files (i.e., users thought they were downloading pornography or something, but instead were getting APK files with this browser), advertised using worrisome banners about a user’s browser being outdated or vulnerable. The official UC Browser VK group had a \u003Ca href=\"https:\u002F\u002Fvk.com\u002Ftopic-27170131_31448404?offset=0\"\u003Etopic\u003C\u002Fa\u003E where users could complain about false advertising and many users provided examples. In 2016, there was even a \u003Ca href=\"https:\u002F\u002Fwww.youtube.com\u002Fwatch?v=VRFOl7k5axc\"\u003Ecommercial\u003C\u002Fa\u003E in Russian (yes, a commercial of a browser that blocks commercials).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAs we write this article, UC Browser was installed 500,000,000 times from Google Play. This is impressive since only Google Chrome managed to top that. Among the reviews, you can see a lot of user complaints about advertising and being redirected to other applications on Google Play. This was the reason for our study: we wanted to see if UC Browser is doing something wrong. And it is! The application is able to download and run executable code, which \u003Ca href=\"https:\u002F\u002Fplay.google.com\u002Fabout\u002Fprivacy-security-deception\u002Fmalicious-behavior\u002F\"\u003Eviolates Google Play’s policy for app publishing \u003C\u002Fa\u003E. And UC Browser doesn’t only download executable code; it does this unsafely, which can be used for a MitM attack. Let's see if we can use it this way.\u003Cbr\u002F\u003E\r\n","imageUrl":null,"buttonTextHtml":null,"image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":28,"votesCount":126},"rating":0,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"56752","alias":"doctorweb","fullname":null,"avatarUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Favatars\u002F3c5\u002F026\u002F15b\u002F3c502615b845bc7d9a930778c9e7f1da.jpg","speciality":null},"statistics":{"commentsCount":5,"favoritesCount":0,"readingCount":10308,"score":8,"votesCount":14},"hubs":[{"relatedData":null,"id":"5161","alias":"drweb","type":"corporative","title":"Блог компании Доктор Веб","titleHtml":"Блог компании Доктор Веб","isProfiled":false},{"relatedData":null,"id":"19257","alias":"browsers","type":"collective","title":"Браузеры","titleHtml":"Браузеры","isProfiled":false}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fke\u002Fe0\u002Frd\u002Fkee0rdupth-kalljz9gfxpjndnk.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fke\u002Fe0\u002Frd\u002Fkee0rdupth-kalljz9gfxpjndnk.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EIntroduction\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nAt the end of March we \u003Ca href=\"https:\u002F\u002Fnews.drweb.ru\u002Fshow\u002F?i=13176\"\u003Ereported\u003C\u002Fa\u003E on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use it.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nSome time ago, UC Browser was promoted and distributed quite aggressively. It was installed on devices by malware, distributed via websites under the guise of video files (i.e., users thought they were downloading pornography or something, but instead were getting APK files with this browser), advertised using worrisome banners about a user’s browser being outdated or vulnerable. The official UC Browser VK group had a \u003Ca href=\"https:\u002F\u002Fvk.com\u002Ftopic-27170131_31448404?offset=0\"\u003Etopic\u003C\u002Fa\u003E where users could complain about false advertising and many users provided examples. In 2016, there was even a \u003Ca href=\"https:\u002F\u002Fwww.youtube.com\u002Fwatch?v=VRFOl7k5axc\"\u003Ecommercial\u003C\u002Fa\u003E in Russian (yes, a commercial of a browser that blocks commercials).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAs we write this article, UC Browser was installed 500,000,000 times from Google Play. This is impressive since only Google Chrome managed to top that. Among the reviews, you can see a lot of user complaints about advertising and being redirected to other applications on Google Play. This was the reason for our study: we wanted to see if UC Browser is doing something wrong. And it is! The application is able to download and run executable code, which \u003Ca href=\"https:\u002F\u002Fplay.google.com\u002Fabout\u002Fprivacy-security-deception\u002Fmalicious-behavior\u002F\"\u003Eviolates Google Play’s policy for app publishing \u003C\u002Fa\u003E. And UC Browser doesn’t only download executable code; it does this unsafely, which can be used for a MitM attack. Let's see if we can use it this way.\u003Cbr\u002F\u003E\r\n\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\nEverything that follows applies to the version of UC Browser that was distributed via Google Play at the time of our study:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Epackage: com.UCMobile.intl\nversionName: 12.10.8.1172\nversionCode: 10598\nsha1 APK-file: f5edb2243413c777172f6362876041eb0c3a928c\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EAttack Vector\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nUC Browser’s manifest contains a service with a telltale name of \u003Ci\u003Ecom.uc.deployment.UpgradeDeployService\u003C\u002Fi\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E    &lt;service android:exported=\"false\" android:name=\"com.uc.deployment.UpgradeDeployService\" android:process=\":deploy\" \u002F\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nWhen this service launches, the browser makes a POST request to \u003Ca href=\"http:\u002F\u002Fpuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\"\u003Epuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\u003C\u002Fa\u003E that can be seen in traffic for some time after the launch. In response, the browser may receive a command to download any update or a new module. During our analysis, we never received such commands from the server, but we noticed that when trying to open a PDF file in the browser, it repeats the request to the above address, then downloads a native library. To simulate an attack, we decided to use this feature of UC Browser—the ability to open PDF files using a native library — not present in the APK file, but downloadable from the Internet. Technically, UC Browser can download something without a user’s permission when given an appropriate response to a request sent upon startup. But for this we need to study the interaction protocol with the server in more detail, so we thought it was easier to just hook and edit the response and then replace the library needed to open PDF files with something different.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nSo when a user wants to open a PDF file directly in the browser, traffic may contain the following requests:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fj0\u002Fi1\u002Fc1\u002Fj0i1c1n_nwf_gnauzbudnqor5oi.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nFirst, there is a POST request to \u003Ca href=\"http:\u002F\u002Fpuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\"\u003Epuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\u003C\u002Fa\u003E, then the compressed library for viewing PDF files and office documents is downloaded. Logically, we can assume that the first request sends information about the system (at least the architecture, because the server needs to select an appropriate library), and the server responds with some information about the library that needs to be downloaded, like its address and maybe something else. The problem is that this request is encrypted.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"scrollable-table\"\u003E\u003Ctable\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003E Request fragment\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E Response fragment\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003Ctr\u003E\r\n\u003Ctd\u003E\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fgo\u002Ftj\u002Ftz\u002Fgotjtzkpg2owfmk8jrnznox_vdg.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fgo\u002Ftj\u002Ftz\u002Fgotjtzkpg2owfmk8jrnznox_vdg.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003C\u002Ftd\u003E\r\n\u003Ctd\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fg5\u002F7k\u002Fiv\u002Fg57kivkwrysmcqvptmhclqzzipq.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003C\u002Ftd\u003E\r\n\u003C\u002Ftr\u003E\r\n\u003C\u002Ftable\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\nThe library is compressed in a ZIP file and not encrypted.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F6r\u002Flt\u002Fns\u002F6rltnsrtyd-_5ekwis68qn-vydc.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003ESearching for traffic decryption code\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nLet’s try and decrypt the server’s response. Take a look at the code of the \u003Ci\u003Ecom.uc.deployment.UpgradeDeployService class\u003C\u002Fi\u003E: from the \u003Ci\u003EonStartCommand method\u003C\u002Fi\u003E, we navigate to \u003Ci\u003Ecom.uc.deployment.b.x\u003C\u002Fi\u003E, and then to \u003Ci\u003Ecom.uc.browser.core.d.c.f.e\u003C\u002Fi\u003E:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E    public final void e(l arg9) {\n        int v4_5;\n        String v3_1;\n        byte[] v3;\n        byte[] v1 = null;\n        if(arg9 == null) {\n            v3 = v1;\n        }\n        else {\n            v3_1 = arg9.iGX.ipR;\n            StringBuilder v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]product:\");\n            v4.append(arg9.iGX.ipR);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]version:\");\n            v4.append(arg9.iGX.iEn);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]upgrade_type:\");\n            v4.append(arg9.iGX.mMode);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]force_flag:\");\n            v4.append(arg9.iGX.iEo);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]silent_mode:\");\n            v4.append(arg9.iGX.iDQ);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]silent_type:\");\n            v4.append(arg9.iGX.iEr);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]silent_state:\");\n            v4.append(arg9.iGX.iEp);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]silent_file:\");\n            v4.append(arg9.iGX.iEq);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]apk_md5:\");\n            v4.append(arg9.iGX.iEl);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]download_type:\");\n            v4.append(arg9.mDownloadType);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]download_group:\");\n            v4.append(arg9.mDownloadGroup);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]download_path:\");\n            v4.append(arg9.iGH);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]apollo_child_version:\");\n            v4.append(arg9.iGX.iEx);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]apollo_series:\");\n            v4.append(arg9.iGX.iEw);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]apollo_cpu_arch:\");\n            v4.append(arg9.iGX.iEt);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]apollo_cpu_vfp3:\");\n            v4.append(arg9.iGX.iEv);\n            v4 = new StringBuilder(\"[\");\n            v4.append(v3_1);\n            v4.append(\"]apollo_cpu_vfp:\");\n            v4.append(arg9.iGX.iEu);\n            ArrayList v3_2 = arg9.iGX.iEz;\n            if(v3_2 != null &amp;&amp; v3_2.size() != 0) {\n                Iterator v3_3 = v3_2.iterator();\n                while(v3_3.hasNext()) {\n                    Object v4_1 = v3_3.next();\n                    StringBuilder v5 = new StringBuilder(\"[\");\n                    v5.append(((au)v4_1).getName());\n                    v5.append(\"]component_name:\");\n                    v5.append(((au)v4_1).getName());\n                    v5 = new StringBuilder(\"[\");\n                    v5.append(((au)v4_1).getName());\n                    v5.append(\"]component_ver_name:\");\n                    v5.append(((au)v4_1).aDA());\n                    v5 = new StringBuilder(\"[\");\n                    v5.append(((au)v4_1).getName());\n                    v5.append(\"]component_ver_code:\");\n                    v5.append(((au)v4_1).gBl);\n                    v5 = new StringBuilder(\"[\");\n                    v5.append(((au)v4_1).getName());\n                    v5.append(\"]component_req_type:\");\n                    v5.append(((au)v4_1).gBq);\n                }\n            }\n \n            j v3_4 = new j();\n            m.b(v3_4);\n            h v4_2 = new h();\n            m.b(v4_2);\n            ay v5_1 = new ay();\n            v3_4.hS(\"\");\n            v3_4.setImsi(\"\");\n            v3_4.hV(\"\");\n            v5_1.bPQ = v3_4;\n            v5_1.bPP = v4_2;\n            v5_1.yr(arg9.iGX.ipR);\n            v5_1.gBF = arg9.iGX.mMode;\n            v5_1.gBI = arg9.iGX.iEz;\n            v3_2 = v5_1.gAr;\n            c.aBh();\n            v3_2.add(g.fs(\"os_ver\", c.getRomInfo()));\n            v3_2.add(g.fs(\"processor_arch\", com.uc.b.a.a.c.getCpuArch()));\n            v3_2.add(g.fs(\"cpu_arch\", com.uc.b.a.a.c.Pb()));\n            String v4_3 = com.uc.b.a.a.c.Pd();\n            v3_2.add(g.fs(\"cpu_vfp\", v4_3));\n            v3_2.add(g.fs(\"net_type\", String.valueOf(com.uc.base.system.a.Jo())));\n            v3_2.add(g.fs(\"fromhost\", arg9.iGX.iEm));\n            v3_2.add(g.fs(\"plugin_ver\", arg9.iGX.iEn));\n            v3_2.add(g.fs(\"target_lang\", arg9.iGX.iEs));\n            v3_2.add(g.fs(\"vitamio_cpu_arch\", arg9.iGX.iEt));\n            v3_2.add(g.fs(\"vitamio_vfp\", arg9.iGX.iEu));\n            v3_2.add(g.fs(\"vitamio_vfp3\", arg9.iGX.iEv));\n            v3_2.add(g.fs(\"plugin_child_ver\", arg9.iGX.iEx));\n            v3_2.add(g.fs(\"ver_series\", arg9.iGX.iEw));\n            v3_2.add(g.fs(\"child_ver\", r.aVw()));\n            v3_2.add(g.fs(\"cur_ver_md5\", arg9.iGX.iEl));\n            v3_2.add(g.fs(\"cur_ver_signature\", SystemHelper.getUCMSignature()));\n            v3_2.add(g.fs(\"upgrade_log\", i.bjt()));\n            v3_2.add(g.fs(\"silent_install\", String.valueOf(arg9.iGX.iDQ)));\n            v3_2.add(g.fs(\"silent_state\", String.valueOf(arg9.iGX.iEp)));\n            v3_2.add(g.fs(\"silent_file\", arg9.iGX.iEq));\n            v3_2.add(g.fs(\"silent_type\", String.valueOf(arg9.iGX.iEr)));\n            v3_2.add(g.fs(\"cpu_archit\", com.uc.b.a.a.c.Pc()));\n            v3_2.add(g.fs(\"cpu_set\", SystemHelper.getCpuInstruction()));\n            boolean v4_4 = v4_3 == null || !v4_3.contains(\"neon\") ? false : true;\n            v3_2.add(g.fs(\"neon\", String.valueOf(v4_4)));\n            v3_2.add(g.fs(\"cpu_cores\", String.valueOf(com.uc.b.a.a.c.Jl())));\n            v3_2.add(g.fs(\"ram_1\", String.valueOf(com.uc.b.a.a.h.Po())));\n            v3_2.add(g.fs(\"totalram\", String.valueOf(com.uc.b.a.a.h.OL())));\n            c.aBh();\n            v3_2.add(g.fs(\"rom_1\", c.getRomInfo()));\n            v4_5 = e.getScreenWidth();\n            int v6 = e.getScreenHeight();\n            StringBuilder v7 = new StringBuilder();\n            v7.append(v4_5);\n            v7.append(\"*\");\n            v7.append(v6);\n            v3_2.add(g.fs(\"ss\", v7.toString()));\n            v3_2.add(g.fs(\"api_level\", String.valueOf(Build$VERSION.SDK_INT)));\n            v3_2.add(g.fs(\"uc_apk_list\", SystemHelper.getUCMobileApks()));\n            Iterator v4_6 = arg9.iGX.iEA.entrySet().iterator();\n            while(v4_6.hasNext()) {\n                Object v6_1 = v4_6.next();\n                v3_2.add(g.fs(((Map$Entry)v6_1).getKey(), ((Map$Entry)v6_1).getValue()));\n            }\n \n            v3 = v5_1.toByteArray();\n        }\n \n        if(v3 == null) {\n            this.iGY.iGI.a(arg9, \"up_encode\", \"yes\", \"fail\");\n            return;\n        }\n \n        v4_5 = this.iGY.iGw ? 0x1F : 0;\n        if(v3 == null) {\n        }\n        else {\n            v3 = g.i(v4_5, v3);\n            if(v3 == null) {\n            }\n            else {\n                v1 = new byte[v3.length + 16];\n                byte[] v6_2 = new byte[16];\n                Arrays.fill(v6_2, 0);\n                v6_2[0] = 0x5F;\n                v6_2[1] = 0;\n                v6_2[2] = ((byte)v4_5);\n                v6_2[3] = -50;\n                System.arraycopy(v6_2, 0, v1, 0, 16);\n                System.arraycopy(v3, 0, v1, 16, v3.length);\n            }\n        }\n \n        if(v1 == null) {\n            this.iGY.iGI.a(arg9, \"up_encrypt\", \"yes\", \"fail\");\n            return;\n        }\n \n        if(TextUtils.isEmpty(this.iGY.mUpgradeUrl)) {\n            this.iGY.iGI.a(arg9, \"up_url\", \"yes\", \"fail\");\n            return;\n        }\n \n        StringBuilder v0 = new StringBuilder(\"[\");\n        v0.append(arg9.iGX.ipR);\n        v0.append(\"]url:\");\n        v0.append(this.iGY.mUpgradeUrl);\n        com.uc.browser.core.d.c.i v0_1 = this.iGY.iGI;\n        v3_1 = this.iGY.mUpgradeUrl;\n        com.uc.base.net.e v0_2 = new com.uc.base.net.e(new com.uc.browser.core.d.c.i$a(v0_1, arg9));\n        v3_1 = v3_1.contains(\"?\") ? v3_1 + \"&amp;dataver=pb\" : v3_1 + \"?dataver=pb\";\n        n v3_5 = v0_2.uc(v3_1);\n        m.b(v3_5, false);\n        v3_5.setMethod(\"POST\");\n        v3_5.setBodyProvider(v1);\n        v0_2.b(v3_5);\n        this.iGY.iGI.a(arg9, \"up_null\", \"yes\", \"success\");\n        this.iGY.iGI.b(arg9);\n    }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nWe can see this is where the POST request is made. Have a look at the 16-byte array that contains: 0x5F, 0, 0x1F, -50 (=0xCE). Values are the same as in the above request.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThe same class contains a nested class with another interesting method:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E        public final void a(l arg10, byte[] arg11) {\n            f v0 = this.iGQ;\n            StringBuilder v1 = new StringBuilder(\"[\");\n            v1.append(arg10.iGX.ipR);\n            v1.append(\"]:UpgradeSuccess\");\n            byte[] v1_1 = null;\n            if(arg11 == null) {\n            }\n            else if(arg11.length &lt; 16) {\n            }\n            else {\n                if(arg11[0] != 0x60 &amp;&amp; arg11[3] != 0xFFFFFFD0) {\n                    goto label_57;\n                }\n                int v3 = 1;\n                int v5 = arg11[1] == 1 ? 1 : 0;\n                if(arg11[2] != 1 &amp;&amp; arg11[2] != 11) {\n                    if(arg11[2] == 0x1F) {\n                    }\n                    else {\n                        v3 = 0;\n                    }\n                }\n                byte[] v7 = new byte[arg11.length - 16];\n                System.arraycopy(arg11, 16, v7, 0, v7.length);\n                if(v3 != 0) {\n                    v7 = g.j(arg11[2], v7);\n                }\n                if(v7 == null) {\n                    goto label_57;\n                }\n                if(v5 != 0) {\n                    v1_1 = g.P(v7);\n                    goto label_57;\n                }\n                v1_1 = v7;\n            }\n        label_57:\n            if(v1_1 == null) {\n                v0.iGY.iGI.a(arg10, \"up_decrypt\", \"yes\", \"fail\");\n                return;\n            }\n            q v11 = g.b(arg10, v1_1);\n            if(v11 == null) {\n                v0.iGY.iGI.a(arg10, \"up_decode\", \"yes\", \"fail\");\n                return;\n            }\n            if(v0.iGY.iGt) {\n                v0.d(arg10);\n            }\n            if(v0.iGY.iGo != null) {\n                v0.iGY.iGo.a(0, ((o)v11));\n            }\n            if(v0.iGY.iGs) {\n                v0.iGY.a(((o)v11));\n                v0.iGY.iGI.a(v11, \"up_silent\", \"yes\", \"success\");\n                v0.iGY.iGI.a(v11);\n                return;\n            }\n            v0.iGY.iGI.a(v11, \"up_silent\", \"no\", \"success\");\n        }\n    }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nThis method receives an input of a bytes array and checks whether the zero byte is 0x60, or the third byte is 0xD0 and if the second byte is 1, 11, or 0x1F. Check out the server response: zero byte is 0x60, the second byte is 0x1F, the third byte is 0x60. It looks like what we need. Judging by the strings («up_decrypt», for example), a method is supposed to be called here to decrypt the server response. Now let’s look at the g.j method. Note that the first argument is a byte at offset 2 (that is, 0x1F in our case), and the second is the server response without the first 16 bytes.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E     public static byte[] j(int arg1, byte[] arg2) {\n        if(arg1 == 1) {\n            arg2 = c.c(arg2, c.adu);\n        }\n        else if(arg1 == 11) {\n            arg2 = m.aF(arg2);\n        }\n        else if(arg1 != 0x1F) {\n        }\n        else {\n            arg2 = EncryptHelper.decrypt(arg2);\n        }\n        return arg2;\n    }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nObviously, it is selecting the decryption algorithm, and the byte that in our case equals 0x1F indicates one of three possible options.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nLet’s go back to the code analysis. After a couple of jumps, we get to the method with the telltale name, \u003Ci\u003EdecryptBytesByKey\u003C\u002Fi\u003E. Now, two more bytes are separated from our response and form a string. It’s clear this is how the key is selected to decrypt the message.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E    private static byte[] decryptBytesByKey(byte[] bytes) {\n        byte[] v0 = null;\n        if(bytes != null) {\n            try {\n                if(bytes.length &lt; EncryptHelper.PREFIX_BYTES_SIZE) {\n                }\n                else if(bytes.length == EncryptHelper.PREFIX_BYTES_SIZE) {\n                    return v0;\n                }\n                else {\n                    byte[] prefix = new byte[EncryptHelper.PREFIX_BYTES_SIZE];  \u002F\u002F 2 байта\n                    System.arraycopy(bytes, 0, prefix, 0, prefix.length);\n                    String keyId = c.ayR().d(ByteBuffer.wrap(prefix).getShort()); \u002F\u002F Выбор ключа\n                    if(keyId == null) {\n                        return v0;\n                    }\n                    else {\n                        a v2 = EncryptHelper.ayL();\n                        if(v2 == null) {\n                            return v0;\n                        }\n                        else {\n                            byte[] enrypted = new byte[bytes.length - EncryptHelper.PREFIX_BYTES_SIZE];\n                            System.arraycopy(bytes, EncryptHelper.PREFIX_BYTES_SIZE, enrypted, 0, enrypted.length);\n                            return v2.l(keyId, enrypted);\n                        }\n                    }\n                }\n            }\n            catch(SecException v7_1) {\n                EncryptHelper.handleDecryptException(((Throwable)v7_1), v7_1.getErrorCode());\n                return v0;\n            }\n            catch(Throwable v7) {\n                EncryptHelper.handleDecryptException(v7, 2);\n                return v0;\n            }\n        }\n \n        return v0;\n    }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nJumping ahead a bit, note that at this stage, it’s only the key identifier, not the key itself. Key selection is going to be a little more complicated.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nIn the next method, two more parameters are added to the existing ones, so we get a total of four. The magic number 16, the key identifier, the encrypted data, and a string is added there for some reason (empty in our case).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003E    public final byte[] l(String keyId, byte[] encrypted) throws SecException {\n        return this.ayJ().staticBinarySafeDecryptNoB64(16, keyId, encrypted, \"\");\n    }\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nAfter a series of jumps, we see the \u003Ci\u003EstaticBinarySafeDecryptNoB64\u003C\u002Fi\u003E method of the \u003Ci\u003Ecom.alibaba.wireless.security.open.staticdataencrypt.IStaticDataEncryptComponent\u003C\u002Fi\u003E interface. The main application code has no classes that implement this interface. This class is contained in the file \u003Cb\u003E\u003Ci\u003Elib\u002Farmeabi-v7a\u002Flibsgmain.so\u003C\u002Fi\u003E\u003C\u002Fb\u003E, which is not really .SO, but rather .JAR. The method we are interested in is implemented as follows:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage com.alibaba.wireless.security.a.i;\n \n\u002F\u002F ...\n \npublic class a implements IStaticDataEncryptComponent {\n    private ISecurityGuardPlugin a;\n\u002F\u002F ...\n    private byte[] a(int mode, int magicInt, int xzInt, String keyId, byte[] encrypted, String magicString) {\n        return this.a.getRouter().doCommand(10601, new Object[]{Integer.valueOf(mode), Integer.valueOf(magicInt), Integer.valueOf(xzInt), keyId, encrypted, magicString});\n    }\n\u002F\u002F ...\n    private byte[] b(int magicInt, String keyId, byte[] encrypted, String magicString) {\n        return this.a(2, magicInt, 0, keyId, encrypted, magicString);\n    }\n\u002F\u002F ...\n    public byte[] staticBinarySafeDecryptNoB64(int magicInt, String keyId, byte[] encrypted, String magicString) throws SecException {\n        if(keyId != null &amp;&amp; keyId.length() \u003E 0 &amp;&amp; magicInt \u003E= 0 &amp;&amp; magicInt &lt; 19 &amp;&amp; encrypted != null &amp;&amp; encrypted.length \u003E 0) {\n            return this.b(magicInt, keyId, encrypted, magicString);\n        }\n \n        throw new SecException(\"\", 301);\n    }\n\u002F\u002F...\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nHere, our parameter list is supplemented with two more integers: 2 and 0. Apparently, 2 means decryption, as in the \u003Ci\u003EdoFinal method\u003C\u002Fi\u003E of the \u003Ci\u003Ejavax.crypto.Cipher system\u003C\u002Fi\u003E class. Then, this information is transmitted to a certain Router along with the number 10601, which is apparently the command number.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAfter the next chain of jumps, we find a class that implements the \u003Ci\u003ERouterComponent\u003C\u002Fi\u003E interface and the \u003Ci\u003EdoCommand\u003C\u002Fi\u003E method:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage com.alibaba.wireless.security.mainplugin;\n\nimport com.alibaba.wireless.security.framework.IRouterComponent;\nimport com.taobao.wireless.security.adapter.JNICLibrary;\n \npublic class a implements IRouterComponent {\n    public a() {\n        super();\n    }\n    public Object doCommand(int arg2, Object[] arg3) {\n        return JNICLibrary.doCommandNative(arg2, arg3);\n    }\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nThere is also the \u003Ci\u003EJNICLibrary\u003C\u002Fi\u003E class, where the native \u003Ci\u003EdoCommandNative\u003C\u002Fi\u003E method is declared:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"java\"\u003Epackage com.taobao.wireless.security.adapter;\n \npublic class JNICLibrary {\n    public static native Object doCommandNative(int arg0, Object[] arg1);\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nSo, we need to find the \u003Ci\u003EdoCommandNative\u003C\u002Fi\u003E method in the native code. That’s where the fun begins.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EMachine code obfuscation\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nThere is one native library in the \u003Ci\u003Elibsgmain.so\u003C\u002Fi\u003E file (which is actually a .JAR file and, like we said above, implements some encryption related interfaces): \u003Ci\u003E\u003Cb\u003Elibsgmainso-6.4.36.so\u003C\u002Fb\u003E\u003C\u002Fi\u003E. We load it in IDA and get a bunch of dialogs with error messages. The problem is that the section header table is invalid. This is done on purpose to complicate the analysis.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002F_k\u002Fbz\u002F5c\u002F_kbz5cbedw6g1jnsj047rtqudli.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F_k\u002Fbz\u002F5c\u002F_kbz5cbedw6g1jnsj047rtqudli.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nBut we don’t really need it anyway. The program header table is enough to correctly load the ELF file and analyze it. So we simply delete the section header table, nulling the corresponding fields in the header.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002F2y\u002Fxh\u002Fvk\u002F2yxhvksp30f016gfyhrlfh0pklc.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F2y\u002Fxh\u002Fvk\u002F2yxhvksp30f016gfyhrlfh0pklc.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThen we open the file in IDA again.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe have two ways to tell the Java virtual machine exactly where the native library contains the implementation of the method declared as native in the Java code. The first is to give it a name like this: \u003Ci\u003EJava_package_name_ClassName_methodName\u003C\u002Fi\u003E. The second one is to register it when loading the library (in the JNI_OnLoad function) by calling the RegisterNatives function. In our case, if you use the first method, the name should be like this: \u003Ci\u003EJava_com_taobao_wireless_security_adapter_JNICLibrary_doCommandNative\u003C\u002Fi\u003E. The list of exported functions doesn’t contain this name, which means we need to look for the RegisterNatives. Thus, we go to the JNI_OnLoad function and see the following:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fm6\u002Fdp\u002Fiw\u002Fm6dpiwaonfuyri-jg8thppcfgqe.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fm6\u002Fdp\u002Fiw\u002Fm6dpiwaonfuyri-jg8thppcfgqe.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWhat’s going on here? At first glance, the beginning and end of the function are typical of the ARM architecture. The first instruction pushes the contents of the registers that the function will use to the stack (in this case, R0, R1, and R2), as well as the contents of the LR register with the function’s return address. The last instruction restores the saved registers and puts the return address to the PC register, thus returning from the function. But if we take a closer look, we may notice that the penultimate instruction changes the return address, stored on the stack. Let’s calculate what it will be when the code is executed. The address 0xB130 loads in R1, has 5 subtracted from it, then is moved to R0 and receives an addition of 0x10. In the end, it equals 0xB13B. Thus, IDA thinks that the final instruction performs a normal function return, while in fact, it performs a transfer to the calculated address 0xB13B.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nNow let us remind you that ARM processors have two modes and two sets of instructions — ARM and Thumb. The low-order bit of the address determines which instruction set the processor will use That is, the address is actually 0xB13A, while the value in the low-order bit indicates the Thumb mode.\u003Cbr\u002F\u003E\r\nA similar “adapter” and some semantic garbage are added to the beginning of each function in this library. But we won’t dwell on them in detail. Just remember that the real beginning of almost all functions is a little further.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nSince no explicit transition to 0xB13A in the code exists, IDA cannot recognize that there is code there. For the same reason, it does not recognize most of the code in the library as code, which makes analyzing a bit trickier. So, we tell IDA that there is code, and this is what happens:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Feq\u002Fwp\u002Fp3\u002Feqwpp3exmqnybi7r_tdvvan4jls.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nStarting from 0xB144, we clearly have the table. But what about sub_494C?\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fbo\u002F9b\u002Frn\u002Fbo9brnkfvauy3ntm2dnucnsxqhs.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWhen calling this function in the LR register, we get the address of the above-mentioned table (0xB144). R0 contains the index in this table. That is, we take the value from the table, add it to LR, and obtain the address we need to go to. Let's try to calculate it: 0xB144 + [0xB144 + 8 * 4] = 0xB144 + 0x120 = 0xB264. We navigate to this address and see a couple of useful instructions, then go to 0xB140:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fnz\u002F95\u002F4x\u002Fnz954xqtjmky6tnpaqeejhvecus.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nNow there will be a transition at offset with the index 0x20 from the table.\u003Cbr\u002F\u003E\r\nJudging by the size of the table, there will be many such transitions in the code. So we would want to deal with this automatically and avoid manually calculating addresses. Thus, scripts and the ability to patch code in IDA come to our rescue:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"python\"\u003Edef put_unconditional_branch(source, destination):\n    offset = (destination - source - 4) \u003E\u003E 1\n    if offset \u003E 2097151 or offset &lt; -2097152:\n        raise RuntimeError(\"Invalid offset\")\n    if offset \u003E 1023 or offset &lt; -1024:\n        instruction1 = 0xf000 | ((offset \u003E\u003E 11) &amp; 0x7ff)\n        instruction2 = 0xb800 | (offset &amp; 0x7ff)\n        patch_word(source, instruction1)\n        patch_word(source + 2, instruction2)\n    else:\n        instruction = 0xe000 | (offset &amp; 0x7ff)\n        patch_word(source, instruction)\n \nea = here()\nif get_wide_word(ea) == 0xb503: #PUSH {R0,R1,LR}\n    ea1 = ea + 2\n    if get_wide_word(ea1) == 0xbf00: #NOP\n        ea1 += 2\n    if get_operand_type(ea1, 0) == 1 and get_operand_value(ea1, 0) == 0 and get_operand_type(ea1, 1) == 2:\n        index = get_wide_dword(get_operand_value(ea1, 1))\n        print \"index =\", hex(index)\n        ea1 += 2\n        if get_operand_type(ea1, 0) == 7:\n            table = get_operand_value(ea1, 0) + 4\n        elif get_operand_type(ea1, 1) == 2:\n            table = get_operand_value(ea1, 1) + 4\n        else:\n            print \"Wrong operand type on\", hex(ea1), \"-\", get_operand_type(ea1, 0), get_operand_type(ea1, 1)\n            table = None\n        if table is None:\n            print \"Unable to find table\"\n        else:\n            print \"table =\", hex(table)\n            offset = get_wide_dword(table + (index &lt;&lt; 2))\n            put_unconditional_branch(ea, table + offset)\n    else:\n        print \"Unknown code\", get_operand_type(ea1, 0), get_operand_value(ea1, 0), get_operand_type(ea1, 1) == 2\nelse:\n    print \"Unable to detect first instruction\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nWe put the cursor on the 0xB26A string, run the script, and see the transition to 0xB4B0:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F52\u002Frf\u002Ffx\u002F52rffxhzmtrfdhfrznsr8dovfim.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAgain, IDA does not recognize this place as code. We help it and see another structure there:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fct\u002Fd9\u002Fkv\u002Fctd9kvewm9l1blmw3pqipi8mnqm.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nInstructions that go after BLX do not appear very meaningful; they are more like some kind of offset. We look at sub_4964:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fo7\u002Fwi\u002F4-\u002Fo7wi4-imrothkr6qpkbrklj40aw.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nIndeed, it takes DWORD at the address from LR, adds it to this address, then takes the value at the resulting address and stores it in the stack. Additionally, it adds 4 to LR to jump this same offset after returning from the function. Then the POP {R1} command takes the resulting value from the stack. Looking at what is located at the address 0xB4BA + 0xEA = 0xB5A4, we can see something similar to the address table:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fev\u002Fhb\u002Fa8\u002Fevhba8ty8dtnv8niuxyfue0nkfk.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nTo patch this structure, we need to get two parameters from the code: the offset and the register number where we want to push the result. We will have to prepare a piece of code in advance for each possible register.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"python\"\u003Epatches = {}\npatches[0] = (0x00, 0xbf, 0x01, 0x48, 0x00, 0x68, 0x02, 0xe0)\npatches[1] = (0x00, 0xbf, 0x01, 0x49, 0x09, 0x68, 0x02, 0xe0)\npatches[2] = (0x00, 0xbf, 0x01, 0x4a, 0x12, 0x68, 0x02, 0xe0)\npatches[3] = (0x00, 0xbf, 0x01, 0x4b, 0x1b, 0x68, 0x02, 0xe0)\npatches[4] = (0x00, 0xbf, 0x01, 0x4c, 0x24, 0x68, 0x02, 0xe0)\npatches[5] = (0x00, 0xbf, 0x01, 0x4d, 0x2d, 0x68, 0x02, 0xe0)\npatches[8] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0x80, 0xd8, 0xf8, 0x00, 0x80, 0x01, 0xe0)\npatches[9] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0x90, 0xd9, 0xf8, 0x00, 0x90, 0x01, 0xe0)\npatches[10] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0xa0, 0xda, 0xf8, 0x00, 0xa0, 0x01, 0xe0)\npatches[11] = (0x00, 0xbf, 0xdf, 0xf8, 0x06, 0xb0, 0xdb, 0xf8, 0x00, 0xb0, 0x01, 0xe0)\n \nea = here()\nif (get_wide_word(ea) == 0xb082 #SUB SP, SP, #8\n        and get_wide_word(ea + 2) == 0xb503): #PUSH {R0,R1,LR}\n    if get_operand_type(ea + 4, 0) == 7:\n        pop = get_bytes(ea + 12, 4, 0)\n        if pop[1] == '\\xbc':\n            register = -1\n            r = get_wide_byte(ea + 12)\n            for i in range(8):\n                if r == (1 &lt;&lt; i):\n                    register = i\n                    break\n            if register == -1:\n                print \"Unable to detect register\"\n            else:\n                address = get_wide_dword(ea + 8) + ea + 8\n                for b in patches[register]:\n                    patch_byte(ea, b)\n                    ea += 1\n                if ea % 4 != 0:\n                    ea += 2\n                patch_dword(ea, address)\n        elif pop[:3] == '\\x5d\\xf8\\x04':\n            register = ord(pop[3]) \u003E\u003E 4\n            if register in patches:\n                address = get_wide_dword(ea + 8) + ea + 8\n                for b in patches[register]:\n                    patch_byte(ea, b)\n                    ea += 1\n                patch_dword(ea, address)\n        else:\n            print \"POP instruction not found\"\n    else:\n        print \"Wrong operand type on +4:\", get_operand_type(ea + 4, 0)\nelse:\n    print \"Unable to detect first instructions\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nWe put the cursor at the beginning of the structure we want to replace (i.e. 0xB4B2) and run the script:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Flv\u002Fmp\u002Foo\u002Flvmpoow5agndjnbbl-t3imyaisq.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Flv\u002Fmp\u002Foo\u002Flvmpoow5agndjnbbl-t3imyaisq.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nIn addition to the already mentioned structures, the code includes the following:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fdk\u002Fnn\u002Frw\u002Fdknnrwaye18zzz0xipny0_gdqfq.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAs in the previous case, there is an offset after the BLX instruction:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Ffn\u002Fbw\u002Fuz\u002Ffnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ffn\u002Fbw\u002Fuz\u002Ffnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe take the offset at the address from LR, add it to LR, and navigate there. 0x72044 + 0xC = 0x72050. The script for this structure is quite simple:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"python\"\u003Edef put_unconditional_branch(source, destination):\n    offset = (destination - source - 4) \u003E\u003E 1\n    if offset \u003E 2097151 or offset &lt; -2097152:\n        raise RuntimeError(\"Invalid offset\")\n    if offset \u003E 1023 or offset &lt; -1024:\n        instruction1 = 0xf000 | ((offset \u003E\u003E 11) &amp; 0x7ff)\n        instruction2 = 0xb800 | (offset &amp; 0x7ff)\n        patch_word(source, instruction1)\n        patch_word(source + 2, instruction2)\n    else:\n        instruction = 0xe000 | (offset &amp; 0x7ff)\n        patch_word(source, instruction)\n \n \nea = here()\nif get_wide_word(ea) == 0xb503: #PUSH {R0,R1,LR}\n    ea1 = ea + 6\n    if get_wide_word(ea + 2) == 0xbf00: #NOP\n        ea1 += 2\n    offset = get_wide_dword(ea1)\n    put_unconditional_branch(ea, (ea1 + offset) &amp; 0xffffffff)\nelse:\n    print \"Unable to detect first instruction\"\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nThe result of executing the script:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Ftm\u002Ffq\u002Fyo\u002Ftmfqyogtdhbje0atjckosbrgide.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ftm\u002Ffq\u002Fyo\u002Ftmfqyogtdhbje0atjckosbrgide.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAfter we patch everything in this function, we can point the IDA to its real beginning. It will collect the entire function code piece by piece and we’ll be able to decompile it using HexRays.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EDecrypting the strings\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nWe’ve learned how to deal with machine code obfuscation in the \u003Cb\u003E\u003Ci\u003Elibsgmainso-6.4.36.so\u003C\u002Fi\u003E\u003C\u002Fb\u003E library from UC Browser and obtained the function code \u003Ci\u003EJNI_OnLoad\u003C\u002Fi\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eint __fastcall real_JNI_OnLoad(JavaVM *vm)\n{\n  int result; \u002F\u002F r0\n  jclass clazz; \u002F\u002F r0 MAPDST\n  int v4; \u002F\u002F r0\n  JNIEnv *env; \u002F\u002F r4\n  int v6; \u002F\u002F [sp-40h] [bp-5Ch]\n  int v7; \u002F\u002F [sp+Ch] [bp-10h]\n  v7 = *(_DWORD *)off_8AC00;\n  if ( !vm )\n    goto LABEL_39;\n  sub_7C4F4();\n  env = (JNIEnv *)sub_7C5B0(0);\n  if ( !env )\n    goto LABEL_39;\n  v4 = sub_72CCC();\n  sub_73634(v4);\n  sub_73E24(&amp;unk_83EA6, &amp;v6, 49);\n  clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)-\u003EFindClass)(env, &amp;v6);\n  if ( clazz\n    &amp;&amp; (sub_9EE4(),\n        sub_71D68(env),\n        sub_E7DC(env) \u003E= 0\n     &amp;&amp; sub_69D68(env) \u003E= 0\n     &amp;&amp; sub_197B4(env, clazz) \u003E= 0\n     &amp;&amp; sub_E240(env, clazz) \u003E= 0\n     &amp;&amp; sub_B8B0(env, clazz) \u003E= 0\n     &amp;&amp; sub_5F0F4(env, clazz) \u003E= 0\n     &amp;&amp; sub_70640(env, clazz) \u003E= 0\n     &amp;&amp; sub_11F3C(env) \u003E= 0\n     &amp;&amp; sub_21C3C(env, clazz) \u003E= 0\n     &amp;&amp; sub_2148C(env, clazz) \u003E= 0\n     &amp;&amp; sub_210E0(env, clazz) \u003E= 0\n     &amp;&amp; sub_41B58(env, clazz) \u003E= 0\n     &amp;&amp; sub_27920(env, clazz) \u003E= 0\n     &amp;&amp; sub_293E8(env, clazz) \u003E= 0\n     &amp;&amp; sub_208F4(env, clazz) \u003E= 0) )\n  {\n    result = (sub_B7B0(env, clazz) \u003E\u003E 31) | 0x10004;\n  }\n  else\n  {\nLABEL_39:\n    result = -1;\n  }\n  return result;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nLet’s look into the following strings:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003E  sub_73E24(&amp;unk_83EA6, &amp;v6, 49);\n  clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)-\u003EFindClass)(env, &amp;v6);\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nIt’s quite clear that the \u003Ci\u003Esub_73E24\u003C\u002Fi\u003E function decrypts the class name. Parameters of this function contain a pointer to the data that look similar to those encrypted, a kind of buffer, and a number. Obviously, a decrypted string will be in the buffer after a call to the function, since the buffer goes to the \u003Ci\u003EFindClass\u003C\u002Fi\u003E function, which receives the same class name as the second parameter. So the number is the size of the buffer or the length of the string. Let’s try to decrypt the name of the class. It should indicate if we are going in the right direction. Let’s take a closer look at what happens in \u003Ci\u003Esub_73E24\u003C\u002Fi\u003E.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eint __fastcall sub_73E56(unsigned __int8 *in, unsigned __int8 *out, size_t size)\n{\n  int v4; \u002F\u002F r6\n  int v7; \u002F\u002F r11\n  int v8; \u002F\u002F r9\n  int v9; \u002F\u002F r4\n  size_t v10; \u002F\u002F r5\n  int v11; \u002F\u002F r0\n  struc_1 v13; \u002F\u002F [sp+0h] [bp-30h]\n  int v14; \u002F\u002F [sp+1Ch] [bp-14h]\n  int v15; \u002F\u002F [sp+20h] [bp-10h]\n  v4 = 0;\n  v15 = *(_DWORD *)off_8AC00;\n  v14 = 0;\n  v7 = sub_7AF78(17);\n  v8 = sub_7AF78(size);\n  if ( !v7 )\n  {\n    v9 = 0;\n    goto LABEL_12;\n  }\n  (*(void (__fastcall **)(int, const char *, int))(v7 + 12))(v7, \"DcO\u002FlcK+h?m3c*q@\", 16);\n  if ( !v8 )\n  {\nLABEL_9:\n    v4 = 0;\n    goto LABEL_10;\n  }\n  v4 = 0;\n  if ( !in )\n  {\nLABEL_10:\n    v9 = 0;\n    goto LABEL_11;\n  }\n  v9 = 0;\n  if ( out )\n  {\n    memset(out, 0, size);\n    v10 = size - 1;\n    (*(void (__fastcall **)(int, unsigned __int8 *, size_t))(v8 + 12))(v8, in, v10);\n    memset(&amp;v13, 0, 0x14u);\n    v13.field_4 = 3;\n    v13.field_10 = v7;\n    v13.field_14 = v8;\n    v11 = sub_6115C(&amp;v13, &amp;v14);\n    v9 = v11;\n    if ( v11 )\n    {\n      if ( *(_DWORD *)(v11 + 4) == v10 )\n      {\n        qmemcpy(out, *(const void **)v11, v10);\n        v4 = *(_DWORD *)(v9 + 4);\n      }\n      else\n      {\n        v4 = 0;\n      }\n      goto LABEL_11;\n    }\n    goto LABEL_9;\n  }\nLABEL_11:\n  sub_7B148(v7);\nLABEL_12:\n  if ( v8 )\n    sub_7B148(v8);\n  if ( v9 )\n    sub_7B148(v9);\n  return v4;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nThe sub_7AF78 function creates a container instance for byte arrays of the specified size (we will not focus on them in detail). Two such containers are created here: one contains the string \"\u003Cb\u003E\u003Ci\u003EDcO\u002FlcK+h?m3c*q@\u003C\u002Fi\u003E\u003C\u002Fb\u003E\" (it is easy to guess that this is the key), the other has the encrypted data. Both objects are then placed in a certain structure, which transfers to the \u003Ci\u003Esub_6115C\u003C\u002Fi\u003E function. We may also note that this structure contains a field with a value of 3. Let’s see what happens next.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eint __fastcall sub_611B4(struc_1 *a1, _DWORD *a2)\n{\n  int v3; \u002F\u002F lr\n  unsigned int v4; \u002F\u002F r1\n  int v5; \u002F\u002F r0\n  int v6; \u002F\u002F r1\n  int result; \u002F\u002F r0\n  int v8; \u002F\u002F r0\n  *a2 = 820000;\n  if ( a1 )\n  {\n    v3 = a1-\u003Efield_14;\n    if ( v3 )\n    {\n      v4 = a1-\u003Efield_4;\n      if ( v4 &lt; 0x19 )\n      {\n        switch ( v4 )\n        {\n          case 0u:\n            v8 = sub_6419C(a1-\u003Efield_0, a1-\u003Efield_10, v3);\n            goto LABEL_17;\n          case 3u:\n            v8 = sub_6364C(a1-\u003Efield_0, a1-\u003Efield_10, v3);\n            goto LABEL_17;\n          case 0x10u:\n          case 0x11u:\n          case 0x12u:\n            v8 = sub_612F4(\n                   a1-\u003Efield_0,\n                   v4,\n                   *(_QWORD *)&amp;a1-\u003Efield_8,\n                   *(_QWORD *)&amp;a1-\u003Efield_8 \u003E\u003E 32,\n                   a1-\u003Efield_10,\n                   v3,\n                   a2);\n            goto LABEL_17;\n          case 0x14u:\n            v8 = sub_63A28(a1-\u003Efield_0, v3);\n            goto LABEL_17;\n          case 0x15u:\n            sub_61A60(a1-\u003Efield_0, v3, a2);\n            return result;\n          case 0x16u:\n            v8 = sub_62440(a1-\u003Efield_14);\n            goto LABEL_17;\n          case 0x17u:\n            v8 = sub_6226C(a1-\u003Efield_10, v3);\n            goto LABEL_17;\n          case 0x18u:\n            v8 = sub_63530(a1-\u003Efield_14);\nLABEL_17:\n            v6 = 0;\n            if ( v8 )\n            {\n              *a2 = 0;\n              v6 = v8;\n            }\n            return v6;\n          default:\n            LOWORD(v5) = 28032;\n            goto LABEL_5;\n        }\n      }\n    }\n  }\n  LOWORD(v5) = -27504;\nLABEL_5:\n  HIWORD(v5) = 13;\n  v6 = 0;\n  *a2 = v5;\n  return v6;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nThe field with the previously assigned value 3 is transitioned as the switch parameter. Let’s take a look at case 3 — parameters that the previous function added to the structure (i.e., the key and the encrypted data) are transitioned to the sub_6364C function. If we look closely at sub_6364C, we can recognize the RC4 algorithm.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nSo we have an algorithm and a key. Let’s try to decrypt the name of the class. This is what we’ve got: com\u002Ftaobao\u002Fwireless\u002Fsecurity\u002Fadapter\u002FJNICLibrary. Brilliant! We are on the right track.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003ECommand tree\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nNow we need to find the call to \u003Ci\u003ERegisterNatives\u003C\u002Fi\u003E, which will point us to the \u003Ci\u003EdoCommandNative\u003C\u002Fi\u003E function. So we look through the functions called from \u003Ci\u003EJNI_OnLoad\u003C\u002Fi\u003E, and find it in \u003Ci\u003Esub_B7B0\u003C\u002Fi\u003E:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eint __fastcall sub_B7F6(JNIEnv *env, jclass clazz)\n{\n  char signature[41]; \u002F\u002F [sp+7h] [bp-55h]\n  char name[16]; \u002F\u002F [sp+30h] [bp-2Ch]\n  JNINativeMethod method; \u002F\u002F [sp+40h] [bp-1Ch]\n  int v8; \u002F\u002F [sp+4Ch] [bp-10h]\n \n  v8 = *(_DWORD *)off_8AC00;\n  decryptString((unsigned __int8 *)&amp;unk_83ED9, (unsigned __int8 *)name, 0x10u);\u002F\u002F doCommandNative\n  decryptString((unsigned __int8 *)&amp;unk_83EEA, (unsigned __int8 *)signature, 0x29u);\u002F\u002F (I[Ljava\u002Flang\u002FObject;)Ljava\u002Flang\u002FObject;\n  method.name = name;\n  method.signature = signature;\n  method.fnPtr = sub_B69C;\n  return ((int (__fastcall *)(JNIEnv *, jclass, JNINativeMethod *, int))(*env)-\u003ERegisterNatives)(env, clazz, &amp;method, 1) \u003E\u003E 31;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nAnd indeed, a native method with the name \u003Ci\u003EdoCommandNative\u003C\u002Fi\u003E is registered here. Now we know its address. Let’s have a look at what it does.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"cpp\"\u003Eint __fastcall doCommandNative(JNIEnv *env, jobject obj, int command, jarray args)\n{\n  int v5; \u002F\u002F r5\n  struc_2 *a5; \u002F\u002F r6\n  int v9; \u002F\u002F r1\n  int v11; \u002F\u002F [sp+Ch] [bp-14h]\n  int v12; \u002F\u002F [sp+10h] [bp-10h]\n  v5 = 0;\n  v12 = *(_DWORD *)off_8AC00;\n  v11 = 0;\n  a5 = (struc_2 *)malloc(0x14u);\n  if ( a5 )\n  {\n    a5-\u003Efield_0 = 0;\n    a5-\u003Efield_4 = 0;\n    a5-\u003Efield_8 = 0;\n    a5-\u003Efield_C = 0;\n    v9 = command % 10000 \u002F 100;\n    a5-\u003Efield_0 = command \u002F 10000;\n    a5-\u003Efield_4 = v9;\n    a5-\u003Efield_8 = command % 100;\n    a5-\u003Efield_C = env;\n    a5-\u003Efield_10 = args;\n    v5 = sub_9D60(command \u002F 10000, v9, command % 100, 1, (int)a5, &amp;v11);\n  }\n  free(a5);\n  if ( !v5 &amp;&amp; v11 )\n    sub_7CF34(env, v11, &amp;byte_83ED7);\n  return v5;\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nThe name suggests that it is the entry point for all functions the developers transferred to the native library. We’re specifically interested in function number 10601.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nFrom the code, we can see that the command number gives us three numbers: command \u002F 10000, command % 10000 \u002F 100, and command % 10 (in our case, 1, 6, and 1). These three numbers, as well as the pointer to JNIEnv and the arguments transferred to the function, make up a structure and are passed on. With these three numbers (we’ll denote them N1, N2, and N3), a command tree is constructed. Something like this:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fxg\u002Fjk\u002Fl1\u002Fxgjkl1uhzmibo-nhmha3kpivf5a.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThe tree is created dynamically in JNI_OnLoad. Three numbers encode the path in the tree. Each leaf of the tree contains the corresponding function’s xorred address. The key is in the parent node. It is quite easy to find a place in the code where the function we need is added to the tree if we understand all the structures there (we won’t spend time describing them in this article).\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EMore obfuscation\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nWe’ve got the address of the function that is supposed to decrypt the traffic: 0x5F1AC. But it’s still too early to relax — the UC Browser developers have another surprise for us.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAfter receiving the parameters from an array in the Java code, we go to the function at 0x4D070. Another type of code obfuscation is already waiting.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe then push two indices in R7 and R4:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F7i\u002Ffx\u002F86\u002F7ifx86mr4yph41jsxukpjqvxmfa.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThe first index moves to R11:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Ffa\u002F62\u002F6j\u002Ffa626jaylcaaewtslff_-byaseo.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Ffa\u002F62\u002F6j\u002Ffa626jaylcaaewtslff_-byaseo.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe use this index to obtain the address from the table:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fco\u002Frk\u002Fs1\u002Fcorks1o2dp75elfvdsxjimrohuo.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAfter transferring to the first address, we use the second index from R4. The table contains 230 elements.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWhat do we do with it? We could tell the IDA that it is a sort of a switch: Edit -\u003E Other -\u003E Specify switch idiom.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002F36\u002Fuu\u002Fxn\u002F36uuxnabf3xesptr8qisxzzfutk.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F36\u002Fuu\u002Fxn\u002F36uuxnabf3xesptr8qisxzzfutk.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThe resulting code is horrendous. However, we can see the call to the familiar \u003Ci\u003Esub_6115C\u003C\u002Fi\u003E function in its tangles:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002F-d\u002Fpt\u002F3a\u002F-dpt3akb_yckinmdheczkktzlem.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F-d\u002Fpt\u002F3a\u002F-dpt3akb_yckinmdheczkktzlem.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThere was the switch parameter with the RC4 decryption in case 3. In this case, the structure that transfers to the function is filled with the parameters transferred to doCommandNative. We recall that we had magicInt there with value 16. We look at the corresponding case and after several transitions, find the code that helps us identify the algorithm.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Frn\u002F_1\u002Fi4\u002Frn_1i4avl8oki83hslk5u19ygoe.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Frn\u002F_1\u002Fi4\u002Frn_1i4avl8oki83hslk5u19ygoe.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nIt’s AES!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe have an algorithm and only need to get its parameters, such as mode, key, and (possibly) the initialization vector (its presence depends on the AES algorithm operation mode). The structure that contains them should be created somewhere before calling the sub_6115C function. But since this part of the code is particularly well obfuscated, we decided to patch the code so all parameters of the decryption function could be dumped into a file.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EPatch\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nIf you don’t want to manually write all the patch code in the assembly language, you can run Android Studio, code a function that receives the same parameters as our decryption function and writes to the file, then copy the resulting code generated by the compiler.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nOur good friends from the UC Browser team also “ensured” the convenience of adding code. We do remember that we have garbage code at the beginning of each function, which can easily be replaced with any other code. Very convenient :) However, there is not enough room at the beginning of the target function for the code that saves all parameters to a file. We had to divide it into parts and use the garbage blocks of neighboring functions. We got four parts in total.\u003Cbr\u002F\u003E\r\nPart one:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fhy\u002Flk\u002Fqr\u002Fhylkqrhqgyei6qjdj6ayvgivpqu.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fhy\u002Flk\u002Fqr\u002Fhylkqrhqgyei6qjdj6ayvgivpqu.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThe first four function parameters in the ARM architecture are indicated in the R0-R3 registers, while the rest, if any, goes via the stack. The LR register indicates the return address. We need to save all this data so the function can work after we dump its parameters. We also need to save all the registers that we use in the process, so we use PUSH.W {R0-R10,LR}. In R7, we get the address of the list of parameters transferred to the function via the stack.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nUsing the fopen function, we open the \u002Fdata\u002Flocal\u002Ftmp\u002Faes file in the “ab” mode (so that we could add something). We then load the file name address in R0 and the string address that indicates the mode in R1. This is where the garbage code ends, so we navigate to the next function. Since we want it to continue working, we put the transition to the actual function code in the beginning, before the garbage, and replace the garbage with the rest of the patch.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F68\u002Fss\u002Fkf\u002F68sskfcymjorl_flpf8mg9wwej4.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe then call fopen.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThe first three parameters of the aes function are of the int type. Since we pushed the registers to the stack at the beginning, we can simply transfer their addresses in the stack to the fwrite function.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fd1\u002Fyt\u002Fiz\u002Fd1ytiz_jx7byflntqxxec2nece0.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fd1\u002Fyt\u002Fiz\u002Fd1ytiz_jx7byflntqxxec2nece0.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nNext, we have three structures that indicate the size of the data and contain a pointer to the data for the key, the initialization vector, and the encrypted data.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"https:\u002F\u002Fhabrastorage.org\u002Fr\u002Fw780q1\u002Fwebt\u002Fme\u002Fvy\u002Fkz\u002Fmevykztpkcwdr6xkpnenauxqccs.jpeg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fme\u002Fvy\u002Fkz\u002Fmevykztpkcwdr6xkpnenauxqccs.jpeg\" data-blurred=\"true\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAt the end, we close the file, restore the registers, and give control back to the actual aes function.\u003Cbr\u002F\u003E\r\nWe compile the APK file with the patched library, sign it, download it onto a device or emulator, and run it. Now we see the dump has been created with a lot of data. The browser does not just decrypt traffic, but other data too, and all decryption is performed via this function. For some reason, we don’t see the data we need, and the request we are expecting is not visible in the traffic. Let’s skip waiting until UC Browser has the chance to make this request and take the encrypted response obtained earlier from the server to patch the application again. We’ll add the decryption to the onCreate of the main activity.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003E    const\u002F16 v1, 0x62\n    new-array v1, v1, [B\n    fill-array-data v1, :encrypted_data\n    const\u002F16 v0, 0x1f\n    invoke-static {v0, v1}, Lcom\u002Fuc\u002Fbrowser\u002Fcore\u002Fd\u002Fc\u002Fg;-\u003Ej(I[B)[B\n    move-result-object v1\n    array-length v2, v1\n    invoke-static {v2}, Ljava\u002Flang\u002FString;-\u003EvalueOf(I)Ljava\u002Flang\u002FString;\n    move-result-object v2\n    const-string v0, \"ololo\"\n    invoke-static {v0, v2}, Landroid\u002Futil\u002FLog;-\u003Ed(Ljava\u002Flang\u002FString;Ljava\u002Flang\u002FString;)I\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\nWe compile it, sign, install, and run. Thus, we get a NullPointerException since the method returns a null value.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nAfter analyzing of the code further, we found a function with rather interesting strings: “META-INF\u002F” and “.RSA”. Looks like the app verifies its certificate, or even generates keys from it. We don’t really want to dig into what is happening with the certificate, so let’s just give it the correct certificate. We’ll patch the encrypted string, so instead of “META-INF\u002F” we get “BLABLINF\u002F”, we create a folder with this name in the APK file, and save the browser certificate in it.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe compile it, sign, install, and run. Bingo! We have the key!\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EMitM\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nNow we’ve got the key and an equal initialization vector. Let’s try to decrypt the server response in the CBC mode.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F9k\u002Fm7\u002Fun\u002F9km7unymy_ybx1lwnflfbqd36ke.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe see the archive URL, something like MD5, “extract_unzipsize”, and a number. Let us check. The MD5 of the archive is the same; the size of the unzipped library is the same. Now we’ll try to patch this library and transmit it to the browser. To show that our patched library has loaded, we’ll build an Intent to create the text message «PWNED!» We’ll replace two responses from the server: \u003Ca href=\"http:\u002F\u002Fpuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\"\u003Epuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\u003C\u002Fa\u003E and the one that prompts the archive download. In the first, we substitute MD5 (the size remains the same after unzipping); in the second, we send the archive with the patched library.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nThe browser makes several attempts to download the archive, resulting in an error. Apparently, something fishy is happening there. Analyzing this bizarre format, we found that the server also transmits the archive size:\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fe2\u002F-v\u002Fua\u002Fe2-vuahng86h0bt0vm84f3xhqrg.png\"\u002F\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nIt is LEB128 encoded. The patch slightly changes the size of the compressed library, so the browser decided that the archive broke upon download and displayed an error after several attempts.\u003Cbr\u002F\u003E\r\nSo we fix the archive size and… voila! :) See the result in the video.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv class=\"oembed\"\u003E\u003Cdiv\u003E\u003Cdiv style=\"left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.2493%;\"\u003E\u003Cdiv class=\"tm-iframe_temp\" data-src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002FNfns7uH03J8?rel=0&amp;showinfo=1&amp;hl=en-US\" data-style=\"border: 0; top: 0; left: 0; width: 100%; height: 100%; position: absolute;\" id=\"\" width=\"\"\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3\u003EConsequences and developer’s response\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\nIn the same way, hackers can use this insecure feature of UC Browser to distribute and launch malicious libraries. These libraries will work in the context of the browser, resulting in full system privileges that the browser has. This grants them free reign to display phishing windows, as well as access to the browser’s working files including logins, passwords, and cookies in the database.\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\nWe contacted the UC Browser developers and informed them about the problem we had found, tried to point out the vulnerability and its danger, but they refused to discuss the matter. Meanwhile, the browser with the dangerous function remained in plain sight. Though as soon as we revealed the details of the vulnerability, it was impossible to ignore it as before. A new version of UC Browser 12.10.9.1193 was released on March 27, which accessed the server via HTTPS \u003Ca href=\"https:\u002F\u002Fpuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\"\u003Epuds.ucweb.com\u002Fupgrade\u002Findex.xhtml\u003C\u002Fa\u003E. In addition, between the “bug fixing” and the time we wrote this article, an attempt to open a PDF in the browser resulted in an error message with the text, “Oops, something is wrong.” There was no request to the server when trying to open the PDF file. This was performed upon startup, though, which is a sign that the ability to download the executable code in violation of Google Play policies is still present.\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"UC Browser"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452076\u002F7bcd7451e10f6276c67c858c7a79d2d8\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F452076\u002F7bcd7451e10f6276c67c858c7a79d2d8\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fen\\\u002Fcompany\\\u002Fdrweb\\\u002Fblog\\\u002F452076\\\u002F\"},\"headline\":\"Breaking UC Browser\",\"datePublished\":\"2019-05-16T10:39:48+03:00\",\"dateModified\":\"2019-05-17T13:02:52+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"doctorweb\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Introduction At the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fen\\\u002Fcompany\\\u002Fdrweb\\\u002Fblog\\\u002F452076\\\u002F#post-content-body\",\"about\":[\"c_drweb\",\"h_browsers\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fke\\\u002Fe0\\\u002Frd\\\u002Fkee0rdupth-kalljz9gfxpjndnk.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fj0\\\u002Fi1\\\u002Fc1\\\u002Fj0i1c1n_nwf_gnauzbudnqor5oi.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fgo\\\u002Ftj\\\u002Ftz\\\u002Fgotjtzkpg2owfmk8jrnznox_vdg.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fg5\\\u002F7k\\\u002Fiv\\\u002Fg57kivkwrysmcqvptmhclqzzipq.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F6r\\\u002Flt\\\u002Fns\\\u002F6rltnsrtyd-_5ekwis68qn-vydc.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F_k\\\u002Fbz\\\u002F5c\\\u002F_kbz5cbedw6g1jnsj047rtqudli.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F2y\\\u002Fxh\\\u002Fvk\\\u002F2yxhvksp30f016gfyhrlfh0pklc.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fm6\\\u002Fdp\\\u002Fiw\\\u002Fm6dpiwaonfuyri-jg8thppcfgqe.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Feq\\\u002Fwp\\\u002Fp3\\\u002Feqwpp3exmqnybi7r_tdvvan4jls.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fbo\\\u002F9b\\\u002Frn\\\u002Fbo9brnkfvauy3ntm2dnucnsxqhs.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fnz\\\u002F95\\\u002F4x\\\u002Fnz954xqtjmky6tnpaqeejhvecus.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F52\\\u002Frf\\\u002Ffx\\\u002F52rffxhzmtrfdhfrznsr8dovfim.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fct\\\u002Fd9\\\u002Fkv\\\u002Fctd9kvewm9l1blmw3pqipi8mnqm.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fo7\\\u002Fwi\\\u002F4-\\\u002Fo7wi4-imrothkr6qpkbrklj40aw.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fev\\\u002Fhb\\\u002Fa8\\\u002Fevhba8ty8dtnv8niuxyfue0nkfk.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Flv\\\u002Fmp\\\u002Foo\\\u002Flvmpoow5agndjnbbl-t3imyaisq.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fdk\\\u002Fnn\\\u002Frw\\\u002Fdknnrwaye18zzz0xipny0_gdqfq.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ffn\\\u002Fbw\\\u002Fuz\\\u002Ffnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ftm\\\u002Ffq\\\u002Fyo\\\u002Ftmfqyogtdhbje0atjckosbrgide.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fxg\\\u002Fjk\\\u002Fl1\\\u002Fxgjkl1uhzmibo-nhmha3kpivf5a.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F7i\\\u002Ffx\\\u002F86\\\u002F7ifx86mr4yph41jsxukpjqvxmfa.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Ffa\\\u002F62\\\u002F6j\\\u002Ffa626jaylcaaewtslff_-byaseo.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fco\\\u002Frk\\\u002Fs1\\\u002Fcorks1o2dp75elfvdsxjimrohuo.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F36\\\u002Fuu\\\u002Fxn\\\u002F36uuxnabf3xesptr8qisxzzfutk.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F-d\\\u002Fpt\\\u002F3a\\\u002F-dpt3akb_yckinmdheczkktzlem.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Frn\\\u002F_1\\\u002Fi4\\\u002Frn_1i4avl8oki83hslk5u19ygoe.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fhy\\\u002Flk\\\u002Fqr\\\u002Fhylkqrhqgyei6qjdj6ayvgivpqu.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F68\\\u002Fss\\\u002Fkf\\\u002F68sskfcymjorl_flpf8mg9wwej4.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fd1\\\u002Fyt\\\u002Fiz\\\u002Fd1ytiz_jx7byflntqxxec2nece0.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fme\\\u002Fvy\\\u002Fkz\\\u002Fmevykztpkcwdr6xkpnenauxqccs.jpeg\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F9k\\\u002Fm7\\\u002Fun\\\u002F9km7unymy_ybx1lwnflfbqd36ke.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fe2\\\u002F-v\\\u002Fua\\\u002Fe2-vuahng86h0bt0vm84f3xhqrg.png\"]}","metaDescription":"Introduction\r\nAt the end of March we reported on the hidden potential to download and run unverified code in UC Browser. Today we will examine in detail how it happens and how hackers can use...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":""},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{"drweb":{"alias":"drweb","imageUrl":"\u002F\u002Fhabrastorage.org\u002Fgetpro\u002Fhabr\u002Fcompany\u002F002\u002F8a7\u002Fc16\u002F0028a7c16cc021fea7f86c13e082f507.gif","titleHtml":"Доктор Веб","descriptionHtml":null,"relatedData":null,"statistics":{"postsCount":39,"newsCount":1,"vacanciesCount":0,"employeesCount":17,"careerRating":null,"subscribersCount":705,"rating":53.82,"invest":null},"foundationDate":{"year":"2003","month":"12","day":"22"},"location":{"city":null,"region":null,"country":{"id":"168","title":"Россия"}},"siteUrl":"http:\u002F\u002Fwww.drweb.ru\u002F","staffNumber":"Неизвестно","registrationDate":"2008-08-09T07:42:52+00:00","representativeUser":null,"contacts":[],"settings":{"analyticsSettings":[],"branding":null,"status":"active"},"metadata":{"titleHtml":"Доктор Веб, Россия -  с 22 декабря 2003 г.","title":"Доктор Веб, Россия -  с 22 декабря 2003 г.","keywords":["Информационная безопасность","Антивирусная защита","Реверс-инжиниринг","IT-инфраструктура"],"descriptionHtml":"39 статей от авторов компании Доктор Веб","description":"39 статей от авторов компании Доктор Веб"},"aDeskSettings":null,"careerAlias":"drweb","maxCustomTrackerLinks":0}},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
