<!DOCTYPE html>
<html lang="ru" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22ru%22%7D%7D">
<head >
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Swift under the hood: Generic implementation / Хабр</title>
  <style>
    /* cyrillic-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSxf6TF0.woff2) format('woff2');
      unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
    }

    /* cyrillic */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveQhf6TF0.woff2) format('woff2');
      unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
    }

    /* latin-ext */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveSBf6TF0.woff2) format('woff2');
      unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
    }

    /* latin */
    @font-face {
      font-family: 'Fira Sans';
      font-style: normal;
      font-weight: 500;
      font-display: swap;
      src: url(https://fonts.gstatic.com/s/firasans/v11/va9B4kDNxMZdWfMOD5VnZKveRhf6.woff2) format('woff2');
      unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
    }
  </style>
  <link rel="preload" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" as="script"><link rel="preload" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css" as="style"><link rel="preload" href="https://assets.habr.com/habr-web/js/app.c0af73e7.js" as="script">
  <link rel="stylesheet" href="https://assets.habr.com/habr-web/css/chunk-vendors.e7843cc0.css"><link rel="stylesheet" href="https://assets.habr.com/habr-web/css/app.02ee25a4.css">
  <script>window.i18nFetch = new Promise((res, rej) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', '/js/i18n/ru-compiled.85eb77f0b17c8235e7b64b9f81ea5ec2.json');
          xhr.responseType = 'json';
          xhr.onload = function(e) {
            if (this.status === 200) {
              res({ru: xhr.response});
            } else {
              rej(e);
            }
          };
          xhr.send();
        });</script>
  
  <script data-vue-meta="ssr" src="/js/ads.js" onload="window['zhY4i4nJ9K'] = true" data-vmid="checkad"></script><script data-vue-meta="ssr" type="application/ld+json" data-vmid="ldjson-schema">{"@context":"http:\/\/schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/habr.com\/ru\/post\/451704\/"},"headline":"Swift under the hood: Generic implementation","datePublished":"2019-05-14T08:38:24+03:00","dateModified":"2019-07-05T16:18:45+03:00","author":{"@type":"Person","name":"Nekitosss"},"publisher":{"@type":"Organization","name":"Habr","logo":{"@type":"ImageObject","url":"https:\/\/habrastorage.org\/webt\/a_\/lk\/9m\/a_lk9mjkccjox-zccjrpfolmkmq.png"}},"description":"Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write...","url":"https:\/\/habr.com\/ru\/post\/451704\/#post-content-body","about":["h_ios_dev","h_mobile_dev","h_swift","f_develop"],"image":["https:\/\/habrastorage.org\/webt\/ac\/l5\/dh\/acl5dhtdca3tl80zbott4turszy.gif","https:\/\/habrastorage.org\/webt\/-a\/lw\/p-\/-alwp-gdushiyhqxgfch2iyppj8.gif","https:\/\/habrastorage.org\/webt\/wt\/4g\/0y\/wt4g0yxc0ang-ityxpwxr9wrelg.png","https:\/\/habrastorage.org\/webt\/ay\/ts\/j1\/aytsj1ykoyhd0o38wpi1owignwo.png"]}</script>
  <script src="//www.googletagservices.com/tag/js/gpt.js" async></script>
  <style>.grecaptcha-badge{visibility: hidden;}</style>
  <meta name="habr-version" content="2.49.0">
  
  <meta data-vue-meta="ssr" property="fb:app_id" content="444736788986613"><meta data-vue-meta="ssr" property="fb:pages" content="472597926099084"><meta data-vue-meta="ssr" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" name="twitter:site" content="@habr_eng"><meta data-vue-meta="ssr" property="og:title" content="Swift under the hood: Generic implementation" data-vmid="og:title"><meta data-vue-meta="ssr" name="twitter:title" content="Swift under the hood: Generic implementation" data-vmid="twitter:title"><meta data-vue-meta="ssr" name="aiturec:title" content="Swift under the hood: Generic implementation" data-vmid="aiturec:title"><meta data-vue-meta="ssr" name="description" content="Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses..." data-vmid="description"><meta data-vue-meta="ssr" itemprop="description" content="Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses..." data-vmid="description:itemprop"><meta data-vue-meta="ssr" property="og:description" content="Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses..." data-vmid="og:description"><meta data-vue-meta="ssr" name="twitter:description" content="Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses..." data-vmid="twitter:description"><meta data-vue-meta="ssr" property="aiturec:description" content="Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses..." data-vmid="aiturec:description"><meta data-vue-meta="ssr" itemprop="image" content="https://habr.com/share/publication/451704/081154b4a6b02adecac9aa58b8595110/" data-vmid="image:itemprop"><meta data-vue-meta="ssr" property="og:image" content="https://habr.com/share/publication/451704/081154b4a6b02adecac9aa58b8595110/" data-vmid="og:image"><meta data-vue-meta="ssr" property="aiturec:image" content="https://habr.com/share/publication/451704/081154b4a6b02adecac9aa58b8595110/" data-vmid="aiturec:image"><meta data-vue-meta="ssr" name="twitter:image" content="https://habr.com/share/publication/451704/081154b4a6b02adecac9aa58b8595110/" data-vmid="twitter:image"><meta data-vue-meta="ssr" property="vk:image" content="https://habr.com/share/publication/451704/081154b4a6b02adecac9aa58b8595110/" data-vmid="vk:image"><meta data-vue-meta="ssr" property="aiturec:item_id" content="451704" data-vmid="aiturec:item_id"><meta data-vue-meta="ssr" property="aiturec:datetime" content="2019-05-14T05:38:24.000Z" data-vmid="aiturec:datetime"><meta data-vue-meta="ssr" property="og:type" content="article" data-vmid="og:type"><meta data-vue-meta="ssr" property="og:locale" content="ru_RU" data-vmid="og:locale"><meta data-vue-meta="ssr" property="og:image:width" content="1200" data-vmid="og:image:width"><meta data-vue-meta="ssr" property="og:image:height" content="630" data-vmid="og:image:height">
  <link data-vue-meta="ssr" href="https://habr.com/ru/rss/post/451704/?fl=ru" type="application/rss+xml" title="" rel="alternate" name="rss"><link data-vue-meta="ssr" href="https://habr.com/ru/post/451704/" rel="canonical" data-vmid="canonical"><link data-vue-meta="ssr" data-vmid="hreflang"><link data-vue-meta="ssr" image_src="image" href="https://habr.com/share/publication/451704/081154b4a6b02adecac9aa58b8595110/" data-vmid="image:href">
  <meta name="apple-mobile-web-app-status-bar-style" content="#303b44">
  <meta name="msapplication-TileColor" content="#629FBC">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="16x16"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-16.png"
  >
  <link
    rel="shortcut icon"
    type="image/png"
    sizes="32x32"
    href="https://assets.habr.com/habr-web/img/favicons/favicon-32.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="76x76"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-76.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="120x120"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="152x152"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-152.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="180x180"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-180.png"
  >
  <link
    rel="apple-touch-icon"
    type="image/png"
    sizes="256x256"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-256.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1136x640.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2436x1125.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1792x828.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_828x1792.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1334x750.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2208x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1125x2436.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1242x2208.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2732x2048.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2688x1242.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2224x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_750x1334.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x2732.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2388x1668.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2224.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_640x1136.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1668x2388.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_2048x1536.png"
  >
  <link
    rel="apple-touch-startup-image"
    media="screen and (device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"
    href="https://assets.habr.com/habr-web/img/splashes/splash_1536x2048.png"
  >
  <link
    rel="mask-icon"
    color="#77a2b6"
    href="https://assets.habr.com/habr-web/img/favicons/apple-touch-icon-120.svg"
  >
  <link
    crossorigin="use-credentials"
    href="/manifest.webmanifest"
    rel="manifest"
  >
</head>
<body>


<div id="app" data-server-rendered="true" data-async-called="true"><div class="tm-layout__wrapper"><!----> <div></div> <!----> <header class="tm-header"><div class="tm-page-width"><div class="tm-header__container"><!----> <span class="tm-header__logo-wrap"><a href="/ru/" class="tm-header__logo tm-header__logo_ru"><svg height="16" width="16" class="tm-svg-img tm-header__icon"><title>Хабр</title> <use xlink:href="/img/habr-logo-ru.svg#logo"></use></svg></a> <span class="tm-header__beta-sign" style="display:none;">β</span></span> <div class="tm-dropdown tm-header__projects"><div class="tm-dropdown__head"><button class="tm-header__dropdown-toggle"><svg height="16" width="16" class="tm-svg-img tm-header__icon tm-header__icon_dropdown"><title>Открыть список</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#arrow-down"></use></svg></button></div> <!----></div> <a href="/ru/sandbox/start/" class="tm-header__become-author-btn">
            Как стать автором
          </a> <div class="tm-feature tm-header__feature tm-feature_variant-inline"><!----></div> <!----> <!----></div></div></header> <div class="tm-layout"><div class="tm-page-progress-bar"></div> <div data-menu-sticky="true" class="tm-base-layout__header tm-base-layout__header_is-sticky"><div class="tm-page-width"><div class="tm-base-layout__header-wrapper"><div class="tm-main-menu"><div class="tm-main-menu__section"><nav class="tm-main-menu__section-content"><!----> <a href="/ru/all/" class="tm-main-menu__item">
        Все потоки
      </a> <a href="/ru/flows/develop/" class="tm-main-menu__item">
          Разработка
        </a><a href="/ru/flows/admin/" class="tm-main-menu__item">
          Администрирование
        </a><a href="/ru/flows/design/" class="tm-main-menu__item">
          Дизайн
        </a><a href="/ru/flows/management/" class="tm-main-menu__item">
          Менеджмент
        </a><a href="/ru/flows/marketing/" class="tm-main-menu__item">
          Маркетинг
        </a><a href="/ru/flows/popsci/" class="tm-main-menu__item">
          Научпоп
        </a></nav></div></div> <div class="tm-header-user-menu tm-base-layout__user-menu"><a href="/ru/search/" class="tm-header-user-menu__item tm-header-user-menu__search"><svg height="24" width="24" class="tm-svg-img tm-header-user-menu__icon tm-header-user-menu__icon_search tm-header-user-menu__icon_dark"><title>Поиск</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#search"></use></svg></a> <!----> <!----> <!----> <div class="tm-header-user-menu__item tm-header-user-menu__user_desktop"><div class="tm-dropdown"><div class="tm-dropdown__head"><svg height="24" width="24" data-test-id="menu-toggle-guest" class="tm-svg-img tm-header-user-menu__icon"><title>Профиль</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#header-user"></use></svg> <!----></div> <!----></div> <!----></div> <!----></div></div></div></div> <!----> <div class="tm-page-width"></div> <main class="tm-layout__container"><div hl="ru" data-async-called="true" class="tm-page"><div class="tm-page-width"><!----> <div class="tm-page__wrapper"><div class="tm-page__main tm-page__main_has-sidebar"><div class="pull-down"><div class="pull-down__header" style="height:0px;"><div class="pull-down__content" style="bottom:10px;"><svg height="24" width="24" class="tm-svg-img pull-down__arrow"><title>Обновить</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#pull-arrow"></use></svg></div></div> <div class="tm-article-presenter"> <div class="tm-article-presenter__body"><div class="tm-misprint-area"><div class="tm-misprint-area__wrapper"><article class="tm-article-presenter__content tm-article-presenter__content_narrow"><div class="tm-article-presenter__header"> <div class="tm-article-snippet tm-article-presenter__snippet"><div class="tm-article-snippet__meta-container"><div class="tm-article-snippet__meta"><span class="tm-user-info tm-article-snippet__author"><a href="/ru/users/Nekitosss/" title="Nekitosss" class="tm-user-info__userpic"><div class="tm-entity-image"><svg height="24" width="24" class="tm-svg-img tm-image-placeholder tm-image-placeholder_green"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <span class="tm-user-info__user"><a href="/ru/users/Nekitosss/" class="tm-user-info__username">
      Nekitosss
    </a> </span></span> <span class="tm-article-snippet__datetime-published"><time datetime="2019-05-14T05:38:24.000Z" title="2019-05-14, 08:38">14  мая  2019 в 08:38</time></span></div> <!----></div> <h1 lang="ru" class="tm-article-snippet__title tm-article-snippet__title_h1"><span>Swift under the hood: Generic implementation</span></h1> <div class="tm-article-snippet__hubs"><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/ios_dev/" class="tm-article-snippet__hubs-item-link"><span>Разработка под iOS</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/mobile_dev/" class="tm-article-snippet__hubs-item-link"><span>Разработка мобильных приложений</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span><span class="tm-article-snippet__hubs-item"><a href="/ru/hub/swift/" class="tm-article-snippet__hubs-item-link"><span>Swift</span> <span title="Профильный хаб" class="tm-article-snippet__profiled-hub">*</span></a></span></div> <!----> <!----> <!----></div></div> <!----> <div data-gallery-root="" lang="ru" class="tm-article-body"><div id="post-content-body" class="article-formatted-body article-formatted-body_version-1"><div xmlns="http://www.w3.org/1999/xhtml"><blockquote>Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses its intent in a clear, abstracted manner. — <strong>Swift docs</strong></blockquote><p>Каждый, кто писал на Swift использовал дженерики. <code>Array</code>, <code>Dictionary</code>, <code>Set</code> — самые базовые варианты использования дженериков из стандартной библиотеке. Как они представлены внутри? Расмотрим, как данная основополагающая возможность языка реализована инженерами Apple. </p><a name="habracut"></a><br/>
<p>Дженериковые параметры могут быть как ограничены протоколами, так и не ограничены, хотя, в основном, дженерики используются совместно с протоколами, которые описывают, что именно можно делать с параметрами метода или полями типа.</p><br/>
<p>Для реализации дженериков Swift использует два подхода:</p><br/>
<ol>
<li>Runtime-way — generic код является обёрткой (Boxing).</li>
<li>Compiletime-way — generic код преобразуется в код конкретного типа для оптимизации (Specialization).</li>
</ol><br/>
<h2 id="boxing">Boxing</h2><br/>
<p>Рассмотрим простой метод с неограниченным протоколом дженериковым параметром:</p><br/>
<pre><code class="swift">func test&lt;T>(value: T) -> T {
    let copy = value
    print(copy)
    return copy
}</code></pre><br/>
<p>Компилятор swift создаёт один единственный блок кода, который будет вызываться для работы с любым <code>&lt;T></code>. То есть, независимо от того, напишем мы <code>test(value: 1)</code> или <code>test(value: "Hello")</code>, будет вызван один и тот же код и дополнительно в метод будет передана информация о типе <code>&lt;T></code>, содержащая в себе всё необходимое.</p><br/>
<p>Мало что можно сделать с такими неограниченными протоколами параметрами, но, уже для реализации этого метода, необходимо знать, как копировать параметр, необходимо знать его размер, чтобы выделить под него память в рантайме, необходимо знать, как его уничтожать, когда параметр уходит из области видимости. Для хранения этой информации используется <code>Value Witness Table</code> (<code>VWT</code>). <code>VWT</code> создаётся на этапе компиляции для всех типов и компилятор гарантирует, что в рантайме будет именно такой лэйаут объекта. Напомню, что структуры в Swift передаются по значению, а классы по ссылке, поэтому для <code>let copy = value</code> при <code>T == MyClass</code> и <code>T == MyStruct</code> будут сделаны разные вещи.</p><br/>
<div style="text-align:center;"><img src="/img/image-loader.svg" alt="Value witness table" data-src="https://habrastorage.org/webt/ac/l5/dh/acl5dhtdca3tl80zbott4turszy.gif"/></div><br/>
<p>То есть, вызов метода <code>test</code> с передачей туда объявленной структуры будет в итоге выглядеть примерно так:</p><br/>
<pre><code class="swift">// Приблизительный псевдокод, параметр metadata добавляется компилятором
let myStruct = MyStruct()
test(value: myStruct, metadata: MyStruct.metadata)</code></pre><br/>
<p>Вещи становятся чуть сложнее, когда <code>MyStruct</code> сама является дженериковой структурой и принимает вид <code>MyStruct&lt;T></code>. В зависимости от <code>&lt;T></code> внутри <code>MyStruct</code>, метаданные и <code>VWT</code> будут разными для типов <code>MyStruct&lt;Int></code> и <code>MyStruct&lt;Bool></code>. Это два разных типа в рантайме. Но создавать метаданные для каждой возможной комбинации <code>MyStruct</code> и <code>T</code> крайне неэффективно, поэтому Swift идёт другим путём и для таких случаев конструирует метаданные в рантайме на ходу. Компилятором создаётся один metadata pattern для дженериковой структуры, который можно комбинировать с конкретным типом и, в итоге, получать полную информацию по типу в рантайме с корректной <code>VWT</code>.</p><br/>
<pre><code class="swift">// Опять же псевдокод, параметр metadata добавляется компилятором
func test&lt;T>(value: MyStruct&lt;T>, tMetadata: T.Type) {
    // Комбинируем информацию и получаем итоговые метаданные
    let myStructMetadata = get_generic_metadata(MyStruct.metadataPattern, tMetadata)
    ...
}

let myStruct = MyStruct&lt;Int>()
test(value: myStruct) // Исходный код
test(value: myStruct, tMetadata: Int.metadata) // Примерно вот в это компилируется</code></pre><br/>
<p>Когда мы комбинируем информацию, мы получаем метаданные, с которыми можно работать (копировать, перемещать, уничтожать).</p><br/>
<p>Всё ещё немного сложнее, когда на дженерики добавляются ограничения в виде протоколов. К примеру, ограничим <code>&lt;T></code> протоколом <code>Equatable</code>. Пусть это будет очень простой метод, который сравнивает два переданных аргумента. Получится просто обёртка над методом сравнения.</p><br/>
<pre><code class="swift">func isEquals&lt;T: Equatable>(first: T, second: T) -> Bool {
    return first == second
}</code></pre><br/>
<p>Для правильной работы программы необходимо иметь указатель на метод сравнения <code>static func ==(lhs:T, rhs:T)</code>. Как его получить? Очевидно, что передачи <code>VWT</code> не хватит, она не содержит этой информации. Для решения этой проблемы существует <code>Protocol Witness Table</code> или <code>PWT</code>. Эта табличка похожа на <code>VWT</code> и создаётся на этапе компиляции для протоколов и описывает эти протоколы.</p><br/>
<pre><code class="swift">isEquals(first: 1, second: 2) // Исходный код

// Примерно во что превращается
isEquals(first: 1, // 1
         second: 2,
         metadata: Int.metadata, // 2
         intIsEquatable: Equatable.witnessTable) // 3</code></pre><br/>
<ol>
<li>Передаются два аргумента</li>
<li>Передаём метаданные для <code>Int</code>, чтобы можно было копировать/перемещать/уничтожать объекты</li>
<li>Передаём информацию и том, что <code>Int</code> реализует <code>Equatable</code>.</li>
</ol><br/>
<p>Если бы ограничение требовало реализации ещё одного протокола, к примеру, <code>T: Equatable &amp; MyProtocol</code>, то информация о <code>MyProtocol</code> добавилась бы следующим параметром:</p><br/>
<pre><code class="swift">isEquals(...,
        intIsEquatable: Equatable.witnessTable,
        intIsMyProtocol: MyProtocol.witnessTable)</code></pre><br/>
<p>Использование обёрток для реализации дженериков позволяет гибко реализовывать все необходимые фичи, но имеет оверхед, который можно оптимизировать.</p><br/>
<h2 id="specializaciya-dzhenerikov">Специализация дженериков</h2><br/>
<p>Чтобы устранить излишнюю необходимость получения информации во время выполнения программы, был использован так называемый подход специализации дженериков. Он позволяет заменить дженериковую обёртку конкретным типом с конкретной реализацией. К примеру, для двух вызовов <code>isEquals(first: 1, second: 2)</code> и <code>isEquals(first: "Hello", second: "world")</code>, помимо основной "обёрточной" реализации, будут скомпилированы две дополнительные абсолютно разные версии метода для <code>Int</code> и для <code>String</code>.</p><br/>
<h3 id="ishodnyy-kod">Исходный код</h3><br/>
<p>Для начала создадим <em>generic.swift</em> файл и напишем небольшую generic функцию, которую будем рассматривать.</p><br/>
<pre><code class="swift">func isEquals&lt;T: Equatable>(first: T, second: T) -> Bool {
    return first == second
}
isEquals(first: 10, second: 11)</code></pre><br/>
<p>Теперь необходимо понять, во что это в итоге превращается компилятором.<br/>
Это можно наглядно посмотреть, скомпилировав наш <em>.swift</em> файл в <em>Swift Intermediate Language</em> или <code>SIL</code>.</p><br/>
<h4 id="nemnogo-o-sil-i-processe-kompilyacii">Немного о SIL и процессе компиляции</h4><br/>
<p><code>SIL</code> является результатом одним из нескольких этапов компиляции swift.</p><br/>
<div style="text-align:center;"><img src="/img/image-loader.svg" alt="Compiler pipeline" data-src="https://habrastorage.org/webt/-a/lw/p-/-alwp-gdushiyhqxgfch2iyppj8.gif"/></div><br/>
<p>Исходный код <em>.swift передаеётся Lexer, который создаёт абстрактное синтаксическое дерево (<code>AST</code>) языка, на основе которого проводится проверка типов и семантический анализ кода. SilGen преобразует <code>AST</code> в <code>SIL</code>, называемый <code>raw SIL</code>, на основе которого происходит оптимизация кода и получается оптимизированный <code>canonical SIL</code>, который передаётся в <code>IRGen</code> для преобразования в <code>IR</code> — специальный формат, понятный <code>LLVM</code>, который будет преобразован в `</em>.o<code>файлы, собранные под конкретную архитектуру процессора. Во что превращается наш дженериковый код можно посмотреть как раз на этапе создания</code>SIL`.</p><br/>
<h3 id="i-snova-k-dzhenerikam">И снова к дженерикам</h3><br/>
<p>Создадим <code>SIL</code> файл из нашего исходного кода.</p><br/>
<pre><code class="plaintext">swiftc generic.swift -O -emit-sil -o generic-sil.s</code></pre><br/>
<p>Получим новый файл с расширением <code>*.s</code>. Заглянув вовнутрь, мы увидим гораздо менее читаемый код, чем исходный, но, всё равно, относительно понятный.</p><br/>
<div style="text-align:center;"><img src="/img/image-loader.svg" alt="Raw SIL" data-src="https://habrastorage.org/webt/wt/4g/0y/wt4g0yxc0ang-ityxpwxr9wrelg.png"/></div><br/>
<p>Найдём строку с комментарием <code>// isEquals&lt;A>(first:second:)</code>. Это и есть начало описания нашего метода. Заканчивается он комментарием <code>// end sil function '$s4main8isEquals5first6secondSbx_xtSQRzlF'</code>. У вас название может немного отличаться. Немного разберём описание метода.</p><br/>
<ul>
<li><code>%0</code> и <code>%1</code> на 21 строке являются <code>first</code> и <code>second</code> параметрами соответственно</li>
<li>На 24 строке получаем информацию о типе и передаём в <code>%4</code></li>
<li>На 25 строке получаем указатель на метод сравнения из информации о типе</li>
<li>на 26 строке Вызываем метод по указателю, передавая ему оба параметра и информацию о типе</li>
<li>На 27 строке отдаём результат.</li>
</ul><br/>
<p>В итоге мы видим: чтобы выполнить необходимые действия в реализации дженерикового метода, нам нужно во время выполнения программы получать информацию из описания типа <code>&lt;T></code>.</p><br/>
<p>Перейдём непосредственно к специализации.</p><br/>
<p>В скомпилированном <code>SIL</code> файле сразу после объявления общего метода <code>isEquals</code> следует объявление специализированного для типа <code>Int</code>.</p><br/>
<br/>
<div style="text-align:center;"><img src="/img/image-loader.svg" alt="Specialized SIL" data-src="https://habrastorage.org/webt/ay/ts/j1/aytsj1ykoyhd0o38wpi1owignwo.png"/></div><br/>
<p>На 39 строке вместо получения метода в рантайме из информации о типе сразу вызывается метод сравнения целых чисел <code>"cmp_eq_Int64"</code>.</p><br/>
<p>Чтобы метод "специализировался", необходимо <a href="https://github.com/apple/swift/blob/master/docs/OptimizationTips.rst#enabling-optimizations">включить оптимизацию</a>. Также, необходимо знать, что</p><br/>
<blockquote>The optimizer can only perform specialization if the definition of the generic declaration is visible in the current Module (<a href="https://github.com/apple/swift/blob/master/docs/OptimizationTips.rst#advice-put-generic-declarations-in-the-same-module-where-they-are-used">Источник</a>)</blockquote><p>То есть, метод не может быть специализирован между разными модулями Swift (например, дженериковый метод из Cocoapods библиотеки). Исключением является стандартная библиотека Swift, в которой такие базовые типы, как <code>Array</code>, <code>Set</code> и <code>Dictionary</code>. Все дженерики базовой библиотеки специализируются в конкретные типы.</p><br/>
<p><strong>Note:</strong> В Swift 4.2 были реализованы аттрибуты <code>@inlinable</code> и <code>@usableFromInline</code>, которые позволяют оптимизатору видеть тела методов из других модулей и вроде как есть возможность их специализировать, но данное поведение мной не тестировалось (<a href="https://github.com/apple/swift-evolution/blob/master/proposals/0193-cross-module-inlining-and-specialization.md">Источник</a>)</p><br/>
<h3 id="ssylki">Ссылки</h3><br/>
<ol>
<li><a href="https://github.com/apple/swift/blob/master/docs/Generics.rst">Описание дженериков</a></li>
<li><a href="https://github.com/apple/swift/blob/master/docs/OptimizationTips.rst">Оптимизация в Swift</a></li>
<li><a href="https://www.youtube.com/watch?v=ctS8FzqcRug">Более подробная и глубокая презентация по теме</a></li>
<li><a href="https://nekitosss.github.io/2019-05-12-swift-generics/">Статья на английском</a></li>
</ol></div></div> <!----> <!----></div> <div class="tm-article-presenter__meta"><div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Теги:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5BiOS%5D" class="tm-tags-list__link">iOS</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bswift%5D" class="tm-tags-list__link">swift</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bgenerics%5D" class="tm-tags-list__link">generics</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Bspecialization%5D" class="tm-tags-list__link">specialization</a></li><li class="tm-separated-list__item"><a href="/ru/search/?target_type=posts&amp;order=relevance&amp;q=%5Boptimization%5D" class="tm-tags-list__link">optimization</a></li></ul></div> <div class="tm-separated-list tm-article-presenter__meta-list"><span class="tm-separated-list__title">Хабы:</span> <ul class="tm-separated-list__list"><li class="tm-separated-list__item"><a href="/ru/hub/ios_dev/" class="tm-hubs-list__link">
    Разработка под iOS
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/mobile_dev/" class="tm-hubs-list__link">
    Разработка мобильных приложений
  </a></li><li class="tm-separated-list__item"><a href="/ru/hub/swift/" class="tm-hubs-list__link">
    Swift
  </a></li></ul></div></div></article></div> <!----></div> <div class="tm-article-sticky-panel"><div class="tm-data-icons tm-article-sticky-panel__icons"><div class="tm-article-rating tm-data-icons__item"><div class="tm-votes-meter tm-article-rating__votes-switcher"><svg height="16" width="16" class="tm-svg-img tm-votes-meter__icon tm-votes-meter__icon_medium"><title>Всего голосов 6: ↑6 и ↓0</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-rating"></use></svg> <span title="Всего голосов 6: ↑6 и ↓0" class="tm-votes-meter__value tm-votes-meter__value_positive tm-votes-meter__value_medium">+6</span></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----> <span title="Количество просмотров" class="tm-icon-counter tm-data-icons__item"><svg height="16" width="16" class="tm-svg-img tm-icon-counter__icon"><title>Просмотры</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-views"></use></svg> <span class="tm-icon-counter__value">6.5K</span></span> <button title="Добавить в закладки" type="button" class="bookmarks-button tm-data-icons__item"><span title="Добавить в закладки" class="tm-svg-icon__wrapper bookmarks-button__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Добавить в закладки</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-favorite"></use></svg></span> <span title="Количество пользователей, добавивших публикацию в закладки" class="bookmarks-button__counter">
    37
  </span></button> <!----> <div title="Поделиться" class="tm-sharing tm-data-icons__item"><button type="button" class="tm-sharing__button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="tm-sharing__icon"><path fill="currentColor" d="M10.33.275l9.047 7.572a.2.2 0 010 .306l-9.048 7.572a.2.2 0 01-.328-.153V11c-8 0-9.94 6-9.94 6S-1 5 10 5V.428a.2.2 0 01.328-.153z"></path></svg></button> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> </div></div> <!----> <!----> <div class="tm-article-presenter__footer"><div class="tm-article-blocks"><!----> <section class="tm-block tm-block_spacing-bottom"><!----> <div class="tm-block__body tm-block__body_variant-balanced"><div class="tm-article-author"> <div class="tm-user-card tm-article-author__user-card tm-user-card_variant-article"><div class="tm-user-card__info-container"><div class="tm-user-card__header"><div class="tm-user-card__header-data"><a href="/ru/users/Nekitosss/" class="tm-user-card__userpic tm-user-card__userpic_size-40"><div class="tm-entity-image"><svg class="tm-svg-img tm-image-placeholder tm-image-placeholder_green"><!----> <use xlink:href="/img/megazord-v24.ce74655c.svg#placeholder-user"></use></svg></div></a> <div class="tm-user-card__meta"><div title=" 9 голосов " class="tm-karma tm-user-card__karma"><div class="tm-karma__votes tm-karma__votes_positive">
    9
  </div> <div class="tm-karma__text">
    Карма
  </div></div> <div title="Рейтинг пользователя" class="tm-rating tm-user-card__rating"><div class="tm-rating__header"> <div class="tm-rating__counter">0.1</div></div> <div class="tm-rating__text">
    Рейтинг
  </div></div></div></div></div> <div class="tm-user-card__info tm-user-card__info_variant-article"><div class="tm-user-card__title tm-user-card__title_variant-article"><!----> <a href="/ru/users/Nekitosss/" class="tm-user-card__nickname tm-user-card__nickname_variant-article">
          @Nekitosss
        </a> <!----></div> <p class="tm-user-card__short-info tm-user-card__short-info_variant-article">Пользователь</p></div></div> <div class="tm-user-card__buttons tm-user-card__buttons_variant-article"><!----> <!----> <!----> <!----> <!----></div></div> <!----></div> <DIV class="v-portal" style="display:none;"></DIV></div> <!----></section> <div class="tm-article-blocks__comments"><div class="tm-article-page-comments"><div class="tm-article-comments-counter-link tm-article-comments-counter-button"><a href="/ru/post/451704/comments/" class="tm-article-comments-counter-link__link tm-article-comments-counter-link__link_button-style"><svg height="16" width="16" class="tm-svg-img tm-article-comments-counter-link__icon tm-article-comments-counter-link__icon_contrasted"><title>Комментарии</title> <use xlink:href="/img/megazord-v24.ce74655c.svg#counter-comments"></use></svg> <span class="tm-article-comments-counter-link__value tm-article-comments-counter-link__value_contrasted">
       Комментировать 
    </span></a> <!----></div></div></div> <div class="tm-ad-banner__container tm-page-article__banner"><!----> <div id="articleBottomBanner" class="tm-ad-banner"></div></div> <!----> <!----> <!----> <!----> </div></div></div></div></div> <div class="tm-page__sidebar"><div class="tm-layout-sidebar"><div class="tm-layout-sidebar__ads tm-layout-sidebar__ads_initial"><div class="tm-ad-banner__container tm-layout-sidebar__banner"><!----> <div id="sidebarBanner" class="tm-ad-banner"></div></div></div> <div class="tm-sexy-sidebar tm-sexy-sidebar_initial" style="margin-top:0px;"><!----> <!----></div></div></div></div></div></div></main> <!----></div> <div class="tm-footer-menu"><div class="tm-page-width"><div class="tm-footer-menu__container"><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Ваш аккаунт
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr/?back=/ru/post/451704/&amp;hl=ru" rel="nofollow" target="_self">
                Войти
              </a></li><li class="tm-footer-menu__list-item"><a href="/kek/v1/auth/habrahabr-register/?back=/ru/post/451704/&amp;hl=ru" rel="nofollow" target="_self">
                Регистрация
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Разделы
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/" class="footer-menu__item-link router-link-active">
                Публикации
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/news/" class="footer-menu__item-link">
                Новости
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/hubs/" class="footer-menu__item-link">
                Хабы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/companies/" class="footer-menu__item-link">
                Компании
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/users/" class="footer-menu__item-link">
                Авторы
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/sandbox/" class="footer-menu__item-link">
                Песочница
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Информация
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="/ru/docs/help/" class="footer-menu__item-link">
                Устройство сайта
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/authors/codex/" class="footer-menu__item-link">
                Для авторов
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/companies/corpblogs/" class="footer-menu__item-link">
                Для компаний
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/docs/docs/transparency/" class="footer-menu__item-link">
                Документы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/agreement" target="_blank">
                Соглашение
              </a></li><li class="tm-footer-menu__list-item"><a href="https://account.habr.com/info/confidential/" target="_blank">
                Конфиденциальность
              </a></li></ul></div></div><div class="tm-footer-menu__block"><h3 class="tm-footer-menu__block-title">
          Услуги
        </h3> <div class="tm-footer-menu__block-content"><ul class="tm-footer-menu__list"><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQLwRfQmXibiUlWaRg-BAc38s7oM3lJiaPju7qmdJsp8ysIvZ_G-Npem0njJLMozE2bPHMpDqiI5hhy/pub?start=false&amp;loop=false&amp;delayms=60000&amp;slide=id.g91a03369cd_4_297" target="_blank">
                Реклама
              </a></li><li class="tm-footer-menu__list-item"><a href="https://habrastorage.org/storage/stuff/habr/service_price.pdf" target="_blank">
                Тарифы
              </a></li><li class="tm-footer-menu__list-item"><a href="https://docs.google.com/presentation/d/e/2PACX-1vQJJds8-Di7BQSP_guHxICN7woVYoN5NP_22ra-BIo4bqnTT9FR6fB-Ku2P0AoRpX0Ds-LRkDeAoD8F/pub?start=false&amp;loop=false&amp;delayms=60000" target="_blank">
                Контент
              </a></li><li class="tm-footer-menu__list-item"><a href="https://tmtm.timepad.ru/" target="_blank">
                Семинары
              </a></li><li class="tm-footer-menu__list-item"><a href="/ru/megaprojects/" class="footer-menu__item-link">
                Мегапроекты
              </a></li></ul></div></div></div></div></div> <div class="tm-footer"><div class="tm-page-width"><div class="tm-footer__container"><!----> <div class="tm-footer__social"><a href="https://www.facebook.com/habrahabr.ru" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Facebook</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-facebook"></use></svg></a><a href="https://twitter.com/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Twitter</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-twitter"></use></svg></a><a href="https://vk.com/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>VK</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-vkontakte"></use></svg></a><a href="https://telegram.me/habr_com" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Telegram</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-telegram"></use></svg></a><a href="https://www.youtube.com/channel/UCd_sTwKqVrweTt4oAKY5y4w" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Youtube</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-youtube"></use></svg></a><a href="https://zen.yandex.ru/habr" rel="nofollow noopener noreferrer" target="_blank" class="tm-svg-icon__wrapper tm-social-icons__icon"><svg height="16" width="16" class="tm-svg-img tm-svg-icon"><title>Яндекс Дзен</title> <use xlink:href="/img/social-icons-sprite.svg#social-logo-zen"></use></svg></a></div> <DIV class="v-portal" style="display:none;"></DIV> <button class="tm-footer__link"><!---->
        Настройка языка
      </button> <a href="/ru/about" class="tm-footer__link">
        О сайте
      </a> <a href="/ru/feedback/" class="tm-footer__link">
        Техническая поддержка
      </a> <!----> <a href="/berserk-mode-nope" class="tm-footer__link">
        Вернуться на старую версию
      </a> <div class="tm-footer-copyright"><span class="tm-copyright"><span class="tm-copyright__years">© 2006–2021 </span> <span class="tm-copyright__name">«<a href="https://company.habr.com/" rel="noopener" target="_blank" class="tm-copyright__link">Habr</a>»</span></span></div></div></div></div> <!----> <!----></div> <div class="vue-portal-target"></div></div>
<script>window.__INITIAL_STATE__={"adblock":{"hasAcceptableAdsFilter":false,"hasAdblock":false},"articlesList":{"articlesList":{"451704":{"id":"451704","timePublished":"2019-05-14T05:38:24+00:00","isCorporative":false,"lang":"ru","titleHtml":"Swift under the hood: Generic implementation","leadData":{"textHtml":"\u003Cblockquote\u003EGeneric code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses its intent in a clear, abstracted manner. — \u003Cstrong\u003ESwift docs\u003C\u002Fstrong\u003E\u003C\u002Fblockquote\u003E\u003Cp\u003EКаждый, кто писал на Swift использовал дженерики. \u003Ccode\u003EArray\u003C\u002Fcode\u003E, \u003Ccode\u003EDictionary\u003C\u002Fcode\u003E, \u003Ccode\u003ESet\u003C\u002Fcode\u003E — самые базовые варианты использования дженериков из стандартной библиотеке. Как они представлены внутри? Расмотрим, как данная основополагающая возможность языка реализована инженерами Apple. \u003C\u002Fp\u003E","imageUrl":null,"buttonTextHtml":"Читать дальше →","image":null},"editorVersion":"1.0","postType":"article","postLabels":[],"author":{"scoreStats":{"score":9,"votesCount":9},"rating":0.1,"relatedData":null,"contacts":[],"authorContacts":[],"paymentDetails":{"paymentYandexMoney":null,"paymentPayPalMe":null,"paymentWebmoney":null},"id":"596483","alias":"Nekitosss","fullname":null,"avatarUrl":null,"speciality":null},"statistics":{"commentsCount":0,"favoritesCount":37,"readingCount":6501,"score":6,"votesCount":6},"hubs":[{"relatedData":null,"id":"548","alias":"ios_dev","type":"collective","title":"Разработка под iOS","titleHtml":"Разработка под iOS","isProfiled":true},{"relatedData":null,"id":"6345","alias":"mobile_dev","type":"collective","title":"Разработка мобильных приложений","titleHtml":"Разработка мобильных приложений","isProfiled":true},{"relatedData":null,"id":"19039","alias":"swift","type":"collective","title":"Swift","titleHtml":"Swift","isProfiled":true}],"flows":[{"id":"1","alias":"develop","title":"Разработка"}],"relatedData":null,"textHtml":"\u003Cdiv xmlns=\"http:\u002F\u002Fwww.w3.org\u002F1999\u002Fxhtml\"\u003E\u003Cblockquote\u003EGeneric code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses its intent in a clear, abstracted manner. — \u003Cstrong\u003ESwift docs\u003C\u002Fstrong\u003E\u003C\u002Fblockquote\u003E\u003Cp\u003EКаждый, кто писал на Swift использовал дженерики. \u003Ccode\u003EArray\u003C\u002Fcode\u003E, \u003Ccode\u003EDictionary\u003C\u002Fcode\u003E, \u003Ccode\u003ESet\u003C\u002Fcode\u003E — самые базовые варианты использования дженериков из стандартной библиотеке. Как они представлены внутри? Расмотрим, как данная основополагающая возможность языка реализована инженерами Apple. \u003C\u002Fp\u003E\u003Ca name=\"habracut\"\u003E\u003C\u002Fa\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДженериковые параметры могут быть как ограничены протоколами, так и не ограничены, хотя, в основном, дженерики используются совместно с протоколами, которые описывают, что именно можно делать с параметрами метода или полями типа.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля реализации дженериков Swift использует два подхода:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003ERuntime-way — generic код является обёрткой (Boxing).\u003C\u002Fli\u003E\r\n\u003Cli\u003ECompiletime-way — generic код преобразуется в код конкретного типа для оптимизации (Specialization).\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"boxing\"\u003EBoxing\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EРассмотрим простой метод с неограниченным протоколом дженериковым параметром:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Efunc test&lt;T\u003E(value: T) -\u003E T {\n    let copy = value\n    print(copy)\n    return copy\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКомпилятор swift создаёт один единственный блок кода, который будет вызываться для работы с любым \u003Ccode\u003E&lt;T\u003E\u003C\u002Fcode\u003E. То есть, независимо от того, напишем мы \u003Ccode\u003Etest(value: 1)\u003C\u002Fcode\u003E или \u003Ccode\u003Etest(value: \"Hello\")\u003C\u002Fcode\u003E, будет вызван один и тот же код и дополнительно в метод будет передана информация о типе \u003Ccode\u003E&lt;T\u003E\u003C\u002Fcode\u003E, содержащая в себе всё необходимое.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EМало что можно сделать с такими неограниченными протоколами параметрами, но, уже для реализации этого метода, необходимо знать, как копировать параметр, необходимо знать его размер, чтобы выделить под него память в рантайме, необходимо знать, как его уничтожать, когда параметр уходит из области видимости. Для хранения этой информации используется \u003Ccode\u003EValue Witness Table\u003C\u002Fcode\u003E (\u003Ccode\u003EVWT\u003C\u002Fcode\u003E). \u003Ccode\u003EVWT\u003C\u002Fcode\u003E создаётся на этапе компиляции для всех типов и компилятор гарантирует, что в рантайме будет именно такой лэйаут объекта. Напомню, что структуры в Swift передаются по значению, а классы по ссылке, поэтому для \u003Ccode\u003Elet copy = value\u003C\u002Fcode\u003E при \u003Ccode\u003ET == MyClass\u003C\u002Fcode\u003E и \u003Ccode\u003ET == MyStruct\u003C\u002Fcode\u003E будут сделаны разные вещи.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Value witness table\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fac\u002Fl5\u002Fdh\u002Facl5dhtdca3tl80zbott4turszy.gif\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТо есть, вызов метода \u003Ccode\u003Etest\u003C\u002Fcode\u003E с передачей туда объявленной структуры будет в итоге выглядеть примерно так:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003E\u002F\u002F Приблизительный псевдокод, параметр metadata добавляется компилятором\nlet myStruct = MyStruct()\ntest(value: myStruct, metadata: MyStruct.metadata)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВещи становятся чуть сложнее, когда \u003Ccode\u003EMyStruct\u003C\u002Fcode\u003E сама является дженериковой структурой и принимает вид \u003Ccode\u003EMyStruct&lt;T\u003E\u003C\u002Fcode\u003E. В зависимости от \u003Ccode\u003E&lt;T\u003E\u003C\u002Fcode\u003E внутри \u003Ccode\u003EMyStruct\u003C\u002Fcode\u003E, метаданные и \u003Ccode\u003EVWT\u003C\u002Fcode\u003E будут разными для типов \u003Ccode\u003EMyStruct&lt;Int\u003E\u003C\u002Fcode\u003E и \u003Ccode\u003EMyStruct&lt;Bool\u003E\u003C\u002Fcode\u003E. Это два разных типа в рантайме. Но создавать метаданные для каждой возможной комбинации \u003Ccode\u003EMyStruct\u003C\u002Fcode\u003E и \u003Ccode\u003ET\u003C\u002Fcode\u003E крайне неэффективно, поэтому Swift идёт другим путём и для таких случаев конструирует метаданные в рантайме на ходу. Компилятором создаётся один metadata pattern для дженериковой структуры, который можно комбинировать с конкретным типом и, в итоге, получать полную информацию по типу в рантайме с корректной \u003Ccode\u003EVWT\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003E\u002F\u002F Опять же псевдокод, параметр metadata добавляется компилятором\nfunc test&lt;T\u003E(value: MyStruct&lt;T\u003E, tMetadata: T.Type) {\n    \u002F\u002F Комбинируем информацию и получаем итоговые метаданные\n    let myStructMetadata = get_generic_metadata(MyStruct.metadataPattern, tMetadata)\n    ...\n}\n\nlet myStruct = MyStruct&lt;Int\u003E()\ntest(value: myStruct) \u002F\u002F Исходный код\ntest(value: myStruct, tMetadata: Int.metadata) \u002F\u002F Примерно вот в это компилируется\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EКогда мы комбинируем информацию, мы получаем метаданные, с которыми можно работать (копировать, перемещать, уничтожать).\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВсё ещё немного сложнее, когда на дженерики добавляются ограничения в виде протоколов. К примеру, ограничим \u003Ccode\u003E&lt;T\u003E\u003C\u002Fcode\u003E протоколом \u003Ccode\u003EEquatable\u003C\u002Fcode\u003E. Пусть это будет очень простой метод, который сравнивает два переданных аргумента. Получится просто обёртка над методом сравнения.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Efunc isEquals&lt;T: Equatable\u003E(first: T, second: T) -\u003E Bool {\n    return first == second\n}\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля правильной работы программы необходимо иметь указатель на метод сравнения \u003Ccode\u003Estatic func ==(lhs:T, rhs:T)\u003C\u002Fcode\u003E. Как его получить? Очевидно, что передачи \u003Ccode\u003EVWT\u003C\u002Fcode\u003E не хватит, она не содержит этой информации. Для решения этой проблемы существует \u003Ccode\u003EProtocol Witness Table\u003C\u002Fcode\u003E или \u003Ccode\u003EPWT\u003C\u002Fcode\u003E. Эта табличка похожа на \u003Ccode\u003EVWT\u003C\u002Fcode\u003E и создаётся на этапе компиляции для протоколов и описывает эти протоколы.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003EisEquals(first: 1, second: 2) \u002F\u002F Исходный код\n\n\u002F\u002F Примерно во что превращается\nisEquals(first: 1, \u002F\u002F 1\n         second: 2,\n         metadata: Int.metadata, \u002F\u002F 2\n         intIsEquatable: Equatable.witnessTable) \u002F\u002F 3\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003EПередаются два аргумента\u003C\u002Fli\u003E\r\n\u003Cli\u003EПередаём метаданные для \u003Ccode\u003EInt\u003C\u002Fcode\u003E, чтобы можно было копировать\u002Fперемещать\u002Fуничтожать объекты\u003C\u002Fli\u003E\r\n\u003Cli\u003EПередаём информацию и том, что \u003Ccode\u003EInt\u003C\u002Fcode\u003E реализует \u003Ccode\u003EEquatable\u003C\u002Fcode\u003E.\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЕсли бы ограничение требовало реализации ещё одного протокола, к примеру, \u003Ccode\u003ET: Equatable &amp; MyProtocol\u003C\u002Fcode\u003E, то информация о \u003Ccode\u003EMyProtocol\u003C\u002Fcode\u003E добавилась бы следующим параметром:\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003EisEquals(...,\n        intIsEquatable: Equatable.witnessTable,\n        intIsMyProtocol: MyProtocol.witnessTable)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИспользование обёрток для реализации дженериков позволяет гибко реализовывать все необходимые фичи, но имеет оверхед, который можно оптимизировать.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch2 id=\"specializaciya-dzhenerikov\"\u003EСпециализация дженериков\u003C\u002Fh2\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧтобы устранить излишнюю необходимость получения информации во время выполнения программы, был использован так называемый подход специализации дженериков. Он позволяет заменить дженериковую обёртку конкретным типом с конкретной реализацией. К примеру, для двух вызовов \u003Ccode\u003EisEquals(first: 1, second: 2)\u003C\u002Fcode\u003E и \u003Ccode\u003EisEquals(first: \"Hello\", second: \"world\")\u003C\u002Fcode\u003E, помимо основной \"обёрточной\" реализации, будут скомпилированы две дополнительные абсолютно разные версии метода для \u003Ccode\u003EInt\u003C\u002Fcode\u003E и для \u003Ccode\u003EString\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"ishodnyy-kod\"\u003EИсходный код\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EДля начала создадим \u003Cem\u003Egeneric.swift\u003C\u002Fem\u003E файл и напишем небольшую generic функцию, которую будем рассматривать.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"swift\"\u003Efunc isEquals&lt;T: Equatable\u003E(first: T, second: T) -\u003E Bool {\n    return first == second\n}\nisEquals(first: 10, second: 11)\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EТеперь необходимо понять, во что это в итоге превращается компилятором.\u003Cbr\u002F\u003E\r\nЭто можно наглядно посмотреть, скомпилировав наш \u003Cem\u003E.swift\u003C\u002Fem\u003E файл в \u003Cem\u003ESwift Intermediate Language\u003C\u002Fem\u003E или \u003Ccode\u003ESIL\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch4 id=\"nemnogo-o-sil-i-processe-kompilyacii\"\u003EНемного о SIL и процессе компиляции\u003C\u002Fh4\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Ccode\u003ESIL\u003C\u002Fcode\u003E является результатом одним из нескольких этапов компиляции swift.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Compiler pipeline\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002F-a\u002Flw\u002Fp-\u002F-alwp-gdushiyhqxgfch2iyppj8.gif\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EИсходный код \u003Cem\u003E.swift передаеётся Lexer, который создаёт абстрактное синтаксическое дерево (\u003Ccode\u003EAST\u003C\u002Fcode\u003E) языка, на основе которого проводится проверка типов и семантический анализ кода. SilGen преобразует \u003Ccode\u003EAST\u003C\u002Fcode\u003E в \u003Ccode\u003ESIL\u003C\u002Fcode\u003E, называемый \u003Ccode\u003Eraw SIL\u003C\u002Fcode\u003E, на основе которого происходит оптимизация кода и получается оптимизированный \u003Ccode\u003Ecanonical SIL\u003C\u002Fcode\u003E, который передаётся в \u003Ccode\u003EIRGen\u003C\u002Fcode\u003E для преобразования в \u003Ccode\u003EIR\u003C\u002Fcode\u003E — специальный формат, понятный \u003Ccode\u003ELLVM\u003C\u002Fcode\u003E, который будет преобразован в `\u003C\u002Fem\u003E.o\u003Ccode\u003Eфайлы, собранные под конкретную архитектуру процессора. Во что превращается наш дженериковый код можно посмотреть как раз на этапе создания\u003C\u002Fcode\u003ESIL`.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"i-snova-k-dzhenerikam\"\u003EИ снова к дженерикам\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EСоздадим \u003Ccode\u003ESIL\u003C\u002Fcode\u003E файл из нашего исходного кода.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cpre\u003E\u003Ccode class=\"plaintext\"\u003Eswiftc generic.swift -O -emit-sil -o generic-sil.s\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПолучим новый файл с расширением \u003Ccode\u003E*.s\u003C\u002Fcode\u003E. Заглянув вовнутрь, мы увидим гораздо менее читаемый код, чем исходный, но, всё равно, относительно понятный.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Raw SIL\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fwt\u002F4g\u002F0y\u002Fwt4g0yxc0ang-ityxpwxr9wrelg.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНайдём строку с комментарием \u003Ccode\u003E\u002F\u002F isEquals&lt;A\u003E(first:second:)\u003C\u002Fcode\u003E. Это и есть начало описания нашего метода. Заканчивается он комментарием \u003Ccode\u003E\u002F\u002F end sil function '$s4main8isEquals5first6secondSbx_xtSQRzlF'\u003C\u002Fcode\u003E. У вас название может немного отличаться. Немного разберём описание метода.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cul\u003E\r\n\u003Cli\u003E\u003Ccode\u003E%0\u003C\u002Fcode\u003E и \u003Ccode\u003E%1\u003C\u002Fcode\u003E на 21 строке являются \u003Ccode\u003Efirst\u003C\u002Fcode\u003E и \u003Ccode\u003Esecond\u003C\u002Fcode\u003E параметрами соответственно\u003C\u002Fli\u003E\r\n\u003Cli\u003EНа 24 строке получаем информацию о типе и передаём в \u003Ccode\u003E%4\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003EНа 25 строке получаем указатель на метод сравнения из информации о типе\u003C\u002Fli\u003E\r\n\u003Cli\u003Eна 26 строке Вызываем метод по указателю, передавая ему оба параметра и информацию о типе\u003C\u002Fli\u003E\r\n\u003Cli\u003EНа 27 строке отдаём результат.\u003C\u002Fli\u003E\r\n\u003C\u002Ful\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ итоге мы видим: чтобы выполнить необходимые действия в реализации дженерикового метода, нам нужно во время выполнения программы получать информацию из описания типа \u003Ccode\u003E&lt;T\u003E\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EПерейдём непосредственно к специализации.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EВ скомпилированном \u003Ccode\u003ESIL\u003C\u002Fcode\u003E файле сразу после объявления общего метода \u003Ccode\u003EisEquals\u003C\u002Fcode\u003E следует объявление специализированного для типа \u003Ccode\u003EInt\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cbr\u002F\u003E\r\n\u003Cdiv style=\"text-align:center;\"\u003E\u003Cimg src=\"\u002Fimg\u002Fimage-loader.svg\" alt=\"Specialized SIL\" data-src=\"https:\u002F\u002Fhabrastorage.org\u002Fwebt\u002Fay\u002Fts\u002Fj1\u002Faytsj1ykoyhd0o38wpi1owignwo.png\"\u002F\u003E\u003C\u002Fdiv\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EНа 39 строке вместо получения метода в рантайме из информации о типе сразу вызывается метод сравнения целых чисел \u003Ccode\u003E\"cmp_eq_Int64\"\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003EЧтобы метод \"специализировался\", необходимо \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fapple\u002Fswift\u002Fblob\u002Fmaster\u002Fdocs\u002FOptimizationTips.rst#enabling-optimizations\"\u003Eвключить оптимизацию\u003C\u002Fa\u003E. Также, необходимо знать, что\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cblockquote\u003EThe optimizer can only perform specialization if the definition of the generic declaration is visible in the current Module (\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fapple\u002Fswift\u002Fblob\u002Fmaster\u002Fdocs\u002FOptimizationTips.rst#advice-put-generic-declarations-in-the-same-module-where-they-are-used\"\u003EИсточник\u003C\u002Fa\u003E)\u003C\u002Fblockquote\u003E\u003Cp\u003EТо есть, метод не может быть специализирован между разными модулями Swift (например, дженериковый метод из Cocoapods библиотеки). Исключением является стандартная библиотека Swift, в которой такие базовые типы, как \u003Ccode\u003EArray\u003C\u002Fcode\u003E, \u003Ccode\u003ESet\u003C\u002Fcode\u003E и \u003Ccode\u003EDictionary\u003C\u002Fcode\u003E. Все дженерики базовой библиотеки специализируются в конкретные типы.\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Cp\u003E\u003Cstrong\u003ENote:\u003C\u002Fstrong\u003E В Swift 4.2 были реализованы аттрибуты \u003Ccode\u003E@inlinable\u003C\u002Fcode\u003E и \u003Ccode\u003E@usableFromInline\u003C\u002Fcode\u003E, которые позволяют оптимизатору видеть тела методов из других модулей и вроде как есть возможность их специализировать, но данное поведение мной не тестировалось (\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fapple\u002Fswift-evolution\u002Fblob\u002Fmaster\u002Fproposals\u002F0193-cross-module-inlining-and-specialization.md\"\u003EИсточник\u003C\u002Fa\u003E)\u003C\u002Fp\u003E\u003Cbr\u002F\u003E\r\n\u003Ch3 id=\"ssylki\"\u003EСсылки\u003C\u002Fh3\u003E\u003Cbr\u002F\u003E\r\n\u003Col\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fapple\u002Fswift\u002Fblob\u002Fmaster\u002Fdocs\u002FGenerics.rst\"\u003EОписание дженериков\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fapple\u002Fswift\u002Fblob\u002Fmaster\u002Fdocs\u002FOptimizationTips.rst\"\u003EОптимизация в Swift\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fwww.youtube.com\u002Fwatch?v=ctS8FzqcRug\"\u003EБолее подробная и глубокая презентация по теме\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003Cli\u003E\u003Ca href=\"https:\u002F\u002Fnekitosss.github.io\u002F2019-05-12-swift-generics\u002F\"\u003EСтатья на английском\u003C\u002Fa\u003E\u003C\u002Fli\u003E\r\n\u003C\u002Fol\u003E\u003C\u002Fdiv\u003E","tags":[{"titleHtml":"iOS"},{"titleHtml":"swift"},{"titleHtml":"generics"},{"titleHtml":"specialization"},{"titleHtml":"optimization"}],"metadata":{"stylesUrls":[],"scriptUrls":[],"shareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F451704\u002F081154b4a6b02adecac9aa58b8595110\u002F","shareImageWidth":1200,"shareImageHeight":630,"vkShareImageUrl":"https:\u002F\u002Fhabr.com\u002Fshare\u002Fpublication\u002F451704\u002F081154b4a6b02adecac9aa58b8595110\u002F?format=vk","schemaJsonLd":"{\"@context\":\"http:\\\u002F\\\u002Fschema.org\",\"@type\":\"Article\",\"mainEntityOfPage\":{\"@type\":\"WebPage\",\"@id\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F451704\\\u002F\"},\"headline\":\"Swift under the hood: Generic implementation\",\"datePublished\":\"2019-05-14T08:38:24+03:00\",\"dateModified\":\"2019-07-05T16:18:45+03:00\",\"author\":{\"@type\":\"Person\",\"name\":\"Nekitosss\"},\"publisher\":{\"@type\":\"Organization\",\"name\":\"Habr\",\"logo\":{\"@type\":\"ImageObject\",\"url\":\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fa_\\\u002Flk\\\u002F9m\\\u002Fa_lk9mjkccjox-zccjrpfolmkmq.png\"}},\"description\":\"Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write...\",\"url\":\"https:\\\u002F\\\u002Fhabr.com\\\u002Fru\\\u002Fpost\\\u002F451704\\\u002F#post-content-body\",\"about\":[\"h_ios_dev\",\"h_mobile_dev\",\"h_swift\",\"f_develop\"],\"image\":[\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fac\\\u002Fl5\\\u002Fdh\\\u002Facl5dhtdca3tl80zbott4turszy.gif\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002F-a\\\u002Flw\\\u002Fp-\\\u002F-alwp-gdushiyhqxgfch2iyppj8.gif\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fwt\\\u002F4g\\\u002F0y\\\u002Fwt4g0yxc0ang-ityxpwxr9wrelg.png\",\"https:\\\u002F\\\u002Fhabrastorage.org\\\u002Fwebt\\\u002Fay\\\u002Fts\\\u002Fj1\\\u002Faytsj1ykoyhd0o38wpi1owignwo.png\"]}","metaDescription":"Generic code enables you to write flexible, reusable functions and types that can work with any type, subject to requirements that you define. You can write code that avoids duplication and expresses...","mainImageUrl":null,"amp":false},"polls":[],"commentsEnabled":true,"rulesRemindEnabled":false,"votesEnabled":true,"status":"published","plannedPublishTime":null,"checked":null,"isEditorial":false}},"articlesIds":{},"isLoading":false,"pagesCount":{},"route":{},"reasonsList":null,"view":"cards","lastVisitedRoute":{},"ssrCommentsArticleIds":[""],"karma":{}},"authorContribution":{"authors":{}},"betaTest":{"currentAnnouncement":null,"announcements":{},"announcementCards":null,"announcementComments":{},"announcementCommentThreads":{},"announcementCommentingStatuses":{},"archivedList":[]},"authorStatistics":{"articleRefs":{},"articleIds":{},"pagesCount":{},"route":{},"viewsCount":[],"maxStatsCount":{}},"career":{"seoLandings":[],"hubs":"ios_dev,mobile_dev,swift"},"comments":{"articleComments":{},"searchCommentsResults":null,"previewComment":null,"pagesCount":null,"commentAccess":{},"scrollParents":{},"pageArticleComments":{"lastViewedComment":0,"postId":null,"lastCommentTimestamp":"","moderated":[],"moderatedIds":[],"commentRoute":""}},"companies":{"companyRefs":{},"companyIds":{},"companyTopIds":{},"pagesCount":{},"companyProfiles":{},"companiesCategories":[],"companiesCategoriesTotalCount":0,"companiesWidgets":{},"companiesWorkers":{},"companiesFans":{},"route":{},"isLoading":false,"companyWorkersLoading":false,"companyFansLoading":false,"vacancies":{}},"companiesContribution":{"hubs":{},"flows":{},"companyRefs":{}},"companyHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"conversation":{"messages":[],"respondent":null,"isLoadMore":false},"conversations":{"conversations":[],"unreadCount":0,"pagesCount":0,"isLoadMore":false},"desktopState":{"desktopFl":null,"desktopHl":null,"isChecked":false,"isLoginDemanded":false},"dfp":{"slotsDict":{}},"docs":{"menu":{},"articles":{},"mainMenu":[],"loading":{"main":false,"dropdown":false,"article":false}},"feature":{"isProbablyVisible":"true"},"flows":{"flows":[{"alias":"develop","id":1,"route":{"name":"FLOW_PAGE","params":{"flowName":"develop"}}},{"alias":"admin","id":6,"route":{"name":"FLOW_PAGE","params":{"flowName":"admin"}}},{"alias":"design","id":2,"route":{"name":"FLOW_PAGE","params":{"flowName":"design"}}},{"alias":"management","id":3,"route":{"name":"FLOW_PAGE","params":{"flowName":"management"}}},{"alias":"marketing","id":4,"route":{"name":"FLOW_PAGE","params":{"flowName":"marketing"}}},{"alias":"popsci","id":7,"route":{"name":"FLOW_PAGE","params":{"flowName":"popsci"}}}]},"global":{"isPwa":false,"device":"desktop","isHabrCom":true},"hubs":{"hubRefs":{},"hubIds":{},"pagesCount":{},"isLoading":false,"route":{}},"hubsBlock":{"hubRefs":{},"hubIds":{}},"i18n":{"fl":"ru","hl":"ru"},"info":{"infoPage":{},"isLoading":true},"location":{"urlStruct":{"protocol":null,"slashes":null,"auth":null,"host":null,"port":null,"hostname":null,"hash":null,"search":null,"query":{},"pathname":null,"path":null,"href":""},"searchQuery":null},"me":{"user":null,"ppgDemanded":false,"karmaResetInfo":{"canReincarnate":null,"wasReincarnated":null,"currentScore":null},"notes":null},"mostReadingList":{"mostReadingListIds":[],"mostReadingListRefs":null,"promoPost":null},"pinnedPost":{"pinnedPost":null},"ppa":{"articles":{},"card":null,"transactions":null,"totalTransactions":null,"isAccessible":null},"projectsBlocks":{"activeBlocks":{}},"pullRefresh":{"shouldRefresh":false},"sandbox":{"articleIds":[],"articleRefs":{},"pagesCount":null,"route":{},"lastVisitedRoute":{},"isLoading":false},"settingsOther":{"inputs":{"uiLang":{"errors":[],"ref":null,"value":""},"articlesLangEnglish":{"errors":[],"ref":null,"value":false},"articlesLangRussian":{"errors":[],"ref":null,"value":false},"agreement":{"errors":[],"ref":null,"value":false},"email":{"errors":[],"ref":null,"value":true},"digest":{"errors":[],"ref":null,"value":true}}},"similarList":{"similarListIds":[],"similarListRefs":null},"ssr":{"error":null,"isDataLoaded":false,"isDataLoading":false,"isHydrationFailed":false,"isServer":false},"userHubsContribution":{"contributionRefs":{"hubRefs":{},"hubIds":{}}},"userInvites":{"availableInvites":0,"usedInvitesIds":[],"usedInvitesRefs":{},"usedInvitesPagesCount":0,"unusedInvitesIds":[],"unusedInvitesRefs":{},"unusedInvitesPagesCount":0},"users":{"authorRefs":{},"authorIds":{},"pagesCount":{},"authorProfiles":{},"userHubs":{},"userInvitations":{},"authorFollowers":{},"authorFollowed":{},"karmaStats":[],"statistics":null,"isLoading":false,"authorFollowersLoading":false,"authorFollowedLoading":false,"userHubsLoading":false,"userInvitationsLoading":false,"route":{}},"viewport":{"prevScrollY":{},"scrollY":0,"width":0},"tracker":{"items":{},"pagesCache":{},"markedViewedSilently":{},"markedRead":{},"unreadCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null},"unviewedCounters":{"applications":null,"system":null,"mentions":null,"subscribers":null,"posts_and_comments":null}}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script>
<script src="https://assets.habr.com/habr-web/js/chunk-vendors.c2c3fc9a.js" defer></script><script src="https://assets.habr.com/habr-web/js/app.c0af73e7.js" defer></script>



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    </script>
  
  <script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

    ym(24049213, "init", {
      defer:true,
      trackLinks:true,
      accurateTrackBounce:true,
      webvisor:false,
    });
  </script>
  <noscript>
    <div>
      <img src="https://mc.yandex.ru/watch/24049213" style="position:absolute; left:-9999px;" alt="" />
    </div>
  </noscript>
  
    <script type="text/javascript">
      window.addEventListener('load', function () {
        setTimeout(() => {
          const img = new Image();
          img.src = 'https://vk.com/rtrg?p=VK-RTRG-421343-57vKE';
        }, 0);
      });
    </script>
  
</body>
</html>
